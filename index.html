<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#001d25">
  <link rel="apple-touch-icon" href="medinova_ios.png">
  <link rel="icon" href="medinova.ico" type="image/x-icon" />
  <title>Medinova</title>

  <!-- ‚úÖ Externos -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/gh/qzind/tray/qz-tray.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- ‚úÖ Supabase (v2) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
// =========================
// üî• LOG helper global (simple pero √∫til)
// =========================
window.LOGS_ON = true;
window.logx = function logx(tag, msg, obj) {
  if (!window.LOGS_ON) return;
  const line = `[${new Date().toISOString()}] ${tag} ${msg}`;
  console.log(line, obj ?? "");
  const box = document.getElementById("logsForecast");
  if (box) {
    const extra = obj ? ` :: ${JSON.stringify(obj)}` : "";
    box.textContent = (line + extra + "\n" + (box.textContent || "")).slice(0, 8000);
  }
};

    // =========================
    // ‚úÖ Config Supabase
    // =========================
    window.SUPABASE_URL = "https://ldjrpfsbpcfninntffoj.supabase.co";
    window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"; // <-- deja la tuya

    // Espera a que el script defer haya cargado
    window.addEventListener("DOMContentLoaded", () => {
      try {
        if (!window.supabase || typeof window.supabase.createClient !== "function") {
          logx("‚ùå[Supabase]", "No existe window.supabase.createClient. Revisa el CDN.");
          return;
        }
        window.sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);
        logx("‚úÖ[Supabase]", "Cliente listo", { hasSb: !!window.sb });
      } catch (e) {
        logx("‚ùå[Supabase]", "Fallo inicializando cliente", { err: String(e?.message || e) });
      }
    });
  </script>

  <style>

:root{
  --bg-0:#030b10;
  --bg-1:#06161d;

  --glass: rgba(0,18,22,.72);
  --panel: rgba(0,18,22,.78);
  --panel-strong: rgba(0,18,22,.82);

  --stroke: rgba(23,162,166,.30);
  --stroke-strong: rgba(23,162,166,.40);
  --stroke-soft: rgba(255,255,255,.10);

  --teal:#17a2a6;
  --blue:#1e40af;

  --txt:#eaf6f7;
  --muted: rgba(255,255,255,.72);

  --shadow: 0 25px 60px rgba(0,0,0,.55);
  --shadow-soft: 0 18px 45px rgba(0,0,0,.35);

  --radius: 24px;
  --radius-sm: 16px;
}
.dial { width: 140px; height: 140px; touch-action: none; }
.dial svg { width: 100%; height: 100%; overflow: visible; }
.dial .bg { stroke: rgba(255,255,255,0.10); }
.dial .track { stroke: rgba(2,199,202,0.20); }
.dial .value { stroke: rgba(204,163,0,0.95); filter: drop-shadow(0 0 10px rgba(204,163,0,0.25)); }
.dial .knob { fill: rgba(255,255,255,0.85); }
.dial .txt { fill: rgba(229,231,235,0.9); font: 700 16px system-ui; }
.dial .sub { fill: rgba(203,213,225,0.65); font: 12px system-ui; }

/* =========================
   Base
========================= */
body{
  margin:0;
  color:var(--txt);
  font-family:'Segoe UI',sans-serif;
  background: url('bcg_centrum.png') no-repeat center center fixed;
  background-size:cover;
  background-color:#001d25;
}

@media (max-width: 767px){
  body{
    background-position: top center;
    padding-top: env(safe-area-inset-top);
  }
}

/* =========================
   Glass Components
========================= */
.space-panel{
  background:
    radial-gradient(1200px 600px at 10% 10%, rgba(23,162,166,.25), transparent 55%),
    radial-gradient(900px 500px at 90% 30%, rgba(30,64,175,.25), transparent 60%),
    var(--panel);
  border:1px solid var(--stroke-strong);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

.space-card{
  background:rgba(255,255,255,.05);
  border:1px solid var(--stroke-soft);
  border-radius:18px;
  box-shadow:var(--shadow-soft);
}

.space-input{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  outline:none;

  background:rgba(0,0,0,.30);
  border:1px solid rgba(255,255,255,.12);
  color:var(--txt);

  transition: box-shadow .12s ease, border-color .12s ease;
  color-scheme: dark; /* üëà inputs nativos dark (incluye number/date) */
}
.space-input::placeholder{ color:rgba(255,255,255,.45); }
.space-input:focus{
  border-color:rgba(23,162,166,.55);
  box-shadow:0 0 0 2px rgba(23,162,166,.55);
}
/* ===== Caducidad: tabla glass bonita ===== */
.cadu-table-wrap{
  overflow-x: auto;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(0,0,0,0.22);
}
.cadu-table{
  width: 100%;
  min-width: 640px;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 12.5px;
  color: rgba(255,255,255,0.88);
}
.cadu-table thead th{
  position: sticky;
  top: 0;
  z-index: 1;
  text-transform: uppercase;
  letter-spacing: .08em;
  font-size: 11px;
  color: rgba(255,255,255,0.70);
  background: rgba(255,255,255,0.06);
  border-bottom: 1px solid rgba(255,255,255,0.10);
  padding: 10px 12px;
}
.cadu-table tbody td{
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  vertical-align: top;
}
.cadu-table tbody tr:nth-child(odd){ background: rgba(255,255,255,0.02); }
.cadu-table tbody tr:hover{ background: rgba(255,255,255,0.05); }

.cadu-pill{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 11px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(255,255,255,0.06);
}
.cadu-pill--danger{
  background: rgba(244,63,94,0.14);
  border-color: rgba(244,63,94,0.30);
  color: rgba(255,255,255,0.92);
}
.cadu-pill--warn{
  background: rgba(245,158,11,0.14);
  border-color: rgba(245,158,11,0.30);
}
.cadu-pill--ok{
  background: rgba(16,185,129,0.14);
  border-color: rgba(16,185,129,0.30);
}
.cadu-sub{
  display:block;
  color: rgba(255,255,255,0.58);
  font-size: 11px;
  margin-top: 2px;
}

.space-btn{
  border-radius:18px;
  padding:10px 14px;
  font-weight:700;
  color:#fff;

  background:linear-gradient(90deg, rgba(30,64,175,.25), rgba(23,162,166,.25));
  border:1px solid rgba(23,162,166,.25);
  box-shadow:0 12px 30px rgba(0,0,0,.35);

  transition: transform .12s ease, opacity .12s ease;
}
.space-btn:hover{ opacity:.95; transform: translateY(-1px); }
.space-btn:active{ transform: translateY(0); }

.space-btn-ghost{
  border-radius:18px;
  padding:10px 14px;
  font-weight:700;
  color:var(--txt);

  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);

  transition: background .12s ease;
}
.space-btn-ghost:hover{ background:rgba(255,255,255,.09); }

/* =========================
   Backdrops / Modals
========================= */
.space-modal-backdrop{
  background:rgba(0,0,0,.72);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

/* Modal system (el que est√°s usando ya) */
.space-modal{
  position:fixed;
  inset:0;
  z-index:10000;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
  background:rgba(0,0,0,.72);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}
.space-modal.hidden{ display:none !important; }

.space-modal__panel{
  width:min(560px, 96vw);
  max-height:min(92dvh, 760px);
  overflow:auto;

  background:
    radial-gradient(1200px 600px at 10% 10%, rgba(23,162,166,.25), transparent 55%),
    radial-gradient(900px 500px at 90% 30%, rgba(30,64,175,.25), transparent 60%),
    var(--panel-strong);

  border:1px solid rgba(23,162,166,.35);
  border-radius:22px;
  box-shadow:var(--shadow);
  color:var(--txt);
}

.space-modal__header{
  position:sticky;
  top:0;
  z-index:1;
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.10);
  background:rgba(0,18,22,.72);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}
.space-modal__body{ padding:16px; }

/* Modal viejo (compat) */
.modal{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:18px;
  display:none;
  z-index:10000;

  background:
    radial-gradient(900px 500px at 20% 20%, rgba(23,162,166,.22), transparent 60%),
    radial-gradient(700px 420px at 85% 40%, rgba(30,64,175,.22), transparent 65%),
    rgba(0,18,22,.85);

  border:1px solid rgba(23,162,166,.35);
  border-radius:var(--radius-sm);
  box-shadow:var(--shadow);
  color:var(--txt);
  max-width:min(520px, 92vw);
}

/* =========================
   Special UI blocks
========================= */
#mensajeQR{
  position:fixed;
  top:40%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:18px 22px;
  border-radius:18px;
  font-weight:700;
  font-size:18px;
  text-align:center;
  display:none;
  z-index:9999;
  max-width:min(680px,86vw);

  background:
    radial-gradient(900px 500px at 15% 10%, rgba(23,162,166,.22), transparent 60%),
    radial-gradient(700px 420px at 90% 30%, rgba(30,64,175,.20), transparent 65%),
    rgba(0,18,22,.86);

  border:1px solid rgba(23,162,166,.38);
  box-shadow:0 22px 60px rgba(0,0,0,.55);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

.blur-fondo::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  background:rgba(0,0,0,.70);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

.completada{
  background-color: rgba(16,185,129,.16);
  border-left:3px solid rgba(16,185,129,.55);
}

#qr-reader{
  border:1px solid rgba(23,162,166,.45);
  border-radius:18px;
  overflow:hidden;
  background:rgba(0,0,0,.25);
  box-shadow:0 18px 45px rgba(0,0,0,.35);
}

/* =========================
   Accessibility / Utils
========================= */
.sr-only{
  position:absolute !important;
  width:1px !important;
  height:1px !important;
  padding:0 !important;
  margin:-1px !important;
  overflow:hidden !important;
  clip:rect(0,0,0,0) !important;
  white-space:nowrap !important;
  border:0 !important;
}

/* File input styled */
.space-file-wrap{ display:grid; gap:10px; }
.space-file-input{
  position:absolute !important;
  width:1px !important;
  height:1px !important;
  padding:0 !important;
  margin:-1px !important;
  overflow:hidden !important;
  clip:rect(0,0,0,0) !important;
  white-space:nowrap !important;
  border:0 !important;
}
.space-file-input:focus + label,
.space-file-input:focus-visible + label{
  box-shadow:0 0 0 2px rgba(23,162,166,.55);
  border-color:rgba(23,162,166,.55);
}

/* =========================
   Overrides: Cantidad compacto (number)
========================= */
.input-cantidad{
  width:72px !important;
  min-width:64px !important;
  max-width:80px !important;

  padding:6px 8px !important;
  border-radius:12px !important;
  text-align:right !important;
  font-variant-numeric: tabular-nums;

  background:rgba(0,0,0,.35) !important;
  color:var(--txt) !important;
  border:1px solid rgba(255,255,255,.14) !important;

  outline:none !important;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
}
.input-cantidad::placeholder{ color:rgba(255,255,255,.45) !important; }
.input-cantidad:focus{
  border-color:rgba(23,162,166,.55) !important;
  box-shadow:0 0 0 2px rgba(23,162,166,.45) !important;
}
.input-cantidad::-webkit-outer-spin-button,
.input-cantidad::-webkit-inner-spin-button{
  opacity:.65;
  filter: invert(1);
}

/* =========================
   Overrides: botones con salto en m√≥vil
========================= */
.btn-wrap{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  text-align:center;
}
.btn-text{
  display:inline-block;
  line-height:1.05;
  white-space:normal;
}
@media (max-width: 520px){
  .btn-wrap{ padding:10px 12px !important; }
  .btn-text{ max-width:10.5ch; font-size:.92rem; }
}

/* =========================
   Fonts
========================= */
@font-face{
  font-family:'MagmaWave';
  src:url('MagmawaveCaps-Bold.woff2') format('woff2');
  font-weight:normal;
  font-style:normal;
}
.fuente-magma{ font-family:'MagmaWave', sans-serif; }

.modo-basurero{
  background-image:url('blackhole.png');
  background-size:cover;
  background-position:center;
  transition: background 3s ease-in-out;
}

  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center text-white px-3 py-6 sm:py-8 md:py-10">

<!-- ‚úÖ Loader (space) -->
<div id="loaderOverlay"
     class="fixed inset-0 z-[99999] hidden select-none flex items-center justify-center space-modal-backdrop">
  <div id="loaderPanel"
       class="space-panel p-6 flex items-center gap-4 w-[min(370px,92vw)]">
    <img src="loader.gif" alt="Cargando..." class="w-20 h-20 pointer-events-none">
    <div class="text-white/80 flex-1 min-w-0">
      <div class="fuente-magma tracking-widest text-lg">
        PROCESANDO
      </div>

      <!-- üîí Status con ancho fijo (no brinca con los "...") -->
      <div id="loaderStatus"
           class="text-xs text-white/60 inline-block w-[28ch] whitespace-nowrap font-mono">
        Ejecutando operaci√≥n‚Ä¶
      </div>

      <!-- ‚úÖ Ticker: si aparece, no cambia la altura porque reservamos espacio -->
      <div id="loaderTicker"
           class="hidden mt-3 text-[11px] bg-black/30 border border-white/10
                  rounded-xl p-2 space-y-1 max-h-36 min-h-[90px] overflow-y-auto font-mono">
      </div>
    </div>
  </div>
</div>


  <!-- =========================
      MODAL QR draggable (space)
      ========================= -->
  <div id="modalQR" class="fixed top-4 right-4 z-[890] hidden cursor-move w-[360px] max-w-full">
    <div class="space-panel p-3" id="handleQR">
      <div class="flex items-center justify-between">
        <h2 class="text-center font-semibold text-sm text-white/80">Escanea un QR</h2>
        <button onclick="cerrarModalQR()" class="text-red-900 hover:text-red-600 font-bold text-xl px-2">√ó</button>
      </div>
      <div id="qr-reader" class="w-full mt-2"></div>
      <div class="mt-3 flex justify-end">
        <button onclick="cerrarModalQR()" class="space-btn-ghost text-sm">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- LOGO CENTRUM ARRIBA DERECHA -->
  <div class="absolute top-4 right-4 flex-col items-center text-center hidden sm:flex">
    <h1 class="text-xs font-bold tracking-widest text-white/80 fuente-magma">In Collab with:</h1>
    <img src="centrum.png" alt="Logo Centrum" class="h-12 mt-1 md:h-10" />
  </div>

  <!-- PORTADA -->
  <div class="text-center mb-3 sm:mb-4 md:mb-5">
    <a href="https://instagram.com/medinova.cuu" target="_blank" rel="noopener noreferrer">
      <img src="Andromeda.png" alt="Logo Medinova" class="block mx-auto h-auto w-auto max-h-[clamp(9rem,18vw,11rem)] -mb-3 sm:-mb-2 md:-mb-1" />
    </a>
    <!-- <h1 class="text-5xl font-bold tracking-widest text-white fuente-magma">R.I.C.A.R.D.O.</h1>
    <p class="text-base text-white/80 font-medium max-w-2xl mx-auto text-center">
      <strong>R</strong>egistro <strong>I</strong>nteligente de <strong>C</strong>ontrol, <strong>A</strong>lmacenamiento y
      <strong>R</strong>astreo <strong>D</strong>igital de <strong>O</strong>peraciones
    </p> -->
  </div>

  <!-- Modal selecci√≥n modo -->
  <div id="modalModo" class="fixed inset-0 z-50 hidden items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 w-[92%] max-w-sm text-center">
      <h2 class="text-lg font-bold mb-4 text-white/90">Selecciona el modo de operaci√≥n</h2>
      <div class="grid gap-3">
        <button onclick="seleccionarModo('entrada')" class="space-btn w-full">üì• Entrada</button>
        <button onclick="seleccionarModo('salida')" class="w-full rounded-2xl px-4 py-2 font-bold text-white bg-gradient-to-r from-rose-700 to-red-900 border border-red-400/20 shadow-lg hover:opacity-95">
          üì§ Salida
        </button>
      </div>
    </div>
  </div>

  <div id="mensajeQR"></div>

  <!-- Modal movimientos -->
  <div id="modalMovimientos" class="space-modal hidden">
    <div class="space-panel rounded-3xl p-6 w-[92%] max-w-4xl overflow-y-auto">
      <h2 class="text-lg font-bold mb-4 text-center text-white/90">üìã Movimientos del producto</h2>

      <div class="space-card p-4 mb-4">
        <div class="flex flex-col md:flex-row items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <label for="cantidadMovimientos" class="text-sm font-semibold text-white/80">Mostrar:</label>
            <select id="cantidadMovimientos" class="space-input !w-auto !py-2">
              <option value="20">√öltimos 20</option>
              <option value="50" selected>√öltimos 50</option>
              <option value="100">√öltimos 100</option>
              <option value="todos">Todos</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm font-semibold text-white/80" for="selectLote">Lote:</label>
            <select id="selectLote" class="space-input !w-auto !py-2 text-sm" onchange="verMovimientos(filtroReferenciaGlobal)">
              <option value="">Todos</option>
            </select>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm font-semibold text-white/80">Entre:</span>
            <input id="fechaInicio" type="date" class="space-input !w-auto !py-2" title="Fecha de inicio"/>
            <span class="text-sm text-white/70">y</span>
            <input id="fechaFin" type="date" class="space-input !w-auto !py-2" title="Fecha de fin"/>
            <button onclick="verMovimientos(filtroReferenciaGlobal)" class="space-btn !px-3 !py-2 text-sm">üîç Filtrar</button>
          </div>
        </div>
      </div>

      <div id="movimientosContenido" class="max-h-64 overflow-y-auto text-sm text-white/80 space-card p-4"></div>

      <div class="text-center mt-4">
        <button onclick="document.getElementById('modalMovimientos').classList.add('hidden')"
          class="w-full md:w-auto rounded-2xl px-4 py-2 font-bold text-white bg-gradient-to-r from-rose-900 to-red-900 border border-red-400/20 shadow-lg hover:opacity-95">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal cantidad -->
  <div id="modalCantidad" class="fixed inset-0 hidden z-50 items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 w-[92%] max-w-sm">
      <h2 class="text-xl font-bold mb-4 text-white text-center">¬øCu√°ntas piezas desea retirar?</h2>
      <input id="inputCantidadPiezas" type="number" min="1" class="space-input text-center text-lg font-mono" placeholder="Cantidad"/>
      <div class="flex justify-between gap-3 mt-4">
        <button onclick="cerrarModalCantidad()" class="space-btn-ghost w-1/2">Cancelar</button>
        <button onclick="confirmarCantidad()" class="space-btn w-1/2">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Aviso -->
  <div id="modalAviso" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden z-50 max-w-lg w-[92%]">
    <div class="space-panel p-5 text-center">
      <div class="fuente-magma tracking-widest text-xl text-rose-200">AVISO</div>
      <div id="modalAvisoTexto" class="mt-2 text-white/85"></div>
    </div>
  </div>

  <div id="overlayColor" class="fixed inset-0 z-40 hidden transition-opacity"></div>

  <!-- Modal inventario -->
  <div id="modalInventario" class="hidden fixed inset-0 z-50 items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 max-w-md w-[92%] text-center border border-rose-400/25">
      <h2 class="text-xl font-bold mb-4 text-rose-200">‚ö†Ô∏è ¬°CUIDADO!</h2>
      <p class="mb-6 leading-relaxed text-white/85">
        Al enviar los datos a Supabase esto<br>
        <strong class="block text-lg mt-1 text-white">REEMPLAZAR√Å LA BASE DE DATOS ACTUAL</strong><br>
        esta acci√≥n<br>
        <strong class="block text-lg text-white">NO SE PUEDE DESHACER</strong>
      </p>
      <div class="flex justify-center gap-3">
        <button onclick="document.getElementById('modalInventario').classList.add('hidden')" class="space-btn-ghost px-4 py-2">Cancelar</button>
        <button onclick="enviarModoInventario()" class="rounded-2xl px-4 py-2 font-bold text-white bg-gradient-to-r from-rose-900 to-red-900 border border-red-400/20 shadow-lg hover:opacity-95">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal PIN + unidad -->
  <div id="modalPinUnidad" class="fixed inset-0 z-50 hidden items-center justify-center p-4 space-modal-backdrop">
    <div class="space-panel rounded-3xl p-6 w-[92%] max-w-md relative space-y-4 max-h-[92dvh] overflow-y-auto">
      <button type="button" onclick="cerrarModalPin()" class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-600" aria-label="Cerrar">√ó</button>
      <h2 class="text-lg font-bold text-center text-white/90">Acceso requerido</h2>

      <div>
        <label for="inputNIP" class="block text-sm font-semibold mb-1 text-white/80">NIP:</label>
        <input id="inputNIP" type="password" maxlength="4" inputmode="numeric" autocomplete="one-time-code" title="Ingresa tu NIP" class="space-input"/>
      </div>

      <div id="unidadDestinoGroup" class="hidden">
        <label for="inputUnidad" class="block text-sm font-semibold mb-1 text-white/80">Clave unidad destino:</label>
        <input id="inputUnidad" type="text" placeholder="Ej: C03128" title="Clave unidad destino" autocomplete="off" class="space-input uppercase"/>
      </div>

      <div id="remisionGroup" class="hidden">
        <label for="inputRemision" class="block text-sm font-semibold mb-1 text-white/80">No. de remisi√≥n:</label>
        <input id="inputRemision" type="text" placeholder="Ej: 465131" title="N√∫mero de remisi√≥n" autocomplete="off" class="space-input uppercase"/>
      </div>

      <div id="bloqueCargaRemision" class="hidden space-y-2">
        <label for="inputArchivoRemision" class="block text-sm font-semibold mb-1 text-white/80">Cargar archivo remisi√≥n SAP:</label>
        <div class="space-file-wrap">
          <input type="file" id="inputArchivoRemision" class="space-file-input" accept=".xlsx"/>
          <label for="inputArchivoRemision" class="space-btn px-5 py-3 text-center">Elegir archivo</label>
        </div>
        <div class="flex justify-center">
          <button id="btnSubirRemision" type="button" class="space-btn px-6 py-3 text-base">üì§ Cargar archivo SAP</button>
        </div>
        <div id="resultadoCargaArchivo" class="text-center font-semibold text-sm text-white/80"></div>
      </div>

      <div id="pinError" class="text-sm text-rose-200 hidden">‚ùå NIP o unidad no v√°lidos.</div>

      <div class="flex flex-col gap-2 mt-4">
        <div class="flex justify-end gap-2">
          <button type="button" onclick="cerrarModalPin()" class="space-btn-ghost px-4 py-2">Cancelar</button>
          <button type="button" onclick="validarPinYUnidad()" class="space-btn px-4 py-2">Confirmar</button>
        </div>
        <button type="button" onclick="mostrarCambioNIP()" class="text-sm text-teal-200 underline hover:text-teal-100 text-center mt-2">üîë Cambiar NIP</button>
      </div>

      <div class="h-[env(safe-area-inset-bottom)]"></div>
    </div>
  </div>

  <!-- Modal caducidad -->
  <div id="modalCaducidad" class="fixed inset-0 hidden z-[900] items-center justify-center space-modal-backdrop">
    <div class="space-panel w-[95%] max-w-5xl relative max-h-[80vh] overflow-y-auto p-6">
      <button onclick="cerrarModalCaducidad()" class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-600">√ó</button>
      <h2 class="text-xl font-bold mb-4 text-white/90">‚ö†Ô∏è Productos por caducar</h2>
      <div id="contenidoCaducidad" class="text-sm mb-4 text-white/80"></div>
    </div>
  </div>

  <!-- Modal QC Command (Supervisor de Calidad) -->
  <div id="modalQC" class="fixed inset-0 hidden z-[950] items-center justify-center space-modal-backdrop">
    <div class="space-panel w-[97%] max-w-6xl relative max-h-[92vh] overflow-y-auto p-6">
      <button onclick="cerrarModalQC()" class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-600">√ó</button>

      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <div class="fuente-magma tracking-widest text-2xl text-white/90">üõ∞Ô∏è QC COMMAND</div>
          <div class="text-xs text-white/60 mt-1">Dashboard operativo para IQC / EQC ‚Ä¢ stock ‚Ä¢ caducidad ‚Ä¢ cobertura ‚Ä¢ compra sugerida</div>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
          <button onclick="qc_refrescarDashboard()" class="space-btn px-4 py-2">üîÑ Refrescar</button>
          <button onclick="qc_exportarCSV()" class="space-btn-ghost px-4 py-2">‚¨áÔ∏è Exportar CSV</button>
        </div>
      </div>

      <!-- Filtros -->
      <div class="mt-4 space-card p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3">

          <div>
            <label class="block text-xs font-semibold text-white/70 mb-1">Tipo</label>
            <select id="qcTipo" class="space-input !py-2">
              <option value="ALL" selected>IQC + EQC</option>
              <option value="IQC">IQC (Interno)</option>
              <option value="EQC">EQC (Externo)</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-white/70 mb-1">Almac√©n / Representaci√≥n</label>
            <select id="qcAlmacen" class="space-input !py-2">
              <option value="ALL" selected>Todos</option>
              <option value="CUU">Almac√©n Chihuahua (CUU)</option>
              <option value="65">Almac√©n Ju√°rez (65)</option>
              <option value="66">Almac√©n Parral (66)</option>
              <option value="BCS">Baja California Sur (BCS)</option>
              <option value="DUR">Durango (DUR)</option>
              <option value="NAY">Nayarit (NAY)</option>
              <option value="SIN">Sinaloa (SIN)</option>
              <option value="TAM">Tamaulipas (TAM)</option>
              <option value="COA">Coahuila (COA)</option>
              <option value="CHP">Chiapas (CHP)</option>
              <option value="OAX">Oaxaca (OAX)</option>
              <option value="TAB">Tabasco (TAB)</option>
              <option value="CAM">Campeche (CAM)</option>
              <option value="QROO">Quintana Roo (QROO)</option>
              <option value="GRO">Guerrero (GRO)</option>
              <option value="EDOMEX">Edo. de M√©xico (EDOMEX)</option>
              <option value="HGO">Hidalgo (HGO)</option>
            </select>
          </div>

          <div class="lg:col-span-2">
            <label class="block text-xs font-semibold text-white/70 mb-1">Unidad m√©dica</label>
            <select id="qcUnidad" class="space-input !py-2">
              <option value="ALL" selected>Todas</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-white/70 mb-1">Rango (inicio)</label>
            <input id="qcDesde" type="date" class="space-input !py-2" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-white/70 mb-1">Rango (fin)</label>
            <input id="qcHasta" type="date" class="space-input !py-2" />
          </div>

        </div>

        <div class="mt-3 flex flex-wrap gap-2 items-center justify-between">
          <div class="flex flex-wrap gap-2">
            <label class="inline-flex items-center gap-2 text-xs text-white/70">
              <input id="qcSoloCriticos" type="checkbox" class="accent-teal-400" />
              S√≥lo cr√≠ticos (caducidad/cobertura)
            </label>
            <label class="inline-flex items-center gap-2 text-xs text-white/70">
              <input id="qcIncluirCentral" type="checkbox" class="accent-teal-400" checked />
              Incluir central
            </label>
          </div>
          <button onclick="qc_refrescarDashboard()" class="space-btn !px-4 !py-2 text-sm">Aplicar</button>
        </div>
      </div>

      <!-- KPIs -->
      <div id="qcKPIs" class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-3"></div>
      <!-- =========================
          SOL LOG√çSTICO (Nacional + Drilldown)
      ========================= -->
      <div class="space-card p-4 mt-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div class="text-sm font-bold text-white/85">‚òÄÔ∏è Sol Nacional</div>
            <div id="solSubtitulo" class="text-xs text-white/55">Vista por representaci√≥n</div>
          </div>

          <!-- Toggle m√©trica -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-white/60">M√©trica:</span>
            <div class="flex rounded-2xl border border-white/10 overflow-hidden bg-white/5">
              <button id="btnMetricStock" class="px-3 py-2 text-xs font-semibold">Stock</button>
              <button id="btnMetricValor" class="px-3 py-2 text-xs font-semibold opacity-60">Valor</button>
            </div>
          </div>
        </div>

        <!-- SVG Nacional -->
        <div class="mt-3">
          <svg id="solNacional" viewBox="0 0 900 900" class="w-full h-auto"></svg>
        </div>

        <!-- Drilldown -->
        <div id="solDrillWrap" class="mt-4 hidden">
          <div class="flex items-center justify-between">
            <div>
              <div id="solDrillTitle" class="text-sm font-bold text-white/85">üè• Unidades</div>
              <div id="solDrillHint" class="text-xs text-white/55">Click en una unidad para ver detalle (opcional)</div>
            </div>
            <button id="btnCerrarDrill" class="space-btn-ghost px-3 py-2 text-xs">Cerrar</button>
          </div>

          <div class="mt-3">
            <svg id="solDrill" viewBox="0 0 900 900" class="w-full h-auto"></svg>
          </div>
        </div>

        <div class="mt-3 text-[11px] text-white/55 font-mono whitespace-pre-wrap" id="solLogs"></div>
      </div>
      <!-- Charts -->
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="space-card p-4">
          <div class="text-sm font-bold text-white/85 mb-2">Consumo mensual</div>
          <div class="h-[240px]"><canvas id="qcChartConsumo"></canvas></div>
        </div>
        <div class="space-card p-4">
          <div class="text-sm font-bold text-white/85 mb-2">Cobertura (d√≠as) por almac√©n</div>
          <div class="h-[240px]"><canvas id="qcChartCobertura"></canvas></div>
        </div>
        <div class="space-card p-4">
          <div class="text-sm font-bold text-white/85 mb-2">Caducidades (ventanas)</div>
          <div class="h-[240px]"><canvas id="qcChartCaducidad"></canvas></div>
        </div>
      </div>

      <!-- Tablas -->
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div class="space-card p-4">
          <div class="flex items-center justify-between gap-2 mb-2">
            <div class="text-sm font-bold text-white/85">Cr√≠ticos QC</div>
            <div class="text-xs text-white/55">caducidad < 30d ‚Ä¢ cobertura baja</div>
          </div>
          <div id="qcTablaCriticos" class="cadu-table-wrap"></div>
        </div>
        <div class="space-card p-4">
          <div class="flex items-center justify-between gap-2 mb-2">
            <div class="text-sm font-bold text-white/85">Compra sugerida</div>
            <div class="text-xs text-white/55">(consumo + buffer) ‚àí stock</div>
          </div>
          <div id="qcTablaCompra" class="cadu-table-wrap"></div>
        </div>
      </div>

      <div class="mt-4 text-xs text-white/60 space-card p-3">
        <div class="font-mono whitespace-pre-wrap" id="qcLogs"></div>
      </div>

      <div class="h-[env(safe-area-inset-bottom)]"></div>
    </div>
  </div>

  <!-- Modal cambio NIP -->
  <div id="modalCambioNIP" class="fixed inset-0 z-50 hidden items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 w-[92%] max-w-md space-y-4">
      <h2 class="text-lg font-bold text-center text-white/90">Cambiar NIP</h2>
      <div>
        <label for="nipAntiguo" class="block text-sm font-semibold mb-1 text-white/80">NIP actual:</label>
        <input id="nipAntiguo" type="password" maxlength="4" class="space-input" />
      </div>
      <div>
        <label for="nipNuevo" class="block text-sm font-semibold mb-1 text-white/80">NIP nuevo:</label>
        <input id="nipNuevo" type="password" maxlength="4" class="space-input" />
      </div>
      <div>
        <label for="nipConfirmar" class="block text-sm font-semibold mb-1 text-white/80">Confirmar nuevo NIP:</label>
        <input id="nipConfirmar" type="password" maxlength="4" class="space-input" />
      </div>

      <div id="cambioNipError" class="text-sm text-rose-200 hidden">‚ùå Error en los datos ingresados.</div>

      <div class="flex justify-end gap-2 mt-2">
        <button onclick="cerrarCambioNIP()" class="space-btn-ghost px-4 py-2">Cancelar</button>
        <button onclick="guardarNuevoNIP()" class="space-btn px-4 py-2">Guardar</button>
      </div>
    </div>
  </div>

  <!-- CONTENEDOR PRINCIPAL -->
  <div class="w-full max-w-2xl mt-2 sm:mt-3 md:mt-4">
    <div class="space-panel rounded-[28px] p-6 md:p-7 shadow-2xl pt-5">

      <div class="flex flex-wrap justify-center gap-3 mt-2">
        <button onclick="solicitarNIP()" class="space-btn px-5 py-3 rounded-2xl btn-wrap">
          üìù <span class="btn-text">Inventario/<wbr>Pruebas facturadas</span>
        </button>
        <button onclick="abrirModalReporteMensual()" class="space-btn px-5 py-3 rounded-2xl btn-wrap">
          üìä <span class="btn-text">Generar <wbr>reporte</span>
        </button>
      </div>

      <div class="mt-6">
        <label for="refBusqueda" class="sr-only">Buscar por referencia</label>
        <input type="text" id="refBusqueda" placeholder="Buscar por referencia..." class="space-input w-full text-center" oninput="buscarReferencia(this.value)" autocomplete="off"/>
        <div id="resultadoBusqueda" class="text-sm text-white/80 mt-3"></div>
      </div>

      <div id="estadoUsuario" onclick="mostrarMenuModo()" class="mt-4 cursor-pointer space-card p-4 rounded-2xl hover:bg-white/10 transition" role="button" tabindex="0">
        <div class="text-base flex items-center justify-center gap-2">
          <span id="usuarioActivo" class="text-lg font-extrabold ml-2 text-white/90">Selecciona un modo para iniciar</span>
        </div>
        <div class="mt-2 text-center">
          <span id="modoLabel" class="inline-block font-bold px-3 py-1 rounded-2xl text-white bg-white/10 border border-white/10 text-sm">INACTIVO</span>
        </div>
      </div>

      <div id="contenedorQR" class="relative w-full mb-4 hidden mt-4">
        <label for="inputQR" class="sr-only">Escanea el c√≥digo QR</label>
        <input type="text" id="inputQR" placeholder="Escanea el c√≥digo QR" class="space-input w-full text-center pr-12" autocomplete="off"/>
        <button type="button" onclick="abrirModalQR()" aria-label="Escanear QR con c√°mara" class="absolute right-2 top-1/2 -translate-y-1/2 rounded-full p-2 text-2xl bg-white/5 hover:bg-white/10 border border-white/10 transition">üì∑</button>
      </div>

      <div id="tablaRemisionSAP" class="hidden mt-6">
        <div class="flex justify-between items-center mb-3">
          <h2 class="font-bold text-sm text-white/90">üßæ Avance remisi√≥n SAP:</h2>
          <button id="btnToggleFilasValidadas" class="text-sm text-teal-200 hover:text-teal-100 underline">Ocultar validados</button>
        </div>

        <div class="space-card rounded-2xl overflow-hidden border border-white/10">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-white/5 text-center text-white/80">
                <th class="p-2">Referencia</th>
                <th class="p-2">Descripci√≥n</th>
                <th class="p-2">Lote</th>
                <th class="p-2">Escaneados</th>
              </tr>
            </thead>
            <tbody id="bodyRemisionSAP" class="text-white/85"></tbody>
          </table>
        </div>
      </div>

      <div class="text-center mt-6 space-y-3">
        <button id="btnAlertasCaducidad" class="w-full md:w-auto rounded-2xl px-5 py-3 font-semibold bg-gradient-to-r from-amber-900/60 to-yellow-900/50 border border-amber-300/20 shadow-lg hover:opacity-95">
          ‚ö†Ô∏è Ver productos pr√≥ximos a caducar
        </button>

        <div class="flex justify-center">
          <button id="btnQC" type="button" onclick="abrirModalQC()" class="w-full md:w-auto rounded-2xl px-5 py-3 font-semibold bg-gradient-to-r from-sky-900/60 to-teal-900/60 border border-teal-300/20 shadow-lg hover:opacity-95">
            üõ∞Ô∏è QC Command
          </button>
        </div>

        <div class="flex justify-center">
          <button type="button" onclick="abrirModalHipotesis()" class="space-btn px-5 py-3 rounded-2xl">
            üß™ Laboratorio de Hip√≥tesis
          </button>
        </div>
      </div>

      <div id="resumenEscaneos" class="hidden mt-6 space-card p-3 rounded-2xl text-sm text-white/85"></div>

      <div id="tablaContenedora" class="hidden opacity-0 transition-opacity duration-300 mt-4">
        <div class="space-card rounded-2xl overflow-hidden border border-white/10">
          <table class="min-w-full text-sm text-left" id="tablaRegistros">
            <thead>
              <tr class="bg-white/5 text-white/80">
                <th class="p-2">Referencia</th>
                <th class="p-2">Lote</th>
                <th class="p-2">Estado</th>
                <th class="p-2 text-center">Eliminar</th>
              </tr>
            </thead>
            <tbody id="tablaRegistrosBody"></tbody>
          </table>
        </div>
      </div>

      <button id="btnEnviarSupabase2" onclick="enviarSupabase()" class="hidden mt-4 w-full bg-teal-900 text-white py-2 rounded-2xl">
        Enviar a Base de Datos
      </button>

    </div>
  </div>

  <!-- BOT√ìN CERRAR SESI√ìN -->
  <button id="btnCerrarSesion" onclick="cerrarSesion()"
    class="hidden fixed bottom-4 left-4 z-50 rounded-2xl px-4 py-2 text-sm font-semibold bg-white/10 border border-white/15 shadow-lg hover:bg-white/15 transition">
    üîí Cerrar sesi√≥n
  </button>

  <!-- BOT√ìN OPCIONES USUARIO -->
  <button onclick="mostrarOpcionesAdmin()"
    class=" bottom-4 right-4 z-50 rounded-full px-4 py-3 text-sm font-semibold bg-white/10 border border-white/15 shadow-lg hover:bg-white/15 transition">
    ‚öôÔ∏è Opciones de usuario
  </button>

  <!-- MODAL REPORTE MENSUAL -->
  <div id="modalReporteMensual" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 space-modal-backdrop">
    <div class="space-panel rounded-3xl p-6 w-[92%] max-w-md relative">
      <button onclick="cerrarModalReporteMensual()" class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-700">√ó</button>
      <h2 class="text-xl font-bold text-center mb-6 text-white/90">üìä Generar reporte mensual</h2>

      <div class="mb-6">
        <div class="flex gap-2">
          <div class="flex-1">
            <label for="inputMesMes" class="block text-sm font-semibold mb-1 text-white/80">Mes</label>
            <select id="inputMesMes" class="space-input w-full !py-2 text-base">
              <option value="">Mes</option>
              <option value="01">Enero</option><option value="02">Febrero</option><option value="03">Marzo</option>
              <option value="04">Abril</option><option value="05">Mayo</option><option value="06">Junio</option>
              <option value="07">Julio</option><option value="08">Agosto</option><option value="09">Septiembre</option>
              <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
            </select>
          </div>

          <div class="w-28">
            <label for="inputMesAnio" class="block text-sm font-semibold mb-1 text-white/80">A√±o</label>
            <select id="inputMesAnio" class="space-input w-full !py-2 text-base"></select>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button onclick="cerrarModalReporteMensual()" class="space-btn-ghost px-4 py-2 rounded-2xl">Cancelar</button>
        <button onclick="generarReporteMensual()" class="space-btn px-4 py-2 rounded-2xl">Generar Excel</button>
      </div>
    </div>
  </div>

  <!-- MODAL OPCIONES ADMIN -->
  <div id="modalOpcionesAdmin" class="fixed inset-0 z-50 hidden flex items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 rounded-3xl w-[92%] max-w-md space-y-4">
      <h2 class="text-lg font-bold text-center text-white/90">‚öôÔ∏è Opciones de Usuario</h2>
      <div class="flex flex-col space-y-3">
        <button onclick="cerrarModalOpcionesAdmin(); mostrarCambioNIP()" class="space-btn w-full py-3 rounded-2xl">üîë Cambiar NIP</button>

        <button id="btnModificarUnidades" onclick="cerrarModalOpcionesAdmin(); mostrarModalAsignarUnidades()" class="space-btn w-full py-3 rounded-2xl hidden">
          üè• Modificar Unidades
        </button>

        <button id="btnRestablecerNIP" onclick="restablecerNIPUsuario()" class="w-full rounded-2xl py-3 font-semibold text-white bg-gradient-to-r from-rose-900 to-red-900 border border-red-400/20 shadow-lg hover:opacity-95 hidden">
          üîÅ Restablecer NIP de Usuario
        </button>

        <button id="btnBloqueoRemision" onclick="cargarEstadoBloqueo()" class="w-full rounded-2xl py-3 font-semibold text-white bg-gradient-to-r from-purple-900 to-indigo-900 border border-white/10 shadow-lg hover:opacity-95 hidden">
          üîí Cargar estado de bloqueo
        </button>

        <button id="btnVerPinDinamico" onclick="abrirModalPinDinamico()" class="w-full rounded-2xl py-3 font-semibold text-white bg-gradient-to-r from-pink-900 to-rose-900 border border-white/10 shadow-lg hover:opacity-95 hidden">
          üìü Ver PIN Din√°mico
        </button>
      </div>

      <div class="text-center mt-5">
        <button onclick="cerrarModalOpcionesAdmin()" class="space-btn-ghost w-full py-3 rounded-2xl">‚ùå Cerrar</button>
      </div>
    </div>
  </div>

  <!-- MODAL PIN DIN√ÅMICO -->
  <div id="modalPinDinamico" class="fixed inset-0 z-50 hidden items-center justify-center space-modal-backdrop">
    <div class="space-panel rounded-3xl p-6 max-w-sm w-[92%] text-center">
      <h2 class="text-xl font-bold mb-4 text-white/90">üìü PIN Din√°mico</h2>
      <p class="text-sm text-white/70 mb-2">V√°lido por:</p>
      <div id="contadorPin" class="text-lg font-semibold text-teal-200 mb-4">--:--</div>
      <p class="text-sm text-white/70">PIN actual:</p>
      <div id="valorPinDinamicoSolo" class="text-4xl font-mono text-emerald-200 my-2 tracking-widest">------</div>
      <button onclick="cerrarModalPinDinamico()" class="space-btn-ghost w-full py-2 rounded-2xl mt-4">Cerrar</button>
    </div>
  </div>

  <!-- MODAL PIN EXCESO -->
  <div id="modalPINExceso" class="hidden fixed inset-0 z-[9990] items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 rounded-3xl w-[92%] max-w-[380px] text-sm">
      <div id="contenidoPINExceso" class="space-y-3 text-white/85"></div>

      <div class="mt-4">
        <label for="nipdinamico" class="block text-sm font-semibold mb-1 text-white/80">NIP de autorizaci√≥n:</label>
        <input id="nipdinamico" name="pin_temporal" type="text" inputmode="text" pattern="[0-9A-Fa-f]{6}" maxlength="6" minlength="6" autocomplete="off"
          class="space-input text-center font-mono text-xl tracking-widest" placeholder="######" />
        <p id="pinErrorExceso" class="text-rose-200 text-xs mt-2 hidden">‚ùå PIN incorrecto</p>
      </div>

      <div class="flex justify-between gap-3 mt-5">
        <button id="btnCancelarPIN" class="space-btn-ghost w-1/2 py-2 rounded-2xl">Cancelar</button>
        <button id="btnConfirmarPin" class="space-btn w-1/2 py-2 rounded-2xl">Confirmar PIN</button>
      </div>
    </div>
  </div>

  <!-- NOTIFICACI√ìN -->
  <div id="notificacion" class="modal text-center font-bold"></div>

  <!-- MODAL ASIGNAR UNIDADES -->
  <div id="modalAsignarUnidades" class="fixed inset-0 z-50 hidden items-center justify-center space-modal-backdrop">
    <div class="space-panel rounded-3xl p-6 w-[92%] max-w-xl shadow-2xl">
      <h2 class="text-lg font-bold text-center mb-4 text-white/90">üè• Asignar unidades a usuario</h2>

      <label for="selectUsuario" class="block text-sm font-semibold mb-2 text-white/80">Selecciona un usuario:</label>
      <select id="selectUsuario" class="space-input w-full mb-4"></select>

      <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto mb-4" id="listaUnidades"></div>

      <div id="unidadAsignarError" class="text-sm text-rose-200 hidden mb-2">‚ùå Error al guardar unidades.</div>

      <div class="flex justify-end gap-2">
        <button onclick="cerrarModalAsignarUnidades()" class="space-btn-ghost px-4 py-2 rounded-2xl">Cancelar</button>
        <button onclick="guardarUnidadesAsignadas()" class="space-btn px-4 py-2 rounded-2xl">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL NIP -->
  <div id="modalNIP" class="space-modal hidden">
    <div class="space-modal__panel">
      <div class="space-modal__header flex items-center justify-between">
        <h2 class="text-lg font-bold">üîê Ingresa tu NIP</h2>
        <button onclick="cerrarModalNIP()" class="text-red-900 hover:text-red-700 text-2xl font-bold">√ó</button>
      </div>

      <div class="space-modal__body">
        <label for="nipInput" class="sr-only">NIP</label>
        <input id="nipInput" type="password" placeholder="NIP" class="space-input w-full mb-3"
          onkeydown="if(event.key==='Enter'){ validarNIP(); }" />
        <button onclick="validarNIP()" class="space-btn w-full py-3 rounded-2xl">Ingresar</button>
        <p id="nipError" class="text-red-900 text-sm mt-2 hidden">‚ùå NIP inv√°lido.</p>
      </div>
    </div>
  </div>

  <!-- MODAL CAPTURA -->
  <!-- ================= MODAL CAPTURA (COMPLETO) ================= -->
<div id="modalCaptura" class="fixed inset-0 hidden z-50 items-center justify-center blur-fondo">
  <div class="space-panel rounded-3xl p-6 w-[95%] max-w-6xl max-h-[95vh] overflow-auto shadow-2xl">

    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-white/90">üìã Captura de Inventario / Pruebas Facturadas</h2>
      <button onclick="cerrarModalCaptura()"
        class="text-red-900 font-bold text-2xl hover:text-red-600" aria-label="Cerrar">√ó</button>
    </div>

    <!-- GRID PRINCIPAL -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mt-4 w-full">

      <!-- Modo -->
      <div class="w-full space-card p-4 rounded-2xl border border-white/10 bg-white/5">
        <label class="block font-semibold mb-2 text-white/80">Modo:</label>

        <div class="flex items-center justify-between gap-2">
          <span id="modoTexto" class="font-bold text-sm text-emerald-200">üü¢ Inventario</span>

          <label for="modoToggle" class="inline-flex items-center cursor-pointer" title="Modo captura">
            <input type="checkbox" id="modoToggle" class="sr-only peer"
                   onchange="actualizarModoCaptura()" aria-label="Cambiar modo de captura"/>
            <div class="w-14 h-7 bg-emerald-900/80 rounded-full peer-checked:bg-rose-900/80 relative transition border border-white/10">
              <div class="w-6 h-6 bg-white rounded-full absolute top-0.5 left-0.5 peer-checked:translate-x-full transition-transform"></div>
            </div>
          </label>

          <input type="hidden" id="modoCaptura" value="inventario">
        </div>
      </div>

      <!-- Unidad -->
      <div class="w-full">
        <label for="unidadCaptura" class="block font-semibold mb-1 text-white/80">Unidad asignada:</label>
        <select id="unidadCaptura"
                class="space-input w-full"
                onchange="mostrarReferenciasUnidad()">
        </select>
      </div>

      <!-- Referencia -->
      <div class="w-full relative">
        <label for="inputReferencia" class="block font-semibold mb-1 text-white/80">Referencia:</label>

        <div class="flex gap-2">
          <input id="inputReferencia"
                 class="space-input w-full"
                 placeholder="Ej. 368171 o MD-VE-C22"
                 oninput="buscarReferenciaCaptura()"
                 onkeydown="if(event.key==='Enter'){ agregarFilaCaptura?.(); }"
                 autocomplete="off"/>

          <button type="button" id="btnQrInventario"
                  onclick="abrirModalQRInventario?.()"
                  class="inline-flex items-center justify-center px-3 py-2 rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition text-xl"
                  title="Escanear etiqueta con c√°mara (modo inventario)"
                  aria-label="Escanear con c√°mara">
            üì∑
          </button>
        </div>

        <div id="sugerenciasReferencia"
             class="absolute z-50 mt-2 w-full hidden rounded-2xl border border-white/10 bg-black/70 backdrop-blur-xl shadow-2xl overflow-hidden">
        </div>
      </div>

      <!-- Cantidad -->
      <div class="w-full">
        <label for="inputCantidad" class="block font-semibold mb-1 text-white/80">Cantidad:</label>
        <input
          id="inputCantidad"
          type="number"
          step="0.1"
          min="0"
          max="999.9"
          inputmode="decimal"
          class="cantidad-input input-cantidad"
          placeholder="0.0"
          onkeydown="if(event.key==='Enter'){ agregarFilaCaptura(); }"
        />
      </div>

      <!-- Bot√≥n agregar -->
      <div class="w-full flex items-end">
        <button id="btnAgregarCaptura"
                onclick="agregarFilaCaptura?.()"
                class="space-btn w-full py-3 rounded-2xl">
          Agregar
        </button>
      </div>
    </div>

    <!-- FILA CONFIG -->
    <div class="flex flex-wrap md:flex-nowrap items-center justify-between mt-5 w-full gap-4">

      <div class="flex items-center gap-2 flex-shrink-0">
        <input type="checkbox" onchange="toggleFilasCompletadas?.(this.checked)"
               id="checkboxFilas" class="accent-teal-500" />
        <label for="checkboxFilas" class="text-sm text-white/80">Ocultar filas completadas</label>
      </div>

      <div class="flex items-center gap-2 flex-wrap md:flex-nowrap flex-grow justify-start">
        <div class="min-w-[120px]">
          <label for="mesCaptura" class="text-sm font-semibold text-white/80">Mes:</label>
          <select id="mesCaptura" name="mesCaptura" title="Mes de captura"
                  class="space-input w-full !py-2 text-sm"></select>
        </div>
        <div class="min-w-[120px]">
          <label for="anioCaptura" class="text-sm font-semibold text-white/80">A√±o:</label>
          <select id="anioCaptura" name="anioCaptura" title="A√±o de captura"
                  class="space-input w-full !py-2 text-sm"></select>
        </div>
      </div>

      <div class="min-w-[220px]">
        <label class="text-sm font-semibold text-white/80 text-center block">üìÑ Precargar archivo:</label>

        <div class="mt-1 flex items-center gap-2">
          <input type="file" id="archivoCaptura"
                 accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
                 class="hidden"
                 onchange="precargarArchivoCaptura()" />
          <label for="archivoCaptura" class="space-btn px-4 py-2 rounded-2xl cursor-pointer">Elegir archivo</label>
          <span id="archivoCapturaNombre" class="text-xs text-white/70 truncate max-w-[180px]">Ning√∫n archivo</span>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-shrink-0">
        <label for="toggleTipoCaptura" class="text-sm font-semibold text-white/80">Tipo:</label>
        <div class="flex items-center gap-2">
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="toggleTipoCaptura" class="sr-only" onchange="actualizarTextoTipoCaptura?.()">
            <div id="fondoToggleTipo" class="w-14 h-7 bg-white/10 rounded-full transition-colors duration-300 border border-white/10"></div>
            <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-transform duration-300" id="circuloToggleTipo"></div>
          </label>
          <span id="textoTipoCaptura" class="text-sm font-semibold text-white/80">Inicial</span>
        </div>
      </div>

      <div class="flex-shrink-0">
        <button id="btnEnviarCaptura"
                onclick="enviarCapturaBase?.()"
                class="space-btn px-5 py-3 rounded-2xl whitespace-nowrap">
          üì§ Enviar
        </button>
      </div>
    </div>

    <!-- TABLA CAPTURA -->
    <div id="contenedorTabla" class="overflow-x-auto max-h-[75vh] overflow-y-auto hidden mt-5">
      <div class="space-card rounded-2xl overflow-hidden border border-white/10">
        <table class="w-full text-sm text-left" id="tablaCaptura">
          <thead id="tablaEncabezado" class="bg-white/5 text-white/80">
            <tr class="text-left">
              <th class="w-14 p-2">Cantidad</th>
              <th class="p-2">Nombre</th>
              <th class="w-32 p-2">Referencia</th>
              <th class="w-16 p-2">Eliminar</th>
            </tr>
          </thead>
          <tbody class="text-white/85"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>
<!-- ================= FIN MODAL CAPTURA ================= -->

  <!-- ================= MODAL LABORATORIO DE HIP√ìTESIS ================= -->
  <div id="modalHipotesis" class="space-modal hidden">
    <div class="space-modal__panel w-[96%] max-w-5xl rounded-3xl text-white shadow-2xl max-h-[92dvh] overflow-hidden border border-white/10">
      <div class="flex items-start justify-between gap-4 p-5 border-b border-white/10">
        <div class="min-w-0">
          <h2 class="text-2xl font-bold fuente-magma tracking-wider">Laboratorio de Hip√≥tesis</h2>
          <p class="text-sm text-white/70 mt-1 break-words">Pregunta libre ‚Üí IA / Plan cient√≠fico ‚Üí evidencia + conclusi√≥n auditable.</p>
        </div>

        <button type="button" onclick="cerrarModalHipotesis()"
          class="shrink-0 w-10 h-10 grid place-items-center rounded-2xl bg-white/5 border border-white/10 text-red-900 hover:text-red-700 text-2xl font-bold"
          aria-label="Cerrar">√ó</button>
      </div>

      <div class="p-5 overflow-y-auto max-h-[calc(92dvh-84px)]">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <label class="text-sm font-semibold text-white/80">Pregunta / hip√≥tesis</label>

            <textarea id="hipotesisPregunta"
              class="mt-2 w-full min-h-[140px] p-3 rounded-2xl bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500"
              placeholder="Ej: En invierno se incrementan las pruebas efectivas en C03128 vs resto del a√±o."></textarea>

            <div class="mt-3 flex gap-2">
              <button type="button" onclick="ejecutarPreguntaLibreIA()"
                class="flex-1 px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/15 border border-white/10 font-semibold">üí¨ Preguntar</button>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4">
              <div>
                <label class="text-xs text-white/70" for="hipotesisLab">Unidad (opcional)</label>
                <input id="hipotesisLab" class="mt-1 w-full p-2 rounded-xl bg-black/30 border border-white/10" placeholder="C03128" />
              </div>
              <div>
                <label class="text-xs text-white/70" for="hipotesisRef">Referencia (opcional)</label>
                <input id="hipotesisRef" class="mt-1 w-full p-2 rounded-xl bg-black/30 border border-white/10" placeholder="GLU-001" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <label for="hipotesisDesde" class="text-xs text-white/70">Desde</label>
                <input id="hipotesisDesde" type="date" class="mt-1 w-full p-2 rounded-xl bg-black/30 border border-white/10" />
              </div>
              <div>
                <label for="hipotesisHasta" class="text-xs text-white/70">Hasta</label>
                <input id="hipotesisHasta" type="date" class="mt-1 w-full p-2 rounded-xl bg-black/30 border border-white/10" />
              </div>
            </div>

            <div class="flex items-center justify-between mt-4">
              <label class="text-xs text-white/70 flex items-center gap-2">
                <input id="hipotesisDemo" type="checkbox" class="accent-teal-500">
                Modo demo
              </label>
              <div id="hipotesisStatus" class="text-xs text-white/70"></div>
            </div>
          </div>

          <div class="lg:col-span-2 rounded-2xl p-4 bg-white/5 border border-white/10">
            <div id="hipotesisSalida" class="space-y-4">
              <div class="text-white/60 text-sm">
                Aqu√≠ se mostrar√° el chat libre o el reporte cient√≠fico (H0/H1, m√©todo, supuestos, etc.).
              </div>
            </div>
          </div>

        </div>

        <div class="h-[env(safe-area-inset-bottom)]"></div>
      </div>
    </div>
  </div>

  <!-- ================= Scripts locales ================= -->
  <script>
//#region constantes
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo";
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo";
const VALIDAR_URL = "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/validar_qr";
const API_URL = "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr";
const SONIDO_BLOQUEADO = "https://github.com/RicardoCentrum/centrum/raw/main/losiento.mp3";
let modo = "entrada";
let qrsPendientes = [];  // lo que se ha validado pero a√∫n no enviado
let estaProcesandoSalida = false;
let filtroReferenciaGlobal = null;
let fraccionesEscaneadas = []; // cada item: { timestamp, cantidad_restante, lote }
let cantidadFaltante = 0;
let referenciasCache = [];
let usuario = null;                 // Se debe asignar al seleccionar usuario
let unidadSeleccionada = null;      // Se asigna desde la selecci√≥n de unidad m√©dica
let modoSeleccionado = null;
let esAdmin = false;
let UNIDAD_DESTINO = null;          // Se usa en modo salida para fraccionados
let REF_GLOBAL = null;
let modoExtraccionFraccionableActivo = false;
let referenciaActual = null;
let loteActual = null;
let ultimoContenidoEscaneado = null;
let datosCaptura = [], usuarioActivo = "", unidadesAsignadas = [], referenciasPorUnidad = [];
let remisionGlobal = null;
let remisionActual = null; // nueva variable global
let remision = null;
let callbackSobrescribir = null;
let remisionActiva = "";
let avanceRemision = {}; // { '10309546||252450': { nombre, lote, escaneados, total } }
let ocultarValidados = false;
let intervaloPin = null;
let intervaloCuentaRegresiva = null;
let scannerActivo = false, qrScanner = null;
let modoScannerQR = "movimientos"; // "movimientos" | "inventario"
let inventarioDetallado = {};
window.autorizacionesExceso = window.autorizacionesExceso || {};
window.FORECAST_DEFAULT_HORIZON = 6;  // üëà Default 6 meses
window.FORECAST_DEFAULT_MERMA_PCT = 10; // üëà Merma default
window.FORECAST_DEFAULT_MODELO = "auto"; // auto | arimax | xgboost | ensemble
const unidadesDestino = {
  "C03442": "C.S. GALEANA", "C03441": "C.S. HIDALGO", "C03438": "C.S. NUEVO CASAS GRANDES", "C03443": "CAAPS ANAPRA", "C03439": "CESSA COLINAS", "C03440": "CESSA ZARAGOZA", "C03435": "H.C. NUEVO CASAS GRANDES", "C03436": "HIE JUAREZ",
  "C03420": "HOSPITAL DE LA MUJER CD JUAREZ", "C03419": "HOSPITAL GENERAL CD JUAREZ", "C03127": "HGZ 6", "C03131": "HGS 22", "C03135": "HGR 02", "C03133": "HGZ UMAA 35", "C03134": "HGR 66", "C03448": "C.S. GUACHOCHI", "C03447": "C.S. JIMENEZ", "C03446": "H. GPE Y CALVO", "C03132": "H.G.Z.M.F. 23", "C03122": "H.R.O. No. 26", "C03124": "H.R.O. No. 36", "C03445": "HOSPITAL CAMARGO", "C03421": "HOSPITAL DE JIMENEZ", "C03422": "HOSPITAL GINECOLOGIA PARRAL", "C03444": "HOSPITAL PARRAL", "C03451": "CESSA ALDAMA", "C03433": "CESSA MADERA",
  "C03415": "HOSPITAL CENTRAL", "C03424": "HG CUAUHTEMOC", "C03416": "HGO CUAUHTEMOC", "C03432": "CESSA TIERRA NUEVA", "C03431": "CS CREEL", "C03428": "CS TEMORIS", "C03123": "HRO No. 18 SAN JUANITO", "C03430": "C.S. DELICIAS", "C03425": "H.C. OJINAGA", "C03417": "H.R. DELICIAS", "C03434": "C.S. SANTA ISABEL", "C03429": "CAAPS NOGALES", "C03427": "C.S. SAN FELIPE", "C03426": "H.C. GOMEZ FARIAS", "C03418": "HIE CHIHUAHUA", "C03423": "H.G. DR. SALVADOR ZUBIRAN", "C03128": "H.G.Z.M.F. 11", "C03130": "H.G.Z.M.F. 16", "C03129": "HGO No. 15", "C03126": "HGR No. 1", "66": "ALMACEN PARRAL", "65": "ALMACEN JUAREZ", "CUU": "ALMACEN CHIHUAHUA"
};
const unidadesFijas = {
  "C03442": "CS Galeana", "C03441": "C.S. HIDALGO", "C03438": "CS Casas Grandes", "C03443": "CAAPS ANAPRA", "C03439": "CESSA Colinas", "C03440": "CESSA Zaragoza", "C03435": "HC Casas Grandes", "C03436": "HIE Cd. Juarez",
  "C03420": "hospital de la mujer", "C03419": "hg cd. juarez", "C03127": "HGZ 6", "C03131": "HGS 22", "C03135": "HGR 02", "C03133": "HGZ UMAA 35", "C03134": "HGR 66", "C03448": "CAAPS Guachochi", "C03447": "CS Jimenez", "C03446": "HC Guadalupe y Calvo", "C03132": "H.G.Z.M.F. 23", "C03122": "H.R.O. No. 26", "C03124": "H.R.O. No. 36", "C03445": "HG Camargo", "C03421": "hr jimenez", "C03422": "Ginecologia Parral", "C03444": "HG Parral", "C03451": "CESSA Aldama", "C03433": "CESSA Madera",
  "C03415": "hospital central", "C03424": "HG Cuauhtemoc", "C03416": "Ginecologia Cuauhtemoc", "C03432": "CESSA Tierra Nueva", "C03431": "CS Creel", "C03428": "CS Temoris", "C03123": "HRO No. 18 SAN JUANITO", "C03430": "CS Delicias", "C03425": "HC Ojinaga", "C03417": "hr delicias", "C03434": "CS Sta. Isabel", "C03429": "CAAPS Nogales", "C03427": "CS San Felipe", "C03426": "HC Gomez Farias", "C03418": "hie chihuahua", "C03423": "HG Chihuahua", "C03128": "H.G.Z.M.F. 11", "C03130": "H.G.Z.M.F. 16", "C03129": "HGO No. 15", "C03126": "HGR No. 1", "66": "ALMACEN PARRAL", "65": "ALMACEN JUAREZ", "CUU": "ALMACEN CHIHUAHUA"
};
const anioSelect = document.getElementById('anioSelect');
const timestampsEscaneadosInventario = new Set();
// ‚úÖ sort s√∫per defensivo para Chart.js v4
const safeLegendSort = (a, b, third) => {
  // Chart.js v4 llama sort(a,b,chart) o sort(a,b,data) seg√∫n contexto,
  // as√≠ que lo detectamos sin asumir nada.
  const chart =
    third?.chart ||               // a veces viene envuelto
    third?.$context?.chart ||     // algunos plugins
    third;                        // a veces es el chart directo

  const ds = chart?.data?.datasets || [];

  const oa = ds?.[a?.datasetIndex]?.order ?? a?.datasetIndex ?? 0;
  const ob = ds?.[b?.datasetIndex]?.order ?? b?.datasetIndex ?? 0;

  return oa - ob;
};
if (anioSelect) {
  const thisYear = new Date().getFullYear();
  anioSelect.innerHTML = '<option value="">A√±o</option>';
  for (let y = thisYear - 2; y <= thisYear + 8; y++) {
    anioSelect.innerHTML += `<option value="${y}">${y}</option>`;
  }
}
//#endregion Constanes==============================================================================================================

//#region funciones auxiliares =====================================================================================================
function mostrarLoader(show=true){const el = document.getElementById("loaderOverlay");if(!el) return;el.classList.toggle("hidden", !show);}
function ocultarLoader(){const o=document.getElementById("loaderOverlay");o&&o.classList.add("hidden");document.body.style.overflow="";window.removeEventListener("keydown",bloquearTeclas,true);window.removeEventListener("mousedown",bloquearClicks,true);}
function bloquearTeclas(e){if(!(e.key==="F5"||e.key==="Escape")){e.stopPropagation();e.preventDefault();}}
function bloquearClicks(e){e.stopPropagation();e.preventDefault();}
function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
function loaderReset(){
  const ticker = document.getElementById("loaderTicker");
  const status = document.getElementById("loaderStatus");

  if (status) {
    status.textContent = "Ejecutando operaci√≥n‚Ä¶";
  }

  if (ticker) {
    ticker.innerHTML = "";
    ticker.classList.add("hidden"); // üëà vuelve a modo cl√°sico
  }
}
function loaderPush(message){
  const ticker = document.getElementById("loaderTicker");
  if(!ticker) return;

  // üî• Primera vez que se usa ‚Üí expandimos loader
  if(ticker.classList.contains("hidden")){
    ticker.classList.remove("hidden");
  }

  const line = document.createElement("div");
  line.textContent = "‚Ä¢ " + message;
  ticker.appendChild(line);

  ticker.scrollTop = ticker.scrollHeight;
}
function loaderSetStatus(text){
  const el = document.getElementById("loaderStatus");
  if(el) el.textContent = text;
}
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
function startLoaderProgress(steps, delayMs = 900){
  let stopped = false;

  (async () => {
    for (const step of steps){
      if (stopped) break;

      // step puede ser string o {status, push}
      if (typeof step === "string") {
        loaderPush(step);
      } else {
        if (step.status) loaderSetStatus(step.status);
        if (step.push) loaderPush(step.push);
      }

      await sleep(delayMs);
    }

    // Si sigue vivo y se acabaron steps, deja un ‚Äúheartbeat‚Äù suave
    let dots = 0;
    while (!stopped) {
      dots = (dots + 1) % 4;
      loaderSetStatus(`üß† Procesando${".".repeat(dots)}`);
      await sleep(700);
    }
  })();

  return () => { stopped = true; };
}
function startLoaderStatusFlow(steps, msStep = 850) {
  // steps: [{text, mode}] mode: "once" | "dots"
  let i = 0;
  let dotsTimer = null;
  let stepTimer = null;
  let cancelled = false;

  const stopDots = () => {
    if (dotsTimer) clearInterval(dotsTimer);
    dotsTimer = null;
  };

  const setDots = (base) => {
    stopDots();
    let k = 0;
    loaderSetStatus(base);
    dotsTimer = setInterval(() => {
      if (cancelled) return;
      k = (k + 1) % 4; // "", ".", "..", "..."
      loaderSetStatus(base + ".".repeat(k));
    }, 350);
  };

  const runStep = () => {
    if (cancelled) return;
    stopDots();

    const s = steps[i] || steps[steps.length - 1];
    if (!s) return;

    if (s.mode === "dots") setDots(s.text);
    else loaderSetStatus(s.text);

    i++;
    if (i < steps.length) {
      stepTimer = setTimeout(runStep, msStep);
    }
  };

  runStep();

  return () => {
    cancelled = true;
    stopDots();
    if (stepTimer) clearTimeout(stepTimer);
    stepTimer = null;
  };
}
function startThinkingTicker(statusEl){
  const t0 = Date.now();
  const msgs = [
    "üß† Analizando evidencia‚Ä¶",
    "üìä Cruzando consumos vs pruebas‚Ä¶",
    "üß™ Evaluando hip√≥tesis‚Ä¶",
    "üßæ Redactando conclusi√≥n‚Ä¶"
  ];
  let i = 0;

  statusEl.textContent = msgs[0];
  const id = setInterval(() => {
    const s = Math.floor((Date.now() - t0) / 1000);
    statusEl.textContent = `${msgs[i % msgs.length]} (${s}s)`;
    i++;
  }, 1200);

  return () => clearInterval(id);
}
function sanitizeHipotesisOutputForUser(text) {
  let s = String(text ?? "");

  // Caso 1: bloque de markdown json
  s = s.replace(/```json[\s\S]*?```/gi, "").trim();

  // Caso 2: desde "5) JSON final" hasta el final
  s = s.replace(/\n?5\)\s*JSON\s*final[\s\S]*$/i, "").trim();

  // Caso 3: desde "JSON final" hasta el final (por si cambia numeraci√≥n)
  s = s.replace(/\n?JSON\s*final[\s\S]*$/i, "").trim();

  return s;
}
//#endregion funciones auxiliares
//88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
//#region Modulo Hipotesis
function abrirModalHipotesis() {
  console.log("üß™ [HIPOTESIS] abrirModalHipotesis()");
  const m = document.getElementById("modalHipotesis");
  if (!m) return console.error("‚ùå [HIPOTESIS] No existe #modalHipotesis");

  m.classList.remove("hidden");

  const rect = m.getBoundingClientRect();
  console.log("‚úÖ [HIPOTESIS] Modal abierto rect:", rect);

  const textarea = document.getElementById("hipotesisPregunta");
  textarea?.focus();
}

function cerrarModalHipotesis() {
  console.log("‚ùå [HIPOTESIS] cerrarModalHipotesis()");
  const m = document.getElementById("modalHipotesis");
  if (!m) return console.error("‚ùå [HIPOTESIS] No existe #modalHipotesis");
  m.classList.add("hidden");
}

async function ejecutarPreguntaLibreIA(){
  const status = document.getElementById("hipotesisStatus");
  const out = document.getElementById("hipotesisSalida");
  const pregunta = document.getElementById("hipotesisPregunta")?.value?.trim();

  if(!pregunta){
    status.textContent = "‚ö†Ô∏è Escribe una pregunta primero.";
    return;
  }

  const requestId = crypto.randomUUID();

  const contextObj = {
    lab_id: document.getElementById("hipotesisLab")?.value?.trim() || null,
    referencia: document.getElementById("hipotesisRef")?.value?.trim() || null,
    desde: document.getElementById("hipotesisDesde")?.value || null,
    hasta: document.getElementById("hipotesisHasta")?.value || null,
    demo: !!document.getElementById("hipotesisDemo")?.checked
  };

  const payload = {
    mode: "chat",
    question: pregunta,
    context: JSON.stringify(contextObj),
    ui_request_id: requestId
  };

  // ‚úÖ Estas son las √öNICAS que se detienen en finally
  let stopLoaderFlow = null;
  let stopTicker = null;

  try {
    mostrarLoader(true);
    loaderReset();

    const flow = [
      { text: "üß† Analizando hip√≥tesis", mode: "once" },
      { text: "üìå Validando contexto", mode: "once" },
      { text: contextObj.lab_id ? `üè• Unidad ${contextObj.lab_id}` : "üè• Unidad no especificada", mode: "once" },
      { text: contextObj.referencia ? `üßæ Ref ${contextObj.referencia}` : "üßæ Ref no especificada", mode: "once" },
      { text: "üîé Consultando Supabase", mode: "once" },
      { text: "üìä Armando evidencia", mode: "once" },
      { text: "üß© Preparando prompt auditable", mode: "once" },
      { text: "üöÄ Enviando a IA", mode: "once" },
      { text: "ü§ñ Esperando respuesta de la IA", mode: "dots" },
    ];

    // ‚úÖ OJO: NO uses "let" aqu√≠. Solo asigna.
    stopLoaderFlow = startLoaderStatusFlow(flow, 850);

    // ‚úÖ Si quieres, deja este ticker SOLO en el status del modal (no el loader)
    stopTicker = startThinkingTicker(status);

    out.classList.add("opacity-50");
    status.textContent = "üí¨ Consultando IA‚Ä¶";

    const ansRaw = await preguntarIA(payload);
    if(!ansRaw){
      status.textContent = "‚ùå No hubo respuesta.";
      return;
    }

    const ansUser = sanitizeHipotesisOutputForUser(ansRaw);
    status.textContent = "‚úÖ Listo.";

    out.innerHTML = `
      <div class="rounded-2xl p-4 bg-black/25 border border-white/10">
        <div class="text-xs text-white/60 mb-2">üßë‚Äçüíª T√∫</div>
        <div class="text-sm text-white/90 whitespace-pre-wrap">${escapeHtml(pregunta)}</div>
      </div>

      <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
        <div class="text-xs text-white/60 mb-2">ü§ñ IA</div>
        <div class="text-sm text-white/90 whitespace-pre-wrap">${escapeHtml(ansUser)}</div>
      </div>
    `;

  } catch (err) {
    console.error(err);
    status.textContent = "‚ùå Error al procesar la hip√≥tesis.";
  } finally {
    // ‚úÖ Det√©n loops SIEMPRE
    if (typeof stopTicker === "function") stopTicker();
    if (typeof stopLoaderFlow === "function") stopLoaderFlow();

    // ‚úÖ Cierra tu loader como siempre
    ocultarLoader();

    out.classList.remove("opacity-50");
    localStorage.removeItem("hyp_pending");
  }
}


function uiLog(requestId, stage, meta = {}, level = "info") {
  const entry = { ts: new Date().toISOString(), requestId, scope:"UI", stage, level, meta };
  console[level === "error" ? "error" : "log"]("[AUDIT]", entry);

  // Opcional: persistir logs UI en localStorage para debug r√°pido
  const key = "audit_ui_logs";
  const arr = JSON.parse(localStorage.getItem(key) || "[]");
  arr.push(entry);
  localStorage.setItem(key, JSON.stringify(arr.slice(-300))); // guarda √∫ltimos 300
}

async function preguntarIA(payload) {
  const requestId = payload?.ui_request_id || crypto.randomUUID();
  const t0 = performance.now();

  try {
    mostrarModal("üß† Procesando‚Ä¶", "#0ea5e9");

    uiLog(requestId, "HYP_API_HTTP_SEND", {
      url: "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/new_hipotesis",
      payload_preview: {
        mode: payload.mode,
        question_len: (payload.question || "").length,
        context_len: (payload.context || "").length
      }
    });

    const r = await fetch(
      "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/new_hipotesis",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "X-Client-Request-Id": requestId
        },
        body: JSON.stringify(payload),
      }
    );

    const data = await r.json().catch(() => ({}));

    uiLog(requestId, "HYP_API_HTTP_RECV", {
      status: r.status,
      ok: r.ok,
      ms: Math.round(performance.now() - t0),
      keys: Object.keys(data || {})
    });

    if (!r.ok || data?.error) {
      uiLog(requestId, "HYP_API_ERROR", {
        status: r.status,
        error: data?.error || "Error al consultar IA",
        raw: data
      }, "error");

      mostrarModal(`‚ùå ${data?.error || "Error al consultar IA"}`, "#991b1b");
      return null;
    }

    // ‚úÖ modo chat: esperamos data.answer (texto)
    const answer = data?.answer ?? null;

    uiLog(requestId, "HYP_API_OK", {
      ms: Math.round(performance.now() - t0),
      answer_len: (answer || "").length
    });

    return answer;
  } catch (e) {
    uiLog(requestId, "HYP_API_EXCEPTION", { message: e?.message }, "error");
    mostrarModal("‚ùå Error de red / servidor", "#991b1b");
    return null;
  }
}

async function ejecutarHipotesisIA(){
  const status = document.getElementById("hipotesisStatus");
  const out = document.getElementById("hipotesisSalida");
  const pregunta = document.getElementById("hipotesisPregunta").value.trim();

  if(!pregunta){
    status.textContent = "‚ö†Ô∏è Escribe una hip√≥tesis primero.";
    return;
  }

  const requestId = crypto.randomUUID();

  const payload = {
    mode: "reporte",
    question: pregunta,
    context: JSON.stringify({
      lab_id: document.getElementById("hipotesisLab").value.trim() || null,
      referencia: document.getElementById("hipotesisRef").value.trim() || null,
      desde: document.getElementById("hipotesisDesde").value || null,
      hasta: document.getElementById("hipotesisHasta").value || null,
      demo: document.getElementById("hipotesisDemo").checked
    }),
    ui_request_id: requestId
  };

  try{
    mostrarLoader();
    status.textContent = "üß™ Generando reporte cient√≠fico‚Ä¶";
    out.innerHTML = "";

    const res = await fetch(
      "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/new_hipotesis",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "X-Client-Request-Id": requestId
        },
        body: JSON.stringify(payload)
      }
    );

    const data = await res.json();

    if(!res.ok || data?.error){
      throw new Error(data?.error || "Error generando reporte");
    }

    status.textContent = "‚úÖ Reporte generado.";
    out.innerHTML = renderHipotesisReporte(data.reporte);

  }catch(err){
    console.error(err);
    status.textContent = "‚ùå " + (err.message || "Error");
  }finally{
    ocultarLoader();
  }
}

function renderHipotesisReporte(r){
  // r = { plan, evidencia, resultados, conclusion, warnings }
  const esc = (s)=> String(s ?? "").replaceAll("<","&lt;").replaceAll(">","&gt;");
  const pill = (t)=> `<span class="px-2 py-1 rounded-full bg-teal-500/15 border border-teal-400/30 text-teal-100 text-xs">${esc(t)}</span>`;

  return `
    <div class="rounded-2xl p-4 bg-black/25 border border-white/10">
      <div class="flex flex-wrap gap-2 items-center">
        ${pill(r?.plan?.metodo || "m√©todo")}
        ${pill("Œ±=" + (r?.plan?.alpha ?? 0.05))}
        ${r?.plan?.metric ? pill("m√©trica: " + r.plan.metric) : ""}
      </div>

      <h3 class="text-lg font-bold mt-3">Hip√≥tesis</h3>
      <p class="text-sm text-white/80 mt-1"><b>H0:</b> ${esc(r?.plan?.H0)}</p>
      <p class="text-sm text-white/80 mt-1"><b>H1:</b> ${esc(r?.plan?.H1)}</p>

      <h3 class="text-lg font-bold mt-4">Evidencia (resumen)</h3>
      <pre class="text-xs bg-black/40 border border-white/10 rounded-2xl p-3 overflow-auto">${esc(JSON.stringify(r?.evidencia, null, 2))}</pre>

      <h3 class="text-lg font-bold mt-4">Resultados</h3>
      <pre class="text-xs bg-black/40 border border-white/10 rounded-2xl p-3 overflow-auto">${esc(JSON.stringify(r?.resultados, null, 2))}</pre>

      <h3 class="text-lg font-bold mt-4">Conclusi√≥n</h3>
      <p class="text-sm text-white/85 mt-1">${esc(r?.conclusion)}</p>

      ${r?.warnings?.length ? `
        <h3 class="text-lg font-bold mt-4 text-amber-200">Warnings</h3>
        <ul class="list-disc pl-5 text-sm text-amber-100/90">
          ${r.warnings.map(w=>`<li>${esc(w)}</li>`).join("")}
        </ul>` : ""
      }
    </div>
  `;
}
window.abrirModalHipotesis = abrirModalHipotesis;
window.cerrarModalHipotesis = cerrarModalHipotesis;
window.ejecutarPreguntaLibreIA = ejecutarPreguntaLibreIA;
window.ejecutarHipotesisIA = ejecutarHipotesisIA;
window.addEventListener("beforeunload", (e) => {
  const pending = localStorage.getItem("hyp_pending");
  if (!pending) return;
  e.preventDefault();
  e.returnValue = "";
});
//#endregion Modulo Hipotesis
// Permitir arrastrar la ventana del lector QR
function hacerDraggable(idElemento) {
  const el = document.getElementById(idElemento);
  let offsetX = 0, offsetY = 0, mouseX = 0, mouseY = 0;

  const handle = document.getElementById("handleQR") || el;

  handle.onmousedown = function (e) {
    e.preventDefault();
    mouseX = e.clientX;
    mouseY = e.clientY;
    document.onmouseup = detenerArrastre;
    document.onmousemove = moverElemento;
  };

  function moverElemento(e) {
    e.preventDefault();
    offsetX = mouseX - e.clientX;
    offsetY = mouseY - e.clientY;
    mouseX = e.clientX;
    mouseY = e.clientY;

    const rect = el.getBoundingClientRect();
    el.style.top = (rect.top - offsetY) + "px";
    el.style.left = (rect.left - offsetX) + "px";
    el.style.bottom = "auto";
    el.style.right = "auto";
    el.style.position = "fixed";
  }

  function detenerArrastre() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}

// Activar cuando se abra el lector
function abrirModalQR(modo = "movimientos") {
  // Define si el esc√°ner trabajar√° para movimientos o inventario
  modoScannerQR = modo;

  const modal = document.getElementById("modalQR");
  const visor = document.getElementById("qr-reader");

  if (!modal || !visor) return;

  modal.classList.remove("hidden");
  hacerDraggable("modalQR");  // üëà activa drag al abrir
  iniciarScannerQR();
}

function cerrarModalQR() {
  console.log("üõë cerrarModalQR() llamado");
  const modal = document.getElementById("modalQR");

  if (!modal) {
    console.error("‚ùå No se encontr√≥ el elemento #modalQR para cerrar");
    return;
  }

  modal.classList.add("hidden");
  detenerScannerQR();
  console.log("‚úÖ Modal QR oculto");
}

function iniciarScannerQR() {
  console.log("üîÑ iniciarScannerQR() llamado");

  if (scannerActivo) {
    console.warn("‚ö†Ô∏è Esc√°ner ya activo, evitando duplicaci√≥n");
    return;
  }

  const visor = document.getElementById("qr-reader");
  if (!visor) {
    console.error("‚ùå No se encontr√≥ el visor QR con id #qr-reader");
    return;
  }

  try {
    console.log("üöÄ Iniciando Html5Qrcode...");
    scannerActivo = true;
    qrScanner = new Html5Qrcode("qr-reader");

    let ultimaLectura = "";
    let tiempoUltimaLectura = 0;

    qrScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 220 },
      qrCodeMessage => {
        const ahora = Date.now();
        if (qrCodeMessage === ultimaLectura && ahora - tiempoUltimaLectura < 2000) {
          // Ignora duplicados muy recientes
          return;
        }

        ultimaLectura = qrCodeMessage;
        tiempoUltimaLectura = ahora;

        console.log("‚úÖ QR detectado (bruto):", qrCodeMessage, " | modo:", modoScannerQR);

        if (modoScannerQR === "inventario") {
          manejarEscaneoInventario(qrCodeMessage);
        } else {
          const inputQR = document.getElementById("inputQR");
          if (inputQR) inputQR.value = qrCodeMessage;
          procesarQR(qrCodeMessage);
        }
      },
      errorMsg => {
        console.log("üîç Esperando QR v√°lido...", errorMsg);
      }
    ).catch(err => {
      console.error("‚ùå Error al iniciar esc√°ner:", err);
      alert("Error al acceder a la c√°mara: " + err);
      scannerActivo = false;
      cerrarModalQR();
    });

  } catch (e) {
    console.error("‚ùå Excepci√≥n en iniciarScannerQR():", e);
    scannerActivo = false;
    cerrarModalQR();
  }
}

function abrirModalQRInventario() {
  const modo = document.getElementById("modoCaptura")?.value;
  if (modo !== "inventario") {
    mostrarModal("‚ö†Ô∏è El lector QR de inventario solo funciona cuando el modo est√° en INVENTARIO.", "#f97316");
    return;
  }
  abrirModalQR("inventario");
}

function detenerScannerQR() {
  console.log("üîß detenerScannerQR() llamado");

  if (!qrScanner) {
    console.warn("‚ö†Ô∏è qrScanner no definido a√∫n");
    return;
  }

  qrScanner.stop().then(() => {
    console.log("üõë Esc√°ner detenido correctamente");
    scannerActivo = false;
    qrScanner.clear();
  }).catch(err => {
    console.error("‚ùå Error al detener esc√°ner:", err);
    scannerActivo = false;
  });
}


//88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888

function inicializarSelectorMesAnio() {
  const anioSelect = document.getElementById('inputMesAnio');
  if (anioSelect) {
    const thisYear = new Date().getFullYear();
    anioSelect.innerHTML = '';
    for (let y = thisYear - 2; y <= thisYear + 8; y++) {
      anioSelect.innerHTML += `<option value="${y}">${y}</option>`;
    }
  }
}
  const INTERVALO_MINUTOS = 10; // Puedes cambiar a 5, 15, etc.
  const listaAdmins = ["Silvia", "Luis", "Aida", "Ricardo", "Alex", "Adrian"];

function enfocarInputQR() {
  const contenedor = document.getElementById("contenedorQR");
  const input = document.getElementById("inputQR");

  if (contenedor) contenedor.classList.remove("hidden");

  if (input) {
    input.classList.remove("hidden");

    // üîÅ Espera breve para asegurar render antes de enfocar
    setTimeout(() => {
      input.value = "";
      input.focus();
      input.select();
      console.log("üéØ Enfocado inputQR (con delay)");
    }, 100); // Ajustable si es necesario
  } else {
    console.warn("‚ö†Ô∏è No se encontr√≥ el inputQR");
  }
}


function desbloquearEscaneoCritico() {
  window.escaneoBloqueado = false;
  if (typeof reanudarEscaneo === "function") reanudarEscaneo();
  const inputQR = document.getElementById("inputQR");
  if (inputQR) inputQR.disabled = false;
}

let audioBloqueo;
document.addEventListener("DOMContentLoaded", function() {
  audioBloqueo = new Audio(SONIDO_BLOQUEADO);
});
function bloquearEscaneoCritico(opciones = {}) {
  window.escaneoBloqueado = true;
  if (typeof detenerEscaneo === "function") detenerEscaneo();
  const inputQR = document.getElementById("inputQR");
  if (inputQR) {
    // inputQR.disabled = true; // üëà NO lo hagas
    inputQR.value = "";        // Limpia el input, pero no lo bloquees
    inputQR.blur();            // Puedes dejar el blur si quieres evitar focus
  }
  const sonido = opciones.sonido || SONIDO_BLOQUEADO;
  if (sonido) {
    try { new Audio(sonido).play(); } catch (e) {}
  }
  if (opciones.vibrar && window.navigator.vibrate) {
    window.navigator.vibrate([200, 100, 200]);
  }
}



async function validarPinYUnidad() {
  const TAG = "[PIN]";

  const elNip = document.getElementById("inputNIP");
  const elUnidad = document.getElementById("inputUnidad");
  const elRemision = document.getElementById("inputRemision");
  const elPinError = document.getElementById("pinError");
  const modalPin = document.getElementById("modalPinUnidad");

  const nip = (elNip?.value || "").trim();
  nipAdmin = nip;

  const unidad = (elUnidad?.value || "").trim().toUpperCase();
  const esSalida = (modoSeleccionado === "salida");

  const remisionRaw = (elRemision?.value || "").trim().toLowerCase();
  const unidadRaw = (elUnidad?.value || "").trim().toLowerCase();
  const esBasurero = (modoSeleccionado === "salida" && unidadRaw === "eliminar" && remisionRaw === "etiqueta");

  console.log(`${TAG} iniciar`, { modoSeleccionado, esSalida, nipLen: nip.length, unidad, remisionRaw });

  // Limpia error visible
  if (elPinError) {
    elPinError.classList.add("hidden");
    elPinError.textContent = "";
  }

  // ========== MODO BASURERO ==========
  if (esBasurero) {
    console.log(`${TAG} modo basurero ACTIVADO`);

    usuario = "Basurero";
    unidadSeleccionada = "Eliminar";
    modo = "salida";
    remisionActual = "Etiqueta"; // opcional para que todo quede consistente

    // cerrar modal bien
    if (modalPin) {
      modalPin.classList.add("hidden");
      modalPin.classList.remove("flex");
    }

    const usuarioActivoEl = document.getElementById("usuarioActivo");
    if (usuarioActivoEl) {
      usuarioActivoEl.innerHTML = `
        üï≥Ô∏è <strong>MODO ELIMINACI√ìN ACTIVADO</strong><br>
        <strong>Eliminar</strong><br>
        <strong>Etiqueta</strong>
      `;
    }

    actualizarBotonModo("Salida", "bg-black", "üï≥Ô∏è");
    document.body.classList.add("modo-basurero");

    // UI QR
    const contenedorQR = document.getElementById("contenedorQR");
    const btnEnviar = document.getElementById("btnEnviarSupabase");
    const inputQR = document.getElementById("inputQR");

    contenedorQR?.classList.remove("hidden");
    btnEnviar?.classList.remove("hidden");

    if (inputQR) {
      inputQR.classList.remove("hidden");
      inputQR.value = "";
      inputQR.focus();
    }

    // bot√≥n cerrar sesi√≥n
    document.getElementById("btnCerrarSesion")?.classList.remove("hidden");
    return;
  }

  // ========== VALIDACIONES PREVIAS (SALIDA) ==========
  let remision = null;

  if (esSalida) {
    remision = (elRemision?.value || "").trim();
    console.log(`${TAG} salida -> remision`, remision);

    const bloqueoActivo = await consultarEstadoBloqueo();
    console.log(`${TAG} bloqueoActivo`, bloqueoActivo);

    if (bloqueoActivo && !remision) {
      if (elPinError) {
        elPinError.textContent = "‚ùå Debes cargar la remisi√≥n para continuar.";
        elPinError.classList.remove("hidden");
      }
      return;
    }
  }

  remisionActual = remision;

  // ========== SI HAY REMISI√ìN, INTENTA CARGAR PENDIENTE ==========
  if (esSalida && remision) {
    try {
      console.log(`${TAG} buscando remisi√≥n pendiente`, remision);

      const resPendiente = await fetch(
        `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?select=*`,
        {
          headers: {
            apikey: API_KEY,
            Authorization: `Bearer ${API_KEY}`
          }
        }
      );

      const todasRemisiones = await resPendiente.json();
      console.log(`${TAG} remisiones encontradas`, (todasRemisiones || []).map(r => r.numero_remision));

      const remisionNormalizada = remision.trim();
      const datosPendientes = (todasRemisiones || []).filter(r =>
        (r.numero_remision || "").replaceAll('"', "").trim() === remisionNormalizada
      );

      console.log(`${TAG} remision buscada`, remisionNormalizada);
      console.log(`${TAG} pendientes match`, datosPendientes);

      if (datosPendientes.length > 0) {
        avanceRemision = {};

        for (const item of datosPendientes) {
          const clave = `${item.referencia}||${item.lote}`;
          avanceRemision[clave] = {
            ...item,
            escaneados: 0,
            nombre: item.descripcion || ""
          };
        }

        console.log(`${TAG} avanceRemision cargado`, avanceRemision);
        actualizarTablaRemisionSAP();
        mostrarModal("üì§ Remisi√≥n previa cargada autom√°ticamente", "#0ea5e9");
      }
    } catch (err) {
      console.error(`${TAG} error al cargar remisi√≥n previa`, err);
    }
  }

  // ========== VALIDAR NIP (SUPABASE FUNCTION) ==========
  try {
    console.log(`${TAG} validando nip...`);

    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/validar_nip", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nip })
    });

    const data = await res.json();
    console.log(`${TAG} respuesta validar_nip`, data);

    const unidadesLista = typeof data?.unidades === "string"
      ? data.unidades.split(",").map(u => u.trim().toUpperCase())
      : Array.isArray(data?.unidades)
        ? data.unidades.map(u => String(u).trim().toUpperCase())
        : [];

    const unidadValidaParaSalida = !esSalida || unidadesLista.includes(unidad);

    if (!data || !data.nombre || !unidadValidaParaSalida) {
      if (elPinError) {
        elPinError.textContent = "‚ùå Verifica NIP o unidad.";
        elPinError.classList.remove("hidden");
      }
      console.warn(`${TAG} acceso denegado`, { tieneNombre: !!data?.nombre, unidadValidaParaSalida, unidad, unidadesLista });
      return;
    }

    // Set globals
    usuario = data.nombre;
    window.usuario = usuario;

    esAdmin = data.es_admin;
    usuarioAdmin = (esAdmin === true);
    window.usuarioEsAdmin = usuarioAdmin;

    if (usuarioAdmin) {
      window.nombreAdmin = usuario;
      console.log(`${TAG} admin detectado`, window.nombreAdmin);
    } else {
      window.nombreAdmin = null;
    }

    unidadSeleccionada = esSalida ? unidad : null;
    modo = modoSeleccionado;

    // cerrar modal bien
    if (modalPin) {
      modalPin.classList.add("hidden");
      modalPin.classList.remove("flex");
    }

    // UI estado usuario
    const usuarioActivoEl = document.getElementById("usuarioActivo");
    const nombreUnidad = (typeof unidadesDestino === "object" && unidadesDestino?.[unidad]) ? unidadesDestino[unidad] : "Unidad desconocida";

    if (usuarioActivoEl) {
      if (modoSeleccionado === "entrada") {
        usuarioActivoEl.textContent = usuario;
      } else if (modoSeleccionado === "salida") {
        usuarioActivoEl.innerHTML = `
          ${usuario} ‚Üí ${unidad} ${nombreUnidad}<br>
          No. de Remisi√≥n: <strong>${remisionActual || "‚Äî"}</strong>
        `;
      } else {
        usuarioActivoEl.textContent = "Selecciona un modo para iniciar";
      }
    }

    // Bot√≥n inventario
    const btnInventario = document.querySelector('button[onclick="confirmarModoInventario()"]');
    if (modo === "entrada") btnInventario?.classList.remove("hidden");
    else btnInventario?.classList.add("hidden");

    // Bot√≥n modo
    const texto = modo;
    const color = (modo === "entrada") ? "bg-green-700"
                : (modo === "salida") ? "bg-red-900"
                : "bg-gray-500";
    const icono = (modo === "entrada") ? "üì•"
                : (modo === "salida") ? "üì§"
                : "üîí";

    actualizarBotonModo(texto.charAt(0).toUpperCase() + texto.slice(1), color, icono);

    console.log(`${TAG} modo activado`, { usuario, modo, unidadSeleccionada, remisionActual });
    notificar(`Modo ${modo.toUpperCase()} activado`, "#003f40");

  } catch (e) {
    console.error(`${TAG} error conexi√≥n validar_nip`, e);
    if (elPinError) {
      elPinError.textContent = "‚ùå Error de conexi√≥n.";
      elPinError.classList.remove("hidden");
    }
    return;
  } finally {
    // ========== UI QR + Bot√≥n enviar + Cerrar sesi√≥n (siempre consistente) ==========
    const contenedorQR = document.getElementById("contenedorQR");
    const btnEnviar = document.getElementById("btnEnviarSupabase");
    const btnCerrar = document.getElementById("btnCerrarSesion");

    const activo = !!modo && modo !== "inactivo";

    console.log(`${TAG} finally UI`, { activo, modo });

    if (!activo) {
      contenedorQR?.classList.add("hidden");
      btnEnviar?.classList.add("hidden");
      btnCerrar?.classList.add("hidden");
    } else {
      contenedorQR?.classList.remove("hidden");
      btnEnviar?.classList.remove("hidden");
      btnCerrar?.classList.remove("hidden");
      // focus lector QR
      if (typeof enfocarInputQR === "function") enfocarInputQR();
    }
  }
}



function abrirModalPinDinamico() {
  document.getElementById("modalPinDinamico").classList.remove("hidden");
  actualizarPinYContador(); // Primera carga
  intervaloCuentaRegresiva = setInterval(actualizarPinYContador, 1000); // Actualiza cada segundo
}

function cerrarModalPinDinamico() {
  document.getElementById("modalPinDinamico").classList.add("hidden");
  clearInterval(intervaloCuentaRegresiva);
}

async function sha256(text) {
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function generarPinDinamico(usuarioAdmin) {
  if (!nombreAdmin || typeof nombreAdmin !== "string") {
    console.error("‚ùå No se proporcion√≥ un nombreAdmin v√°lido a generarPinDinamico");
    return "------";
  }

  const clave = "medinova-secreto-2025";
  const ahora = new Date();
  const yyyy = ahora.getUTCFullYear();
  const mm = String(ahora.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(ahora.getUTCDate()).padStart(2, "0");
  const hora = String(ahora.getUTCHours()).padStart(2, "0");
  const bloque = Math.floor(ahora.getUTCMinutes() / 10);

  const base = `${nombreAdmin.toLowerCase()}::${yyyy}-${mm}-${dd}-${hora}-${bloque}::${clave}`;
  const hash = await sha256(base);
  return hash.substring(0, 6).toUpperCase();
}


async function actualizarPinYContador() {
  if (!window.nombreAdmin) {
    console.warn("‚ö†Ô∏è No hay admin logueado, no se puede generar PIN");
    return;
  }

  const pin = await generarPinDinamico(window.nombreAdmin);
  const elValor = document.getElementById("valorPinDinamicoSolo");
  if (elValor) elValor.textContent = pin;

  const ahora = new Date();
  const minutos = ahora.getUTCMinutes();
  const segundos = ahora.getUTCSeconds();
  const minutosRestantes = INTERVALO_MINUTOS - (minutos % INTERVALO_MINUTOS) - 1;
  const segundosRestantes = 59 - segundos;

  const mm = minutosRestantes.toString().padStart(2, "0");
  const ss = segundosRestantes.toString().padStart(2, "0");

  const elContador = document.getElementById("contadorPin");
  if (elContador) elContador.textContent = `${mm}:${ss}`;
}

async function mostrarOpcionesAdmin() {
  document.getElementById("modalOpcionesAdmin").classList.remove("hidden");

  if (usuarioAdmin) {
    document.getElementById("btnModificarUnidades")?.classList.remove("hidden");
    document.getElementById("btnRestablecerNIP")?.classList.remove("hidden");
    document.getElementById("btnBloqueoRemision")?.classList.remove("hidden");
    document.getElementById("btnVerPinDinamico")?.classList.remove("hidden");

    await mostrarPinDinamicoAdmin(); // Recomendado con await
  }
}

function cerrarModalOpcionesAdmin(){
  document.getElementById("modalOpcionesAdmin")?.classList.add("hidden");
}

function eliminarFila(boton) {
  const fila = boton.closest("tr");
  const index = parseInt(fila.dataset.index);

  if (!isNaN(index)) {
    console.log(`üóëÔ∏è Eliminando fila ${index} de qrsPendientes`);
    qrsPendientes.splice(index, 1); // Eliminar del arreglo
    actualizarTablaRegistros();     // Volver a renderizar tabla
  } else {
    console.warn("‚ö†Ô∏è No se pudo determinar el √≠ndice de la fila a eliminar.");
  }
}


function extraerDatosQR(qr) {
  if (window.escaneoBloqueado) {
    try {
      if (audioBloqueo) { audioBloqueo.currentTime = 0; audioBloqueo.play(); }
      else { new Audio(SONIDO_BLOQUEADO).play(); }
    } catch (e) {}
    mostrarModal(
      "üö´ El sistema est√° temporalmente bloqueado.<br>Completa o cierra la operaci√≥n cr√≠tica antes de escanear.",
      "#b91c1c"
    );
    // Limpia el input, pero no lo deshabilites
    const input = document.getElementById("inputQR");
    if (input) input.value = "";
    return;
  }

  const limpio = qr.trim().replace(/\s+/g, '');
  let partes = null;

  // üìå Formato original Israel: **{ref}//{lote}--{caducidad}|T:{timestamp}
  const nuevoFormato = /^\*\*\{(.+?)\}\/\/\{(.+?)\}--\{(.+?)\}\|T:(.+)$/;
  const matchNuevo = limpio.match(nuevoFormato);
  if (matchNuevo) {
    return {
      referencia: matchNuevo[1]?.trim() || null,
      lote: matchNuevo[2]?.trim() || null,
      caducidad: matchNuevo[3]?.trim() || null,
      timestamp: matchNuevo[4]?.trim() || null
    };
  }

  // üìå NUEVO formato Israel (mejorado) ‚Äî acepta asteriscos especiales y guion largo
  const nuevoFormatoV2 = /^[\*\u2217\u2731]{2}\{(.+?)\}\/\/\{(.+?)\}(?:--|‚Äî)\{(.+?)\}\|T:(.+)$/;
  const matchNuevoV2 = limpio.match(nuevoFormatoV2);
  if (matchNuevoV2) {
    return {
      referencia: matchNuevoV2[1]?.trim() || null,
      lote: matchNuevoV2[2]?.trim() || null,
      caducidad: matchNuevoV2[3]?.trim() || null,
      timestamp: matchNuevoV2[4]?.trim() || null
    };
  }

  // üìå Formato tipo R:xxx|L:xxx|C:xxx|T:xxx
  if (limpio.includes('|') && limpio.includes(':')) {
    partes = Object.fromEntries(
      limpio.split('|').map(p => p.split(':')).filter(p => p.length === 2)
    );
  }

  // üìå Formato m√≥vil tipo R>xxx`L>xxx`C>xxx`T>xxx
  else if (limpio.includes('`') && limpio.includes('>')) {
    partes = Object.fromEntries(
      limpio.split('`').map(p => p.split('>')).filter(p => p.length === 2)
    );
  }

  // üìå Formato m√≥vil tipo R√ëxxx√áL√ëxxx√áC√ëxxx√áT√ëxxx
//  else if (limpio.includes('√á') && limpio.includes('√ë')) {
 //   partes = Object.fromEntries(
  //    limpio.split('√á').map(p => p.split('√ë')).filter(p => p.length === 2)
    //);
  //}

  // üìå Formato m√≥vil tipo R√ëxxx]L√ëxxx]C√ëxxx]T√ëxxx
  else if (limpio.includes(']') && limpio.includes('√ë')) {
    partes = Object.fromEntries(
      limpio.split(']').map(p => p.split('√ë')).filter(p => p.length === 2)
    );
  }

  if (!partes) return null;

  return {
    referencia: partes["R"]?.trim() || null,
    lote: partes["L"]?.trim() || null,
    caducidad: partes["C"]?.trim() || null,
    timestamp: partes["T"]?.trim() || null
  };
}


function verificarCaducidadYMostrarModal(caducidadStr) {
  console.log("üß™ Verificando caducidad:", caducidadStr);

  if (!caducidadStr || caducidadStr.toLowerCase() === "s/c") {
    console.warn("‚è© Caducidad vac√≠a o sin control (S/C)");
    return;
  }

  const hoy = new Date();
  const fecha = new Date(caducidadStr);

  if (isNaN(fecha)) {
    console.error("‚ùå Fecha inv√°lida:", caducidadStr);
    return;
  }

  const diff = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));
  console.log(`üìÜ D√≠as hasta caducidad: ${diff}`);

  if (diff < 5) {
    console.warn("‚ö†Ô∏è Producto caduco o pr√≥ximo a caducar");

    if (modo === "entrada") {
      // ‚ö° Aviso r√°pido, sin bloqueo
      setTimeout(() => {
        mostrarModal("üíÄ Producto caduco o pr√≥ximo a caducar", "#304000");
      }, 600);

    } else if (modo === "salida") {
      // üö® Modal interactivo con bot√≥n ‚ÄúEntendido‚Äù
      const overlay = document.createElement("div");
      overlay.style.position = "fixed";
      overlay.style.top = "0";
      overlay.style.left = "0";
      overlay.style.width = "100vw";
      overlay.style.height = "100vh";
      overlay.style.background = "rgba(48, 64, 0, 0.4)";
      overlay.style.backdropFilter = "blur(10px)";
      overlay.style.webkitBackdropFilter = "blur(10px)";
      overlay.style.zIndex = "998";

      const modal = document.createElement("div");
      modal.style.position = "fixed";
      modal.style.top = "50%";
      modal.style.left = "50%";
      modal.style.transform = "translate(-50%, -50%)";
      modal.style.background = "rgba(255, 255, 255, 0.25)";
      modal.style.border = "2px solid rgba(255, 255, 255, 0.6)";
      modal.style.boxShadow = "0 4px 30px rgba(0, 0, 0, 0.2)";
      modal.style.borderRadius = "16px";
      modal.style.padding = "24px 32px";
      modal.style.textAlign = "center";
      modal.style.color = "#000";
      modal.style.fontWeight = "bold";
      modal.style.fontSize = "20px";
      modal.style.zIndex = "999";

      modal.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 1rem;">üíÄ</div>
        <div>Producto caduco o pr√≥ximo a caducar</div>
        <div style="margin-top: 1rem;">
          <button id="btnEntendidoCaducidad"
            style="margin-top: 1.5rem; padding: 0.5rem 1.5rem; font-size: 1rem; border: none; background-color: #333; color: white; border-radius: 12px; cursor: pointer;">
            Entendido
          </button>
        </div>
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(modal);

      // üéØ Cerrar modal al hacer clic en "Entendido"
      document.getElementById("btnEntendidoCaducidad").addEventListener("click", () => {
        modal.remove();
        overlay.remove();
      });
    }
  }
}



// Mostrar mensajes temporales
let timeoutAviso = null;
function mostrarModal(mensaje, color) {
  const modal = document.getElementById("modalAviso");
  const overlay = document.getElementById("overlayColor");

  if (timeoutAviso) clearTimeout(timeoutAviso);

  // üéØ Estilo del modal (efecto vidrio con borde brillante)
  modal.textContent = mensaje;
  modal.style.background = "rgba(255, 255, 255, 0.25)";   // m√°s transparente para que el glass sea real
  modal.style.color = "#000";                             // texto oscuro
  modal.style.backdropFilter = "blur(10px)";
  modal.style.webkitBackdropFilter = "blur(10px)";
  modal.style.border = "2px solid rgba(255, 255, 255, 0.6)";  // üî• Borde brillante estilo glass
  modal.style.boxShadow = "0 4px 30px rgba(0, 0, 0, 0.2)";    // sombra suave para flotar
  modal.style.borderRadius = "16px";
  modal.style.padding = "24px 32px";
  modal.style.zIndex = "999";
  modal.style.display = "block";
  modal.style.textAlign = "center";
  modal.style.fontWeight = "bold";
  modal.style.fontSize = "20px";

  if (overlay) {
    // ‚úÖ Convertimos el color s√≥lido en transl√∫cido
    let colorRGBA = color;
    if (!color.includes("rgba") && color.startsWith("#")) {
      const hex = color.replace("#", "");
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      colorRGBA = `rgba(${r}, ${g}, ${b}, 0.5)`; // üî• un poco menos opaco para ver el blur
    } else if (!color.includes("rgba") && color.startsWith("rgb")) {
      colorRGBA = color.replace("rgb", "rgba").replace(")", ", 0.5)");
    }

    // üé® Fondo con color + transparencia
    overlay.style.backgroundColor = colorRGBA;
    overlay.style.display = "block";
    overlay.style.zIndex = "998";

    // ü™ü Blur real del fondo
    overlay.style.backdropFilter = "blur(10px)";
    overlay.style.webkitBackdropFilter = "blur(10px)";

    // üîß Aseguramos que cubra toda la pantalla
    overlay.style.position = "fixed";
    overlay.style.top = "0";
    overlay.style.left = "0";
    overlay.style.width = "100vw";
    overlay.style.height = "100vh";
  }

  timeoutAviso = setTimeout(() => {
    modal.style.display = "none";
    if (overlay) {
      overlay.style.display = "none";
      overlay.style.backdropFilter = "";
      overlay.style.webkitBackdropFilter = "";
    }
    timeoutAviso = null;
  }, 1500);
}



async function mostrarPrevisualizacionDesdeQR(contenido) {
  const ref = extraerReferenciaDesdeQR(contenido);
  if (!ref) return;

  try {
    const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/buscar_referencia?ref=${encodeURIComponent(ref)}`);
    const data = await res.json();

    if (!data || !data.nombre) return;

    const lote = (() => {
      const partes = contenido.trim().split("|");
      for (let parte of partes) {
        if (parte.startsWith("L:")) return parte.slice(2).trim();
      }
      return "";
    })();

    const producto = {
      nombre: data.nombre,
      fabricante: data.fabricante,
      lote: lote,
      referencia: ref
    };

    mostrarVentanaPrevisualizacion(producto); // <-- esta l√≠nea faltaba
  } catch (err) {
    console.warn("No se pudo mostrar previsualizaci√≥n:", err);
  }
}



//======================================================================================


function intentoMuestreoDeCalidad(producto) {
  console.log("üß™ Ejecutando intentoMuestreoDeCalidad");
  console.log("üß™ Producto recibido:", producto);

  const probabilidad = 1 / 300; // Cambia a 1/30 en producci√≥n
  const aleatorio = Math.random();
  console.log("üß™ N√∫mero aleatorio generado:", aleatorio);

  if (aleatorio > probabilidad) {
    console.log("üß™ Muestreo NO activado por probabilidad");
    return;
  }

  console.log("üß™ Muestreo ACTIVADO - generando modal");

  // Modal centrado y responsive
  const modal = document.createElement("div");
  modal.className = "muestreo-calidad";
  modal.style.position = "fixed";
  modal.style.top = "0";
  modal.style.left = "0";
  modal.style.width = "100vw";
  modal.style.height = "100vh";
  modal.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
  modal.style.backdropFilter = "blur(8px)";
  modal.style.webkitBackdropFilter = "blur(8px)"; // Safari/iOS
  modal.style.display = "flex";
  modal.style.justifyContent = "center";
  modal.style.alignItems = "center";
  modal.style.zIndex = "9000";
  modal.style.padding = "1rem";
  modal.style.boxSizing = "border-box";

  const contenido = document.createElement("div");
  contenido.style.backgroundColor = "white";
  contenido.style.padding = "1.5rem";
  contenido.style.borderRadius = "1rem";
  contenido.style.boxShadow = "0 0 20px rgba(0,0,0,0.3)";
  contenido.style.width = "100%";
  contenido.style.maxWidth = "500px";
  contenido.style.boxSizing = "border-box";
  contenido.innerHTML = `
    <h2 style="font-size: 1.25rem; font-weight: bold; text-align: center; color: #990026; margin-bottom: 1rem;">üß™ Muestreo de Calidad</h2>
    <p style="margin-bottom: 0.5rem; color: #990026; font-weight: bold;">
      ‚ö†Ô∏è <b>IMPORTANTE:</b> NO uses la etiqueta. 
      Ingresa los datos impresos directamente en el envase o empaque original del producto.
    </p>
    <label style="color: black;"><b>Referencia:</b> Escribe la clave o n√∫mero como aparece en el empaque.</label>
    <input id="input_ref_validar" type="text" placeholder="Ej: 547321" style="width: 100%; color: black; padding: 0.5rem; margin-bottom: 0.5rem;">
    <label style="color: black;"><b>Lote:</b> Captura el lote visible en el producto (no en la etiqueta).</label>
    <input id="input_lote_validar" type="text" placeholder="Ej: A23B56" style="width: 100%; color: black; padding: 0.5rem; margin-bottom: 0.5rem;">
    <label style="color: black;"><b>Caducidad:</b> Ingresa la fecha como viene impresa, o marca "Sin caducidad" si aplica.</label>
    <input id="input_cad_validar" type="date" style="width: 100%; color: black; padding: 0.5rem; margin-bottom: 0.5rem;">
    <div style="display:flex; align-items:center; margin-bottom: 1rem;">
      <input id="cad_no_aplica" type="checkbox" style="margin-right: 0.5rem;" onchange="toggleCaducidadInput(this)">
      <label for="cad_no_aplica" style="color:black; margin:0;">Sin caducidad / No aplica</label>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
      <button onclick="validarMuestreo('${producto.referencia}','${producto.lote}','${producto.caducidad}')" style="padding: 0.5rem; background-color: #15803d; color: white; font-weight: bold; border: none; border-radius: 5rem;">Validar</button>
      <button onclick="cancelarMuestreo()" style="padding: 0.5rem; background-color: #990026; color: white; font-weight: bold; border: none; border-radius: 5rem;">Omitir</button>
    </div>
  `;

  modal.appendChild(contenido);
    // üö´ Bloquea escaneo cuando se activa el muestreo
  bloquearEscaneoCritico({
    sonido: "https://github.com/RicardoCentrum/centrum/raw/main/losiento.mp3",
    vibrar: true
  });
  document.body.appendChild(modal);
  console.log("üß™ Modal de muestreo insertado en el DOM");
}

// Permitir desactivar el input de caducidad si es "no aplica"
function toggleCaducidadInput(checkbox) {
  const inputCad = document.getElementById('input_cad_validar');
  if (checkbox.checked) {
    inputCad.disabled = true;
    inputCad.value = "";
  } else {
    inputCad.disabled = false;
  }
}

function sonCaducidadesEquivalentes(a, b) {
  const equivalentes = ["0", "S/C", "SC", "SIN CADUCIDAD", "N/A", "NA", "", null, undefined];

  // Si ambos son equivalentes "sin caducidad", acepta
  const upperA = (a === null || a === undefined) ? "" : String(a).trim().toUpperCase();
  const upperB = (b === null || b === undefined) ? "" : String(b).trim().toUpperCase();
  if (equivalentes.includes(upperA) && equivalentes.includes(upperB)) {
    console.log("üü¢ Ambos valores equivalentes a 'sin caducidad':", upperA, upperB);
    return true;
  }

  // Funci√≥n interna para normalizar cualquier fecha a ISO (YYYY-MM-DD)
  function fechaExcelANormal(fecha) {
    if (!fecha) return "";
    // Detecta si es un n√∫mero Excel v√°lido
    if (!isNaN(Number(fecha)) && Number(fecha) > 10000 && Number(fecha) < 60000) {
      const serial = Number(fecha);
      // Excel usa 1899-12-30 como d√≠a 0
      const msPerDay = 24 * 60 * 60 * 1000;
      const excelEpoch = Date.UTC(1899, 11, 30);
      const dateMs = excelEpoch + serial * msPerDay;
      // Siempre toma la fecha en UTC, as√≠ no afecta la zona horaria local
      const date = new Date(dateMs);
      return date.toISOString().split("T")[0];
    }
    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) return fecha;
    // YYYY/MM/DD
    if (/^\d{4}\/\d{2}\/\d{2}$/.test(fecha)) return fecha.replace(/\//g, '-');
    // DD/MM/YYYY
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
      const [d, m, y] = fecha.split("/");
      return `${y}-${m}-${d}`;
    }
    // Si es string y parece fecha
    if (!isNaN(Date.parse(fecha))) {
      return new Date(fecha).toISOString().split("T")[0];
    }
    return String(fecha).trim().toUpperCase();
  }

  const fa = fechaExcelANormal(a);
  const fb = fechaExcelANormal(b);

  console.log("üîé Caducidad A normalizada:", fa, "| original:", a);
  console.log("üîé Caducidad B normalizada:", fb, "| original:", b);

  // Si alguna era "S/C" o "0", ya fue cubierto arriba.
  // Ahora comparamos fechas normalizadas.
  const resultado = fa === fb;
  if (resultado) {
    console.log("‚úÖ Caducidades equivalentes:", fa, fb);
  } else {
    console.log("‚ùå Caducidades diferentes:", fa, fb);
  }
  return resultado;
}


function validarMuestreo(refEsperada, loteEsperado, cadEsperada) {
  console.log("üß™ Validando muestreo:", { refEsperada, loteEsperado, cadEsperada });
  const ref = document.getElementById("input_ref_validar").value.trim();
  const lote = document.getElementById("input_lote_validar").value.trim();
  let cad = document.getElementById("input_cad_validar")
    ? document.getElementById("input_cad_validar").value
    : null;

  // Si el checkbox est√° marcado, la caducidad es "S/C"
  if (document.getElementById("cad_no_aplica")?.checked) {
    cad = "S/C";
  }

  console.log("üß™ Valores ingresados:", { ref, lote, cad });

  const nip = typeof usuario !== "undefined" ? usuario : "SIN_NIP";
  const nombre = localStorage.getItem("nombreUsuario") || "Anonimo";

  // Si la caducidad esperada es "vac√≠a" o equivalente, acepta cualquier valor en caducidad:
  const equivalentes = ["0", "S/C", "SC", "SIN CADUCIDAD", "N/A", "NA", "", null, undefined];
  const cadEsperadaVac√≠a = equivalentes.includes(
    cadEsperada === undefined || cadEsperada === null ? "" : String(cadEsperada).trim().toUpperCase()
  );

  let validacionOK = false;
  if (cadEsperadaVac√≠a) {
    validacionOK = ref === refEsperada && lote === loteEsperado;
  } else {
    validacionOK =
      ref === refEsperada &&
      lote === loteEsperado &&
      sonCaducidadesEquivalentes(cad, cadEsperada);
  }

  // SIEMPRE registra el intento, aunque falte referencia/lote/cad
  fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/registro_errores", {
    method: "POST",
    headers: {
      "apikey": API_KEY,
      "Authorization": `Bearer ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      usuario: nombre,
      referencia: refEsperada,
      lote: loteEsperado,
      fecha: new Date().toISOString(),
      motivo: validacionOK ? "muestreo validado" : "muestreo error",
      modo: "muestreo",
      pin_ingresado: nip,
      valido: validacionOK,
      // OPCIONAL: guarda lo que el usuario captur√≥
      ref_ingresada: ref,
      lote_ingresado: lote,
      caducidad_ingresada: cad
    })
  });

  if (validacionOK) {
    mostrarModal("Validaci√≥n exitosa ‚úÖ", "#22c55e");
  } else {
    mostrarModal("‚ùå Error de validaci√≥n. Notificado a administradores.", "#990026");
  }

  desbloquearEscaneoCritico();
  cerrarModalMuestreo();
}




function cancelarMuestreo() {
  console.warn("üö® Muestreo omitido por el usuario");

  // Sonido advertencia
  const SONIDO_ADVERTENCIA = "https://github.com/RicardoCentrum/centrum/raw/main/advertencia%20muestreo%20calidad.mp3";
  try { new Audio(SONIDO_ADVERTENCIA).play(); } catch (e) {}

  // Modal de confirmaci√≥n especial
  const modalConfirm = document.createElement("div");
  modalConfirm.style.position = "fixed";
  modalConfirm.style.top = "0";
  modalConfirm.style.left = "0";
  modalConfirm.style.width = "100vw";
  modalConfirm.style.height = "100vh";
  modalConfirm.style.background = "rgba(200,0,60,0.55)";
  modalConfirm.style.backdropFilter = "blur(8px)";
  modalConfirm.style.webkitBackdropFilter = "blur(8px)";
  modalConfirm.style.zIndex = "99999";
  modalConfirm.style.display = "flex";
  modalConfirm.style.justifyContent = "center";
  modalConfirm.style.alignItems = "center";

  const contenido = document.createElement("div");
  contenido.style.background = "rgba(255,255,255,0.75)"; // Fondo glass
  contenido.style.backdropFilter = "blur(10px)";
  contenido.style.webkitBackdropFilter = "blur(10px)";
  contenido.style.border = "2px solid rgba(255,255,255,0.6)";
  contenido.style.boxShadow = "0 4px 30px rgba(0,0,0,0.2)";
  contenido.style.borderRadius = "16px";
  contenido.style.padding = "2rem";
  contenido.style.textAlign = "center";
  contenido.style.color = "#990026";
  contenido.style.fontWeight = "bold";
  contenido.style.maxWidth = "420px";
  contenido.style.margin = "0 auto";

  // El resto de tu contenido HTML:
  contenido.innerHTML = `
    <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
    <div style="font-size: 1.15rem; margin-bottom: 1.25rem; color:#990026;">
      ¬øTe rehusas a participar en el <b>muestreo aleatorio de calidad</b>?
    </div>
    <div style="display:flex; justify-content:center; gap:1rem;">
      <button id="btnOmitirMuestreo" style="background:#990026; color:white; border:none; border-radius:5rem; padding:0.75rem 2rem; font-size:1rem; font-weight:bold; box-shadow:0 2px 10px #99002633; cursor:pointer;">
        S√≠, omitir muestreo
      </button>
      <button id="btnCancelarOmitir" style="background:#e5e7eb; color:#990026; border:none; border-radius:5rem; padding:0.75rem 2rem; font-size:1rem; font-weight:bold; box-shadow:0 2px 10px #99002622; cursor:pointer;">
        Cancelar
      </button>
    </div>
  `;

  modalConfirm.appendChild(contenido);
  document.body.appendChild(modalConfirm);

  // Acci√≥n al aceptar (omitir realmente)
  contenido.querySelector("#btnOmitirMuestreo").onclick = () => {
    const nombre = localStorage.getItem("nombreUsuario") || "Anonimo";
    const nip = typeof usuario !== "undefined" ? usuario : "-";
    fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/registro_errores", {
      method: "POST",
      headers: {
        "apikey": API_KEY,
        "Authorization": `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        usuario: nombre,
        referencia: "-",
        lote: "-",
        fecha: new Date().toISOString(),
        motivo: "muestreo omitido",
        modo: "muestreo",
        pin_ingresado: nip,
        valido: false
      })
    });
    desbloquearEscaneoCritico();
    cerrarModalMuestreo();
    modalConfirm.remove();
    mostrarModal("üö® Muestreo omitido. Notificado a administradores.", "#990026");
  };

  // Acci√≥n al cancelar (volver al muestreo)
  contenido.querySelector("#btnCancelarOmitir").onclick = () => {
    modalConfirm.remove();
    // ¬°El muestreo original sigue abierto y el escaneo sigue bloqueado!
    try { document.getElementById("input_ref_validar").focus(); } catch (e) {}
  };
}



function cerrarModalMuestreo() {
  const modal = document.querySelector(".muestreo-calidad");
  desbloquearEscaneoCritico()
  if (modal) modal.remove();
  inputQR?.focus();
}




//888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888





async function procesarQR(contenido) {
  try {
    console.log("üì• QR recibido:", contenido);
    const datos = extraerDatosQR(contenido);
    console.log("üîç Datos extra√≠dos del QR:", datos);

    if (!datos || !datos.referencia || !datos.timestamp) {
      mostrarModal("‚ùå QR incompleto o ilegible", "#6b7280");
      return;
    }

    if (!datos.lote) {
      mostrarModal("‚ùå QR sin lote", "#6b7280");
      return;
    }

    const remision = document.getElementById("inputRemision")?.value.trim().toLowerCase();
    const unidad = unidadSeleccionada?.toLowerCase();
    const esBasurero = modo === "salida" && unidad === "eliminar" && remision === "etiqueta";

    if (esBasurero) {
      await procesarBasurero(datos);
      return;
    }

    if (datos.lote.includes('|')) {
      datos.lote = datos.lote.split('|')[0];
    }

    if (!usuario || !modo || modo === "inactivo") {
      mostrarModal("‚ö†Ô∏è Selecciona un modo y un usuario", "#f59e0b");
      return;
    }

    if (modo === "salida" && !unidadSeleccionada) {
      mostrarModal("‚ö†Ô∏è Selecciona una unidad m√©dica", "#f59e0b");
      return;
    }

    if (qrsPendientes.some(q => q.timestamp === datos.timestamp)) {
      mostrarModal("üì¶ Ya escaneado localmente", "#0284c7");
      return;
    }

    const tsCheckRes = await fetch(
      `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/TimeStamps?or=(timestamp.eq.${datos.timestamp},ts_eliminado.eq.${datos.timestamp})&select=timestamp,ts_eliminado,usuario,unidad_destino,fecha_salida_str`,
      { headers: { "apikey": API_KEY, "Authorization": `Bearer ${API_KEY}` } }
    );
    console.log("üåê [FETCH] Consulta enviada a Supabase con timestamp:", datos.timestamp);

    const tsData = await tsCheckRes.json();
    console.log("üîç [TS DEBUG] Respuesta completa de Supabase:", tsData);

    const registro = tsData[0] || null;
    console.log("üì¶ [TS DEBUG] Registro procesado:", registro);

    if (modo === "entrada" && registro?.timestamp) {
      mostrarModal("üì¶ Ya escaneado anteriormente", "#0284c7");
      return;
    }

    if (modo === "salida" && registro?.ts_eliminado) {
      console.log("üö© [TS DEBUG] Producto marcado como eliminado, generando historial...");

      // ‚úÖ Funci√≥n auxiliar para armar historial completo
      function construirHistorial(usuarioStr, unidadStr, remisionStr, fechaStr) {
        const usuarios = usuarioStr ? usuarioStr.split(",") : [];
        const unidades = unidadStr ? unidadStr.split(",") : [];
        const remisiones = remisionStr ? remisionStr.split(",") : [];
        const fechas = fechaStr ? fechaStr.split(",") : [];

        const historial = [];
        for (let i = 0; i < usuarios.length; i++) {
          historial.push(
            `${usuarios[i] || "-"} ‚Üí ${unidades[i] || "-"} ` +
            `(Remisi√≥n: ${remisiones[i] || "-"}) en ${fechas[i] || "-"}`
          );
        }
        return historial.join("\n");
      }

      // ‚úÖ Construimos el historial con los campos concatenados del backend
      const historial = construirHistorial(
        registro.usuario,
        registro.unidad_destino,
        registro.remision,
        registro.fecha_salida_str
      );

      // ‚úÖ Mostrar historial en un modal amarillo
      const msg = `‚ö†Ô∏è Este producto ya fue retirado anteriormente:\n\n${historial}`;
      console.log("üì¢ [TS DEBUG] Mostrando historial completo:\n" + historial);
      mostrarModal(msg, "#facc15");
      return;
    } else {
      console.log("‚úÖ [TS DEBUG] No se encontr√≥ registro eliminado o el modo no es salida.");
    }


    if (modo === "salida" && !registro?.timestamp && !registro?.ts_eliminado) {
      mostrarModal("‚ùå Este c√≥digo no ha sido registrado previamente en modo entrada.\nNo se encontr√≥ el timestamp en la base de datos.", "#dc2626");
      return;
    }
    if (modo === "salida") {
      const inputRemision = document.getElementById("inputNumeroRemision");
      const numeroRemision = inputRemision ? inputRemision.value.trim() : "";
      if (numeroRemision) {
        const remisionValida = await validarContraRemision(datos.referencia, datos.lote, numeroRemision);
        if (!remisionValida) return;
      }
    }

    mostrarModal("üì§ Procesando QR...", "#0ea5e9");

    const urlMultip = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/multiplicadores?select=fraccionable,referencia,referencia_unidad,multiplicador&or=(referencia.eq.${datos.referencia},referencia_unidad.eq.${datos.referencia})`;
    const fraccionableRes = await fetch(urlMultip, {
      headers: { "apikey": API_KEY, "Authorization": `Bearer ${API_KEY}` }
    });
    const fraccionableData = await fraccionableRes.json();
    const entry = fraccionableData[0];
    const esFraccionable = entry?.fraccionable === true;

    // ‚úÖ UNIDAD FRACCIONABLE
    if (entry?.referencia_unidad === datos.referencia) {
      const qrUnidad = {
        ...datos,
        modo,
        usuario,
        unidad: unidadSeleccionada,
        tipo: "unidad",
        remision: document.getElementById("inputRemision")?.value.trim() || null
      };
      qrsPendientes.push(qrUnidad);
      intentoMuestreoDeCalidad(qrUnidad);
      actualizarTablaRegistros();
      mostrarModal("‚úÖ Unidad escaneada", "#22c55e");
      return;
    }

    // ‚úÖ CAJA FRACCIONABLE
    if (esFraccionable && modo === "entrada") {
      const qrCaja = {
        ...datos,
        modo,
        usuario,
        unidad: unidadSeleccionada,
        tipo: "fraccion",
        remision: document.getElementById("inputRemision")?.value.trim() || null
      };
      qrsPendientes.push(qrCaja);
      intentoMuestreoDeCalidad(qrCaja);
      actualizarTablaRegistros();
      mostrarModal("‚úÖ Caja escaneada", "#22c55e");
      return;
    }

    // üîÑ SALIDA FRACCIONABLE
    if (esFraccionable && modo === "salida") {
      abrirModalCantidadFraccionable(datos.referencia, datos.lote, contenido);
      return;
    }

    // ‚úÖ Producto normal
    if (modo === "salida") {
      const permitido = await procesarExtraccionConValidacion(datos.referencia, unidadSeleccionada, 1, usuario, remisionActual);
      if (!permitido) return;
    }

    const historicoRes = await fetch(
      `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/historicos?select=referencia,nombre,fabricante`,
      { headers: { "apikey": API_KEY, "Authorization": `Bearer ${API_KEY}` } }
    );
    const historico = await historicoRes.json();
    const normalizar = str => str.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
    const refLimpiada = normalizar(datos.referencia);
    const match = historico.find(h => normalizar(h.referencia) === refLimpiada);
    const nombre = match?.nombre || "SIN NOMBRE";
    const fabricante = match?.fabricante || "SIN FABRICANTE";

    let caducidadFinal = "S/C";
    if (datos.caducidad && !isNaN(datos.caducidad)) {
      inputQR?.focus();
      try {
        const fechaExcel = new Date((Number(datos.caducidad) - 25569) * 86400 * 1000);
        caducidadFinal = fechaExcel.toISOString().split("T")[0];
      } catch {
        caducidadFinal = "S/C";
      }
    } else if (typeof datos.caducidad === "string") {
      caducidadFinal = datos.caducidad;
    }

    verificarCaducidadYMostrarModal(caducidadFinal);

    const qrPendiente = {
      ...datos,
      modo,
      usuario,
      unidad: unidadSeleccionada,
      nombre,
      fabricante,
      caducidad: caducidadFinal,
      remision: document.getElementById("inputRemision")?.value.trim() || null

    };

    qrsPendientes.push(qrPendiente);
    intentoMuestreoDeCalidad(qrPendiente);
    actualizarTablaRegistros();
    mostrarModal("‚úÖ Producto escaneado", "#22c55e");

  } catch (error) {
    console.error("‚ùå Error en procesarQR:", error);
    mostrarModal("‚ùå Error inesperado", "#dc2626");
  }
}




// === Funciones auxiliares ===
function prepararEventoCantidadFraccionable() {
  const input = document.getElementById("inputCantidadFraccionable");
  if (!input) return;

  // Primero eliminamos cualquier listener previo (por seguridad)
  input.replaceWith(input.cloneNode(true));

  const nuevoInput = document.getElementById("inputCantidadFraccionable");
  nuevoInput.addEventListener("keyup", function (e) {
    if (e.key === "Enter") confirmarCantidadFraccionable();
  });
}

function iniciarExtraccionFraccionableFrontend(ref, lote, cantidad) {
  fraccionesEscaneadas = [];
  cantidadFaltante = cantidad;
  referenciaActual = ref;
  loteActual = lote;
  referenciaFraccionable = ref; // ‚úÖ Definir referencia esperada
  loteFraccionable = lote;       // ‚úÖ Definir lote esperado
  mostrarModal("üîÑ Escanea la primera caja...", "#6b7280");
}

function reenfocarInputFraccionable() {
  const input = document.getElementById("inputEscaneoFraccionable");
  if (input) {
    setTimeout(() => input.focus(), 50);
  }
}


async function procesarCajaFraccionable(contenidoQR) {
  const datos = extraerDatosQR(contenidoQR);
  const ts = datos.timestamp;

  if (!ts || !datos.referencia || !datos.lote) {
    mostrarModal("‚ö†Ô∏è QR incompleto", "#f59e0b");
    return;
  }

  if (datos.referencia !== referenciaFraccionable || datos.lote !== loteFraccionable) {
    mostrarModal("‚ö†Ô∏è Caja/Unidad no coincide con referencia o lote esperado", "#facc15");
    reenfocarInputFraccionable();
    return;
  }

  if (fraccionesEscaneadas.some(f => f.timestamp === ts)) {
    mostrarModal("‚ö†Ô∏è Esta caja/unidad ya fue escaneada", "#facc15");
    reenfocarInputFraccionable();
    return;
  }

  try {
    // üîç Buscar si el timestamp corresponde a una fracci√≥n en Supabase
    const res = await fetch(
      `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/fracciones?timestamp=eq.${ts}`,
      {
        headers: {
          "apikey": API_KEY,
          "Authorization": `Bearer ${API_KEY}`
        }
      }
    );

    if (!res.ok) throw new Error(`‚ùå Error HTTP: ${res.status}`);

    const [fraccion] = await res.json();
    console.log("üì¶ Caja/Unidad procesada:", fraccion);

    if (!fraccion || fraccion.cantidad_restante <= 0) {
      mostrarModal("‚ùå Caja/Unidad vac√≠a o no encontrada", "#dc2626");
      reenfocarInputFraccionable();
      return;
    }

    // ‚úÖ Detectar si es unidad fraccionable o caja fraccionable
    const esUnidad = datos.referencia.endsWith("U"); 
    // si prefieres algo m√°s robusto, puedes validar contra la tabla "multiplicadores"

    const usado = Math.min(fraccion.cantidad_restante, cantidadFaltante);
    cantidadFaltante = Math.max(0, cantidadFaltante - usado);

    // ‚úÖ Guardar en fraccionesEscaneadas con tipo correcto
    console.log("üì• Caja/Unidad a√±adida a fraccionesEscaneadas:", {
      ts,
      lote: datos.lote,
      usado,
      tipo: esUnidad ? "unidad" : "fraccion",
      remision: document.getElementById("inputRemision")?.value.trim() || null
    });

    fraccionesEscaneadas.push({
      timestamp: ts,
      lote: datos.lote,
      usado,
      tipo: esUnidad ? "unidad" : "fraccion",
      remision: document.getElementById("inputRemision")?.value.trim() || null
    });

    actualizarModalFraccionable();

    if (cantidadFaltante > 0) {
      mostrarModal(
        `üì¶ Se usaron ${usado}. Faltan ${cantidadFaltante} piezas. Escanea otra caja o unidad...`,
        "#0ea5e9"
      );
      reenfocarInputFraccionable();
    } else {
      mostrarModal("‚úÖ Todo listo. Enviando informaci√≥n...", "#22c55e");
      cerrarModalFraccionable();
      modoExtraccionFraccionableActivo = false;

      // ‚úÖ Ahora fraccionesEscaneadas puede contener mezcla de cajas y unidades
      fraccionesEscaneadas.forEach(f => {
        qrsPendientes.push({
          referencia: referenciaFraccionable,
          lote: f.lote,
          timestamp: f.timestamp,
          cantidad: f.usado,
          usuario,
          unidad: unidadSeleccionada,
          tipo: f.tipo,
          remision: f.remision || null,
          modo: "salida"
        });
      });
      actualizarTablaRegistros();

    }
  } catch (error) {
    console.error("‚ùå Error al consultar fracci√≥n:", error);
    mostrarModal("‚ùå Error al verificar la caja", "#6b7280");
    reenfocarInputFraccionable();
  }
}


async function registrarExtraccionConjunta(elementos, referencia, usuario, unidad) {
  let errores = 0;
  const procesados = new Set();

  for (const [i, f] of elementos.entries()) {
    try {
      // üîë Usamos un identificador √∫nico (timestamp o ‚Äúunidad‚Äù si no tiene)
      const key = `${referencia}-${f.lote}-${f.timestamp || 'unidad'}`;
      if (procesados.has(key)) continue;
      procesados.add(key);

      // üì¶ Construir el objeto base para Supabase
      const registro = {
        referencia,
        lote: f.lote,
        timestamp: f.timestamp || null,   // ‚úÖ cajas tienen timestamp, unidades pueden no tener
        cantidad: f.usado,
        usuario,
        modo: "salida",
        unidad,
        remision: f.remision || null
      };

      // üîë Si hay PIN de autorizaci√≥n, lo agregamos
      if (window.pinAutorizadoPor && window.pinAutorizadoPor !== usuario) {
        registro.pin_autorizado_por = window.pinAutorizadoPor;
      }

      // üåê Escoger endpoint correcto seg√∫n tipo
      const url = f.tipo === "fraccion"
        ? "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_fraccionable"
        : "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_unidad";

      console.log("üîµ [registrarExtraccionConjunta] Enviando:", url, registro);

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ registros: [registro] })
      });

      if (!res.ok) throw new Error(`‚ùå Error HTTP: ${res.status}`);

      const result = await res.json();
      const r = result.resultados?.[0];

      console.log("üì§ [registrarExtraccionConjunta] Respuesta Supabase:", result);

      // ‚úÖ Si Supabase confirma el registro
      if (r?.status === "ok") {
        // ‚úÖ Guardamos en qrsPendientes para registro local
        const registroQR = {
          referencia,
          lote: f.lote,
          timestamp: f.timestamp || null,
          cantidad: f.usado,
          modo: "salida",
          usuario,
          unidad,
          tipo: f.tipo,
          remision: f.remision || null

        };

        if (registro.pin_autorizado_por) {
          registroQR.pin_autorizado_por = registro.pin_autorizado_por;
        }

        // Evitar duplicados en qrsPendientes
        const yaExiste = qrsPendientes.find(q =>
          q.referencia === referencia &&
          q.lote === f.lote &&
          q.timestamp === f.timestamp
        );

        if (!yaExiste) qrsPendientes.push(registroQR);

        mostrarModal(`‚úÖ Elemento ${i + 1} procesado (${f.usado} piezas, tipo: ${f.tipo})`, "#22c55e");

      } else {
        // ‚ö†Ô∏è Si Supabase devuelve warning/error
        errores++;
        mostrarModal(`‚ö†Ô∏è Elemento ${i + 1} fall√≥: ${r?.mensaje || "desconocido"}`, "#facc15");
      }

    } catch (err) {
      console.error(`‚ùå [registrarExtraccionConjunta] Error al registrar elemento ${i + 1}:`, err);
      errores++;
      mostrarModal(`‚ùå Error de red al registrar elemento ${i + 1}`, "#dc2626");
    }

    // ‚è≥ Pausa ligera para evitar saturar el backend
    await new Promise(resolve => setTimeout(resolve, 200));
  }

  // üéâ Resultado final
  if (errores === 0) {
    mostrarModal("üéâ Todas las cajas y unidades registradas con √©xito", "#4ade80");
  } else {
    mostrarModal(`‚ö†Ô∏è ${errores} de ${elementos.length} elementos fallaron`, "#f59e0b");
  }
}



//88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888


async function validarContraRemision(referencia, lote, numeroRemision) {
  const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?referencia=eq.${referencia}&lote=eq.${lote}&numero_remision=eq.${numeroRemision}`, {
    headers: {
      "apikey": API_KEY,
      "Authorization": `Bearer ${API_KEY}`
    }
  });

  const data = await res.json();

  if (data.length === 0) {
    mostrarModal("‚ö†Ô∏è Producto no pertenece a la remisi√≥n cargada", "#f97316");
    return false;
  }

  const pendiente = data[0].cantidad_solicitada - data[0].cantidad_escaneada;
  if (pendiente <= 0) {
    mostrarModal("üö´ Cantidad ya completa para este producto", "#ef4444");
    return false;
  }

  await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?id=eq.${data[0].id}`, {
    method: "PATCH",
    headers: {
      "apikey": API_KEY,
      "Authorization": `Bearer ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ cantidad_escaneada: data[0].cantidad_escaneada + 1 })
  });

  return true;
}

function abrirModalCantidadFraccionable(referencia, lote, contenidoQR) {
  const existente = document.getElementById("modalFraccionable");
  if (existente) existente.remove();

  // Variables globales
  window.referenciaFraccionable = referencia;
  window.loteFraccionable = lote;
  window.ultimoContenidoEscaneado = contenidoQR;
  window.fraccionesEscaneadas = [];
  window.cantidadFaltante = 0;
  window.modoExtraccionFraccionableActivo = false;

  const modal = document.createElement("div");
  modal.id = "modalFraccionable";
  modal.className = "fixed inset-0 z-950 backdrop-blur-sm bg-black/40 flex items-center justify-center";

  modal.innerHTML = `
    <div class="bg-white text-gray-800 rounded-xl p-6 w-[92%] max-w-md shadow-xl relative animate-fade-in overflow-y-auto max-h-[90vh] space-y-4">
      <button onclick="cerrarModalFraccionable()" class="absolute top-2 right-3 text-2xl font-bold text-red-600 hover:text-red-800">√ó</button>
      <h2 class="text-xl font-bold text-center">üì¶ Producto fraccionable</h2>
      <p class="text-sm text-center">Referencia: <b>${referencia}</b></p>
      <p class="text-sm text-center">Lote: <b>${lote}</b></p>

      <div class="mt-2">
        <label class="block text-sm font-semibold">Cantidad total a retirar:</label>
        <input id="inputCantidadFraccionable" type="number" min="1"
          class="w-full px-4 py-2 mt-1 rounded-md border border-gray-300 text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Ej. 10" autofocus />
      </div>

      <div class="flex justify-between mt-4">
        <button onclick="cerrarModalFraccionable()" class="bg-gray-300 hover:bg-gray-400 text-sm px-4 py-2 rounded-md">Cancelar</button>
          <button id="btnConfirmarCantidadFraccionable" onclick="(async () => {
          const cantidad = parseInt(document.getElementById('inputCantidadFraccionable').value.trim());
          if (!cantidad || cantidad <= 0) {
            mostrarModal('‚ö†Ô∏è Ingresa una cantidad v√°lida', '#f59e0b');
            return;
          }

          const permitido = await procesarExtraccionConValidacion('${referencia}', '${unidadSeleccionada}', cantidad, usuario, remisionActual);
          if (!permitido) {
            mostrarModal('‚ùå Operaci√≥n cancelada por exceso de dotaci√≥n', '#b91c1c');
            cerrarModalFraccionable();
            return;
          }

          confirmarCantidadFraccionable();  // ‚Üê si pasa validaci√≥n
        })()"
        class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2 rounded-md">Aceptar</button>

      </div>

      <div id="seccionFracciones" class="hidden mt-4 space-y-3">
        <div>
          <label class="block text-sm font-semibold">üì∑ Escanea o ingresa caja:</label>
          <input id="inputEscaneoFraccionable" type="text"
            class="w-full px-4 py-2 rounded-md border border-gray-300 text-center font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Escanea aqu√≠..." />
        </div>

        <div class="text-sm text-gray-800">
          <p><b>Piezas restantes:</b> <span id="faltanFracciones">-</span></p>
          <p><b>Cajas escaneadas:</b></p>
          <ul id="listaFracciones" class="list-disc list-inside text-gray-700 mt-1"></ul>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  setTimeout(() => {
    const input = document.getElementById("inputCantidadFraccionable");
    const btnAceptar = document.getElementById("btnConfirmarCantidadFraccionable");

    if (input && btnAceptar) {
      input.focus();
      input.value = "";
      input.addEventListener("keyup", function (e) {
        if (e.key === "Enter") btnAceptar.click();
      }, { once: true });

      btnAceptar.onclick = async () => {
        const cantidadSolicitada = parseInt(input.value);
        if (!cantidadSolicitada || cantidadSolicitada < 1) return;

        const claveRemision = `${referencia}::${unidadSeleccionada}::${document.getElementById("inputRemision")?.value.trim() || "sin_remision"}`;

        if (window.autorizacionesExceso[claveRemision]?.validado) {
            console.log("üîì PIN ya autorizado previamente para esta remisi√≥n. No se pedir√° de nuevo.");
        } else {
            const permitido = await procesarExtraccionConValidacion(referencia, unidadSeleccionada, cantidadSolicitada, usuario, remisionActual);

            if (!permitido) return;
        }

        cerrarModalFraccionable();
        iniciarModoExtraccionFraccionable(referencia, lote, contenidoQR, cantidadSolicitada);
      };
    }
  }, 100);
}


function actualizarModalFraccionable() {
  const modal = document.getElementById("modalFraccionable");
  if (!modal) return;

  // Mostrar resumen de cajas escaneadas
  let info = document.getElementById("infoFracciones");
  let lista = document.getElementById("listaFracciones");
  let faltan = document.getElementById("faltanFracciones");

  if (!info || !lista || !faltan) {
    // Si no existen a√∫n, crearlos dentro del modal
    const contenedor = document.createElement("div");
    contenedor.id = "infoFracciones";
    contenedor.className = "mt-4";

    contenedor.innerHTML = `
      <p class="text-sm mb-1 font-semibold text-center">üì¶ Cajas escaneadas:</p>
      <ul id="listaFracciones" class="text-sm list-disc list-inside text-gray-700"></ul>
      <p class="text-sm mt-2 text-center"><b>Faltan: <span id="faltanFracciones">-</span> piezas</b></p>
    `;

    modal.querySelector("div.bg-white").appendChild(contenedor);

    info = contenedor;
    lista = contenedor.querySelector("#listaFracciones");
    faltan = contenedor.querySelector("#faltanFracciones");
  }

  // Limpiar lista
  lista.innerHTML = "";

  // Agregar elementos escaneados
  fraccionesEscaneadas.forEach((f, i) => {
    const li = document.createElement("li");
    li.textContent = `Caja ${i + 1} ‚Üí ${f.usado} piezas (ID ${f.timestamp})`;
    lista.appendChild(li);
  });

  // Actualizar faltantes
  const piezasAcumuladas = fraccionesEscaneadas.reduce((sum, f) => sum + f.usado, 0);
  const piezasRestantes = Math.max(0, cantidadFaltante);
  faltan.textContent = piezasRestantes;
}


function cerrarModalFraccionable() {
  const modal = document.getElementById("modalFraccionable");
  if (modal) modal.remove();
}

async function procesarQRFraccionableSalida(referencia, lote, cantidad) {
  const payload = {
    registros: [{
      referencia,
      lote,
      cantidad,
      usuario,
      modo: "salida",
      unidad: unidadSeleccionada || null
    }]
  };
  try {
    console.log("üü† [procesarQRFraccionableSalida] Enviando fetch a registrar_qr_fraccionable:", payload);
    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_fraccionable", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    const r = result.resultados?.[0];
    console.log("üì§ [procesarQRFraccionableSalida] Respuesta Supabase:", result);
    if (r?.status === "ok") {
      qrsPendientes.push({ referencia, lote, cantidad, modo: "salida", usuario, unidad: unidadSeleccionada });
      actualizarTablaRegistros();
      mostrarModal("‚úÖ Retiro fraccionado exitoso", "#22c55e");
    } else if (r?.status === "extraido_previo") {
      mostrarModal(`‚ö†Ô∏è Producto ya fue retirado\nüë§ ${res.usuario}\nüè• ${res.unidad_destino}\nüìÖ ${res.fecha_str}`, "#facc15");
    } else if (r?.mensaje) {
      mostrarModal(`‚ö†Ô∏è ${r.mensaje}`, "#6b7280");
    } else {
      mostrarModal("‚ùå Error en el retiro", "#6b7280");
    }
  } catch (err) {
    console.error("‚ùå [procesarQRFraccionableSalida] Error:", err);
    mostrarModal("‚ùå Error de conexi√≥n", "#6b7280");
  }
}

function confirmarCantidadFraccionable() {
  const input = document.getElementById("inputCantidadFraccionable");
  const cantidad = Number(input.value?.trim());

  if (isNaN(cantidad) || cantidad <= 0) {
    mostrarModal("‚ö†Ô∏è Ingresa una cantidad v√°lida", "#f59e0b");
    return;
  }

  modoExtraccionFraccionableActivo = true;
  cantidadFaltante = cantidad;
  fraccionesEscaneadas = [];

  // Mostrar secci√≥n de escaneo
  setTimeout(() => {
    const seccion = document.getElementById("seccionFracciones");
    const lista = document.getElementById("listaFracciones");
    const faltan = document.getElementById("faltanFracciones");
    const escaneo = document.getElementById("inputEscaneoFraccionable");

    if (!seccion || !lista || !faltan || !escaneo) {
      mostrarModal("‚ùå Error interno en el modal", "#dc2626");
      return;
    }

    seccion.classList.remove("hidden");
    lista.innerHTML = "";
    faltan.textContent = cantidad;

    escaneo.focus();
    escaneo.addEventListener("keyup", function (e) {
      if (e.key === "Enter") {
        procesarCajaFraccionable(escaneo.value.trim());
        escaneo.value = "";
      }
    }, { once: false });

    if (ultimoContenidoEscaneado) {
      procesarCajaFraccionable(ultimoContenidoEscaneado);
      ultimoContenidoEscaneado = null;
  }
  }, 0); 
} 



//========================================================================================================


async function procesarExtraccionConValidacion(ref, unidadDestino, cantidadSolicitada, usuario, numeroRemision = null) {
  console.log("üîç Iniciando validaci√≥n de dotaci√≥n para:", { ref, unidadDestino, cantidadSolicitada, numeroRemision });

  const fecha = new Date();
  const mes = fecha.getMonth() + 1;
  const anio = fecha.getFullYear();
  const mesAnterior = mes === 1 ? 12 : mes - 1;
  const anioAnterior = mes === 1 ? anio - 1 : anio;

  const colA = `25_${mesAnterior}_${anioAnterior}`;
  const colB = `10_${mes}_${anio}`;

  console.log("üìÖ Columnas a consultar:", colA, colB);

  const claveRemision = `${ref}||${unidadDestino}||${numeroRemision || "sin_remision"}`;
  // Validar si ya est√° autorizada en memoria
  if (window.autorizacionesExceso?.[claveRemision]) {
    console.log("üîì PIN ya validado anteriormente para esta remisi√≥n. Se permite continuar.");
    return true;
  }

  // Validar si ya estaba autorizada en Supabase
  if (numeroRemision) {
    const resCheck = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?select=nip_verificado&numero_remision=eq.${numeroRemision}`, {
      headers: {
        apikey: API_KEY,
        Authorization: `Bearer ${API_KEY}`
      }
    });

    const remisionInfo = await resCheck.json();
    const algunaVerificada = remisionInfo?.some(r => r.nip_verificado === true);

    if (algunaVerificada) {
      console.log("üîì PIN ya estaba verificado en Supabase para esta remisi√≥n:", remisionActual);
      window.autorizacionesExceso = window.autorizacionesExceso || {};
      window.autorizacionesExceso[claveRemision] = true;
      return true;
    }
  }

  const urlConsumos = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/consumos_mensuales?select=*&referencia=eq.${ref}&unidad_medica=eq.${unidadDestino}`;
  const resConsumos = await fetch(urlConsumos, {
    headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
  });
  const registros = await resConsumos.json();
  const consumos = registros?.[0] || {};

  console.log("üì¶ Registro de consumos encontrado:", consumos);

  const consumoActual = (parseInt(consumos[colA]) || 0) + (parseInt(consumos[colB]) || 0);
  console.log("üìà Consumo actual calculado:", consumoActual);

  const urlDotacion = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/dotaciones?select=*&referencia=eq.${ref}&unidad=eq.${unidadDestino}`;
  const resDot = await fetch(urlDotacion, {
    headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
  });
  const dotacionData = await resDot.json();

  console.log("üìã Datos de dotaci√≥n encontrados:", dotacionData);

  const cantidadPermitida = parseInt(dotacionData?.[0]?.cantidad) || 0;

  const escaneadosLocalmente = qrsPendientes.filter(q =>
    q.referencia === ref && q.unidad === unidadDestino
  ).length;

  console.log("üìä Escaneados localmente:", escaneadosLocalmente);

  const consumoProyectado = consumoActual + escaneadosLocalmente + cantidadSolicitada;

  console.log("üìä Comparaci√≥n:", {
    cantidadPermitida,
    consumoActual,
    cantidadSolicitada,
    consumoProyectado
  });

  if (consumoProyectado > cantidadPermitida) {
    const modal = document.getElementById("modalPINExceso");
    const contenido = document.getElementById("contenidoPINExceso");

    // BLOQUEA ESCANEO AL ABRIR EL MODAL PIN
    bloquearEscaneoCritico({
      sonido: "https://github.com/RicardoCentrum/centrum/raw/main/losiento.mp3",
      vibrar: true
    });

    console.log("üß™ usuario en generar PIN:", usuario);
    const pinGenerado = await generarPinDinamico();
    console.log("üîê PIN din√°mico actual:", pinGenerado);

    contenido.innerHTML = `
      <p class="text-red-800 font-semibold">‚ö†Ô∏è La cantidad solicitada excede la dotaci√≥n autorizada:</p>
      <ul class="list-disc ml-6 text-sm mt-2">
        <li><strong>Referencia:</strong> ${ref}</li>
        <li><strong>Unidad destino:</strong> ${unidadDestino}</li>
        <li><strong>Dotaci√≥n mensual:</strong> ${cantidadPermitida}</li>
        <li><strong>Consumido actual:</strong> ${consumoActual}</li>
        <li><strong>Solicitado ahora:</strong> ${cantidadSolicitada}</li>
        <li class="text-red-900"><strong>Total proyectado:</strong> ${consumoProyectado} (excede)</li>
      </ul>
      <p class="mt-3 text-sm">üîê Se ha generado un PIN din√°mico. Solic√≠talo a un administrador para continuar.</p>
    `;

    console.log("üö™ Mostrando modalPINExceso");
    modal.classList.remove("hidden");
    document.getElementById("nipdinamico").value = "";
    document.getElementById("pinError").classList.add("hidden");
    document.getElementById("nipdinamico").focus();

    return new Promise((resolve) => {
      const btnConfirmar = document.getElementById("btnConfirmarPin");
      const btnCancelar = document.getElementById("btnCancelarPIN");
      const input = document.getElementById("nipdinamico");

      if (!btnConfirmar || !btnCancelar || !input) {
        console.error("‚ùå Elementos del modal no encontrados.");
        desbloquearEscaneoCritico();
        return resolve(false);
      }

      input.focus();
      input.select();

      const confirmarListener = async () => {
        try {
          const pinIngresado = input.value.trim().toUpperCase();
          console.log("üë§ Usuario actual:", usuario);
          console.log("üîê PIN ingresado:", pinIngresado);

          if (pinIngresado.length !== 6 || !/^[0-9A-F]{6}$/.test(pinIngresado)) {
            const msg = "‚ö†Ô∏è El PIN debe tener 6 caracteres hexadecimales.";
            console.warn(msg);
            document.getElementById("pinError").textContent = msg;
            document.getElementById("pinError").classList.remove("hidden");
            return;
          }

          if (!usuario) {
            console.error("‚ùå 'usuario' no est√° definido al verificar PIN.");
            document.getElementById("pinError").textContent = "‚ùå No se pudo validar el PIN. Usuario no definido.";
            document.getElementById("pinError").classList.remove("hidden");
            return;
          }

          console.log("üîç Verificando PIN para usuario:", usuario);
          const generadoPor = await detectarAdminDesdePIN(pinIngresado);
          console.log("üïµÔ∏è‚Äç‚ôÄÔ∏è PIN generado por:", generadoPor);

          const valido = !!generadoPor;
          console.log("‚úÖ Resultado de verificarPin:", valido);

          if (valido) {
            mostrarModal("‚úîÔ∏è PIN correcto. Puedes continuar.", "#16a34a");
            limpiarListeners();
            desbloquearEscaneoCritico();
            modal.classList.add("hidden");

            // Marcar como autorizado en memoria
            window.autorizacionesExceso = window.autorizacionesExceso || {};
            window.autorizacionesExceso[claveRemision] = true;
            console.log("‚úÖ Autorizaci√≥n por PIN guardada para:", claveRemision);

            // Actualizar Supabase si es una remisi√≥n v√°lida
            if (numeroRemision) {
              await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?numero_remision=eq.${numeroRemision}`, {
                method: "PATCH",
                headers: {
                  apikey: API_KEY,
                  Authorization: `Bearer ${API_KEY}`,
                  "Content-Type": "application/json",
                  Prefer: "return=minimal"
                },
                body: JSON.stringify({ nip_verificado: true })
              });
              console.log("üì• Supabase actualizado: remisi√≥n marcada como verificada");
            }

            window.pinAutorizadoPor = generadoPor;
            resolve(true);
          } else {
            console.warn("‚ùå PIN incorrecto.");
            document.getElementById("pinError").textContent = "‚ùå PIN incorrecto. Solicita uno nuevo a un administrador.";
            document.getElementById("pinError").classList.remove("hidden");
            input.value = "";
            input.focus();
          }

        } catch (err) {
          console.error("‚ùå Error en confirmarListener:", err);
          document.getElementById("pinError").textContent = "‚ùå Ocurri√≥ un error inesperado.";
          document.getElementById("pinError").classList.remove("hidden");
        }
      };

      const cancelarListener = () => {
        limpiarListeners();
        desbloquearEscaneoCritico();
        modal.classList.add("hidden");
        resolve(false);
      };

      const keyListener = (e) => {
        if (e.key === "Enter") confirmarListener();
        if (e.key === "Escape") cancelarListener();
      };

      function limpiarListeners() {
        btnConfirmar.removeEventListener("click", confirmarListener);
        btnCancelar.removeEventListener("click", cancelarListener);
        document.removeEventListener("keydown", keyListener);
      }

      btnConfirmar.addEventListener("click", confirmarListener);
      btnCancelar.addEventListener("click", cancelarListener);
      document.addEventListener("keydown", keyListener);
    });
  }

  console.log("‚úÖ Validaci√≥n superada. Se permite continuar.");
  desbloquearEscaneoCritico();
  return true;
}


async function validarDotacionAntesDeExtraer(ref, unidadDestino, cantidadSolicitada, usuario) {
  console.log("üîé Validando dotaci√≥n previa para:", { ref, unidadDestino, cantidadSolicitada });

  const fecha = new Date();
  const mes = fecha.getMonth() + 1;
  const anio = fecha.getFullYear();
  const mesAnterior = mes === 1 ? 12 : mes - 1;
  const anioAnterior = mes === 1 ? anio - 1 : anio;

  const colA = `25_${mesAnterior}_${anioAnterior}`;
  const colB = `10_${mes}_${anio}`;

  const urlConsumos = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/consumos_mensuales?select=*&referencia=eq.${ref}&unidad_medica=eq.${unidadDestino}`;
  const resConsumos = await fetch(urlConsumos, {
    headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
  });
  const registros = await resConsumos.json();
  const consumos = registros?.[0] || {};

  console.log("üì¶ Registro de consumos encontrado:", consumos);

  const sumaConsumos = (parseInt(consumos[colA]) || 0) + (parseInt(consumos[colB]) || 0);

  const urlDotacion = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/dotaciones?select=*&referencia=eq.${ref}&unidad=eq.${unidadDestino}`;
  const resDot = await fetch(urlDotacion, {
    headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
  });
  const dotacionData = await resDot.json();

  console.log("üìã Datos de dotaci√≥n encontrados:", dotacionData);

  const cantidadPermitida = parseInt(dotacionData?.[0]?.cantidad) || 0;

  console.log("üìä Comparaci√≥n:", {
    cantidadPermitida,
    sumaConsumos,
    cantidadSolicitada,
    total: sumaConsumos + cantidadSolicitada
  });

  if (sumaConsumos + cantidadSolicitada > cantidadPermitida) {
    const pin = await obtenerPin(usuario);
    mostrarModal("üîê Se requiere PIN especial para continuar", "#f87171");
    return false;
  }

  console.log("‚úÖ Dotaci√≥n dentro del l√≠mite permitido.");
  return true;
}


async function solicitarPinSilviaSiNecesario(ref, unidadDestino, cantidadSolicitada) {
  const pin = await obtenerPin(usuario, ref, unidadDestino);
  if (!autorizado) return;
// continuar extracci√≥n normal

  // Mostrar modal e instrucci√≥n
  mostrarModal("üîê Se requiere autorizaci√≥n especial. un administrador debe proporcionarte un CODIGO para continuar.", "#f87171");
  document.getElementById("nipdinamico").value = "";
  document.getElementById("nipdinamico").focus();

  return new Promise((resolve) => {
    // Asumimos que el modal tiene un bot√≥n "Confirmar PIN" con id="btnConfirmarPin"
    const btn = document.getElementById("btnConfirmarPin");

    const listener = async () => {
      const pinIngresado = document.getElementById("nipdinamico").value.trim();
      const valido = await verificarPin(usuario, pinIngresado);

      if (valido) {
        notificar("‚úîÔ∏è PIN correcto. Autorizaci√≥n concedida.", "#16a34a");
        btn.removeEventListener("click", listener);
        document.getElementById("modalPinUnidad").classList.add("hidden");
        resolve(true);
      } else {
        document.getElementById("pinError").textContent = "‚ùå PIN incorrecto. Solicita uno nuevo a Silvia.";
        document.getElementById("pinError").classList.remove("hidden");
        document.getElementById("nipdinamico").value = "";
        document.getElementById("nipdinamico").focus();
      }
    };

    btn.addEventListener("click", listener);
  });
}


async function verificarPin(pinIngresado) {
  const admins = ["Silvia", "Luis", "Aida", "Ricardo", "Alex", "Adrian"];
  const ahora = new Date();
  const clave = "medinova-secreto-2025";

  for (const admin of admins) {
    const yyyy = ahora.getUTCFullYear();
    const mm = String(ahora.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(ahora.getUTCDate()).padStart(2, "0");
    const hh = String(ahora.getUTCHours()).padStart(2, "0");
    const bloque = Math.floor(ahora.getUTCMinutes() / 10);
    const base = `${admin.toLowerCase()}::${yyyy}-${mm}-${dd}-${hh}-${bloque}::${clave}`;
    const hash = await sha256(base);
    const generado = hash.substring(0, 6).toUpperCase();

    if (generado === pinIngresado) {
      console.log("‚úÖ PIN verificado. Generado por:", admin);
      desbloquearEscaneoCritico();
      return { valido: true, generadoPor: admin };
    }
  }

  console.warn("‚ùå PIN no coincide con ning√∫n admin");
  return { valido: false, generadoPor: null };
}


//==========================================================================================================
function fp_getUsuarioString() {
  const u = window.usuarioActivo ?? window.usuario ?? "";

  // si ya es string
  if (typeof u === "string") return u.trim();

  // si es objeto, intenta campos comunes
  if (u && typeof u === "object") {
    const cand = u.usuario ?? u.username ?? u.email ?? u.nombre ?? u.id ?? "";
    return String(cand || "").trim();
  }

  return String(u || "").trim();
}
async function fp_getRepresentacionUsuario(usuario) {
  // ajusta el campo si tu tabla usuarios no usa "usuario"
  const q = `select=representacion&usuario=eq.${encodeURIComponent(usuario)}&limit=1`;
  const data = await fp_fetchRest("usuarios", q);
  const rep = data?.[0]?.representacion ?? null;
  logx("üë§[Unidad]", "Representaci√≥n usuario", { usuario, rep });
  return rep;
}

async function fp_getUnidadesByRepresentacion(rep) {
  const q = `select=unidad_medica&representacion=eq.${encodeURIComponent(rep)}&limit=5000`;
  const data = await fp_fetchRest("representaciones", q);

  const unidades = (data || [])
    .map(x => String(x.unidad_medica || "").trim())
    .filter(Boolean);

  const unique = [...new Set(unidades)].sort((a,b)=>a.localeCompare(b));
  logx("üè•[Unidad]", "Unidades por representaci√≥n", { rep, count: unique.length });
  return unique;
}
function fp_getInventarioColVigente(today = new Date()) {
  const d = today.getDate();
  let m = today.getMonth() + 1;
  let y = today.getFullYear();

  if (d >= 25) return `25_${m}_${y}`;
  if (d >= 10) return `10_${m}_${y}`;

  // si hoy < 10 ‚Üí √∫ltimo inventario fue 25 del mes anterior
  m -= 1;
  if (m <= 0) { m = 12; y -= 1; }
  return `25_${m}_${y}`;
}
window.__historicosCache = window.__historicosCache || {}; // { ref: { unidad: rowHistorico } }

async function cargarUnidadesForecast(referencia, modal) {
  const select = modal?.querySelector("#unidadForecast");
  if (!select) return;

  try {
    select.innerHTML = `<option value="TOTAL">Total (suma de consumo)</option>`;

    const usuario = fp_getUsuarioString();
    logx("üß†[Unidad]", "Usuario detectado", { raw: window.usuarioActivo ?? window.usuario, usuario });

    if (!usuario) {
      logx("‚ö†Ô∏è[Unidad]", "No hay usuario. Se queda en TOTAL.");
      return;
    }

    const rep = await fp_getRepresentacionUsuario(usuario);
    if (!rep) {
      logx("‚ö†Ô∏è[Unidad]", "Usuario sin representaci√≥n. Se queda en TOTAL.");
      return;
    }

    const unidades = await fp_getUnidadesByRepresentacion(rep);
    select.innerHTML = `
      <option value="TOTAL">Total (suma de consumo)</option>
      ${unidades.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join("")}
    `;

    // precache historicos para stock r√°pido
    window.__historicosCache[referencia] = window.__historicosCache[referencia] || {};

    // REST "in" -> unidad_medica=in.(A,B,C)
    const inList = unidades.map(u => `"${String(u).replaceAll('"','\\"')}"`).join(",");
    const q = `select=*&referencia=eq.${encodeURIComponent(referencia)}&unidad_medica=in.(${encodeURIComponent(inList)})&limit=5000`;

    logx("üì¶[Unidad]", "Precargando historicos", { referencia, unidades: unidades.length });

    // Nota: si tu PostgREST no acepta comillas as√≠, te lo ajusto en el siguiente paso.
    const rows = await fp_fetchRest("historicos", q);
    const arr = Array.isArray(rows) ? rows : [];

    const map = {};
    for (const r of arr) {
      const u = String(r.unidad_medica || r.unidad || "").trim();
      if (!u) continue;
      map[u] = r;
    }
    window.__historicosCache[referencia] = map;

    logx("‚úÖ[Unidad]", "Cache historicos listo", { referencia, rows: arr.length, keys: Object.keys(map).length });

  } catch (e) {
    logx("‚ùå[Unidad]", "Error cargarUnidadesForecast", { err: String(e?.message || e) });
  }
}
function fp_getStockUnidadDesdeCache(referencia, unidad, today = new Date()) {
  const row = window.__historicosCache?.[referencia]?.[unidad];
  if (!row) return { stock: null, col: null, fuente: "cache-miss" };

  const col = fp_getInventarioColVigente(today);
  const raw = row[col];
  const stock = Number(raw);

  logx("üì¶[Stock]", "Cache", { referencia, unidad, col, raw });

  return { stock: Number.isFinite(stock) ? stock : null, col, fuente: "cache" };
}

async function fp_getStockUnidadREST(referencia, unidad, today = new Date()) {
  const col = fp_getInventarioColVigente(today);

  const q = `select=${encodeURIComponent(col)}&referencia=eq.${encodeURIComponent(referencia)}&unidad_medica=eq.${encodeURIComponent(unidad)}&limit=1`;
  const data = await fp_fetchRest("historicos", q);

  const raw = data?.[0]?.[col];
  const stock = Number(raw);

  logx("üì¶[Stock]", "REST", { referencia, unidad, col, raw, stock });

  return { stock: Number.isFinite(stock) ? stock : 0, col, fuente: "rest" };
}

async function fp_getStockCentralProducto(referencia) {
  const q = `select=stock&referencia=eq.${encodeURIComponent(referencia)}&limit=1`;
  const data = await fp_fetchRest("productos", q);
  const stock = Number(data?.[0]?.stock ?? 0) || 0;

  logx("üè¨[Stock]", "Central productos.stock", { referencia, stock });

  return { stock, fuente: "productos" };
}
// ‚úÖ Cargar unidades del SELECT (por representaci√≥n)
cargarUnidadesForecast(referencia, modal);

// ‚úÖ Cuando cambie la unidad, refresca (si ya tienes refreshNow, √∫salo)
modal.querySelector("#unidadForecast")?.addEventListener("change", () => {
  logx("üîÅ[Unidad]", "Cambio de unidad", { unidad: modal.querySelector("#unidadForecast")?.value });
  // llama tu refreshNow() / cargarForecastPro(referencia)
});



// =====================
// ‚úÖ CACHE GLOBAL (desde el inicio)
// =====================
window.referenciasCache = window.referenciasCache || [];
window.referenciasCacheReady = window.referenciasCacheReady || false;

// =====================
// ‚úÖ Fetch REST helper (con logs)
// =====================
async function fp_fetchRest(path, query = "") {
  const url = `${window.SUPABASE_URL}/rest/v1/${path}${query ? `?${query}` : ""}`;
  logx("üåê[REST]", "GET", { url });

  const res = await fetch(url, {
    headers: {
      apikey: window.SUPABASE_KEY,
      Authorization: `Bearer ${window.SUPABASE}`
    }
  });

  const text = await res.text().catch(() => "");
  logx("üåê[REST]", "RESP", { ok: res.ok, status: res.status, bytes: text.length });

  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = null; }
  if (!res.ok) throw new Error(`REST ${res.status}: ${text.slice(0, 180)}`);

  return data;
}

// =====================
// ‚úÖ Cargar referencias (con logs)
// =====================
async function cargarReferencias() {
  try {
    window.referenciasCacheReady = false;
    logx("üì¶[Refs]", "Cargando referencias...");

    const data = await fp_fetchRest(
      "productos",
      "select=referencia,nombre,fabricante,lote,caducidad,cantidad&limit=50000"
    );

    window.referenciasCache = Array.isArray(data) ? data : [];
    window.referenciasCacheReady = true;

    logx("‚úÖ[Refs]", "Cache listo", { count: window.referenciasCache.length });
  } catch (e) {
    window.referenciasCacheReady = false;
    logx("‚ùå[Refs]", "Error cargando referencias", { err: String(e?.message || e) });
  }
}

// =====================
// ‚úÖ Buscar (NO redeclarar cache local)
// =====================
function buscarReferencia(valor) {
  const cont = document.getElementById("resultadoBusqueda");
  if (!cont) return;

  if (!window.referenciasCacheReady) {
    cont.innerHTML = "<p class='text-gray-500'>Cargando referencias...</p>";
    logx("‚è≥[Refs]", "A√∫n no listo. Ignorando b√∫squeda.", { valor });
    return;
  }

  const cache = window.referenciasCache;
  const q = String(valor || "").trim().toLowerCase();

  if (!q) {
    cont.innerHTML = "<p class='text-gray-500'>Escribe para buscar...</p>";
    return;
  }

  logx("üîé[Refs]", "Buscando", { q, cache: cache.length });
  mostrarResultadosCoincidencias(q, cache, cont);
}

// =====================
// ‚úÖ L√°nzalo al iniciar
// =====================
window.addEventListener("DOMContentLoaded", () => {
  // Si ya la llamas en otro lado, no la dupliques.
  cargarReferencias();
});



async function mostrarResultadosCoincidencias(ref, referenciasCache, cont) {
  const q = String(ref || "").trim().toLowerCase();

  const coincidencias = (referenciasCache || []).filter(p =>
    String(p.referencia || "").toLowerCase().includes(q) ||
    String(p.nombre || "").toLowerCase().includes(q)
  );

  if (!coincidencias.length) {
    cont.innerHTML = `
      <div class="space-card rounded-2xl p-4 border border-white/10 bg-white/5">
        <p class="text-sm text-rose-200 font-semibold">‚ùå Producto no encontrado</p>
        <p class="text-xs text-white/60 mt-1">Intenta otra referencia o parte del nombre.</p>
      </div>
    `;
    return;
  }

  // Agrupa por referencia real
  const agrupadas = {};
  coincidencias.forEach(p => {
    const key = String(p.referencia || "").trim();
    if (!agrupadas[key]) agrupadas[key] = [];
    agrupadas[key].push(p);
  });

  let html = "";

  Object.entries(agrupadas).forEach(([refReal, lotes]) => {
    const data = lotes[0] || {};
    const nombre = String(data.nombre || "");
    const fabricante = String(data.fabricante || "");

    html += `
      <div id="grupo-${escapeHtml(refReal)}" class="space-card rounded-2xl p-4 border border-white/10 bg-white/5 shadow-xl mb-4">
        
        <!-- Header clickable -->
        <div
          class="rounded-2xl px-3 py-3 hover:bg-white/10 transition cursor-pointer flex items-start justify-between gap-3"
          onclick="aislarGrupo('${escapeJs(refReal)}')"
          role="button"
          tabindex="0"
        >
          <div class="min-w-0 text-left">
            <div class="font-extrabold text-base text-white/90 break-words">
              ${escapeHtml(refReal)}
              <span class="font-bold text-white/70">(${escapeHtml(nombre)})</span>
            </div>
            <div class="text-xs text-white/60 mt-0.5">
              Fabricante: <span class="text-white/80">${escapeHtml(fabricante || "‚Äî")}</span>
            </div>
          </div>

          <!-- Acciones (NO disparan el click del header) -->
          <div class="flex items-center gap-2 shrink-0">
            <button
              type="button"
              onclick="event.stopPropagation(); verMovimientos('${escapeJs(refReal)}')"
              title="Ver movimientos"
              class="space-btn px-3 py-2 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 text-white/90"
            >üìö</button>

            <button
              type="button"
              onclick="event.stopPropagation(); verForecast('${escapeJs(refReal)}', '${escapeJs(nombre)}', '${escapeJs(fabricante)}')"
              title="Ver historial de consumo"
              class="space-btn px-3 py-2 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 text-white/90"
            >üìä</button>
          </div>
        </div>

        <!-- Tabla -->
        <div class="mt-3 rounded-2xl overflow-hidden border border-white/10">
          <table class="w-full text-xs text-left">
            <thead class="bg-black/30 text-white/90">
              <tr>
                <th class="p-2">Lote</th>
                <th class="p-2 text-right">Cantidad</th>
                <th class="p-2">Caducidad</th>
                <th class="p-2 text-center">‚ö†Ô∏è</th>
              </tr>
            </thead>
            <tbody class="bg-white/5 text-white/85">
              ${lotes.map(l => {
                const dias = calcularDiasRestantes(l.caducidad);
                let icono = "‚ùó";
                let badge = "bg-amber-400/15 text-amber-100 border-amber-300/20";
                if (dias <= 30) { icono = "‚ùó‚ùó‚ùó"; badge = "bg-rose-500/15 text-rose-100 border-rose-300/20"; }
                else if (dias <= 60) { icono = "‚ùó‚ùó"; badge = "bg-amber-500/15 text-amber-100 border-amber-300/20"; }
                else { badge = "bg-emerald-500/10 text-emerald-100 border-emerald-300/20"; }

                return `
                  <tr class="border-t border-white/10">
                    <td class="p-2">${escapeHtml(l.lote ?? "")}</td>
                    <td class="p-2 text-right">${Number(l.cantidad ?? 0)}</td>
                    <td class="p-2">${escapeHtml(normalizarFechaExcel(l.caducidad))}</td>
                    <td class="p-2 text-center">
                      <span class="inline-flex items-center justify-center px-2 py-1 rounded-xl border ${badge}"
                            title="D√≠as restantes: ${Number.isFinite(dias) ? dias : "‚Äî"}">
                        ${icono}
                      </span>
                    </td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        </div>

      </div>
    `;
  });

  cont.innerHTML = html;
}

/** Helpers seguros */
function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function escapeJs(str) {
  // Para meter strings dentro de atributos onclick='...'
  return String(str ?? "")
    .replaceAll("\\", "\\\\")
    .replaceAll("'", "\\'")
    .replaceAll('"', '\\"')
    .replaceAll("\n", "\\n")
    .replaceAll("\r", "\\r");
}
// ‚úÖ Al cargar la p√°gina, carga los productos
window.addEventListener("DOMContentLoaded", cargarReferencias);

function ajustarMesLogico(timestamp) {
  const fecha = new Date(Number(timestamp));
  const mes = fecha.getMonth();
  return fecha.getDate() >= 25 ? mes + 1 : mes;
}

  function agregarFila(ref, lote, estado) {
    const tabla = document.getElementById("tablaRegistros");
    const contenedor = document.getElementById("tablaContenedora");

    // Asegura que el contenedor est√© visible
    contenedor.classList.remove("hidden");
    setTimeout(() => contenedor.classList.remove("opacity-0"), 10);

    // Crea la fila
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td class='p-1'>${ref}</td>
      <td class='p-1'>${lote}</td>
      <td class='p-1'>${estado}</td>
      <td class='p-1 text-center'><button onclick='eliminarFila(this)' class='text-red-600'>‚úñ</button></td>
    `;
    tabla.appendChild(fila);
  }


function mostrarMenuModo() {
  // Evitar duplicados
  const existente = document.querySelector(".modal-modo");
  if (existente) existente.remove();

  const contenedor = document.createElement("div");
  contenedor.className = "modal-modo fixed inset-0 z-50 flex items-center justify-center blur-fondo";

  contenedor.innerHTML = `
    <div class="panel-hipotesis rounded-3xl p-6 w-[90%] max-w-sm text-white shadow-2xl">
      
      <div class="flex justify-between items-start mb-4">
        <h2 class="fuente-magma text-xl tracking-wider">
          Selecciona el modo
        </h2>
        <button
          onclick="this.closest('.modal-modo').remove()"
          class="text-red-900 hover:text-red-600 text-xl font-bold">
          √ó
        </button>
      </div>

      <div class="flex flex-col gap-3">

        <!-- ENTRADA -->
        <button
          onclick="solicitarPinModo('entrada', this)"
          class="rounded-2xl py-3 font-semibold text-white shadow-lg
                 bg-gradient-to-r from-green-900/80 to-emerald-700/60
                 hover:from-green-700/80 hover:to-emerald-900/60
                 transition backdrop-blur">
          üì• Modo Entrada
        </button>

        <!-- SALIDA -->
        <button
          onclick="solicitarPinModo('salida', this)"
          class="rounded-2xl py-3 font-semibold text-white shadow-lg
                 bg-gradient-to-r from-red-900/80 to-rose-700/60
                 hover:from-red-900/80 hover:to-rose-900/60
                 transition backdrop-blur">
          üì§ Modo Salida
        </button>

        <!-- CANCELAR -->
        <button
          onclick="this.closest('.modal-modo').remove()"
          class="rounded-2xl py-2 text-sm font-semibold
                 bg-white/10 hover:bg-white/20
                 border border-white/10 transition">
          Cancelar
        </button>

      </div>
    </div>
  `;

  document.body.appendChild(contenedor);

  // Cerrar al hacer click fuera
  contenedor.addEventListener("click", (e) => {
    if (e.target === contenedor) contenedor.remove();
  });
}


let nipAdmin = null;

function solicitarPinModo(tipo, boton) {
  // --- LOGS ---
  console.log("[UI][modo] solicitarPinModo()", { tipo });

  // Cierra el men√∫ flotante de modo (si existe)
  const modalAnterior = boton?.closest?.(".modal-modo");
  if (modalAnterior) modalAnterior.remove();

  // Estado
  modoSeleccionado = tipo;
  unidadSeleccionada = null;

  // Inputs
  const inputNIP = document.getElementById("inputNIP");
  const inputUnidad = document.getElementById("inputUnidad");
  const inputRemision = document.getElementById("inputRemision");
  const pinError = document.getElementById("pinError");

  if (inputNIP) inputNIP.value = "";
  if (inputUnidad) inputUnidad.value = "";
  if (inputRemision) inputRemision.value = "";
  if (pinError) pinError.classList.add("hidden");

  // Grupos
  const unidadGroup = document.getElementById("unidadDestinoGroup");
  const remisionGroup = document.getElementById("remisionGroup");
  const bloqueCargaRemision = document.getElementById("bloqueCargaRemision");

  const esSalida = (tipo === "salida");
  if (unidadGroup) unidadGroup.classList.toggle("hidden", !esSalida);
  if (remisionGroup) remisionGroup.classList.toggle("hidden", !esSalida);
  if (bloqueCargaRemision) bloqueCargaRemision.classList.toggle("hidden", !esSalida);

  // Mostrar modal SIEMPRE centrado (hidden -> flex)
  const modal = document.getElementById("modalPinUnidad");
  if (!modal) {
    console.warn("[UI][modo] No existe #modalPinUnidad");
    return;
  }

  modal.classList.remove("hidden");
  modal.classList.add("flex"); // ‚úÖ CLAVE para que items-center/justify-center funcionen

  // Focus seguro (despu√©s de pintar)
  requestAnimationFrame(() => {
    inputNIP?.focus?.();
    console.log("[UI][modo] modalPinUnidad abierto", { esSalida });
  });
}



// üîë Manejador general de Enter para todos los campos:
["inputNIP", "inputUnidad", "inputRemision"].forEach(id => {
  document.getElementById(id).addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      if (id === "inputNIP") {
        const unidadGroup = document.getElementById("unidadDestinoGroup");
        if (!unidadGroup.classList.contains("hidden")) {
          document.getElementById("inputUnidad").focus();
        } else {
          validarPinYUnidad();
        }
      } else if (id === "inputUnidad") {
        const remisionGroup = document.getElementById("remisionGroup");
        if (!remisionGroup.classList.contains("hidden")) {
          document.getElementById("inputRemision").focus();
        } else {
          validarPinYUnidad();
        }
      } else {
        validarPinYUnidad();
      }
    }
  });
});

function cerrarModalPin() {
  document.getElementById("modalPinUnidad").classList.add("hidden");
}



async function enviarModoInventario() {
  try {
    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/modo_inventario", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ usuario })  // env√≠as solo el usuario
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Error en modo inventario");

    mostrarModal("üì¶ Modo INVENTARIO completado correctamente", "#22c55e");
  } catch (e) {
    console.error("‚ùå Error en modo inventario:", e);
    mostrarModal("‚ùå Error al ejecutar modo INVENTARIO", "#dc2626");
  }

  document.getElementById("modalInventario").classList.add("hidden");
}

function mostrarCambioNIP() {
  cerrarModalOpcionesAdmin(); // Asegura que el anterior se cierre
  document.getElementById("modalCambioNIP").classList.remove("hidden");
}

function cerrarCambioNIP() {
  document.getElementById("modalCambioNIP").classList.add("hidden");
}
async function guardarNuevoNIP() {
  const nipAntiguo = document.getElementById("nipAntiguo").value.trim();
  const nipNuevo = document.getElementById("nipNuevo").value.trim();
  const confirmar = document.getElementById("nipConfirmar").value.trim();
  const error = document.getElementById("cambioNipError");

  if (!nipAntiguo || !nipNuevo || nipNuevo !== confirmar) {
    error.textContent = "‚ùå Los NIPs no coinciden o est√°n vac√≠os.";
    error.classList.remove("hidden");
    return;
  }

  if (nipAntiguo === nipNuevo) {
    error.textContent = "‚ùå El nuevo NIP no puede ser igual al actual.";
    error.classList.remove("hidden");
    return;
  }

  try {
    const payload = {
      nip_admin: nipAntiguo,
      nombre: usuario,
      nuevo_nip: nipNuevo,
      nuevas_unidades: []  // No se cambia ninguna unidad aqu√≠
    };

    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/actualizar_nip", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      notificar("‚úÖ NIP actualizado correctamente", "#047857");
      cerrarCambioNIP();
    } else {
      error.textContent = "‚ùå Error al actualizar NIP.";
      error.classList.remove("hidden");
    }
  } catch (e) {
    error.textContent = "‚ùå Error de red al guardar NIP.";
    error.classList.remove("hidden");
  }
}
async function restablecerNIPUsuario() {
  const nombreUsuario = prompt("Nombre EXACTO del usuario que deseas restablecer:");
  if (!nombreUsuario) {
    notificar("‚ùå Debes ingresar un nombre", "#dc2626");
    return;
  }

  const nipAdmin = prompt("NIP del administrador que autoriza:");
  if (!nipAdmin) {
    notificar("‚ùå NIP de administrador requerido", "#dc2626");
    return;
  }

  const nuevoNip = prompt("Nuevo NIP para ese usuario:");
  if (!nuevoNip || nuevoNip.length !== 4) {
    notificar("‚ùå NIP inv√°lido (debe ser de 4 d√≠gitos)", "#dc2626");
    return;
  }

  const payload = {
    nip_admin: nipAdmin,
    nombre: nombreUsuario,
    nuevo_nip: nuevoNip,
    nuevas_unidades: [] // sin cambios de unidades
  };

  try {
    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/actualizar_nip", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      notificar("‚úÖ NIP restablecido correctamente", "#16a34a");
    } else {
      const json = await res.json();
      notificar("‚ùå Error al restablecer: " + json.error, "#dc2626");

    }
  } catch (err) {
    notificar("‚ùå Error de red", "#dc2626");
  }
}
function actualizarBotonModo(texto, claseColor, icono) {
  const modo = (texto || "").toLowerCase();

  const btn = document.getElementById("btnModo");
  const contenedor = document.getElementById("estadoUsuario");
  const label = document.getElementById("modoLabel");
  const usuarioTxt = document.getElementById("usuarioActivo"); // <-- este s√≠ existe en tu HTML

  // ====== helpers ======
  const resetBtn = () => {
    if (!btn) return;
    btn.className =
      "px-4 py-2 rounded-2xl text-white text-sm font-semibold shadow-lg " +
      "border border-white/10 bg-white/5 hover:bg-white/10 transition " +
      "backdrop-blur-xl";
  };

  const resetContenedor = () => {
    if (!contenedor) return;
    contenedor.className =
      "cursor-pointer mb-2 px-4 py-4 rounded-2xl text-center shadow-xl transition " +
      "border border-white/10 bg-white/5 hover:bg-white/10 backdrop-blur-xl";
  };

  const resetLabel = () => {
    if (!label) return;
    label.className =
      "inline-flex items-center gap-2 font-bold px-3 py-1 rounded-2xl text-white text-sm " +
      "border border-white/10 backdrop-blur-xl";
  };

  // Siempre resetea a estilo espacial base
  resetBtn();
  resetContenedor();
  resetLabel();

  // Si existe btnModo, aplica texto
  if (btn) btn.innerHTML = `${icono || "üîí"} Modo ${texto || "Inactivo"}`;

  // Si faltan elementos, sal
  if (!contenedor || !label) return;

  // ====== Aplica estilos por modo ======
  if (modo === "entrada") {
    // Bot√≥n superior (si lo usas)
    if (btn) {
      btn.classList.add(
        "bg-gradient-to-r", "from-emerald-900/80", "to-teal-800/60",
        "hover:from-emerald-800/80", "hover:to-teal-700/60",
        "shadow-emerald-500/20"
      );
    }

    // Tarjeta estadoUsuario
    contenedor.classList.add(
      "bg-gradient-to-r", "from-emerald-800/35", "to-teal-900/20",
      "hover:from-emerald-900/45", "hover:to-teal-900/30",
      "text-emerald-100"
    );

    // Label
    label.classList.add(
      "bg-emerald-500/15",
      "border-emerald-400/25",
      "text-emerald-100"
    );

    label.textContent = "ENTRADA";
    if (usuarioTxt && (!usuarioTxt.textContent || usuarioTxt.textContent.includes("Selecciona"))) {
      usuarioTxt.textContent = "Modo activo: Entrada";
    }
    return;
  }

  if (modo === "salida") {
    if (btn) {
      btn.classList.add(
        "bg-gradient-to-r", "from-rose-900/80", "to-red-800/60",
        "hover:from-rose-800/80", "hover:to-red-900/60",
        "shadow-rose-500/20"
      );
    }

    contenedor.classList.add(
      "bg-gradient-to-r", "from-rose-900/35", "to-red-900/20",
      "hover:from-rose-900/45", "hover:to-red-900/30",
      "text-rose-100"
    );

    label.classList.add(
      "bg-rose-500/15",
      "border-rose-400/25",
      "text-rose-100"
    );

    label.textContent = "SALIDA";
    if (usuarioTxt && (!usuarioTxt.textContent || usuarioTxt.textContent.includes("Selecciona"))) {
      usuarioTxt.textContent = "Modo activo: Salida";
    }
    return;
  }

  // ====== INACTIVO ======
  if (btn) {
    btn.classList.add(
      "bg-gradient-to-r", "from-slate-900/70", "to-gray-800/50",
      "hover:from-slate-800/70", "hover:to-gray-700/50",
      "shadow-white/10"
    );
    btn.innerHTML = `üîí Modo Inactivo`;
  }

  contenedor.classList.add(
    "bg-gradient-to-r", "from-white/8", "to-white/4",
    "hover:from-white/10", "hover:to-white/6",
    "text-white/85"
  );

  label.classList.add(
    "bg-white/10",
    "border-white/15",
    "text-white/90"
  );

  label.textContent = "INACTIVO";
  if (usuarioTxt) usuarioTxt.textContent = "Selecciona un modo para iniciar";
}

function agregarFila(ref, lote, estado) {
    const tabla = document.getElementById("tablaRegistros");
    const contenedor = document.getElementById("tablaContenedora");

    // Asegura que el contenedor est√© visible
    contenedor.classList.remove("hidden");
    setTimeout(() => contenedor.classList.remove("opacity-0"), 10);

    // Crea la fila
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td class='p-1'>${ref}</td>
      <td class='p-1'>${lote}</td>
      <td class='p-1'>${estado}</td>
      <td class='p-1 text-center'><button onclick='eliminarFila(this)' class='text-red-600'>‚úñ</button></td>
    `;
    tabla.appendChild(fila);
  }

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js">function agregarFila(ref, lote, estado) {
    const tabla = document.getElementById("tablaRegistros");
    const contenedor = document.getElementById("tablaContenedora");

    // Asegura que el contenedor est√© visible
    contenedor.classList.remove("hidden");
    setTimeout(() => contenedor.classList.remove("opacity-0"), 10);

    // Crea la fila
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td class='p-1'>${ref}</td>
      <td class='p-1'>${lote}</td>
      <td class='p-1'>${estado}</td>
      <td class='p-1 text-center'><button onclick='eliminarFila(this)' class='text-red-600'>‚úñ</button></td>
    `;
    tabla.appendChild(fila);
  }

</script>
<script>
  //#region 888888888888888888888888888888888888888888888888888888888888888888 FORECAST 88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
// ====================== REGRESI√ìN + FORECAST (CORREGIDO Y COHERENTE) ======================

// ‚úÖ EDITA AQU√ç el horizonte default (6 meses)
// window.FORECAST_DEFAULT_HORIZON = 6;  // üëà Default 6 meses
// window.FORECAST_DEFAULT_MERMA_PCT = 5; // üëà Merma default
// window.FORECAST_DEFAULT_MODELO = "auto"; // auto | arimax | xgboost | ensemble
// Instancias globales de charts
window.graficaForecastInstance = window.graficaForecastInstance || null;
window.graficaForecastProInstance = window.graficaForecastProInstance || null;
window.graficaEscenarioCompareInstance = window.graficaEscenarioCompareInstance || null;

// ---------- Utils ----------
function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function wait2Frames() {
  return new Promise((r) => requestAnimationFrame(() => requestAnimationFrame(r)));
}

async function ensureChartJs() {
  if (window.Chart) return true;
  await new Promise((resolve, reject) => {
    const s = document.createElement("script");
    s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
  return !!window.Chart;
}
function syncVol(v) {
  let val = Number(v);

  // permite escribir "-" temporalmente sin romper
  if (Number.isNaN(val)) return;

  val = Math.max(-100, Math.min(300, val));

  const r = document.getElementById("factorVolForecast");
  const n = document.getElementById("factorVolForecastNum");

  if (r) r.value = String(val);
  if (n) n.value = String(val);
}

function fixCanvasSize(id, h = 320) {
  const c = document.getElementById(id);
  if (!c) return;
  c.style.display = "block";
  c.style.width = "100%";
  c.style.height = `${h}px`;
  c.height = h;
}
async function cargarUnidadesForecast(referencia, modal) {
  const selectUnidad = modal?.querySelector("#unidadForecast");
  if (!selectUnidad) return;

  console.log("üß† [Unidad] Cargando unidades desde historicos para ref:", referencia);

  // 1) Trae filas de historicos que existan para esa referencia
  const { data, error } = await supabase
    .from("historicos")
    .select("*")
    .eq("referencia", referencia);

  if (error) {
    console.error("‚ùå historicos query error:", error);
    return;
  }

  const rows = Array.isArray(data) ? data : [];
  console.log("‚úÖ [Unidad] Filas historicos encontradas:", rows.length);

  // Cache por referencia: { unidad -> row }
  const byUnidad = {};
  for (const r of rows) {
    const u = (r.unidad || r.unidad_medica || r.almacen || "").trim();
    if (!u) continue;
    byUnidad[u] = r;
  }
  window.__historicosCache[referencia] = byUnidad;

  // 2) Render options
  const unidades = Object.keys(byUnidad).sort((a,b)=>a.localeCompare(b));
  selectUnidad.innerHTML = `
    <option value="TOTAL">Total (suma de consumo)</option>
    ${unidades.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join("")}
  `;

  console.log("üßæ [Unidad] Unidades cargadas:", unidades);

  // opcional: si solo hay 1 unidad, autoselecciona
  if (unidades.length === 1) {
    selectUnidad.value = unidades[0];
    console.log("üéØ [Unidad] Auto-select:", unidades[0]);
  }
}
function pickUltimaColInventario(row, today = new Date()) {
  if (!row) return { col: null, date: null };

  // columnas candidatas: "10_5_2025", "25_5_2025", etc.
  const cols = Object.keys(row).filter(k => /^\d{1,2}_\d{1,2}_\d{4}$/.test(k));
  if (!cols.length) return { col: null, date: null };

  const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();

  let best = null;
  let bestT = -Infinity;

  for (const c of cols) {
    const [corteS, mesS, anioS] = c.split("_");
    const corte = Number(corteS);
    const mes = Number(mesS);
    const anio = Number(anioS);
    if (!Number.isFinite(corte) || !Number.isFinite(mes) || !Number.isFinite(anio)) continue;

    // fecha del corte
    const dt = new Date(anio, mes - 1, corte);
    const tt = dt.getTime();
    if (tt <= t0 && tt > bestT) {
      bestT = tt;
      best = c;
    }
  }

  return { col: best, date: best ? new Date(bestT) : null };
}
function getStockUnidadDesdeHistoricos(referencia, unidad, today = new Date()) {
  const cache = window.__historicosCache?.[referencia];
  const row = cache?.[unidad];

  if (!row) {
    console.warn("‚ö†Ô∏è [Stock] No hay fila en historicos para", { referencia, unidad });
    return { stock: null, col: null };
  }

  const { col } = pickUltimaColInventario(row, today);
  if (!col) {
    console.warn("‚ö†Ô∏è [Stock] No encontr√© columna de inventario v√°lida para", { referencia, unidad });
    return { stock: null, col: null };
  }

  const raw = row[col];
  const stock = Number(raw);

  console.log("üì¶ [Stock] Unidad:", unidad, "col:", col, "raw:", raw, "stock:", stock);

  return { stock: Number.isFinite(stock) ? stock : null, col };
}
// ===================== Forecast PRO Helpers =====================

function getSB() {
  // Ajusta si tu cliente se llama distinto
  return window.supabase || supabase;
}

function fpNowISO() {
  return new Date().toISOString();
}

function fpLog(msg, obj) {
  try {
    console.log(`üß™[ForecastPRO] ${msg}`, obj ?? "");
    const box = document.getElementById("logsForecast");
    if (box) {
      const line = `[${fpNowISO()}] ${msg}` + (obj ? ` :: ${JSON.stringify(obj)}` : "");
      box.textContent = (line + "\n" + (box.textContent || "")).slice(0, 5000);
    }
  } catch {}
}

// Devuelve la columna 10_m_y o 25_m_y m√°s reciente <= fecha
function getLatestInventarioCol(fecha = new Date()) {
  const d = new Date(fecha);
  const day = d.getDate();
  let m = d.getMonth() + 1;
  let y = d.getFullYear();

  // Si hoy < 10, lo m√°s reciente fue 25 del mes anterior
  if (day < 10) {
    m -= 1;
    if (m <= 0) { m = 12; y -= 1; }
    return `25_${m}_${y}`;
  }

  // Si 10 <= hoy < 25 ‚Üí corte 10 del mes actual
  if (day < 25) return `10_${m}_${y}`;

  // Si hoy >= 25 ‚Üí corte 25 del mes actual
  return `25_${m}_${y}`;
}

// Obtiene representacion del usuario desde tabla usuarios
async function getUserRepresentacion(usuarioIdOrNombre) {
  const sb = getSB();
  fpLog("Buscando representaci√≥n del usuario‚Ä¶", { usuario: usuarioIdOrNombre });

  // ‚ö†Ô∏è Ajusta el campo de b√∫squeda seg√∫n tu tabla:
  // - si guardas usuario por "usuario" o por "email" o por "id"
  // aqu√≠ uso "usuario" como ejemplo.
  const { data, error } = await sb
    .from("usuarios")
    .select("representacion")
    .eq("usuario", usuarioIdOrNombre)
    .maybeSingle();

  if (error) {
    fpLog("‚ùå Error usuarios.representacion", { error });
    throw error;
  }
  const rep = data?.representacion || null;
  fpLog("Representaci√≥n obtenida", { rep });
  return rep;
}

// Obtiene lista de unidades m√©dicas de la representaci√≥n
async function getUnidadesByRepresentacion(representacion) {
  const sb = getSB();
  fpLog("Cargando unidades por representaci√≥n‚Ä¶", { representacion });

  const { data, error } = await sb
    .from("representaciones")
    .select("unidad_medica")
    .eq("representacion", representacion);

  if (error) {
    fpLog("‚ùå Error representaciones", { error });
    throw error;
  }

  const unidades = (data || [])
    .map(r => String(r.unidad_medica || "").trim())
    .filter(Boolean);

  const unique = [...new Set(unidades)].sort((a,b)=>a.localeCompare(b));
  fpLog("Unidades encontradas", { count: unique.length, unique });
  return unique;
}

// Stock central (almac√©n) desde productos
async function getStockCentralProducto(referencia) {
  const sb = getSB();

  // ‚ö†Ô∏è Ajusta el nombre real de la columna stock si no es "stock"
  const { data, error } = await sb
    .from("productos")
    .select("stock")
    .eq("referencia", referencia)
    .maybeSingle();

  if (error) {
    fpLog("‚ùå Error productos.stock", { error });
    throw error;
  }

  const stock = Number(data?.stock ?? 0) || 0;
  fpLog("Stock central obtenido", { referencia, stock });
  return stock;
}

// Stock de unidad desde historicos: fila (unidad+referencia) y columna (inventario)
async function getStockUnidadHistoricos(unidad_medica, referencia, fecha = new Date()) {
  const sb = getSB();
  const col = getLatestInventarioCol(fecha);

  fpLog("Buscando stock de unidad en historicos‚Ä¶", { unidad_medica, referencia, col });

  // ‚ö†Ô∏è Ajusta nombres de campos si tu tabla usa otros:
  // aqu√≠ asumo: historicos.unidad_medica y historicos.referencia
  const { data, error } = await sb
    .from("historicos")
    .select(col)
    .eq("unidad_medica", unidad_medica)
    .eq("referencia", referencia)
    .maybeSingle();

  if (error) {
    fpLog("‚ùå Error historicos (select col din√°mica)", { error, col });
    throw error;
  }

  const stock = Number(data?.[col] ?? 0) || 0;
  fpLog("Stock unidad obtenido", { unidad_medica, referencia, col, stock });
  return { stock, col };
}

// ---------- UI: Modal Forecast PRO ----------
function verForecast(referencia, nombre = "", fabricante = "") {
  const anterior = document.getElementById("modalForecast");
  if (anterior) anterior.remove();

  document.documentElement.classList.add("overflow-hidden");
  document.body.classList.add("overflow-hidden");

  const modal = document.createElement("div");
  modal.id = "modalForecast";
  modal.className =
    "fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/70 backdrop-blur-sm";

  modal.innerHTML = `
    <div class="
      panel-hipotesis
      w-[96%] sm:w-[95%] sm:max-w-6xl
      rounded-t-3xl sm:rounded-3xl
      p-4 sm:p-6
      text-white shadow-2xl
      max-h-[92dvh] sm:max-h-[95vh]
      overflow-hidden
      relative
    ">

      <!-- Header -->
      <div class="flex items-start justify-between gap-4 pb-3 border-b border-white/10">
        <div class="min-w-0">
          <h2 class="text-xl sm:text-2xl font-bold fuente-magma tracking-wider">
            Forecast PRO
          </h2>
          <p class="text-xs sm:text-sm text-white/70 mt-1 break-words">
            <span class="text-white/90 font-semibold">${escapeHtml(nombre || referencia)}</span>
            ${fabricante ? `<span class="text-white/50"> ‚Ä¢ ${escapeHtml(fabricante)}</span>` : ""}
          </p>
        </div>

        <button type="button" id="btnCerrarForecast"
          class="shrink-0 w-10 h-10 grid place-items-center rounded-2xl
                 bg-white/5 border border-white/10
                 text-red-900 hover:text-red-700 text-2xl font-bold">
          √ó
        </button>
      </div>

      <!-- Tabs -->
      <div class="mt-3 sticky top-0 z-20 bg-black/60 backdrop-blur-md rounded-2xl border border-white/10">
        <div class="flex gap-2 p-2 overflow-x-auto">
          ${["resumen","modelos","escenarios","evidencia","entregas","logs"].map((k,i)=>`
            <button type="button"
              class="tab-btn ${i===0?"bg-white/10 text-white":"bg-white/5 text-white/70"} px-3 py-2 rounded-2xl border border-white/10 hover:bg-white/10 whitespace-nowrap"
              data-tab="${k}">
              ${({
                resumen:"üìå Resumen",
                modelos:"üß† Modelos",
                escenarios:"üß™ Escenarios",
                evidencia:"üßæ Evidencia",
                entregas:"üì¶ Entregas",
                logs:"üß∑ Logs"
              })[k]}
            </button>
          `).join("")}
        </div>
      </div>

      <!-- Body -->
      <div class="pt-4 overflow-y-auto pr-1 max-h-[calc(92dvh-150px)] sm:max-h-[calc(95vh-170px)]">

        <!-- Controls (comunes) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4 items-end">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <label class="block text-sm font-semibold text-white/80">Unidad</label>
            <select id="unidadForecast"
              class="mt-2 w-full px-3 py-2 rounded-2xl bg-black/30 border border-white/10
                     text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
              <option value="TOTAL">Total (suma de consumo)</option>
            </select>
            <p class="text-xs text-white/50 mt-2">Cambia unidad para recalcular.</p>
          </div>

          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <label class="block text-sm font-semibold text-white/80">Horizonte</label>
            <select id="horizonForecast"
              class="mt-2 w-full px-3 py-2 rounded-2xl bg-black/30 border border-white/10 text-white">
              <option value="3">3 meses</option>
              <option value="6" selected>6 meses</option>
              <option value="12">12 meses</option>
            </select>
            <p class="text-xs text-white/50 mt-2">Default: ${Number(window.FORECAST_DEFAULT_HORIZON ?? 6)} meses.</p>
          </div>

          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <label class="block text-sm font-semibold text-white/80">Modelo</label>
            <select id="modeloForecast"
              class="mt-2 w-full px-3 py-2 rounded-2xl bg-black/30 border border-white/10 text-white">
              <option value="auto" selected>Auto (recomendado)</option>
              <option value="arimax">ARIMAX</option>
              <option value="xgboost">XGBoost</option>
              <option value="ensemble">Ensemble</option>
            </select>
            <p class="text-xs text-white/50 mt-2">Puedes comparar sin romper nada.</p>
          </div>
        </div>

        <div id="alertaForecast"
          class="hidden mt-4 rounded-2xl p-3 text-sm text-center
                 bg-black/30 border border-amber-300/30 text-amber-100">
        </div>

        <!-- TAB: RESUMEN -->
        <section id="tab-resumen" class="tab-section mt-4">
          <div id="kpisForecast" class="grid grid-cols-2 lg:grid-cols-6 gap-3"></div>

          <div class="mt-4 grid grid-cols-1 gap-4">
            <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
              <p class="text-sm text-white/70 mb-2">üìä Consumo hist√≥rico</p>
              <div class="relative w-full h-[260px] sm:h-[320px]">
                <canvas id="graficaForecast" class="block w-full h-full"></canvas>
              </div>
            </div>

            <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
              <p class="text-sm text-white/70 mb-2">üîÆ Pron√≥stico (p10 - p50 - p90)</p>
              <div class="relative w-full h-[300px] sm:h-[360px]">
                <canvas id="graficaForecastPro" class="block w-full h-full"></canvas>
              </div>
            </div>

            <div id="accionForecast" class="rounded-2xl p-4 bg-black/30 border border-white/10"></div>
          </div>
        </section>

        <!-- TAB: MODELOS -->
        <section id="tab-modelos" class="tab-section mt-4 hidden">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <p class="text-sm text-white/70 mb-2">üìà M√©tricas</p>
            <div id="metricasForecast" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
            <div class="mt-4 text-xs text-white/60" id="explicabilidadForecast"></div>
          </div>
        </section>

        <!-- TAB: ESCENARIOS -->
          <section id="tab-escenarios" class="tab-section mt-4 hidden">

            <!-- Simulaci√≥n -->
            <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-sm text-white/70 mb-1">üß™ Simulaci√≥n (Live)</p>
                  <p class="text-xs text-white/50">
                    Ajusta sliders y ver√°s el impacto <span class="text-white/80 font-semibold">Base vs Escenario</span> en esta pesta√±a y en Resumen.
                  </p>
                </div>

                <button type="button" id="btnVerImpactoResumen"
                  class="shrink-0 px-3 py-2 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 text-xs text-white/85">
                  üëÄ Ver impacto en Resumen
                </button>
              </div>

              <!-- CONTROLES (grid) -->
              <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">

                
                <!-- MERMA radial -->
                <div class="rounded-2xl p-3 bg-black/20 border border-white/10">
                  <div class="flex items-center justify-between">
                    <label class="text-xs text-white/60">Merma (%)</label>
                    <input id="mermaForecastNum" type="number" value="10" min="0" max="50" step="1"
                      class="w-20 px-2 py-1 rounded-xl bg-black/30 border border-white/5 text-white text-xs text-right" />
                  </div>

                  <div class="mt-3 grid place-items-center">
                    <div id="dialMerma" class="dial" data-min="0" data-max="50" data-step="1" data-value="10"></div>
                  </div>
                </div>

                <!-- VOLUMEN radial -->
                <div class="rounded-2xl p-3 bg-black/20 border border-white/10">
                  <div class="flex items-center justify-between">
                    <label class="text-xs text-white/60">Volumen de Entrega (%)</label>
                    <input id="factorVolForecastNum" type="text" inputmode="numeric" value="100"
                      class="w-24 px-2 py-1 rounded-xl bg-black/30 border border-white/5 text-white text-xs text-right" />
                  </div>

                  <div class="mt-3 grid place-items-center">
                    <div id="dialVol" class="dial" data-min="0" data-max="200" data-step="1" data-value="100"></div>
                  </div>
                </div>

                <!-- Hint -->
                <div class="flex items-end">
                  <div id="scenarioLiveHint"
                    class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-xs text-white/70 text-center">
                    ‚ö° Live: ajusta sliders y se recalcula solo
                  </div>
                </div>

              </div><!-- /grid -->

              <p class="text-xs text-white/50 mt-3">
                *Ej. Volumen de Entrega: -35 = recorte presupuestal 35%. 0 = entrega completa.
              </p>
            </div>

            <!-- Impacto -->
            <div class="mt-4 rounded-2xl p-4 bg-black/30 border border-white/10">
              <div class="flex items-center justify-between gap-3">
                <p class="text-sm text-white/80 font-semibold">üìå Impacto del escenario</p>
                <span id="scenarioBadge" class="text-xs text-white/60">Base vs Escenario</span>
              </div>

              <div id="scenarioImpactCards" class="mt-3 grid grid-cols-2 lg:grid-cols-4 gap-3"></div>

              <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
                  <p class="text-xs text-white/60 mb-2">üìâ Mini forecast comparativo (p50)</p>
                  <div class="relative w-full h-[260px]">
                    <canvas id="graficaEscenarioCompare" class="block w-full h-full"></canvas>
                  </div>
                  <div class="mt-4 rounded-2xl p-3">
                    <p class="text-xs text-white/60 mb-2">üîÆ Pron√≥stico completo (p10‚Äìp50‚Äìp90) ‚Ä¢ (Escenarios)</p>
                    <div class="relative w-full h-[260px]">
                      <canvas id="graficaForecastProEscenarios" class="block w-full h-full"></canvas>
                    </div>
                    </div>
                </div>

                <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
                  <p class="text-xs text-white/60 mb-2">üß† Reglas activadas</p>
                  <div id="scenarioRules" class="text-sm text-white/80"></div>

                  <div class="mt-3 rounded-2xl bg-black/30 border border-white/10 p-3">
                    <p class="text-xs text-white/60 mb-2">üìä Estad√≠sticos del escenario</p>
                    <div id="scenarioStats" class="text-xs text-white/70 whitespace-pre-wrap"></div>
                  </div>
                </div>
              </div>
            </div>

          </section>

        <!-- TAB: EVIDENCIA -->
        <section id="tab-evidencia" class="tab-section mt-4 hidden">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <p class="text-sm text-white/70 mb-3">üßæ Evidencia usada</p>
            <div id="evidenciaForecast" class="space-y-3"></div>
          </div>
        </section>

        <!-- TAB: ENTREGAS -->
        <section id="tab-entregas" class="tab-section mt-4 hidden">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <p class="text-sm text-white/70 mb-3">üì¶ Plan de entrega</p>
            <div id="tablaEntregasForecast" class="text-sm"></div>
          </div>
        </section>

        <!-- TAB: LOGS -->
        <section id="tab-logs" class="tab-section mt-4 hidden">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <p class="text-sm text-white/70 mb-3">üß∑ Logs</p>
            <div id="logsForecast" class="text-xs text-white/70 whitespace-pre-wrap"></div>
          </div>
        </section>

        <div class="h-[env(safe-area-inset-bottom)]"></div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  // Cache local por referencia (para no pegarle a supabase a cada refresh)
  window.__historicosCache = window.__historicosCache || {};

  // ‚úÖ Cargar unidades del SELECT desde historicos
  cargarUnidadesForecast(referencia, modal).catch(err => {
    console.error("‚ùå cargarUnidadesForecast error:", err);
  });

  const cerrar = () => {
    modal.remove();
    document.removeEventListener("keydown", handleEsc);
    document.documentElement.classList.remove("overflow-hidden");
    document.body.classList.remove("overflow-hidden");
  };

  modal.querySelector("#btnCerrarForecast")?.addEventListener("click", cerrar);
  function handleEsc(e) { if (e.key === "Escape") cerrar(); }
  document.addEventListener("keydown", handleEsc);
  modal.addEventListener("click", (e) => { if (e.target === modal) cerrar(); });

  // Tabs handler
  modal.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      modal.querySelectorAll(".tab-btn").forEach(b => {
        b.classList.remove("bg-white/10","text-white");
        b.classList.add("bg-white/5","text-white/70");
      });
            // ‚úÖ Si el tab contiene charts, fuerza resize/update
      setTimeout(() => {
        try { window.graficaForecastInstance?.resize(); window.graficaForecastInstance?.update(); } catch {}
        try { window.graficaForecastProInstance?.resize(); window.graficaForecastProInstance?.update(); } catch {}
        try { window.graficaEscenarioCompareInstance?.resize(); window.graficaEscenarioCompareInstance?.update(); } catch {}
        try { window.graficaForecastProEscenariosInstance?.resize(); window.graficaForecastProEscenariosInstance?.update(); } catch {}
      }, 80);

      btn.classList.add("bg-white/10","text-white");
      btn.classList.remove("bg-white/5","text-white/70");

      modal.querySelectorAll(".tab-section").forEach(sec => sec.classList.add("hidden"));
      modal.querySelector(`#tab-${tab}`)?.classList.remove("hidden");
    });
  });
  // Ir a Resumen desde Escenarios
  modal.querySelector("#btnVerImpactoResumen")?.addEventListener("click", () => {
    modal.querySelector('.tab-btn[data-tab="resumen"]')?.click();
  });

  // Init defaults
  const horizonSel = modal.querySelector("#horizonForecast");
  if (horizonSel) horizonSel.value = String(Number(window.FORECAST_DEFAULT_HORIZON ?? 6));

  const selectUnidad = modal.querySelector("#unidadForecast");
  const selectModelo = modal.querySelector("#modeloForecast");

  const mermaRange = modal.querySelector("#mermaForecast");
  const mermaNum   = modal.querySelector("#mermaForecastNum");
  const volNum     = modal.querySelector("#factorVolForecastNum");

  const hint = modal.querySelector("#scenarioLiveHint");

  const refreshNow = async () => {
    if (hint) hint.textContent = "‚ö° Recalculando‚Ä¶";
    await cargarForecastPro(referencia);
    if (hint) hint.textContent = "‚úÖ Listo (live)";
  };
  const refresh = debounce(refreshNow, 450);

 // Sync merma
const syncMerma = (v) => {
  const val = Math.max(0, Math.min(50, Number(v || 0)));
  if (mermaRange) mermaRange.value = String(val);
  if (mermaNum) mermaNum.value = String(val);
};

// ================== VOLUMEN ==================
const VOL_MIN = 0;
const VOL_MAX = 200;
const VOL_DEFAULT = 100;

const syncVol = (raw) => {
  if (raw === "") { if (volNum) volNum.value = ""; return; }

  let val = Number(raw);
  if (!Number.isFinite(val)) return;

  val = Math.max(VOL_MIN, Math.min(VOL_MAX, val));

  if (volNum) volNum.value = String(val);
  if (volDial) volDial.set(val);
};


// ====== Diales (despu√©s de syncVol) ======
const dialMermaEl = modal.querySelector("#dialMerma");
const dialVolEl   = modal.querySelector("#dialVol");

const mermaDial = createRadialDial(dialMermaEl, {
  label: "Merma",
  min: 0, max: 50, step: 1,
  unit: "%",
  colorMode: "fixed",
  onInput: (v) => { syncMerma(v); refresh(); },
  onCommit: (v) => { syncMerma(v); refreshNow(); }
});

const volDial = createRadialDial(dialVolEl, {
  label: "Volumen",
  min: 0, max: 200, step: 1,
  unit: "%",

  // ‚úÖ mata el "+"
  showPlus: false,

  // ‚úÖ y todav√≠a m√°s robusto: fuerza formato exacto
  formatValue: (v) => `${Number(v)}%`,

  onInput:  (v) => { syncVol(v); refresh(); },
  onCommit: (v) => { syncVol(v); refreshNow(); }
});



// Input manual mueve dial
mermaNum?.addEventListener("input", (e) => {
  syncMerma(e.target.value);
  mermaDial?.set(Number(e.target.value || 0));
  refresh();
});

if (volNum) {
  volNum.type = "number";
  volNum.min = String(VOL_MIN);
  volNum.max = String(VOL_MAX);
  volNum.step = "1";

  // Live mientras escribe
  volNum.addEventListener("input", (e) => {
    syncVol(e.target.value);
    refresh();
  });

  // Enter = commit inmediato
  volNum.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (volNum.value === "") syncVol(VOL_DEFAULT);
      else syncVol(volNum.value);
      refreshNow();
      volNum.blur();
    }
  });

  // Blur = commit
  volNum.addEventListener("blur", () => {
    if (volNum.value === "") syncVol(VOL_DEFAULT);
    else syncVol(volNum.value);
    refreshNow();
  });
}

  // Load
  (async () => {
    const ok = await ensureChartJs();
    if (!ok) {
      const alerta = document.getElementById("alertaForecast");
      if (alerta) {
        alerta.classList.remove("hidden");
        alerta.textContent = "‚ùå No se pudo cargar Chart.js.";
      }
      return;
    }
    await wait2Frames();
    fixCanvasSize("graficaForecast", 320);
    fixCanvasSize("graficaForecastPro", 360);
    fixCanvasSize("graficaEscenarioCompare", 260);
    fixCanvasSize("graficaForecastProEscenarios", 320);

    await cargarForecastPro(referencia);
  })().catch((err) => {
    console.error("Forecast PRO error:", err);
    const alerta = document.getElementById("alertaForecast");
    if (alerta) {
      alerta.classList.remove("hidden");
      alerta.textContent = "‚ùå Error al cargar forecast: " + (err?.message || err);
    }
  });
}
window.verForecast = verForecast;
// ===== Cache para comparar Base vs Escenario =====
window.__forecastBaseCache = window.__forecastBaseCache || {}; // key -> data (respuesta completa)
// ===== Cache + Anti-race (si no existen arriba, d√©jalos tambi√©n) =====
window.__forecastBaseCache = window.__forecastBaseCache || {}; // key -> respuesta completa
window.__forecastReqId = window.__forecastReqId || 0;

/**
 * Forecast PRO (base + escenario live)
 * - Base: merma default + vol 0 (cacheado)
 * - Escenario: merma slider + vol slider (live)
 * - Renderiza Resumen y Escenarios (incluye gr√°ficas)
 */
async function cargarForecastPro(ref) {
  console.groupCollapsed("üìä [Forecast PRO] cargarForecastPro");
  console.log("ref =", ref);

  const selectUnidad = document.getElementById("unidadForecast");
  const alerta = document.getElementById("alertaForecast");

  // Controles
  const horizon = Number(
    document.getElementById("horizonForecast")?.value ??
    (window.FORECAST_DEFAULT_HORIZON ?? 6)
  );

  const modelo = String(
    document.getElementById("modeloForecast")?.value ??
    (window.FORECAST_DEFAULT_MODELO ?? "auto")
  );

  // Inputs escenario (usa los NUM para evitar jitter)
  const mermaPct = Number(
    document.getElementById("mermaForecastNum")?.value ??
    (window.FORECAST_DEFAULT_MERMA_PCT ?? 10)
  );

  const factorVol = Number(
    document.getElementById("factorVolForecastNum")?.value ?? 0
  );

  if (!selectUnidad || !alerta) {
    console.warn("‚ö†Ô∏è [Forecast PRO] faltan elementos del DOM");
    console.groupEnd();
    return;
  }

  const unidad = (selectUnidad.value || "TOTAL").trim();
  const myReqId = ++window.__forecastReqId;

  try {
    alerta.classList.add("hidden");
    alerta.textContent = "";

    // =========================
    // 1) BASE (cacheada)
    // =========================
    const baseKey = `${ref}__${unidad}__h${horizon}__m${modelo}__base`;

    if (!window.__forecastBaseCache[baseKey]) {
      const baseParams = {
        unidad,
        horizon,
        modelo,
        merma_pct: (window.FORECAST_DEFAULT_MERMA_PCT ?? 10), // base estable
        factor_vol_pct: 0
      };

      const baseData = await fetchForecastProData(ref, baseParams);
      window.__forecastBaseCache[baseKey] = baseData;
    }

    const baseData = window.__forecastBaseCache[baseKey];
    const basePro = baseData?.pro || null;

    // =========================
    // 2) ESCENARIO (live)
    // =========================
    const scenParams = {
      unidad,
      horizon,
      modelo,
      merma_pct: mermaPct,
      factor_vol_pct: factorVol
    };

    const data = await fetchForecastProData(ref, scenParams);
    console.log("respuesta escenario =", data);

    // anti-race: ignora respuestas viejas
    if (myReqId !== window.__forecastReqId) {
      console.warn("‚è≠Ô∏è Respuesta vieja ignorada", { myReqId, latest: window.__forecastReqId });
      console.groupEnd();
      return;
    }

    // Logs crudos (√∫tiles para auditar)
    const logsEl = document.getElementById("logsForecast");
    if (logsEl) {
      logsEl.innerHTML = `<pre class="whitespace-pre-wrap bg-white/5 border border-white/10 rounded-2xl p-3">
${escapeHtml(JSON.stringify(data, null, 2))}
</pre>`;
    }

    if (data?.msg) {
      alerta.textContent = String(data.msg);
      alerta.classList.remove("hidden");
    }

    if (data?.error) throw new Error(data.error);

    const pro = data?.pro || null;
    if (!pro) {
      alerta.textContent = "‚ö†Ô∏è Respuesta sin bloque PRO. Revisa backend.";
      alerta.classList.remove("hidden");
      console.groupEnd();
      return;
    }

    // =========================
    // 3) Aplicar Volumen de Entrega (visual/escenario)
    // =========================
    // Nota: NO alteramos hist; solo p10/p50/p90 para simular el evento sobre la demanda/entrega.
    const seriesEsc = aplicarFactorVolumenSeries(pro.series, factorVol);
    const scenPro = { ...pro, series: seriesEsc };

    // =========================
    // 4) Render global (Resumen + dem√°s tabs)
    // =========================
    renderKpisForecast(scenPro);
    renderGraficaConsumo(scenPro);

    // ‚úÖ Pron√≥stico completo en Resumen
    renderGraficaForecastPro(scenPro.series, "graficaForecastPro");

    // ‚úÖ Pron√≥stico completo en Escenarios (mismo motor, canvas distinto)
    renderGraficaForecastPro(scenPro.series, "graficaForecastProEscenarios");

    renderAccionForecast(scenPro);
    renderMetricasYExplicabilidad(scenPro);
    renderEvidenciaForecast(scenPro);
    renderEntregasForecast(scenPro);
    renderLogsForecast(scenPro);

    // =========================
    // 5) Render especial: Escenarios (Base vs Escenario)
    if (window.volDial) {
      // Base = sin simulaci√≥n ‚Üí normalmente 0%
      const baseFactorVol = 100;

      // Escenario = lo que el usuario est√° simulando
      const escenarioFactorVol = factorVol;

      window.volDial.setBoth({
        base: baseFactorVol,
        scenario: escenarioFactorVol
      });
    }

    if (basePro) {
      // Importante: basePro no lleva factorVol del escenario
      renderEscenariosTab({
        basePro,
        scenPro,
        params: { unidad, horizon, modelo, mermaPct, factorVol }
      });
    } else {
      document.getElementById("scenarioImpactCards")?.replaceChildren();
      const rules = document.getElementById("scenarioRules");
      if (rules) rules.innerHTML = `<div class="text-white/60">Sin base para comparar.</div>`;
    }

  } catch (err) {
    console.error("‚ùå [Forecast PRO] Error:", err);
    if (alerta) {
      alerta.textContent = "‚ùå Error al cargar forecast: " + (err?.message || err);
      alerta.classList.remove("hidden");
    }

    // opcional: reset charts si fall√≥ duro
    try { window.graficaForecastInstance?.destroy(); } catch {}
    try { window.graficaForecastProInstance?.destroy(); } catch {}
    try { window.graficaEscenarioCompareInstance?.destroy(); } catch {}
    try { window.graficaForecastProEscenariosInstance?.destroy(); } catch {}

    window.graficaForecastInstance = null;
    window.graficaForecastProInstance = null;
    window.graficaEscenarioCompareInstance = null;
    window.graficaForecastProEscenariosInstance = null;

  } finally {
    console.groupEnd();
  }
}

// (por compat, si lo ocupas en otro lado)
window.cargarForecastPro = cargarForecastPro;
window.cargarDatosForecastEdge = async (ref) => cargarForecastPro(ref);

// Helper: arma URL y trae JSON
async function fetchForecastProData(ref, params) {
  const url =
    `https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/forecast_producto` +
    `?ref=${encodeURIComponent(ref)}` +
    `&unidad=${encodeURIComponent(params.unidad || "TOTAL")}` +
    `&horizon=${encodeURIComponent(params.horizon || (window.FORECAST_DEFAULT_HORIZON ?? 6))}` +
    `&modelo=${encodeURIComponent(params.modelo || "auto")}` +
    `&merma_pct=${encodeURIComponent(params.merma_pct ?? (window.FORECAST_DEFAULT_MERMA_PCT ?? 5))}` +
    `&factor_vol_pct=${encodeURIComponent(params.factor_vol_pct ?? 0)}`;

  const res = await fetch(url);
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status}: ${txt || "sin cuerpo"}`);
  }
  return await res.json().catch(() => ({}));
}
// ===== Debounce + Anti-race =====
function debounce(fn, wait = 450) {
  let t = null;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), wait);
  };
}
function createRadialDial(el, {
  min, max, step,
  value,
  baseValue = null,
  onChange,
  onInput,
  onCommit,
  label = "",
  unit = "",
  colorMode = "fixed",      // "fixed" | "auto"
  showPlus = true,          // false => no muestra "+"
  formatValue = null        // (v)=>string, opcional
} = {}) {

  if (!el) return;

  // Config desde data-attrs si no lo pasan
  min   = (min ?? Number(el.dataset.min ?? 0));
  max   = (max ?? Number(el.dataset.max ?? 100));
  step  = (step ?? Number(el.dataset.step ?? 1));
  value = (value ?? Number(el.dataset.value ?? min));

  if (baseValue == null && el.dataset.base != null) baseValue = Number(el.dataset.base);

  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const snap  = (v) => Math.round(v / step) * step;

  // Dial: arco de 270¬∞ (start=-225 => 135¬∞, end=45¬∞)
  const startDeg = -225, endDeg = 45;

  // SVG
  const size = 152, cx = 76, cy = 76, r = 56;
  const strokeW = 12;

  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
  svg.style.width = "148px";
  svg.style.height = "148px";
  svg.style.touchAction = "none"; // üëà importante en m√≥vil

  // defs: glow
  const defs = document.createElementNS(svg.namespaceURI, "defs");
  defs.innerHTML = `
    <filter id="dialGlow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="2.8" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  `;
  svg.appendChild(defs);

  const mkCircle = (cls) => {
    const c = document.createElementNS(svg.namespaceURI, "circle");
    c.setAttribute("class", cls);
    c.setAttribute("cx", cx);
    c.setAttribute("cy", cy);
    c.setAttribute("r", r);
    c.setAttribute("fill", "none");
    c.setAttribute("stroke-width", strokeW);
    c.setAttribute("stroke-linecap", "round");
    return c;
  };

  // Back plate (opcional)
  const plate = document.createElementNS(svg.namespaceURI, "circle");
  plate.setAttribute("cx", cx);
  plate.setAttribute("cy", cy);
  plate.setAttribute("r", r + 18);
  plate.setAttribute("fill", "rgba(255,255,255,0.03)");
  plate.setAttribute("stroke", "rgba(255,255,255,0.06)");
  plate.setAttribute("stroke-width", "1");

  const bgTrack  = mkCircle("bgTrack");   // pista tenue
  const baseArc  = mkCircle("baseArc");   // base (comparaci√≥n)
  const valueArc = mkCircle("valueArc");  // escenario (principal)

  // knob
  const knob = document.createElementNS(svg.namespaceURI, "circle");
  knob.setAttribute("class", "knob");
  knob.setAttribute("r", 5.5);

  // texto central
  const tVal = document.createElementNS(svg.namespaceURI, "text");
  tVal.setAttribute("class", "txt");
  tVal.setAttribute("x", cx);
  tVal.setAttribute("y", cy + 6);
  tVal.setAttribute("text-anchor", "middle");

  const tSub = document.createElementNS(svg.namespaceURI, "text");
  tSub.setAttribute("class", "sub");
  tSub.setAttribute("x", cx);
  tSub.setAttribute("y", cy + 28);
  tSub.setAttribute("text-anchor", "middle");
  tSub.textContent = label;

  svg.appendChild(plate);
  svg.appendChild(bgTrack);
  svg.appendChild(baseArc);
  svg.appendChild(valueArc);
  svg.appendChild(knob);
  svg.appendChild(tVal);
  svg.appendChild(tSub);

  el.innerHTML = "";
  el.appendChild(svg);

  // stroke-dash para recortar c√≠rculo a 270¬∞
  const circ = 2 * Math.PI * r;
  const arc  = circ * (270 / 360);
  const gap  = circ - arc;

  const prepArc = (c) => {
    c.style.strokeDasharray = `${arc} ${gap}`;
    c.style.strokeDashoffset = `${circ * ((360 - 270) / 360)}`;
    c.style.transformOrigin = "50% 50%";
    c.style.transform = "rotate(-135deg)";
  };
  [bgTrack, baseArc, valueArc].forEach(prepArc);

  // estilos default
  bgTrack.style.stroke = "rgba(255,255,255,0.18)";

  baseArc.style.stroke = "rgba(2,199,202,0.35)"; // teal base
  baseArc.style.filter = "none";

  valueArc.style.stroke = "rgba(204,163,0,1)";   // dorado escenario default
  valueArc.style.filter = "url(#dialGlow)";

  knob.style.fill = "rgba(255,255,255,0.85)";
  knob.style.stroke = "rgba(0,0,0,0.35)";
  knob.style.strokeWidth = "1";

  tVal.style.fill = "rgba(255,255,255,0.92)";
  tVal.style.fontSize = "20px";
  tVal.style.fontWeight = "800";
  tVal.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto";

  tSub.style.fill = "rgba(255,255,255,0.55)";
  tSub.style.fontSize = "11px";
  tSub.style.fontWeight = "600";

  // helpers
  const pct = (v) => (v - min) / (max - min || 1);

  const colorFor = (v) => {
    if (colorMode === "fixed") return { arc: "rgba(204,163,0,1)" };
    // auto: negativos teal, positivos dorado, cero gris
    if (v < 0)  return { arc: "rgba(2,199,202,1)" };
    if (v > 0)  return { arc: "rgba(204,163,0,1)" };
    return { arc: "rgba(255,255,255,0.55)" };
  };

  const fmt = (v) => {
    if (typeof formatValue === "function") return formatValue(v);
    const s = (showPlus && v > 0) ? `+${v}` : String(v);
    return unit ? `${s}${unit}` : s;
  };

  const setArcDash = (circleEl, v) => {
    const p = clamp(pct(v), 0, 1);
    const dash = arc * p;
    circleEl.style.strokeDasharray = `${dash} ${circ - dash}`;
  };

  const setKnobPos = (v) => {
    const p = clamp(pct(v), 0, 1);
    const deg = startDeg + p * (endDeg - startDeg);
    const rad = (deg * Math.PI) / 180;
    knob.setAttribute("cx", cx + Math.cos(rad) * r);
    knob.setAttribute("cy", cy + Math.sin(rad) * r);
  };

  const applyVisual = () => {
    // base
    if (baseValue != null && Number.isFinite(baseValue)) setArcDash(baseArc, baseValue);
    else baseArc.style.strokeDasharray = `0 ${circ}`; // oculta

    // value
    setArcDash(valueArc, value);
    setKnobPos(value);

    const c = colorFor(value);
    valueArc.style.stroke = c.arc;

    // ‚úÖ texto central correcto (sin usar variables inexistentes)
    tVal.textContent = fmt(value);
  };

  const setByValue = (v, emit = true, mode = "input") => {
    v = snap(clamp(v, min, max));
    value = v;
    el.dataset.value = String(v);

    applyVisual();

    if (!emit) return;

    if (mode === "input" && typeof onInput === "function") onInput(v);
    if (mode === "commit") {
      if (typeof onCommit === "function") onCommit(v);
      if (typeof onChange === "function") onChange(v); // compat
    }
  };

  const valueFromPointer = (clientX, clientY) => {
    const rect = svg.getBoundingClientRect();
    const x = clientX - rect.left - rect.width / 2;
    const y = clientY - rect.top - rect.height / 2;

    let ang = Math.atan2(y, x) * 180 / Math.PI; // -180..180

    const within = (deg) => {
      const d = (deg + 360) % 360;
      return (d >= 135 && d <= 360) || (d >= 0 && d <= 45);
    };

    let a = ang;
    if (!within(a)) {
      const d = ((a + 360) % 360);
      const distToStart = Math.min(Math.abs(d - 135), Math.abs(d - (135 + 360)));
      const distToEnd   = Math.min(Math.abs(d - 45),  Math.abs(d - (45 + 360)));
      a = distToStart < distToEnd ? startDeg : endDeg;
    }

    const d = ((a + 360) % 360);
    let prog;
    if (d >= 135) prog = (d - 135) / 270;
    else prog = (d + 225) / 270;

    prog = clamp(prog, 0, 1);
    return min + prog * (max - min);
  };

  // drag handling
  let dragging = false;

  const onDown = (e) => {
    dragging = true;
    svg.setPointerCapture?.(e.pointerId);
    setByValue(valueFromPointer(e.clientX, e.clientY), true, "input");
  };

  const onMove = (e) => {
    if (!dragging) return;
    setByValue(valueFromPointer(e.clientX, e.clientY), true, "input");
  };

  const onUp = () => {
    if (!dragging) return;
    dragging = false;
    setByValue(value, true, "commit");
  };

  svg.addEventListener("pointerdown", onDown);
  svg.addEventListener("pointermove", onMove);
  window.addEventListener("pointerup", onUp);

  // init
  value = snap(clamp(value, min, max));
  if (baseValue != null) baseValue = snap(clamp(baseValue, min, max));
  applyVisual();

  return {
    set: (v) => setByValue(v, false),
    get: () => value,
    setBase: (v) => {
      baseValue = snap(clamp(v, min, max));
      el.dataset.base = String(baseValue);
      applyVisual();
    },
    setScenario: (v) => setByValue(v, false),
    setBoth: ({ base, scenario }) => {
      if (base != null) {
        baseValue = snap(clamp(base, min, max));
        el.dataset.base = String(baseValue);
      }
      if (scenario != null) value = snap(clamp(scenario, min, max));
      el.dataset.value = String(value);
      applyVisual();
    }
  };
}

// id incremental para ignorar respuestas viejas
window.__forecastReqId = window.__forecastReqId || 0;
// ====== Escenarios: aplicar factor volumen SOLO al forecast (p10/p50/p90) ======
function aplicarFactorVolumenSeries(series, factorVolPct) {
  const f = 1 + (Number(factorVolPct || 0) / 100);
  if (!Number.isFinite(f) || f <= 0) return series;

  const mult = (arr) =>
    Array.isArray(arr) ? arr.map(v => (v == null ? v : Math.round(Number(v) * f * 100) / 100)) : arr;

  return {
    ...series,
    // hist√≥rico NO lo tocamos; solo el forecast para simular evento
    p10: mult(series?.p10),
    p50: mult(series?.p50),
    p90: mult(series?.p90),
  };
}

function n(v, fallback = null) {
  const x = Number(v);
  return Number.isFinite(x) ? x : fallback;
}

function fmtDelta(a, b, digits = 2) {
  const A = n(a), B = n(b);
  if (A == null || B == null) return "‚Äî";
  const d = B - A;
  const sign = d > 0 ? "+" : "";
  const val = Math.round(d * Math.pow(10, digits)) / Math.pow(10, digits);
  return `${sign}${val}`;
}

function firstForecastP50(series) {
  const p50 = series?.p50;
  if (!Array.isArray(p50) || !p50.length) return null;
  return n(p50[0], null);
}

// ====== Render: Escenarios tab (cards + chart p50 base vs escenario) ======
function renderEscenariosTab({ basePro, scenPro, params }) {
  const cards = document.getElementById("scenarioImpactCards");
  const rules = document.getElementById("scenarioRules");
  const stats = document.getElementById("scenarioStats");
  const badge = document.getElementById("scenarioBadge");

  if (badge) {
    badge.textContent = `Base vs Escenario ‚Ä¢ Merma ${params.mermaPct}% ‚Ä¢ Vol ${params.factorVol}%`;
  }

  // -------- Cards (deltas) --------
  if (cards) {
    const bK = basePro?.kpis || {};
    const sK = scenPro?.kpis || {};

    const bP50 = firstForecastP50(basePro?.series);
    const sP50 = firstForecastP50(scenPro?.series);

    const chip = (title, baseVal, scenVal, suffix = "") => `
      <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
        <p class="text-xs text-white/60">${escapeHtml(title)}</p>
        <div class="mt-1 flex items-baseline justify-between gap-2">
          <p class="text-sm text-white/70">Base: <span class="text-white/90 font-semibold">${escapeHtml(baseVal ?? "‚Äî")}${suffix}</span></p>
          <p class="text-sm text-white/70">Esc: <span class="text-white/90 font-semibold">${escapeHtml(scenVal ?? "‚Äî")}${suffix}</span></p>
        </div>
        <p class="mt-2 text-xs text-white/60">Œî ${escapeHtml(fmtDelta(baseVal, scenVal))}${suffix}</p>
      </div>
    `;

    cards.innerHTML = [
      chip("Forecast p50 (pr√≥x mes)", bP50, sP50, ""),
      chip("Entrega sugerida", bK.entrega_sugerida_prox_mes, sK.entrega_sugerida_prox_mes, ""),
      chip("Cobertura (meses)", bK.cobertura_meses, sK.cobertura_meses, " m"),
      chip("Confianza", bK.confianza, sK.confianza, "/100"),
    ].join("");
  }

  // -------- Rules + stats --------
  if (rules) {
    const bAcc = basePro?.recomendacion?.accion ?? "‚Äî";
    const sAcc = scenPro?.recomendacion?.accion ?? "‚Äî";
    const bRisk = basePro?.recomendacion?.riesgo?.nivel ?? "‚Äî";
    const sRisk = scenPro?.recomendacion?.riesgo?.nivel ?? "‚Äî";

    rules.innerHTML = `
      <div class="rounded-2xl bg-black/30 border border-white/10 p-3">
        <p class="text-xs text-white/60 mb-2">Acci√≥n / Riesgo</p>
        <p class="text-sm text-white/80">Base: <span class="text-white font-semibold">${escapeHtml(bAcc)}</span> ‚Ä¢ Riesgo: <span class="text-white font-semibold">${escapeHtml(bRisk)}</span></p>
        <p class="text-sm text-white/80 mt-1">Esc: <span class="text-white font-semibold">${escapeHtml(sAcc)}</span> ‚Ä¢ Riesgo: <span class="text-white font-semibold">${escapeHtml(sRisk)}</span></p>
      </div>
    `;
  }

  if (stats) {
    const out = {
      params,
      base: {
        p50_next: firstForecastP50(basePro?.series),
        kpis: basePro?.kpis,
      },
      escenario: {
        p50_next: firstForecastP50(scenPro?.series),
        kpis: scenPro?.kpis,
      },
    };
    stats.textContent = JSON.stringify(out, null, 2);
  }

  // -------- Chart p50 compare --------
  renderGraficaEscenarioCompare(basePro?.series, scenPro?.series);
}

// ‚ö†Ô∏è Mant√©n compatibilidad por si en alg√∫n lado llamas a cargarDatosForecastEdge
window.cargarDatosForecastEdge = async (ref) => cargarForecastPro(ref);
async function cargarDatosForecastEdge(ref, opts = {}) {
  console.groupCollapsed("üìä [Forecast PRO] cargarDatosForecastEdge");
  console.log("ref =", ref, "opts =", opts);

  const alerta = document.getElementById("alertaForecast");
  const selectUnidad = document.getElementById("unidadForecast");
  const canvas = document.getElementById("graficaForecastPro");

  // Elementos PRO
  const kpisEl = document.getElementById("kpisForecast");
  const accionEl = document.getElementById("accionForecast");
  const tablaEl = document.getElementById("tablaForecast");
  const evidenciaEl = document.getElementById("evidenciaForecast");
  const metricasEl = document.getElementById("metricasForecast");
  const expEl = document.getElementById("expForecast");
  const entregasEl = document.getElementById("tablaEntregasForecast");
  const logsEl = document.getElementById("logsForecast");

  console.log("DOM check =", {
    alerta: !!alerta,
    selectUnidad: !!selectUnidad,
    canvas: !!canvas,
    kpisEl: !!kpisEl,
    accionEl: !!accionEl,
    tablaEl: !!tablaEl,
    evidenciaEl: !!evidenciaEl,
    metricasEl: !!metricasEl,
    expEl: !!expEl,
    entregasEl: !!entregasEl,
    logsEl: !!logsEl
  });

  if (!alerta || !selectUnidad || !canvas) {
    console.warn("‚ö†Ô∏è [Forecast PRO] faltan elementos base del DOM");
    console.groupEnd();
    return;
  }

  alerta.classList.add("hidden");
  alerta.textContent = "";

  // Limpia secciones para que notes que se est√° re-renderizando
  if (kpisEl) kpisEl.innerHTML = "";
  if (accionEl) accionEl.innerHTML = "";
  if (tablaEl) tablaEl.innerHTML = "";
  if (evidenciaEl) evidenciaEl.innerHTML = "";
  if (metricasEl) metricasEl.innerHTML = "";
  if (expEl) expEl.innerHTML = "";
  if (entregasEl) entregasEl.innerHTML = "";

  const ctx = canvas.getContext("2d");

  // Destroy chart anterior
  if (window.graficaForecastInstance) {
    try { window.graficaForecastInstance.destroy(); } catch {}
    window.graficaForecastInstance = null;
  }

  // Params
  const unidad = opts.unidad ?? (selectUnidad.value || "TOTAL");
  const horizon = Number(opts.horizon ?? (window.FORECAST_DEFAULT_HORIZON ?? 6));
  const merma_pct = Number(opts.merma_pct ?? (window.FORECAST_DEFAULT_MERMA_PCT ?? 5));
  const modelo = String(opts.modelo ?? (window.FORECAST_DEFAULT_MODELO ?? "auto"));

  const esc = opts.escenario;
  const escTipo = esc?.tipo ?? "";
  const escFactor = Number(esc?.factor ?? 0);

  const url =
    `https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/forecast_producto` +
    `?ref=${encodeURIComponent(ref)}` +
    `&unidad=${encodeURIComponent(unidad)}` +
    `&horizon=${encodeURIComponent(horizon)}` +
    `&modelo=${encodeURIComponent(modelo)}` +
    `&merma_pct=${encodeURIComponent(merma_pct)}` +
    (esc ? `&esc_tipo=${encodeURIComponent(escTipo)}&esc_factor=${encodeURIComponent(escFactor)}` : "");

  console.log("fetch =", url);

  try {
    const res = await fetch(url);

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status}: ${txt || "sin cuerpo"}`);
    }

    const data = await res.json().catch(() => ({}));
    console.log("respuesta =", data);

    // Logs SIEMPRE
    if (logsEl) {
      logsEl.innerHTML = `<pre class="whitespace-pre-wrap bg-white/5 border border-white/10 rounded-2xl p-3">
${escapeHtml(JSON.stringify(data, null, 2))}
</pre>`;
    }

    if (data?.msg) {
      alerta.textContent = String(data.msg);
      alerta.classList.remove("hidden");
    }

    if (data?.error) throw new Error(data.error);

    // Poblar unidades desde consumo (compat)
    if (data?.consumo && typeof data.consumo === "object") {
      const unidades = Object.keys(data.consumo).sort();

      selectUnidad.innerHTML = "";
      const optTotal = document.createElement("option");
      optTotal.value = "TOTAL";
      optTotal.textContent = "TOTAL (suma consumo)";
      selectUnidad.appendChild(optTotal);

      unidades.forEach((u) => {
        const datosUnidad = data.consumo?.[u] || {};
        const tiene = Object.values(datosUnidad).some((v) => v !== 0 && v != null);
        if (tiene) {
          const opt = document.createElement("option");
          opt.value = u;
          opt.textContent = u;
          selectUnidad.appendChild(opt);
        }
      });

      // asegura valor
      if ([...selectUnidad.options].some(o => o.value === unidad)) {
        selectUnidad.value = unidad;
      }
    }

    const pro = data?.pro;

    // Si no hay PRO, muestra algo visible
    if (!pro) {
      alerta.textContent = "‚ö†Ô∏è Respuesta sin bloque PRO. Revisa backend.";
      alerta.classList.remove("hidden");
      console.groupEnd();
      return;
    }

    // ====== KPIs (pinta aunque falle todo lo dem√°s) ======
    if (kpisEl) {
      const k = pro.kpis || {};
      const chip = (label, value) => `
        <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
          <p class="text-xs text-white/60">${escapeHtml(label)}</p>
          <p class="text-lg font-bold text-white">${escapeHtml(value)}</p>
        </div>
      `;

      kpisEl.innerHTML =
        chip("Consumo prom 6M", (k.consumo_prom_6m ?? "‚Äî")) +
        chip("Tendencia", (k.tendencia_pct != null ? `${k.tendencia_pct}%` : "‚Äî")) +
        chip("Stock actual", (k.stock_actual ?? "‚Äî")) +
        chip("Cobertura", (k.cobertura_meses != null ? `${k.cobertura_meses} meses` : "‚Äî")) +
        chip("Entrega sugerida", (k.entrega_sugerida_prox_mes ?? "‚Äî")) +
        chip("Confianza", (k.confianza != null ? `${k.confianza}/100` : "‚Äî"));
    }

    // ====== Gr√°fica ======
    try { if (ctx) renderGraficaForecastPro(ctx, pro.series); }
    catch (e) { console.error("‚ùå gr√°fica PRO fall√≥:", e); }

    // ====== Acci√≥n ======
    if (accionEl) {
      const r = pro.recomendacion || {};
      const nivel = r?.riesgo?.nivel || "‚Äî";
      const motivos = Array.isArray(r.motivos)
        ? r.motivos.map(m => `‚Ä¢ ${escapeHtml(m.text || m)}`).join("<br/>")
        : "‚Äî";

      accionEl.innerHTML = `
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
          <div>
            <p class="text-sm text-white/60">Acci√≥n recomendada</p>
            <p class="text-xl font-bold text-white mt-1">${escapeHtml(r.accion || "‚Äî")}</p>
            <p class="text-sm text-white/80 mt-2">Entrega sugerida: <span class="font-semibold">${escapeHtml(r.entrega_sugerida ?? "‚Äî")}</span></p>
            <p class="text-sm text-white/80 mt-1">Riesgo: <span class="font-semibold">${escapeHtml(nivel)}</span></p>
          </div>
          <div class="text-sm text-white/70 bg-white/5 border border-white/10 rounded-2xl p-3 sm:max-w-[50%]">
            <p class="text-xs text-white/60 mb-2">Motivos</p>
            ${motivos}
          </div>
        </div>
      `;
    }

    // ====== Tabla / Evidencia / Entregas ======
    try { if (tablaEl) tablaEl.innerHTML = renderTablaForecast(pro.series); }
    catch (e) { console.error("‚ùå tabla fall√≥:", e); }

    try { if (evidenciaEl) evidenciaEl.innerHTML = renderEvidencia(pro.evidencia); }
    catch (e) { console.error("‚ùå evidencia fall√≥:", e); }

    try { if (metricasEl) {
      const b = pro.backtest || {};
      metricasEl.innerHTML = `
        <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
          <p class="text-xs text-white/60">MAPE</p><p class="text-lg font-bold text-white">${escapeHtml(b.mape != null ? b.mape + "%" : "‚Äî")}</p>
        </div>
        <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
          <p class="text-xs text-white/60">MAE</p><p class="text-lg font-bold text-white">${escapeHtml(b.mae ?? "‚Äî")}</p>
        </div>
        <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
          <p class="text-xs text-white/60">RMSE</p><p class="text-lg font-bold text-white">${escapeHtml(b.rmse ?? "‚Äî")}</p>
        </div>
      `;
    }} catch (e) { console.error("‚ùå m√©tricas fall√≥:", e); }

    try { if (expEl) {
      const top = pro.explain?.top_features;
      expEl.innerHTML = Array.isArray(top)
        ? `<ul class="list-disc pl-5">${top.map(x => `<li>${escapeHtml(String(x))}</li>`).join("")}</ul>`
        : `<div class="text-white/60">‚Äî</div>`;
    }} catch (e) { console.error("‚ùå explain fall√≥:", e); }

    try { if (entregasEl) entregasEl.innerHTML = renderEntregas(pro.entregas); }
    catch (e) { console.error("‚ùå entregas fall√≥:", e); }

  } catch (err) {
    console.error("‚ùå [Forecast PRO] Error:", err);
    if (ctx) ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    alerta.textContent = "‚ùå Error al cargar forecast: " + (err?.message || err);
    alerta.classList.remove("hidden");
  } finally {
    console.groupEnd();
  }
}

function renderKpisForecast(pro) {
  const wrap = document.getElementById("kpisForecast");
  if (!wrap) return;

  const k = pro?.kpis || {};
  const items = [
    ["Consumo prom 6M", k.consumo_prom_6m],
    ["Tendencia", k.tendencia_pct != null ? `${k.tendencia_pct}%` : null],
    ["Stock actual (almac√©n)", k.stock_actual],
    ["Cobertura", k.cobertura_meses != null ? `${k.cobertura_meses} meses` : null],
    ["Entrega sugerida", k.entrega_sugerida_prox_mes],
    ["Confianza", k.confianza != null ? `${k.confianza}/100` : null],
  ];

  wrap.innerHTML = items.map(([t, v]) => `
    <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
      <p class="text-xs text-white/60">${escapeHtml(t)}</p>
      <p class="text-lg font-bold text-white">${escapeHtml(v ?? "‚Äî")}</p>
    </div>
  `).join("");
}

function renderGraficaConsumo(pro) {
  const canvas = document.getElementById("graficaForecast");
  if (!canvas) return;

  canvas.style.display = "block";
  canvas.style.width = "100%";
  canvas.style.height = "320px";
  canvas.height = 320;

  const ctx = canvas.getContext("2d");

  const histL = pro?.series?.hist_labels || [];
  const histV = (pro?.series?.hist_values || []).map(v => Number(v) || 0);
  if (!histL.length) return;

  if (window.graficaForecastInstance) {
    const ch = window.graficaForecastInstance;
    ch.data.labels = histL;
    ch.data.datasets[0].data = histV;
    ch.update();
    return;
  }

  window.graficaForecastInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels: histL,
      datasets: [{
        label: "Consumo",
        data: histV,
        fill: true,
        borderColor: "#02c7ca",
        backgroundColor: "rgba(2, 199, 202, 0.10)",
        tension: 0.3,
        pointRadius: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 450, easing: "easeOutQuart" },
      plugins: {
        legend: { labels: { color: "#E5E7EB" } },
        title: { display: true, text: "Consumo mensual", color: "#E5E7EB" }
      },
      scales: {
        x: { ticks: { color: "#CBD5E1" }, grid: { color: "rgba(255,255,255,0.08)" } },
        y: { beginAtZero: true, ticks: { color: "#CBD5E1" }, grid: { color: "rgba(255,255,255,0.08)" } }
      }
    }
  });
}
function fadeAlpha(index, total, { min = 0.18, max = 1, power = 1.35 } = {}) {
  if (total <= 1) return max;
  const t = Math.max(0, Math.min(1, index / (total - 1)));
  const eased = Math.pow(t, power);
  return min + (max - min) * eased;
}
function renderGraficaForecastPro(series, canvasId = "graficaForecastPro") {
  try {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    if (!window.Chart) {
      console.warn("‚ö†Ô∏è Chart.js no est√° cargado");
      return;
    }

    // Tama√±o (si tab estaba hidden)
    canvas.style.display = "block";
    canvas.style.width = "100%";
    canvas.style.height = "360px";
    canvas.height = 360;

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const histLabels = series?.hist_labels || [];
    const histValues = (series?.hist_values || []).map(v => toNum(v));

    const fcLabels = series?.fc_labels || [];
    const p10F = (series?.p10 || []).map(v => toNum(v));
    const p50F = (series?.p50 || []).map(v => toNum(v));
    const p90F = (series?.p90 || []).map(v => toNum(v));

    if (!histLabels.length) {
      console.warn("‚ö†Ô∏è Sin hist_labels");
      return;
    }

    const histLen = histLabels.length;
    const futLen = fcLabels.length;

    // Labels globales
    const labels = [...histLabels, ...fcLabels];

    // Serie real
    const realFull = [...histValues, ...Array(futLen).fill(null)];

    // ===== FITTED HIST√ìRICO =====
    const ma = (arr, i, w) => {
      const a = arr.slice(Math.max(0, i - w + 1), i + 1);
      return a.length ? mean(a) : null;
    };

    const fittedHist = histValues.map((v, i) => {
      if (i >= 12) return histValues[i - 12];
      const m = ma(histValues, i, 6);
      return m == null ? histValues[i] : m;
    });

    // Banda hist√≥rica: usa ancho promedio del forecast futuro
    const wUp = mean(p90F.map((v, i) => v - (p50F[i] ?? 0)).filter(isFiniteNum)) || 0;
    const wDn = mean(p50F.map((v, i) => (p50F[i] ?? 0) - (p10F[i] ?? 0)).filter(isFiniteNum)) || 0;

    const fittedP50Hist = fittedHist.map(x => round2(x));
    const fittedP10Hist = fittedHist.map(x => round2(Math.max(0, x - wDn)));
    const fittedP90Hist = fittedHist.map(x => round2(Math.max(0, x + wUp)));

    // Full (hist fitted + futuro)
    const p50Full = [...fittedP50Hist, ...p50F.map(round2)];
    const p10Full = [...fittedP10Hist, ...p10F.map(round2)];
    const p90Full = [...fittedP90Hist, ...p90F.map(round2)];

    // ===== Fade solo en hist√≥rico =====
    const alphaFor = (idx, { min, max, power }) => {
      if (idx >= histLen) return max; // futuro full visible
      return fadeAlpha(idx, histLen, { min, max, power });
    };

    // Instancia por canvas
    const instanceKey =
      canvasId === "graficaForecastProEscenarios"
        ? "graficaForecastProEscenariosInstance"
        : "graficaForecastProInstance";

    // ‚úÖ MORPH
    if (window[instanceKey]) {
      const ch = window[instanceKey];
      const oldCanvas = ch?.canvas;

      if (!oldCanvas || !oldCanvas.isConnected || oldCanvas.id !== canvasId) {
        try { ch.destroy(); } catch {}
        window[instanceKey] = null;
      } else {
        ch.data.labels = labels;
        ch.data.datasets[0].data = realFull;
        ch.data.datasets[1].data = p10Full;
        ch.data.datasets[2].data = p90Full;
        ch.data.datasets[3].data = p50Full;

        // importante: para que Chart recalcule bien los callbacks
        ch.update();
        setTimeout(() => { try { ch.resize(); ch.update(); } catch {} }, 80);
        return;
      }
    }

    // ‚úÖ CREAR
    window[instanceKey] = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          // 0) Real
          {
            label: "Hist√≥rico (real)",
            data: realFull,
            tension: 0.3,
            pointRadius: 2,
            borderColor: "#02c7ca",
            backgroundColor: "rgba(2,199,202,0.08)",
            fill: true,
            spanGaps: true,
            order: 1
          },

          // 1) p10
          {
            label: "p10 (modelo)",
            data: p10Full,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 2,

            // ‚úÖ color estable en leyenda
            borderColor: "rgba(255,255,255,0.35)",
            backgroundColor: "rgba(0,0,0,0)",
            fill: false,
            spanGaps: true,
            order: 2,

            segment: {
              borderColor: (seg) => {
                const i = seg.p0DataIndex ?? 0;
                const a = alphaFor(i, { min: 0.05, max: 0.35, power: 1.2 });
                return `rgba(255,255,255,${a})`;
              }
            }
          },

          // 2) p90 con fill hacia p10
          {
            label: "Banda p10‚Äìp90",
            data: p90Full,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 2,

            // ‚úÖ leyenda estable
            borderColor: "rgba(255,255,255,0.35)",

            // ‚úÖ AQU√ç est√° la magia: el fill necesita backgroundColor propio
            backgroundColor: (c) => {
              const i = c.dataIndex ?? 0;
              const a = alphaFor(i, { min: 0.02, max: 0.36, power: 1.25 });
              return `rgba(255,255,255,${a})`;
            },

            fill: { target: 1 }, // hacia p10
            spanGaps: true,      // importante para que la banda no se rompa por nulls
            order: 3,

            segment: {
              borderColor: (seg) => {
                const i = seg.p0DataIndex ?? 0;
                const a = alphaFor(i, { min: 0.05, max: 0.35, power: 1.2 });
                return `rgba(255,255,255,${a})`;
              }
            }
          },

          // 3) p50
          {
            label: "Forecast p50 (modelo)",
            data: p50Full,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 3,

            // ‚úÖ leyenda estable
            borderColor: "rgba(204,163,0,1)",
            backgroundColor: "rgba(204,163,0,0.08)",
            fill: false,
            spanGaps: true,
            order: 4,

            segment: {
              borderColor: (seg) => {
                const i = seg.p0DataIndex ?? 0;
                const a = alphaFor(i, { min: 0.12, max: 1, power: 1.3 });
                return `rgba(204,163,0,${a})`;
              }
            }
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },

        animation: { duration: 450, easing: "easeOutQuart" },

        layout: { padding: { left: 10, right: 16, top: 8, bottom: 8 } },
        clip: 0,

        plugins: {
          legend: { position: "top", labels: { color: "#E5E7EB" } },
          title: {
            display: true,
            text: "Pron√≥stico (p10‚Äìp50‚Äìp90) sobre toda la serie",
            color: "#E5E7EB"
          },
          tooltip: { mode: "index", intersect: false }
        },
        scales: {
          x: {
            ticks: { color: "#CBD5E1", maxRotation: 45, minRotation: 30 },
            grid: { color: "rgba(255,255,255,0.08)" }
          },
          y: {
            beginAtZero: true,
            ticks: { color: "#CBD5E1", precision: 0 },
            grid: { color: "rgba(255,255,255,0.08)" }
          }
        }
      }
    });

    setTimeout(() => {
      try { window[instanceKey]?.resize(); window[instanceKey]?.update(); } catch {}
    }, 80);

  } catch (e) {
    console.error("‚ùå renderGraficaForecastPro fall√≥:", e);
  }

  // Helpers locales
  function toNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function mean(arr) { return arr.length ? arr.reduce((s, x) => s + x, 0) / arr.length : 0; }
  function round2(x) { return Math.round((toNum(x)) * 100) / 100; }
  function isFiniteNum(x) { return typeof x === "number" && Number.isFinite(x); }
}


function renderAccionForecast(pro) {
  const box = document.getElementById("accionForecast");
  if (!box) return;

  const rec = pro?.recomendacion || {};
  const riesgo = rec?.riesgo || {};
  const motivos = Array.isArray(rec?.motivos) ? rec.motivos : [];

  const modelo = pro?.log?.modelo_solicitado ?? "‚Äî";
  const horizon = pro?.log?.horizon ?? "‚Äî";

  box.innerHTML = `
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-sm text-white/70">üìå Acci√≥n recomendada</p>
        <p class="text-xl font-bold text-white mt-1">${escapeHtml(rec.accion ?? "‚Äî")}</p>
        <p class="text-sm text-white/80 mt-2">
          Entrega sugerida: <span class="font-semibold">${escapeHtml(rec.entrega_sugerida ?? "‚Äî")}</span>
        </p>
        <p class="text-xs text-white/60 mt-2">
          Riesgo: <span class="text-white/90 font-semibold">${escapeHtml(riesgo.nivel ?? "‚Äî")}</span>
          ${riesgo.detalle ? ` ‚Ä¢ ${escapeHtml(riesgo.detalle)}` : ""}
        </p>
      </div>
      <div class="text-xs text-white/60 text-right">
        <p>Modelo: <span class="text-white/90">${escapeHtml(modelo)}</span></p>
        <p>Horizonte: <span class="text-white/90">${escapeHtml(horizon)}</span></p>
      </div>
    </div>

    ${motivos.length ? `
      <div class="mt-3 rounded-2xl bg-white/5 border border-white/10 p-3">
        <p class="text-xs text-white/60 mb-2">Motivos</p>
        <ul class="list-disc pl-5 text-sm text-white/85">
          ${motivos.map(m => `<li>${escapeHtml(m.text ?? m.code ?? "")}</li>`).join("")}
        </ul>
      </div>
    ` : ""}
  `;
}

function renderMetricasYExplicabilidad(pro) {
  const met = document.getElementById("metricasForecast");
  const exp = document.getElementById("explicabilidadForecast");
  if (!met || !exp) return;

  const b = pro?.backtest || {};
  met.innerHTML = [
    ["MAPE", b.mape != null ? `${b.mape}%` : "‚Äî"],
    ["MAE",  b.mae  != null ? b.mae : "‚Äî"],
    ["RMSE", b.rmse != null ? b.rmse : "‚Äî"],
  ].map(([t, v]) => `
    <div class="rounded-2xl p-3 bg-black/30 border border-white/10">
      <p class="text-xs text-white/60">${escapeHtml(t)}</p>
      <p class="text-lg font-bold text-white">${escapeHtml(v)}</p>
    </div>
  `).join("");

  const explain = pro?.explain || null;
  exp.textContent = explain ? JSON.stringify(explain, null, 2) : "Sin explicabilidad disponible (backend no la envi√≥).";
}


function renderEvidenciaForecast(pro) {
  const wrap = document.getElementById("evidenciaForecast");
  if (!wrap) return;

  const ev = pro?.evidencia || {};
  const blocks = Object.entries(ev);

  if (!blocks.length) {
    wrap.innerHTML = `<div class="text-white/60 text-sm">Sin evidencia disponible.</div>`;
    return;
  }

  wrap.innerHTML = blocks.map(([key, obj]) => {
    const source = obj?.source ?? "‚Äî";
    const keys = obj?.keys ? JSON.stringify(obj.keys, null, 2) : "";
    const rows = Array.isArray(obj?.rows) ? obj.rows : [];

    return `
      <div class="rounded-2xl p-3 bg-black/30 border border-white/10">
        <div class="flex items-center justify-between gap-3">
          <p class="text-sm font-semibold text-white">${escapeHtml(key)}</p>
          <span class="text-xs text-white/60">Fuente: ${escapeHtml(source)}</span>
        </div>
        ${keys ? `<pre class="mt-2 text-[11px] text-white/70 overflow-x-auto">${escapeHtml(keys)}</pre>` : ""}
        ${rows.length ? `
          <div class="mt-2 rounded-2xl border border-white/10 overflow-hidden">
            <div class="max-h-[220px] overflow-auto">
              <pre class="p-2 text-[11px] text-white/70">${escapeHtml(JSON.stringify(rows.slice(0, 50), null, 2))}</pre>
            </div>
          </div>
        ` : `<p class="mt-2 text-xs text-white/60">Sin filas (backend no envi√≥ rows).</p>`}
      </div>
    `;
  }).join("");
}


function renderEntregasForecast(pro) {
  const wrap = document.getElementById("tablaEntregasForecast");
  if (!wrap) return;

  const rows = Array.isArray(pro?.entregas) ? pro.entregas : [];
  if (!rows.length) {
    wrap.innerHTML = `<div class="text-white/60 text-sm">Sin plan de entregas (backend no lo envi√≥).</div>`;
    return;
  }

  wrap.innerHTML = `
    <div class="rounded-2xl border border-white/10 overflow-hidden">
      <table class="w-full text-xs text-left">
        <thead class="bg-black/30 text-white">
          <tr>
            <th class="p-2">Unidad</th>
            <th class="p-2 text-right">Consumo Est.</th>
            <th class="p-2 text-right">Stock</th>
            <th class="p-2 text-right">Cobertura</th>
            <th class="p-2 text-right">Entrega</th>
            <th class="p-2">Motivo</th>
          </tr>
        </thead>
        <tbody class="bg-white/5 text-white">
          ${rows.map(r => `
            <tr class="border-t border-white/10">
              <td class="p-2">${escapeHtml(r.unidad ?? "")}</td>
              <td class="p-2 text-right">${escapeHtml(r.consumo_estimado ?? "‚Äî")}</td>
              <td class="p-2 text-right">${escapeHtml(r.stock ?? "‚Äî")}</td>
              <td class="p-2 text-right">${escapeHtml(r.cobertura_meses != null ? `${r.cobertura_meses}m` : "‚Äî")}</td>
              <td class="p-2 text-right font-semibold">${escapeHtml(r.entrega_sugerida ?? "‚Äî")}</td>
              <td class="p-2 text-white/70">${escapeHtml(r.motivo ?? "")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
}


function renderLogsForecast(pro) {
  const wrap = document.getElementById("logsForecast");
  if (!wrap) return;

  // Muestra primero el log ‚Äúcompacto‚Äù (si existe) y si no, todo el objeto pro
  const payload = pro?.log ? pro.log : pro;

  wrap.textContent = JSON.stringify(payload, null, 2);
}

function fmtNum(x, d = 2) {
  const n = Number(x);
  if (!Number.isFinite(n)) return "‚Äî";
  return n.toFixed(d);
}

function fmtPct(x, d = 1) {
  const n = Number(x);
  if (!Number.isFinite(n)) return "‚Äî";
  return `${n.toFixed(d)}%`;
}

function delta(a, b) {
  const na = Number(a), nb = Number(b);
  if (!Number.isFinite(na) || !Number.isFinite(nb)) return null;
  return nb - na;
}

function deltaPct(a, b) {
  const na = Number(a), nb = Number(b);
  if (!Number.isFinite(na) || !Number.isFinite(nb) || na === 0) return null;
  return ((nb - na) / na) * 100;
}

function arrow(d) {
  if (d == null) return "";
  if (d > 0) return "‚ñ≤";
  if (d < 0) return "‚ñº";
  return "‚Ä¢";
}

function badgeDelta(a, b, unit = "") {
  const d = delta(a, b);
  const p = deltaPct(a, b);

  const aTxt = (a == null ? "‚Äî" : a);
  const bTxt = (b == null ? "‚Äî" : b);

  let sub = "";
  if (p != null) sub = `${arrow(p)} ${fmtPct(p)}`;
  else if (d != null) sub = `${arrow(d)} ${fmtNum(d)}${unit}`;

  return { aTxt, bTxt, sub };
}

function renderGraficaEscenarioCompare(basePro, scenPro) {
  const canvas = document.getElementById("graficaEscenarioCompare");
  if (!canvas) return;

  if (!window.Chart) {
    console.warn("‚ö†Ô∏è Chart.js no est√° cargado (escenario)");
    return;
  }

  const ctx = canvas.getContext("2d");
  if (!ctx) return;

  const base = basePro?.series || basePro || {};
  const scen = scenPro?.series || scenPro || {};

  const labels = (scen.fc_labels?.length ? scen.fc_labels : (base.fc_labels || [])) || [];
  const baseP50 = (base.p50 || []).slice(0, labels.length).map(v => {
  const n = Number(v);
    return Number.isFinite(n) ? n : null; // ‚úÖ null, no 0
  });
  const scenP50 = (scen.p50 || []).slice(0, labels.length).map(v => {
    const n = Number(v);
    return Number.isFinite(n) ? n : null; // ‚úÖ null, no 0
  });

  if (!labels.length) {
    console.warn("‚ö†Ô∏è Sin fc_labels para comparar en escenarios");
    return;
  }

  // Asegura tama√±o (por si el tab estaba hidden)
  canvas.style.display = "block";
  canvas.style.width = "100%";
  canvas.style.height = "260px";
  canvas.height = 260;

  // =========================
  // ‚úÖ RANGO DIN√ÅMICO (NO 0)
  // =========================
  const all = [...baseP50, ...scenP50].filter(v => typeof v === "number" && Number.isFinite(v));
  const minV = Math.min(...all);
  const maxV = Math.max(...all);

  // padding relativo + m√≠nimo absoluto para evitar zoom extremo cuando todo es igual
  const span = Math.max(1e-9, (maxV - minV));
  const padRel = span * 0.15;         // 15% del rango
  const padAbs = Math.max(1, maxV * 0.01); // 1% del nivel (m√≠nimo 1)

  const pad = Math.max(padRel, padAbs);
  const suggestedMin = Math.max(0, minV - pad);
  const suggestedMax = maxV + pad;

  // ‚úÖ MORPH: si ya existe, actualiza y anima (no destruir)
  if (window.graficaEscenarioCompareInstance) {
    const ch = window.graficaEscenarioCompareInstance;
    ch.data.labels = labels;
    ch.data.datasets[0].data = baseP50;
    ch.data.datasets[1].data = scenP50;

    // aplica rango din√°mico
    ch.options.scales.y.beginAtZero = false;
    ch.options.scales.y.min = suggestedMin;   // ‚úÖ forzado
    ch.options.scales.y.max = suggestedMax;   // ‚úÖ forzado

    ch.update();
    setTimeout(() => { try { ch.resize(); ch.update(); } catch {} }, 80);
    return;
  }

  // ‚úÖ Crear SOLO una vez
  window.graficaEscenarioCompareInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Base (p50)",
          data: baseP50,
          tension: 0.3,
          pointRadius: 2,
          borderWidth: 2
        },
        {
          label: "Escenario (p50)",
          data: scenP50,
          tension: 0.3,
          pointRadius: 2,
          borderWidth: 3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },

      // ‚úÖ morph suave
      animation: { duration: 450, easing: "easeOutQuart" },
      transitions: {
        active: { animation: { duration: 450 } },
        resize: { animation: { duration: 0 } }
      },

      plugins: {
        legend: { labels: { color: "#E5E7EB" } },
        tooltip: { mode: "index", intersect: false }
      },
      scales: {
        x: { ticks: { color: "#CBD5E1" }, grid: { color: "rgba(255,255,255,0.08)" } },
        y: {
          beginAtZero: false,
          min: suggestedMin,   // ‚úÖ forzado
          max: suggestedMax,   // ‚úÖ forzado
          ticks: { color: "#CBD5E1", precision: 0 },
          grid: { color: "rgba(255,255,255,0.08)" }
        }
      }
    }
  });

  // Nudge por tab hidden->visible
  setTimeout(() => {
    try {
      window.graficaEscenarioCompareInstance?.resize();
      window.graficaEscenarioCompareInstance?.update();
    } catch {}
  }, 80);
}

// ---------- Chart: Regresi√≥n m√≥vil + suavizado (pron√≥stico) ----------
function graficarRegresionLineal(labelsHist, valoresHist) {
  console.groupCollapsed("üìà [Forecast] graficarRegresionLineal");

  const labelsRecortados = Array.isArray(labelsHist) ? [...labelsHist] : [];
  const valoresRecortados = Array.isArray(valoresHist)
    ? valoresHist.map(v => (Number.isFinite(Number(v)) ? Number(v) : 0))
    : [];

  console.log("labels =", labelsRecortados);
  console.log("valores =", valoresRecortados);

  const canvas = document.getElementById("graficaForecastLinea");
  if (!canvas) {
    console.warn("‚ö†Ô∏è No existe #graficaForecastLinea");
    console.groupEnd();
    return;
  }

  // canvas con tama√±o real (si no: 0px => nada visible)
  canvas.style.display = "block";
  canvas.style.width = "100%";
  canvas.style.height = "360px";
  canvas.height = 360;

  const ctx = canvas.getContext("2d");

  if (window.graficaRegresionInstance) {
    window.graficaRegresionInstance.destroy();
    window.graficaRegresionInstance = null;
  }

  if (!labelsRecortados.length || !valoresRecortados.length || labelsRecortados.length !== valoresRecortados.length) {
    console.warn("‚ö†Ô∏è datos insuficientes o desalineados");
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    const tabla = document.getElementById("tablaForecast");
    if (tabla) tabla.innerHTML = `<div class="text-white/70 text-sm">Sin datos suficientes para pron√≥stico.</div>`;
    console.groupEnd();
    return;
  }

  const N = Math.min(5, Math.max(2, valoresRecortados.length));
  const maxPendiente = 2;

  const prediccion = valoresRecortados.map((_, i) => {
    if (i < N) return null;

    const ySegmento = valoresRecortados.slice(i - N, i);
    const xSegmento = ySegmento.map((_, j) => j);

    let { pendiente, intercepto } = calcularRegresionLineal(xSegmento, ySegmento);

    if (!Number.isFinite(pendiente)) pendiente = 0;
    if (!Number.isFinite(intercepto)) intercepto = ySegmento.reduce((a, b) => a + b, 0) / ySegmento.length;

    if (Math.abs(pendiente) > maxPendiente) pendiente = Math.sign(pendiente) * maxPendiente;

    const out = pendiente * (N - 1) + intercepto;
    return Math.round(out * 100) / 100;
  });

  const ultimosY = valoresRecortados.slice(-N);
  const ultimosX = ultimosY.map((_, j) => j);

  let { pendiente: finPend, intercepto: finInt } = calcularRegresionLineal(ultimosX, ultimosY);
  if (!Number.isFinite(finPend)) finPend = 0;
  if (!Number.isFinite(finInt)) finInt = ultimosY.reduce((a, b) => a + b, 0) / ultimosY.length;
  if (Math.abs(finPend) > maxPendiente) finPend = Math.sign(finPend) * maxPendiente;

  const predFuturo = [];
  const labelsForecast = [];

  const ultima = labelsRecortados[labelsRecortados.length - 1];
  const m = String(ultima).match(/^(\d{4})-(\d{2})(?:-(\d{2}))?$/);
  const ultimaFecha = m ? new Date(Number(m[1]), Number(m[2]) - 1, 1) : new Date();

  const horizon = Number(window.FORECAST_DEFAULT_HORIZON ?? 6);
  for (let i = 1; i <= horizon; i++) {
    const index = ultimosX.length + i - 1;
    const pred = Math.max(0, finPend * index + finInt);
    predFuturo.push(Math.round(pred * 100) / 100);

    const nueva = new Date(ultimaFecha);
    nueva.setMonth(nueva.getMonth() + i);
    labelsForecast.push(`${nueva.getFullYear()}-${String(nueva.getMonth() + 1).padStart(2, "0")}`);
  }

  const allLabels = [...labelsRecortados, ...labelsForecast];
  const seriePrediccion = [...prediccion, ...predFuturo];

  // suavizado exponencial
  const alpha = 0.6;
  const suavizado = [];

  const firstIdx = seriePrediccion.findIndex(v => v !== null && v !== undefined && Number.isFinite(Number(v)));
  let seed = firstIdx >= 0 ? Number(seriePrediccion[firstIdx]) : valoresRecortados[0];
  if (!Number.isFinite(seed)) seed = 0;

  for (let i = 0; i < seriePrediccion.length; i++) {
    if (i === 0) {
      suavizado.push(Math.round(seed * 100) / 100);
      continue;
    }
    const prev = suavizado[i - 1] ?? seed;
    const raw = seriePrediccion[i];
    const actual = raw === null || raw === undefined ? prev : Number(raw);
    const val = alpha * (Number.isFinite(actual) ? actual : prev) + (1 - alpha) * prev;
    suavizado.push(Math.round(val * 100) / 100);
  }

  console.log("seriePrediccion =", seriePrediccion);
  console.log("suavizado =", suavizado);

  // ‚úÖ IMPORTANT√çSIMO:
  // Para que "Suavizado" quede encima, se pinta AL FINAL (√∫ltimo dataset)
  // y adem√°s order alto.
  window.graficaRegresionInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels: allLabels,
      datasets: [
        {
          label: "Hist√≥rico",
          data: [...valoresRecortados, ...Array(3).fill(null)],
          borderColor: "#029597",
          backgroundColor: "rgba(2,149,151,0.12)",
          fill: true,
          tension: 0.3,
          pointRadius: 2,
          spanGaps: true,
          order: 1
        },
        {
          label: "Regresi√≥n m√≥vil limitada (5 meses)",
          data: seriePrediccion,
          borderColor: "#02c7ca",
          backgroundColor: "rgba(2,199,202,0.10)",
          borderDash: [4, 4],
          fill: true,
          tension: 0.3,
          pointRadius: 2,
          spanGaps: true,
          order: 2
        },
        {
          label: "Suavizado",
          data: suavizado,
          borderColor: "#cca300",
          backgroundColor: "rgba(204,163,0,0.10)",
          borderDash: [1, 1],
          fill: false,        // üëà clave: no tapes
          tension: 0.35,
          pointRadius: 2,
          borderWidth: 3,     // üëà dominante
          spanGaps: true,
          order: 99           // üëà encima
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,

      plugins: {
        legend: {
          position: "top",
          labels: {
            color: "#E5E7EB",

            // ‚úÖ FIX: Chart.js NO pasa "chart" como par√°metro aqu√≠.
            // Usa function() para tener acceso a this.chart.
            sort: function (a, b) {
              const ds = this?.chart?.data?.datasets || [];
              const da = ds[a.datasetIndex] || {};
              const db = ds[b.datasetIndex] || {};
              return (da.order ?? 0) - (db.order ?? 0);
            }
          }
        },
        title: {
          display: true,
          text: "Pron√≥stico con regresi√≥n m√≥vil suavizada",
          color: "#E5E7EB"
        },
        tooltip: { mode: "index", intersect: false }
      },

      interaction: { mode: "nearest", axis: "x", intersect: false },

      scales: {
        x: {
          ticks: { color: "#CBD5E1", maxRotation: 45, minRotation: 30 },
          grid: { color: "rgba(255,255,255,0.08)" }
        },
        y: {
          beginAtZero: true,
          ticks: { color: "#CBD5E1", precision: 0 },
          grid: { color: "rgba(255,255,255,0.08)" },
          afterDataLimits(scale) {
            scale.max = scale.max * 1.1;
          }
        }
      }
    }
  });

  // Nudge por layout tard√≠o (modal m√≥vil)
  setTimeout(() => {
    try {
      window.graficaRegresionInstance?.resize();
      window.graficaRegresionInstance?.update();
    } catch (e) {
      console.warn("‚ö†Ô∏è nudge update/resize fall√≥:", e);
    }
  }, 80);

  // Tabla (glass)
  const tabla = document.getElementById("tablaForecast");
  if (tabla) {
    const fmt = (v) => (v === null || v === undefined || v === "" ? "" : String(v));
    tabla.innerHTML = `
      <div class="rounded-2xl border border-white/10 overflow-hidden">
        <table class="w-full text-xs text-left">
          <thead class="bg-black/30 text-white">
            <tr>
              <th class="p-2">Mes</th>
              <th class="p-2 text-right">Real</th>
              <th class="p-2 text-right">Regresi√≥n</th>
              <th class="p-2 text-right">Suavizado</th>
            </tr>
          </thead>
          <tbody class="bg-white/5 text-white">
            ${allLabels.map((mes, i) => {
              const real = valoresRecortados[i] !== undefined ? valoresRecortados[i] : "";
              const reg  = seriePrediccion[i] !== undefined ? seriePrediccion[i] : "";
              const sua  = suavizado[i] !== undefined ? suavizado[i] : "";
              return `
                <tr class="border-t border-white/10">
                  <td class="p-2">${escapeHtml(mes)}</td>
                  <td class="p-2 text-right">${fmt(real)}</td>
                  <td class="p-2 text-right">${fmt(reg)}</td>
                  <td class="p-2 text-right">${fmt(sua)}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    `;
  }

  console.groupEnd();
}


function aislarGrupo(ref) {
  const todos = document.querySelectorAll(".grupo-referencia");
  todos.forEach(g => g.style.display = "none");

  const seleccionado = document.getElementById(`grupo-${ref}`);
  if (seleccionado) seleccionado.style.display = "block";
}
function exportarRegresionExcel() {
  const tabla = document.querySelector("#tablaForecast table");
  if (!tabla) return;

  const rows = Array.from(tabla.querySelectorAll("tr")).map(row =>
    Array.from(row.querySelectorAll("td, th")).map(cell => cell.textContent)
  );

  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Pron√≥stico");

  XLSX.writeFile(wb, "Pronostico_Regresion_Centrum.xlsx");
}

async function exportarRegresionPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");

  const fondo = new Image();
  fondo.src = "membretada_medinova.png"; // aseg√∫rate de tenerla accesible

  fondo.onload = () => {
    doc.addImage(fondo, "PNG", 0, 0, 210, 297);

    const logo = new Image();
    logo.src = "centrum.png";

    logo.onload = () => {
      const anchoLogo = 40;
      const altoLogo = 40 * (529 / 729);
      doc.addImage(logo, "PNG", 160, 10, anchoLogo, altoLogo);

      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text("Pron√≥stico de Consumo - Regresi√≥n y Suavizado", 105, 25 + altoLogo, { align: "center" });

      const canvas = document.getElementById("graficaForecastLinea");
      const imgData = canvas.toDataURL("image/png");
      doc.addImage(imgData, "PNG", 10, 40 + altoLogo, 190, 60);

      const tabla = document.querySelector("#tablaForecast table");
      const rows = Array.from(tabla.querySelectorAll("tr")).map(row =>
        Array.from(row.querySelectorAll("td, th")).map(cell => cell.textContent)
      );

      const columnas = ["Mes", "Unidades reales", "Regresi√≥n", "Suavizado"];
      const cuerpo = rows.slice(1).map(row => row.slice(0, 4));

      doc.autoTable({
        head: [columnas],
        body: cuerpo,
        startY: 105 + altoLogo,
        theme: "grid",
        headStyles: {
          fillColor: [13, 148, 136], // teal-900
          textColor: 255,
          fontStyle: "bold"
        },
        bodyStyles: {
          textColor: [0, 0, 0]
        },
        styles: {
          font: "helvetica",
          fontSize: 8,
          halign: "center",
          cellPadding: 1,
          lineColor: [180, 180, 180],
          lineWidth: 0.2
        },
        margin: { top: 105 + altoLogo }
      });

      // Pie de p√°gina
      const hoy = new Date();
      doc.setFontSize(8);
      doc.setTextColor(100);
      doc.text(`Generado el ${hoy.toLocaleDateString("es-MX")}`, 150, 290);

      doc.save("Pronostico_Regresion_Centrum.pdf");
    };
  };
}

// 1. Obtener mes l√≥gico como YYYY-MM
function obtenerMesLogico(timestamp) {
  const fecha = new Date(Number(timestamp));
  const year = fecha.getFullYear();
  const mes = fecha.getDate() >= 25 ? fecha.getMonth() + 2 : fecha.getMonth() + 1;
  return `${year}-${String(mes).padStart(2, '0')}`;
}
// 2. Cargar dotaciones desde Supabase
async function obtenerDotaciones() {
  try {
    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/dotaciones?select=referencia,unidad,cantidad", {
      headers: {
        "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"

      }
    });
    return await res.json();
  } catch (err) {
    console.error("Error cargando dotaciones:", err);
    return [];
  }
}
// 3. Calcular entregas por unidad y referencia
function calcularEntregas(movimientos, ref) {
  const entregas = {};
  for (const mov of movimientos) {
    if (mov.referencia !== ref || mov.movimiento !== "salida") continue;
    const mesLogico = obtenerMesLogico(mov.fecha);
    const unidad = mov.unidad_destino || "SIN_UNIDAD";
    const clave = `${unidad}|${mesLogico}`;
    entregas[clave] = (entregas[clave] || 0) + 1;
  }
  return entregas;
}
// 4. Calcular consumo inferido y sugerido
function inferirConsumo(entregas, dotaciones, ref) {
  const porUnidad = {};
  for (const clave in entregas) {
    const [unidad, mes] = clave.split("|");
    if (!porUnidad[unidad]) porUnidad[unidad] = {};
    porUnidad[unidad][mes] = entregas[clave];
  }

  const sugerencias = {};
  for (const unidad in porUnidad) {
    const meses = Object.keys(porUnidad[unidad]).sort();
    const consumos = [];
    for (let i = 1; i < meses.length; i++) {
      const ant = porUnidad[unidad][meses[i - 1]];
      const act = porUnidad[unidad][meses[i]];
      const cons = Math.max(0, act - ant);
      consumos.push(cons);
    }
    const prom = consumos.slice(-3).reduce((a, b) => a + b, 0) / 3;
    sugerencias[unidad] = Math.ceil((prom || 0) * 1.1);
  }

  const dotacionTotal = dotaciones.filter(d => d.referencia === ref)
    .reduce((a, d) => a + parseInt(d.cantidad), 0);

  return { sugerencias, dotacionTotal };
}
// 5. Verificar si inventario actual cubre la dotaci√≥n
async function verificarStockVsDotacion(ref, dotacionTotal) {
  try {
    const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos?select=referencia,cantidad&referencia=eq.${ref}`, {
      headers: {
        "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"

      }
    });
    const productos = await res.json();
    const totalEnStock = productos.reduce((a, p) => a + parseInt(p.cantidad), 0);

    if (totalEnStock < dotacionTotal) {
      mostrarModal("‚ö†Ô∏è No hay suficiente inventario para abastecer dotaci√≥n autorizada", "#dc2626");
    } else {
      mostrarModal("‚úÖ Inventario suficiente para dotaci√≥n", "#16a34a");
    }
  } catch (err) {
    console.error("Error verificando stock:", err);
  }
}
// 6. Hook para ejecutar todo al cambiar unidad en forecast
async function alCambiarUnidadForecast(ref) {
  try {
    const movRes = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/TimeStamps?select=referencia,fecha,unidad_destino,movimiento&referencia=eq." + ref, {
      headers: {
        "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"

      }
    });
    const movimientos = await movRes.json();
    if (!Array.isArray(movimientos)) throw new Error("Movimientos no v√°lidos");

    const dotaciones = await obtenerDotaciones();
    if (!Array.isArray(dotaciones)) throw new Error("Dotaciones no v√°lidas");

    const entregas = calcularEntregas(movimientos, ref);
    const { sugerencias, dotacionTotal } = inferirConsumo(entregas, dotaciones, ref);
    await verificarStockVsDotacion(ref, dotacionTotal);
  } catch (e) {
    console.error("Error ejecutando forecast extendido:", e);
  }
}
function solicitarCantidad(callback) {
  const cantidad = prompt("¬øCu√°ntas piezas deseas retirar?");
  const cantidadNum = parseInt(cantidad);
  if (!isNaN(cantidadNum) && cantidadNum > 0) {
    callback(cantidadNum);
  } else {
    mostrarModal("‚ö†Ô∏è Cantidad inv√°lida", "#f59e0b");
  }
}
// Extender evento onchange
const selectUnidadForecast = document.getElementById("unidadForecast");
if (selectUnidadForecast) {
  selectUnidadForecast.addEventListener("change", () => {
    const ref = document.querySelector("#grupo-forecast-referencia")?.dataset?.ref;
    if (ref) alCambiarUnidadForecast(ref);
  });
}

function confiabilidadConvertida(original) {
  const resultado = {};
  for (const unidad in original) {
    for (const mes in original[unidad]) {
      if (!resultado[mes]) resultado[mes] = original[unidad][mes];
      else if (original[unidad][mes] === "‚ö†Ô∏è") resultado[mes] = "‚ö†Ô∏è";
    }
  }
  return { TOTAL: resultado };
}
function combinarUnidades(consumo) {
  const total = {};
  for (const unidad in consumo) {
    for (const mes in consumo[unidad]) {
      if (!total[mes]) total[mes] = 0;
      total[mes] += consumo[unidad][mes];
    }
  }
  return total;
}

async function descargarReporteForecast() {
  try {
    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/reporte_forecast_global", {
      headers: {
         "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
         "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"
      }
    });

    const data = await res.json();
    if (!data.resumen || !Array.isArray(data.resumen)) throw new Error("Datos inv√°lidos");

    const resumen = data.resumen;
    const meses = data.meses;

    const encabezados = [
      "UNIDAD", "REFERENCIA", "NOMBRE", "INV. OBJETIVO",
      ...meses.flatMap(m => [`ENTREGADO ${m}`, `CONSUMIDO ${m}`]),
      "PROMEDIO TRIMESTRAL", "PICO CONSUMO", "DOTACI√ìN SUGERIDA", "CONSUMO VS DOTACI√ìN"
    ];

    const filas = resumen.map(f => [
      f.unidad,
      f.referencia,
      f.nombre,
      f.inv_objetivo,
      ...meses.flatMap(m => [f[`entregado_${m}`] || 0, f[`consumido_${m}`] || 0]),
      f.promedio_trimestral,
      f.pico_consumo,
      f.dotacion_sugerida,
      f.consumo_vs_dotacion
    ]);

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([encabezados, ...filas]);
    XLSX.utils.book_append_sheet(wb, ws, "Reporte Forecast");

    XLSX.writeFile(wb, "Reporte_Global_Forecast.xlsx");

  } catch (err) {
    console.error("Error al descargar reporte:", err);
    alert("‚ùå Error al generar el reporte.");
  }
}
//#endregion 888888888888888888888888888888888888888888888888888888888888888888 FORECAST 88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
function cerrarModalAsignarUnidades() {
  document.getElementById("modalAsignarUnidades").classList.add("hidden");
}
async function guardarUnidadesAsignadas() {
  const select = document.getElementById("selectUsuario");
  const nombre = select.value;
  const checkboxes = document.querySelectorAll("#listaUnidades input[type='checkbox']");
  const seleccionadas = Array.from(checkboxes)
    .filter(c => c.checked)
    .map(c => c.value);

  const errorDiv = document.getElementById("unidadAsignarError");

  if (seleccionadas.length === 0) {
    mostrarModal("‚ùå Debes seleccionar al menos una unidad.", "#b91c1c");
    return;
  }

  if (!nipAdmin) {
    mostrarModal("‚ùå No se detect√≥ NIP de administrador.", "#b91c1c");
    return;
  }

  const payload = {
    nip_admin: nipAdmin,
    nombre,
    nuevo_nip: "sin_cambio",
    nuevas_unidades: seleccionadas
  };

  try {
    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/actualizar_nip", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (res.ok) {
      cerrarModalAsignarUnidades();
      mostrarModal("‚úÖ Unidades actualizadas correctamente", "#16a34a");
    } else {
      console.warn("Error desde Supabase:", data);
      mostrarModal("‚ùå " + (data.error || "Error al guardar unidades."), "#b91c1c");
    }

  } catch (err) {
    console.error("Error de red al guardar unidades:", err);
    mostrarModal("‚ùå Error de red al guardar unidades.", "#b91c1c");
  }
}

async function mostrarModalAsignarUnidades() {
  const modal = document.getElementById("modalAsignarUnidades");
  const select = document.getElementById("selectUsuario");
  const lista = document.getElementById("listaUnidades");
  if (!window.usuarioEsAdmin) {
    notificar("‚ùå Solo administradores pueden modificar unidades", "#b91c1c");
    return;
  }
  // Limpiar
  select.innerHTML = "";
  lista.innerHTML = "";

  // 1. Obtener usuarios desde Supabase
  try {
    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/usuarios?select=nombre,unidades", {
      headers: {
        apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
        Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"
      }
    });

    const usuarios = await res.json();
    const usuariosFiltrados = usuarios.filter(u => 
      u.nombre !== "CONTROL_GLOBAL" && u.nombre !== "PIN_AUTO"
    );
    usuariosFiltrados.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u.nombre;
      opt.textContent = u.nombre;
      opt.dataset.unidades = u.unidades || "";
      select.appendChild(opt);
    });

    select.onchange = () => {
      generarCheckboxesPara(select.value, select.selectedOptions[0].dataset.unidades);
    };

    // Dispara por default para el primero
    if (usuariosFiltrados.length) {
      generarCheckboxesPara(usuariosFiltrados[0].nombre, usuariosFiltrados[0].unidades);
    }

    modal.classList.remove("hidden");
  } catch (err) {
    console.error("Error al cargar usuarios:", err);
  }
}

function generarCheckboxesPara(nombre, unidadesStr) {
  const cont = document.getElementById("listaUnidades");
  cont.innerHTML = "";

  const unidadesActuales = unidadesStr
    ? unidadesStr.split(",").map(u => u.trim().toUpperCase())
    : [];

  for (const clave in unidadesDestino) {
    const label = document.createElement("label");
    label.className = "flex items-center gap-2";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = clave;
    checkbox.checked = unidadesActuales.includes(clave);

    label.appendChild(checkbox);
    label.append(`${clave} - ${unidadesDestino[clave]}`);
    cont.appendChild(label);
  }
}
function actualizarTablaRegistros() {
  const tabla = document.getElementById("tablaRegistros");
  const contenedor = document.getElementById("tablaContenedora");
  const resumenDiv = document.getElementById("resumenEscaneos"); // ‚¨Ö nuevo

  if (!tabla) {
    console.warn("‚ö†Ô∏è No existe la tabla de registros a√∫n en el DOM.");
    return;
  }

  // Hacemos visible el contenedor si hay registros pendientes
  if (qrsPendientes.length > 0) {
    contenedor.classList.remove("hidden");
    setTimeout(() => contenedor.classList.remove("opacity-0"), 10);
  } else {
    contenedor.classList.add("opacity-0");
    setTimeout(() => contenedor.classList.add("hidden"), 500);
  }

  // Encabezado con columna extra de Timestamp
  tabla.innerHTML = `
    <thead>
      <tr>
        <th class="p-1">Referencia</th>
        <th class="p-1">Lote</th>
        <th class="p-1">Timestamp</th>
        <th class="p-1 text-center">Eliminar</th>
      </tr>
    </thead>
  `;

  // Filas de la tabla contenedora
  qrsPendientes.forEach((qr, index) => {
    const fila = document.createElement("tr");
    fila.dataset.index = index;
    fila.innerHTML = `
      <td class="p-1">${qr.referencia}</td>
      <td class="p-1">${qr.lote}</td>
      <td class="p-1">${qr.timestamp || ""}</td>

      <td class="p-1 text-center">
        <button onclick="eliminarFila(this)" class="bg-red-600 hover:bg-red-900 text-white px-2 rounded-xl">X</button>
      </td>
    `;
    tabla.appendChild(fila);
  });

// === Generar resumen como tabla ===
if (resumenDiv) {
  if (qrsPendientes.length > 0) {
    const conteo = {};
    qrsPendientes.forEach(q => {
      const clave = `${q.referencia}||${q.lote}`;
      conteo[clave] = (conteo[clave] || 0) + 1;
    });

    let html = `
      <strong>Resumen:</strong>
      <table class="w-full mt-2 border border-gray-300 text-sm text-center bg-white/80 rounded-xl overflow-hidden">
        <thead class="bg-teal-900 text-white">
          <tr>
            <th class="p-1">Referencia</th>
            <th class="p-1">Lote</th>
            <th class="p-1">Cantidad</th>
          </tr>
        </thead>
        <tbody>
    `;

    for (const clave in conteo) {
      const [ref, lote] = clave.split("||");
      html += `
        <tr>
          <td class="p-1">${ref}</td>
          <td class="p-1">${lote}</td>
          <td class="p-1 font-bold">${conteo[clave]}</td>
        </tr>
      `;
    }

    html += `
        </tbody>
      </table>
    `;

    resumenDiv.innerHTML = html;
    resumenDiv.classList.remove("hidden");
  } else {
    resumenDiv.classList.add("hidden");
  }
}
}


//8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888

async function enviarSupabase() {
  console.log("üü¢üöÄ [SUPABASE] Inicio de enviarSupabase()");

  // ‚úÖ Validaci√≥n de modo
  if (!modo || modo === "inactivo") {
    console.warn("‚ö†Ô∏è [SUPABASE] No se seleccion√≥ modo. Operaci√≥n cancelada.");
    mostrarModal("‚ö†Ô∏è Selecciona primero el modo", "#f59e0b");
    return;
  }

  // ‚úÖ Validaci√≥n de datos pendientes
  if (qrsPendientes.length === 0) {
    console.warn("‚ö†Ô∏è [SUPABASE] No hay productos en qrsPendientes.");
    mostrarModal("‚ö†Ô∏è No hay productos para enviar", "#f59e0b");
    return;
  }

  mostrarModal("üì§ Enviando datos...", "#0ea5e9");
  mostrarLoader();
  const registros = [];

  // ‚úÖ Procesar cada registro antes de enviarlo
  for (const r of qrsPendientes) {
    console.log("üîç [SUPABASE] Procesando registro:", r);

    const { referencia, lote, caducidad } = r;

    if (r.tipo !== "unidad") {
      console.log(`üì¶ [SUPABASE] Validando existencia del producto ${referencia} - Lote ${lote}`);
      const consultaProducto = await fetch(
        `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos?referencia=eq.${referencia}&lote=eq.${lote}`,
        {
          headers: {
            "apikey": API_KEY,
            "Authorization": `Bearer ${API_KEY}`
          }
        }
      );

      console.log(`üåê [SUPABASE] Status consulta producto: ${consultaProducto.status}`);
      const productos = await consultaProducto.json();
      console.log("üì• [SUPABASE] Respuesta productos:", productos);

      if (productos.length === 0) {
        console.warn(`‚ö†Ô∏è [SUPABASE] Producto no existe, buscando en historicos: ${referencia}`);
        const historicoRes = await fetch(
          `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/historicos?select=referencia,nombre,fabricante`,
          {
            headers: {
              "apikey": API_KEY,
              "Authorization": `Bearer ${API_KEY}`
            }
          }
        );

        const historico = await historicoRes.json();
        console.log("üìö [SUPABASE] Historico recibido:", historico);

        const normalizar = s => s.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
        const refClean = normalizar(referencia);
        const match = historico.find(h => normalizar(h.referencia) === refClean);

        const nombre = match?.nombre || "SIN NOMBRE";
        const fabricante = match?.fabricante || "SIN FABRICANTE";

        let caducidadFinal = null;
        if (caducidad && !isNaN(caducidad)) {
          try {
            const fechaExcel = new Date((Number(caducidad) - 25569) * 86400 * 1000);
            caducidadFinal = fechaExcel.toISOString().split("T")[0];
            console.log(`üìÜ [SUPABASE] Caducidad convertida desde Excel: ${caducidadFinal}`);
          } catch (e) {
            console.warn("‚ö†Ô∏è [SUPABASE] Error al convertir caducidad:", caducidad, e);
          }
        } else {
          caducidadFinal = caducidad || null;
        }

        const nuevo = {
          referencia,
          lote,
          nombre,
          fabricante,
          cantidad: 0,
          caducidad: caducidadFinal
        };

        console.log("üÜï [SUPABASE] Insertando nuevo producto en Supabase:", nuevo);
        await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos", {
          method: "POST",
          headers: {
            "apikey": API_KEY,
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json",
            "Prefer": "return=minimal"
          },
          body: JSON.stringify(nuevo)
        });
      }
    }

    const base = {
      ...r,
      remision: remisionActual || null
    };

    if (window.pinAutorizadoPor && window.pinAutorizadoPor !== r.usuario) {
      base.pin_autorizado_por = window.pinAutorizadoPor;
      console.log("üîë [SUPABASE] PIN autorizado por:", window.pinAutorizadoPor);
    }

    registros.push(base);
  }

  console.log("‚úÖ [SUPABASE] Registros listos para enviar:", registros);

  // ‚úÖ Clasificaci√≥n de registros
  const normales = registros.filter(r => !r.tipo || r.tipo === "normal");
  const fracciones = registros.filter(r => r.tipo === "fraccion");
  const unidades = registros.filter(r => r.tipo === "unidad");

  console.log(`üì¶ [SUPABASE] Normales: ${normales.length}`, normales);
  console.log(`üì¶ [SUPABASE] Fraccionables: ${fracciones.length}`, fracciones);
  console.log(`üì¶ [SUPABASE] Unidades fraccionables: ${unidades.length}`, unidades);

  try {
    // ‚öôÔ∏è Funci√≥n de env√≠o ya instrumentada
    async function enviarYVerificar(url, datos, tipo) {
      console.log(`üöÄ [${tipo.toUpperCase()}] Enviando a:`, url);
      console.log(`üì¶ [${tipo.toUpperCase()}] Datos antes de enviar:`, datos);
      console.log(`üìú [${tipo.toUpperCase()}] JSON completo:`, JSON.stringify({ registros: datos }, null, 2));

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ registros: datos })
      });

      console.log(`üåê [${tipo.toUpperCase()}] Status HTTP:`, res.status);

      const json = await res.json();
      console.log(`üì• [${tipo.toUpperCase()}] Respuesta JSON:`, json);

      const errores = json.resultados?.filter(r => r.status === "error");
      console.log(`üîç [${tipo.toUpperCase()}] Errores detectados:`, errores);

      if (errores?.length > 0) {
        console.warn(`‚ùå [${tipo.toUpperCase()}] Se encontraron errores:`, errores);
        mostrarModal(`‚ùå Error al enviar productos (${tipo})`, "#b91c1c");
        ocultarLoader();
        throw new Error(`Errores en ${tipo}`);
      } else {
        console.log(`‚úÖ [${tipo.toUpperCase()}] Env√≠o exitoso.`);
      }
    }

    // üöö Env√≠os seg√∫n tipo
    if (normales.length > 0) {
      console.log("üü¢ [enviarSupabase] Enviando NORMALES:", normales);
      await enviarYVerificar(
        "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr",
        normales,
        "normales"
      );
    }

    if (fracciones.length > 0) {
      console.log("üü¢ [enviarSupabase] Enviando FRACCIONABLES:", fracciones);
      await enviarYVerificar(
        "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_fraccionable",
        fracciones,
        "fraccionables"
      );
    }

    if (unidades.length > 0) {
      console.log("üü¢ [enviarSupabase] Enviando UNIDADES:", unidades);
      await enviarYVerificar(
        "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_unidad",
        unidades,
        "unidades fraccionables"
      );
    }

    mostrarModal("üì¶ Productos enviados correctamente", "#22c55e");
    console.log("üéâ [SUPABASE] TODOS los productos enviados correctamente.");
    qrsPendientes = [];
    actualizarTablaRegistros();
    window.pinAutorizadoPor = null;

  } catch (err) {
    console.error("‚ùå [SUPABASE] Error durante el env√≠o:", err);
  } finally {
    ocultarLoader();
    console.log("‚úÖ [SUPABASE] Loader ocultado y funci√≥n finalizada.");
  }
}


//8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888

function moverFilaAlInicio(fila) {
  try {
    const tbody = document.querySelector("#tablaCaptura tbody");
    if (!tbody || !fila) return;

    tbody.insertBefore(fila, tbody.firstChild); // mueve al inicio
    console.log("üîù Fila movida al inicio:", fila);
  } catch (e) {
    console.error("‚ùå Error al mover fila al inicio:", e);
  }
}

function agregarFila(ref, lote, estado) {
    const tabla = document.getElementById("tablaRegistros");
    const contenedor = document.getElementById("tablaContenedora");

    // Asegura que el contenedor est√© visible
    contenedor.classList.remove("hidden");
    setTimeout(() => contenedor.classList.remove("opacity-0"), 10);

    // Crea la fila
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td class='p-1'>${ref}</td>
      <td class='p-1'>${lote}</td>
      <td class='p-1'>${estado}</td>
      <td class='p-1 text-center'><button onclick='eliminarFila(this)' class='text-red-600'>‚úñ</button></td>
    `;
    tabla.appendChild(fila);
  }
  function normalizarTexto(texto) {
    return (texto || "")
      .toUpperCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w]/g, "");
  }
    async function solicitarNIP() {
      document.getElementById("modalNIP").classList.remove("hidden");
    }

    async function validarNIP() {
      const nip = document.getElementById("nipInput").value.trim();
      const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/validar_nip", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nip })
      });
      const data = await res.json();
      if (!data?.nombre) {
        document.getElementById("nipError").classList.remove("hidden");
        return;
      }
      usuarioActivo = data.nombre;
      unidadesAsignadas = typeof data.unidades === "string" ? data.unidades.split(",").map(u => u.trim()) : [];
      document.getElementById("modalNIP").classList.add("hidden");
      cargarUnidades();
      await cargarReferencias();
      mostrarModalCaptura();
    }

    function cargarUnidades() {
      const unidadSelect = document.getElementById("unidadCaptura");

      if (!unidadSelect) {
        console.error("‚ùå cargarUnidades(): #unidadCaptura no existe. (ModalCaptura incompleto o IDs borrados)");
        return;
      }

      if (!Array.isArray(unidadesAsignadas)) {
        console.error("‚ùå cargarUnidades(): unidadesAsignadas no es arreglo:", unidadesAsignadas);
        unidadSelect.innerHTML = `<option value="">(Error: unidades inv√°lidas)</option>`;
        return;
      }

      if (unidadesAsignadas.length === 0) {
        console.warn("‚ö†Ô∏è cargarUnidades(): usuario sin unidades asignadas");
        unidadSelect.innerHTML = `<option value="">(Sin unidades asignadas)</option>`;
        return;
      }

      unidadSelect.innerHTML =
        `<option value="">Selecciona unidad‚Ä¶</option>` +
        unidadesAsignadas.map(u => `<option value="${u}">${u}</option>`).join("");

      console.log("‚úÖ cargarUnidades(): OK", unidadesAsignadas);
    }


    async function cargarReferencias() {
      const totalMaximo = 10000; // L√≠mite m√°ximo si se espera que la tabla crezca m√°s
      const batchSize = 1000;    // Tama√±o de lote por petici√≥n
      const todasReferencias = [];

      try {
        for (let inicio = 0; inicio < totalMaximo; inicio += batchSize) {
          const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/historicos?select=unidad_medica,referencia,nombre`, {
            headers: {
              apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NjQyNzE2NiwiZXhwIjoyMDYyMDAzMTY2fQ.jTu9cMjOgTsvHgNaW5V1mZQM6VqSE55kASVijuCsGaE",
              Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NjQyNzE2NiwiZXhwIjoyMDYyMDAzMTY2fQ.jTu9cMjOgTsvHgNaW5V1mZQM6VqSE55kASVijuCsGaE",
              "Range-Unit": "items",
              "Range": `${inicio}-${inicio + batchSize - 1}`
            }
          });

          if (!res.ok) throw new Error(`HTTP ${res.status} - ${res.statusText}`);
          const datos = await res.json();
          todasReferencias.push(...datos);

          // Si el lote que recibimos es menor que el batchSize, ya no hay m√°s
          if (datos.length < batchSize) break;
        }

        referenciasPorUnidad = todasReferencias;
        console.log("‚úÖ Total referencias cargadas:", referenciasPorUnidad.length);
        console.log("üìã Unidades distintas:", [...new Set(referenciasPorUnidad.map(r => r.unidad_medica))]);
      } catch (err) {
        console.error("‚ùå Error al cargar referencias:", err);
        alert("‚ùå No se pudieron cargar las referencias. Verifica la conexi√≥n y credenciales.");
      }
    }


    function buscarReferenciaCaptura() {
      const texto = document.getElementById("inputReferencia").value.trim().toLowerCase();
      const unidad = document.getElementById("unidadCaptura").value;
      const contenedor = document.getElementById("sugerenciasReferencia");
      const unidadNorm = normalizarTexto(unidad);

      const sugerencias = referenciasPorUnidad.filter(r =>
        normalizarTexto(r.unidad_medica) === unidadNorm &&
        (
          (r.referencia || "").toLowerCase().includes(texto) ||
          (r.nombre || "").toLowerCase().includes(texto)
        )
      );

      contenedor.innerHTML = "";
      if (!texto || sugerencias.length === 0) {
        contenedor.classList.add("hidden");
        return;
      }

      sugerencias.slice(0, 10).forEach(s => {
        const div = document.createElement("div");
        div.className = "px-4 py-2 hover:bg-white/10 cursor-pointer";
        div.textContent = `${s.referencia} - ${s.nombre || ''}`;
        div.onclick = () => {
          document.getElementById("inputReferencia").value = s.referencia;
          contenedor.classList.add("hidden");
          document.getElementById("inputCantidad").focus();  // üëà Autoenfoque al campo de cantidad
        };
        contenedor.appendChild(div);
      });

      contenedor.classList.remove("hidden");
    }
    function extraerLoteCadDeLlaves(qr) {
      if (!qr) return { lote: null, caducidad: null };

      // Quitamos espacios por si el lector los mete
      const limpio = qr.replace(/\s+/g, '');

      // Patr√≥n: {REF}//{LOTE}--{CADUCIDAD}...
      // Ej: {3030603MYB}//{S/L}--{2030-12-31}|T:30072099
      const match = limpio.match(/\{([^}]+)\}\/\/\{([^}]+)\}--\{?([^}|]+)\}?/);
      if (!match) {
        return { lote: null, caducidad: null };
      }

      return {
        lote: match[2] || null,        // S/L
        caducidad: match[3] || null    // 2030-12-31
      };
    }
    function actualizarDatosCaptura() {
      const filas = document.querySelectorAll("#tablaCaptura tbody tr");
      const modo = document.getElementById("modoCaptura")?.value || "inventario";

      datosCaptura = [];

      filas.forEach(fila => {
        // [0] = Cantidad (input)
        // [1] = Nombre (texto)
        // [2] = Referencia (texto)
        const celdaCantidad = fila.children[0];
        const celdaNombre   = fila.children[1];
        const celdaRef      = fila.children[2];

        const inputCantidad = celdaCantidad ? celdaCantidad.querySelector("input") : null;

        const cantidad  = parseFloat(inputCantidad?.value || "0");
        const nombre    = celdaNombre?.textContent.trim() || "";
        const referencia = celdaRef?.textContent.trim() || "";

        // Log para verificar
        console.log("üì¶ fila ‚Üí ref:", referencia, "| nombre:", nombre, "| cantidad:", cantidad);

        if (referencia && !isNaN(cantidad)) {
          datosCaptura.push({
            referencia,
            nombre,
            cantidad,
            tipo: modo
          });
        }
      });

      console.log("üìù datosCaptura listos para enviar:", datosCaptura);
    }
    function actualizarModoCaptura() {
      const toggle = document.getElementById("modoToggle");
      const texto = document.getElementById("modoTexto");
      const nuevoModo = toggle.checked ? "pruebas_facturadas" : "inventario";
      document.getElementById("modoCaptura").value = nuevoModo;

      // Texto e √≠cono del modo
      texto.textContent = toggle.checked ? "üî¥ Pruebas facturadas" : "üü¢ Inventario";
      texto.className = toggle.checked ? "font-bold text-sm text-rose-900" : "font-bold text-sm text-emerald-900";

      // Bot√≥n
      const btn = document.getElementById("btnEnviarCaptura");
      btn.textContent = toggle.checked ? "üì§ Enviar" : "üì§ Enviar";
      btn.classList.remove("bg-emerald-900", "hover:bg-emerald-800", "bg-rose-900", "hover:bg-rose-800");
      if (toggle.checked) {
        btn.classList.add("bg-rose-900", "hover:bg-rose-800");
      } else {
        btn.classList.add("bg-emerald-900", "hover:bg-emerald-800");
      }
      
      // Bot√≥n Agregar
      const btnAgregar = document.getElementById("btnAgregarCaptura");
      btnAgregar.classList.remove("bg-emerald-900", "hover:bg-emerald-800", "bg-rose-900", "hover:bg-rose-800");

      if (toggle.checked) {
        btnAgregar.classList.add("bg-rose-900", "hover:bg-rose-800");
      } else {
        btnAgregar.classList.add("bg-emerald-900", "hover:bg-emerald-800");
      }

      // Encabezado de tabla
      const encabezado = document.getElementById("tablaEncabezado");
      encabezado.classList.remove("bg-emerald-900", "bg-rose-900");

      if (toggle.checked) {
        encabezado.classList.add("bg-rose-900");
      } else {
        encabezado.classList.add("bg-emerald-900");
      }

    }
    function mostrarModalCaptura() {
      document.getElementById("modalCaptura").classList.remove("hidden");
    }

    function cerrarModalCaptura() {
      document.getElementById("modalCaptura").classList.add("hidden");
    }

    async function precargarArchivoCaptura() {
    const input = document.getElementById("archivoCaptura");
    const archivo = input?.files?.[0];

    // Nombre del archivo (UI)
    const nombre = document.getElementById("archivoCapturaNombre");
    if (nombre) nombre.textContent = archivo ? archivo.name : "Ning√∫n archivo";

    if (!archivo) {
      mostrarModal("‚ö†Ô∏è Selecciona un archivo .csv o .xlsx", "#f59e0b");
      return;
    }

    try {
      const datos = await archivo.arrayBuffer();
      const workbook = XLSX.read(datos, { type: "array" });
      const hoja = workbook.Sheets[workbook.SheetNames[0]];
      const filas = XLSX.utils.sheet_to_json(hoja);

      if (!filas.length) {
        mostrarModal("‚ùå El archivo est√° vac√≠o.", "#991b1b");
        return;
      }

      const tabla = document.querySelector("#tablaCaptura tbody");
      tabla.innerHTML = "";
      datosCaptura = [];

      filas.forEach(row => {
        const referencia = row.referencia || row.Referencia || row["N√∫mero de art√≠culo"];
        const nombre = row.nombre || row.Nombre || row["Descripci√≥n del art√≠culo"];
        const cantidad = parseFloat(row.cantidad || row.Cantidad || row["Cantidad Inventario"]);

        if (!referencia || isNaN(cantidad)) return;

        const tr = document.createElement("tr");
        tr.classList.add("completada");

        tr.innerHTML = `
          <td class="p-2 cantidad-td">
            <input
              type="number"
              step="0.1"
              min="0"
              max="999.9"
              value="${cantidad}"
              inputmode="decimal"
              class="cantidad-input input-cantidad"
              onchange="marcarComoCompletada(this)"
            />
          </td>
          <td class="p-2">${nombre || ""}</td>
          <td class="p-2">${referencia}</td>
          <td class="p-2 text-center">
            <button
              onclick='this.closest("tr").remove(); actualizarDatosCaptura()'
              class="text-rose-300 hover:text-rose-200">
              ‚úñ
            </button>
          </td>
        `;
        tabla.appendChild(tr);

        datosCaptura.push({
          referencia,
          nombre,
          cantidad,
          tipo: document.getElementById("modoCaptura").value
        });
      });

      document.getElementById("contenedorTabla").classList.remove("hidden");
      localStorage.setItem("capturaPendiente", JSON.stringify(datosCaptura));
      mostrarModal("‚úÖ Archivo cargado correctamente", "#065f46");

    } catch (err) {
      console.error("‚ùå Error al leer archivo:", err);
      mostrarModal("‚ùå Error al leer archivo", "#991b1b");
    }
  }



    function mostrarReferenciasUnidad() {
      const unidad = document.getElementById("unidadCaptura").value;
      const tabla = document.querySelector("#tablaCaptura tbody");
      const contenedorTabla = document.getElementById("contenedorTabla");

      console.log("üìå Unidad seleccionada:", unidad, "‚Üí Normalizada:", normalizarTexto(unidad));
      console.log("üî¢ Total referencias cargadas:", referenciasPorUnidad.length);

      referenciasPorUnidad.forEach((r, i) => {
        if (!r.unidad_medica) {
          console.warn(`‚ö†Ô∏è Fila ${i} sin unidad_medica definida:`, r);
        } else {
          console.log(
            `Ref ${i}: ${r.unidad_medica} (${normalizarTexto(r.unidad_medica)}) vs ${unidad} (${normalizarTexto(unidad)})`
          );
        }
      });

      const referencias = referenciasPorUnidad.filter(
        r => normalizarTexto(r.unidad_medica) === normalizarTexto(unidad)
      );

      console.log("‚úÖ Referencias encontradas para esta unidad:", referencias.length);

      // Limpiar tabla actual y estado
      tabla.innerHTML = "";
      datosCaptura = [];

      // Crear filas: Cantidad | Nombre | Referencia | Eliminar
      referencias.forEach(r => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td class="p-2 cantidad-td">
            <input
              type="number"
              step="0.1"
              min="0"
              max="999.9"
              inputmode="decimal"
              placeholder="0.0"
              class="cantidad-input input-cantidad"
              onchange="marcarComoCompletada(this)"
            />
          </td>
          <td class="p-2 celda-nombre">${r.nombre || ""}</td>
          <td class="p-2 celda-ref">${r.referencia}</td>
          <td class="p-2 text-center">
            <button onclick='this.closest("tr").remove(); actualizarDatosCaptura()' class='text-red-600'>‚úñ</button>
          </td>
        `;
        tabla.appendChild(fila);
      });

      contenedorTabla.classList.toggle("hidden", referencias.length === 0);
    }


    async function procesarArchivoPruebasFacturadas(archivo, modo) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        const relaciones = await obtenerRelacionesSupabase(); // Debe devolver un array [{ referencia, nombre_facturacion }]
        if (!relaciones.length) return mostrarModal("‚ùå No se pudieron cargar las relaciones.", "red");

        const hojaActual = workbook.SheetNames[0];
        const unidad = unidadesFijas[hojaActual];
        if (!unidad) return mostrarModal("‚ùå Unidad no reconocida: " + hojaActual, "red");

        const sheet = workbook.Sheets[hojaActual];
        const datos = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const nombreColumna = datos[0][0]; // Asumimos que la fila 0 tiene encabezado y columna A es relevante
        const filaInicial = 1; // Saltamos encabezado

        let coincidencias = 0;
        for (let i = filaInicial; i < datos.length; i++) {
          const nombreExcel = (datos[i][0] || "").toString().trim().toUpperCase();
          const cantidad = parseFloat(datos[i][1]);
          if (!nombreExcel || isNaN(cantidad)) continue;

          const rel = relaciones.find(r =>
            (r.nombre_facturacion || "").toUpperCase().trim() === nombreExcel
          );
          if (!rel) continue;

          // Buscar fila en tabla actual y actualizar
          const fila = [...document.querySelectorAll("#tablaCaptura tbody tr")].find(f =>
            f.children[0].textContent.trim() === rel.referencia
          );
          if (fila) {
            const input = fila.querySelector("input[type='number']");
            if (input) {
              input.value = cantidad;
              marcarComoCompletada(input);
              coincidencias++;
            }
          }
        }

        mostrarModal(`üìÑ Archivo cargado: ${coincidencias} coincidencias aplicadas.`, "green");
      };

      reader.readAsArrayBuffer(archivo);
    }

    async function obtenerRelacionesSupabase() {
      try {
        const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/relaciones?select=referencia,nombre_facturacion", {
          headers: {
            apikey: "API_KEY",
            Authorization: "Bearer API_KEY"
          }
        });
        if (!res.ok) throw new Error("Respuesta no v√°lida");
        return await res.json();
      } catch (e) {
        console.error("Error al obtener relaciones:", e);
        return [];
      }
    }
    function extraerTimestampPlano(qr) {
      if (!qr) return null;

      const limpio = qr
        .replace(/["']/g, "")
        .replace(/\*/g, "")
        .trim();

      const match = limpio.match(/T[:>]\s*([A-Za-z0-9\-]+)/i);
      return match ? match[1].trim() : null;
    }

    function extraerReferenciaPlano(qr) {
      if (!qr) return null;

      console.log("üîç extraerReferenciaPlano() input:", qr);

      // Limpiar comillas, asteriscos u otros adornos que vienen del lector
      const limpio = qr
        .replace(/["']/g, "")   // quita comillas
        .replace(/\*/g, "")     // quita asteriscos **
        .trim();

      console.log("üîç extraerReferenciaPlano() limpio:", limpio);

      // 1) Formato con llaves {3030603MYB}//{S/L}--{2030-12-31}|T:...
      const matchLlaves = limpio.match(/\{([^}]+)\}/);
      if (matchLlaves) {
        const ref = matchLlaves[1].trim();
        console.log("‚úÖ referencia por llaves:", ref);
        return ref;
      }

      // 2) Formato cl√°sico con R: o R>
      const matchR = limpio.match(/R[:>]\s*([A-Za-z0-9\-]+)/i);
      if (matchR) {
        const ref = matchR[1].trim();
        console.log("‚úÖ referencia por R:", ref);
        return ref;
      }

      console.warn("‚ö†Ô∏è extraerReferenciaPlano() no encontr√≥ referencia");
      return null;
    }

    function actualizarInventarioDetallado(referencia, lote, caducidad, deltaCantidad) {
      if (!referencia || !deltaCantidad) return;

      const loteKey = lote && lote.trim() ? lote.trim() : "S/L";
      const cadKey  = caducidad && caducidad.trim() ? caducidad.trim() : "SIN_CAD";

      if (!inventarioDetallado[referencia]) {
        inventarioDetallado[referencia] = {};
      }
      if (!inventarioDetallado[referencia][loteKey]) {
        inventarioDetallado[referencia][loteKey] = {};
      }

      const actual = inventarioDetallado[referencia][loteKey][cadKey] || 0;
      inventarioDetallado[referencia][loteKey][cadKey] = actual + deltaCantidad;

      // (Opcional) log para revisar qu√© se va guardando
      console.log("üìä Inventario detallado actualizado:", referencia, loteKey, cadKey, "‚Üí", inventarioDetallado[referencia][loteKey][cadKey]);
    }
    function manejarEscaneoInventario(contenido) {
      try {
        console.log("üì• manejarEscaneoInventario() contenido bruto:", contenido);

        const modo = document.getElementById("modoCaptura")?.value;
        const unidad = document.getElementById("unidadCaptura")?.value;

        console.log("üìå modoCaptura:", modo, " | unidadCaptura:", unidad);

        if (modo !== "inventario") {
          mostrarModal("‚ö†Ô∏è Cambia a modo INVENTARIO para usar el lector QR de inventario.", "#f97316");
          return;
        }

        if (!unidad) {
          mostrarModal("‚ö†Ô∏è Selecciona una unidad antes de escanear.", "#f97316");
          return;
        }

        // 1) Obtener datos con tu parser actual
        const datos = extraerDatosQR(contenido) || {};
        console.log("üß© extraerDatosQR() ‚Üí", datos);

        let referencia = datos.referencia || extraerReferenciaPlano(contenido);
        let lote       = datos.lote || null;
        let caducidad  = datos.caducidad || null;
        let timestamp  = datos.timestamp || extraerTimestampPlano(contenido);

        console.log("üéØ referencia preliminar:", referencia, "| lote:", lote, "| caducidad:", caducidad, "| timestamp:", timestamp);

        if (!referencia) {
          mostrarModal("‚ùå No se encontr√≥ la referencia en el QR.", "#b91c1c");
          return;
        }

        // 2) Bloquear si el timestamp ya se escane√≥ antes
        if (timestamp) {
          console.log("‚è± timestamp detectado:", timestamp);
          if (timestampsEscaneadosInventario.has(timestamp)) {
            console.warn("‚õî timestamp ya escaneado:", timestamp);
            mostrarModal("‚õî Esta etiqueta ya fue escaneada anteriormente.", "#b91c1c");
            return;
          }
        } else {
          console.warn("‚ö†Ô∏è QR sin timestamp, no se puede validar duplicado por T:");
        }

        const referenciaNormalizada = referencia.toString().trim().toUpperCase();
        console.log("üéØ referencia normalizada:", referenciaNormalizada);

        // 3) Buscar en la tabla de captura
        const filas = document.querySelectorAll("#tablaCaptura tbody tr");
        console.log("üìä Filas actuales en tablaCaptura:", filas.length);

        let encontrada = false;
        const refsTabla = [];

        filas.forEach((fila, idx) => {
          const refFila = fila.children[2]?.textContent.trim();
          const refFilaNorm = (refFila ?? "").toString().trim().toUpperCase();
          refsTabla.push(refFilaNorm);
          console.log(`   ‚Ä¢ Fila ${idx}: "${refFilaNorm}" vs "${referenciaNormalizada}"`);

          if (refFilaNorm === referenciaNormalizada) {
            const inputCantidad = fila.children[0]?.querySelector("input");
            if (inputCantidad) {
              const actual = parseFloat(inputCantidad.value) || 0;
              const nueva  = actual + 1;
              inputCantidad.value = nueva.toString();
              marcarComoCompletada(inputCantidad);
              encontrada = true;

              console.log("‚úÖ Fila encontrada, cantidad actualizada a:", nueva);

              // üÜï Mover la fila al inicio porque proviene del esc√°ner
              moverFilaAlInicio(fila);

              // Registrar inventario detallado
              if (typeof actualizarInventarioDetallado === "function") {
                actualizarInventarioDetallado(referencia, lote, caducidad, 1);
              }

              // Registrar timestamp
              if (timestamp) {
                timestampsEscaneadosInventario.add(timestamp);
                console.log("‚è± timestamp registrado:", timestamp);
              }
            }
          }
        });

        if (!encontrada) {
          console.warn("‚ö†Ô∏è Referencia no encontrada en tablaCaptura. Unidad actual:", unidad);
          console.log("üìã Referencias presentes en tablaCaptura:", refsTabla);
          mostrarModal("‚ùå Esta referencia no est√° en la tabla de la unidad seleccionada.", "#b91c1c");
          return;
        }

        // (Opcional) actualizar inputs visibles
        const inputRef = document.getElementById("inputReferencia");
        if (inputRef) inputRef.value = referencia;
        const inputCant = document.getElementById("inputCantidad");
        if (inputCant) inputCant.value = "1";

        console.log("üéØ Escaneo inventario final:", { referencia, lote, caducidad, timestamp });

      } catch (err) {
        console.error("üí• Error en manejarEscaneoInventario:", err);
        mostrarModal("‚ùå Error al procesar el QR de inventario.", "#b91c1c");
      }
    }


    function agregarFilaCaptura() {
      const refInput = document.getElementById("inputReferencia");
      const cantInput = document.getElementById("inputCantidad");
      const tipo = document.getElementById("modoCaptura").value;
      const unidad = document.getElementById("unidadCaptura").value;

      const ref = refInput.value.trim();
      const cantidad = parseFloat(cantInput.value);

      if (!ref || isNaN(cantidad)) {
        alert("‚ö†Ô∏è Faltan datos");
        return;
      }

      // Verificaci√≥n de asignaci√≥n de referencia a la unidad
      const coincide = referenciasPorUnidad.some(r =>
        r.referencia === ref &&
        normalizarTexto(r.unidad_medica) === normalizarTexto(unidad)
      );
      if (!coincide) {
        alert("‚ùå Esta referencia no est√° asignada a la unidad seleccionada.");
        return;
      }

      const filas = document.querySelectorAll("#tablaCaptura tbody tr");
      let encontrada = false;

      filas.forEach(fila => {
        // üÜï Ahora la referencia est√° en la columna 2: [0]=Cantidad, [1]=Nombre, [2]=Referencia
        const celdaRef = fila.children[2];
        if (!celdaRef) return;

        const refFila = celdaRef.textContent.trim();
        console.log("Ref fila:", refFila, "vs ref input:", ref);

        if (refFila === ref) {
          // üÜï La cantidad est√° en la columna 0
          const celdaCantidad = fila.children[0];
          const inputCantidad = celdaCantidad ? celdaCantidad.querySelector("input") : null;

          if (inputCantidad) {
            inputCantidad.value = cantidad;
            marcarComoCompletada(inputCantidad);
            encontrada = true;
          }
        }
      });

      if (!encontrada) {
        mostrarModal("‚ùå Esta referencia no est√° en la tabla de la unidad seleccionada.", "#b91c1c");
      }

      refInput.value = "";
      cantInput.value = "";
    }

    function cerrarModalNIP() {
      document.getElementById("modalNIP").classList.add("hidden");
    }

    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape") {
        cerrarModalNIP();
      }
    });

    function toggleFilasCompletadas(ocultar) {
      document.querySelectorAll("#tablaCaptura tbody tr.completada").forEach(f => f.style.display = ocultar ? "none" : "");
      localStorage.setItem("capturaPendiente", JSON.stringify(datosCaptura));
    }

    function marcarComoCompletada(input) {
      const fila = input.closest("tr");

      // Nuevo orden: Cantidad | Nombre | Referencia
      const nombre = fila.children[1]?.textContent.trim() || "";
      const referencia = fila.children[2]?.textContent.trim() || "";

      const cantidad = parseFloat(input.value);
      const tipo = document.getElementById("modoCaptura").value;

      if (!isNaN(cantidad) && cantidad > 0) {
        fila.classList.add("completada");

        const ocultar = document.querySelector("input[type='checkbox'][onchange*='toggleFilasCompletadas']")?.checked;
        if (ocultar) fila.style.display = "none";
      } else {
        fila.classList.remove("completada");
        fila.style.display = "";
      }

      // Actualizar o insertar en datosCaptura
      const existente = datosCaptura.find(d => d.referencia === referencia);
      if (existente) {
        existente.cantidad = cantidad;
        existente.tipo = tipo;
        existente.nombre = nombre;
      } else {
        // Solo guarda si hay referencia v√°lida
        if (referencia) datosCaptura.push({ referencia, nombre, cantidad, tipo });
      }

      localStorage.setItem("capturaPendiente", JSON.stringify(datosCaptura));
    }

    async function enviarCapturaBase() {
      if (!datosCaptura.length) return alert("No hay datos que enviar.");

      const unidad = document.getElementById("unidadCaptura").value;
      const usuario = usuarioActivo;
      const modo = document.getElementById("modoCaptura").value; // "inventario" o "pruebas_facturadas"
      const mes = parseInt(document.getElementById("mesCaptura").value);
      const anio = document.getElementById("anioCaptura").value;
      const tipoCorte = document.getElementById("toggleTipoCaptura").checked ? "25" : "10";

      if (!unidad || !usuario || !mes || !anio) {
        alert("‚ùå Faltan datos necesarios (usuario, unidad, mes o a√±o).");
        return;
      }

      // Construir nombre de columna, ej. "10_6_2025"
      const columna = `${tipoCorte}_${mes}_${anio}`;

      try {
        const payload = {
          unidad,
          usuario,
          registros: datosCaptura,
          columna,
          tabla: modo // "inventario" o "pruebas_facturadas"
        };

        console.log("üì§ Enviando:", JSON.stringify(payload));

        const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/guardar_captura", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const resultado = await res.json();
        if (res.ok && resultado.status === "ok") {
          alert("‚úÖ Datos enviados correctamente.");
          datosCaptura = [];
          document.querySelector("#tablaCaptura tbody").innerHTML = "";
          localStorage.removeItem("capturaPendiente");
        } else {
          alert("‚ùå Error al enviar: " + (resultado.error || "desconocido"));
        }
      } catch (err) {
        console.error("‚ùå Error de conexi√≥n:", err);
        alert("‚ùå Error de conexi√≥n al enviar.");
      }
    }

    function cerrarModalCaducidad() {
      document.getElementById("modalCaducidad").classList.add("hidden");
    }

function calcularDiasRestantes(fecha) {
  if (!fecha || fecha === "S/C" || fecha === "0" || fecha === 0 || fecha === "000") return Infinity;

  let fechaCad = null;

  // Serial de Excel v√°lido
  if (!isNaN(fecha)) {
    const serial = parseInt(fecha, 10);
    if (serial > 1000) {
      fechaCad = new Date(1900, 0, serial - 2);
    }
  }

  // Formato YYYY-MM-DD
  if (!fechaCad && /^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
    const [anio, mes, dia] = fecha.split("-").map(Number);
    fechaCad = new Date(anio, mes - 1, dia);
  }

  // Formato DD/MM/YYYY
  if (!fechaCad && /^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
    const [dia, mes, anio] = fecha.split("/").map(Number);
    fechaCad = new Date(anio, mes - 1, dia);
  }

  // Si sigue sin poderse interpretar, retorna infinito
  if (!fechaCad || isNaN(fechaCad.getTime())) return Infinity;

  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  const diff = fechaCad - hoy;
  return Math.floor(diff / (1000 * 60 * 60 * 24));
}


    function formatearCaducidad(fecha) {
      let fechaCad = null;
      if (!isNaN(fecha)) {
        const serial = parseInt(fecha, 10);
        if (serial > 1000) fechaCad = new Date(1900, 0, serial - 2);
      } else if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
        const [anio, mes, dia] = fecha.split("-").map(Number);
        fechaCad = new Date(anio, mes - 1, dia);
      } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
        const [dia, mes, anio] = fecha.split("/").map(Number);
        fechaCad = new Date(anio, mes - 1, dia);
      }
      if (!fechaCad) return "-";

      const dd = String(fechaCad.getDate()).padStart(2, "0");
      const mm = String(fechaCad.getMonth() + 1).padStart(2, "0");
      const yyyy = fechaCad.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

async function mostrarAlertasCaducidad() {
  console.log("‚ñ∂ Iniciando mostrarAlertasCaducidad()");

  const cont = document.getElementById("contenidoCaducidad");
  const modal = document.getElementById("modalCaducidad");

  try {
    // Loader opcional si lo tienes
    if (typeof mostrarLoader === "function") mostrarLoader(true);

    const res = await fetch(
      "https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos?select=referencia,nombre,fabricante,lote,caducidad,cantidad",
      {
        headers: {
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",            // üëà NO uses service_role en frontend
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"
        }
      }
    );

    console.log("‚úÖ Fetch ejecutado", res.status);

    const data = await res.json();
    console.log("‚úÖ Respuesta recibida:", data);

    if (!Array.isArray(data)) {
      console.error("‚ùå ERROR: La respuesta no es un array:", data);
      cont.innerHTML = `<div class="space-card p-4 rounded-2xl border border-white/10 text-white/80">
        ‚ùå Respuesta inv√°lida del servidor.
      </div>`;
      modal.classList.remove("hidden");
      return;
    }

    const proximos = data
      .map(p => ({ ...p, diasRestantes: calcularDiasRestantes(p.caducidad) }))
      .filter(p => Number.isFinite(p.diasRestantes) && p.diasRestantes <= 30)
      .sort((a, b) => a.diasRestantes - b.diasRestantes);

    if (!proximos.length) {
      cont.innerHTML = `
        <div class="space-card p-5 rounded-2xl border border-white/10 text-center">
          <div class="text-emerald-200 font-extrabold">‚úÖ No hay productos pr√≥ximos a caducar</div>
          <div class="text-xs text-white/60 mt-1">Rango: pr√≥ximos 30 d√≠as</div>
        </div>
      `;
      modal.classList.remove("hidden");
      return;
    }

    const pill = (dias) => {
      if (dias <= 7) return `<span class="cadu-pill cadu-pill--danger">‚õî URGENTE ¬∑ ${dias} d√≠as</span>`;
      if (dias <= 15) return `<span class="cadu-pill cadu-pill--warn">‚ö†Ô∏è PRONTO ¬∑ ${dias} d√≠as</span>`;
      return `<span class="cadu-pill cadu-pill--ok">‚úÖ OK ¬∑ ${dias} d√≠as</span>`;
    };

    const esc = (v) => (typeof escapeHtml === "function")
      ? escapeHtml(v)
      : String(v ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    const header = `
      <div class="space-card p-4 rounded-2xl border border-white/10 mb-3">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <div class="font-extrabold text-white/90">‚ö†Ô∏è Productos pr√≥ximos a caducar</div>
          <div class="text-xs text-white/60">${proximos.length} encontrados (‚â§ 30 d√≠as)</div>
        </div>
        <div class="text-xs text-white/60 mt-1">
          En m√≥vil puedes deslizar horizontalmente la tabla.
        </div>
      </div>
    `;

    let rows = "";
    for (const p of proximos) {
      rows += `
        <tr>
          <td>
            <div class="font-bold text-white/90">${esc(p.referencia)}</div>
            <span class="cadu-sub">${esc(p.nombre || "")}</span>
            <span class="cadu-sub">${esc(p.fabricante || "")}</span>
          </td>
          <td class="whitespace-nowrap">${esc(p.lote || "S/L")}</td>
          <td class="whitespace-nowrap">${esc(formatearCaducidad(p.caducidad))}</td>
          <td class="whitespace-nowrap">${pill(p.diasRestantes)}</td>
          <td class="whitespace-nowrap text-right">${esc(p.cantidad ?? "")}</td>
        </tr>
      `;
    }

    cont.innerHTML = `
      ${header}
      <div class="cadu-table-wrap">
        <table class="cadu-table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Lote</th>
              <th>Caducidad</th>
              <th>Estado</th>
              <th class="text-right">Cantidad</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;

    modal.classList.remove("hidden");
  } catch (err) {
    console.error("‚ùå Error cargando productos urgentes:", err);
    cont.innerHTML = `
      <div class="space-card p-5 rounded-2xl border border-rose-400/20 bg-rose-900/20 text-white/85">
        ‚ùå Error al cargar datos. Revisa conexi√≥n o permisos.
        <div class="text-xs text-white/60 mt-1">${String(err?.message || err)}</div>
      </div>
    `;
    modal.classList.remove("hidden");
  } finally {
    if (typeof ocultarLoader === "function") ocultarLoader();
    else if (typeof mostrarLoader === "function") mostrarLoader(false);
  }
}

    // Asignar el evento al bot√≥n una vez cargue todo
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("btnAlertasCaducidad").addEventListener("click", mostrarAlertasCaducidad);
    });
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    const modal = document.getElementById("modalCaducidad");
    if (modal && !modal.classList.contains("hidden")) {
      cerrarModalCaducidad();
    }
  }
});

// =================================================================================================
// üõ∞Ô∏èüß™ QC COMMAND (Supervisor de Calidad)
// - Requiere tablas: qc_items (cat√°logo), qc_consumo (consumo)
// - Usa productos (stock central/lotes/caducidad) + historicos (stock unidades por corte)
// - FULL LOGGING (console + panel)
// =================================================================================================
(function initQCModule(){
  window.qcState = window.qcState || {
    catalogo: [],
    productosQC: [],
    historicosQC: [],
    consumoQC: [],
    computed: null,
    charts: { consumo: null, cobertura: null, caducidad: null },
    lastRunAt: null,
  };

  function qclog(msg, obj){
    try{
      if(typeof window.logx === "function") window.logx("üõ∞Ô∏è[QC]", msg, obj);
      const box = document.getElementById("qcLogs");
      if(box){
        const line = `[${new Date().toISOString()}] ${msg}` + (obj ? ` :: ${JSON.stringify(obj)}` : "");
        box.textContent = (line + "\n" + (box.textContent || "")).slice(0, 8000);
      }
    }catch(_){/* no-op */}
  }
  // =========================
  // ‚òÄÔ∏è Sol Log√≠stico: Motor SVG
  // =========================

  // 1) Orden fijo (tu arreglo real)
  const REPRESENTACIONES_RADIALES = [
    { id: "CUU", nombre: "ALMAC√âN CHIHUAHUA", angulo: 330, color: "#17A2A6" },
    { id: "65",  nombre: "ALMAC√âN JU√ÅREZ",     angulo: 345, color: "#1E40AF" },
    { id: "66",  nombre: "ALMAC√âN PARRAL",     angulo: 315, color: "#CCA300" },
    { id: "BCS",   nombre: "BAJA CALIFORNIA SUR", angulo: 250, color: "#06B6D4" },
    { id: "DUR",   nombre: "DURANGO",             angulo: 305, color: "#3B82F6" },
    { id: "NAY",   nombre: "NAYARIT",             angulo: 270, color: "#22C55E" },
    { id: "SIN",   nombre: "SINALOA",             angulo: 290, color: "#A3E635" },
    { id: "TAM",   nombre: "TAMAULIPAS",          angulo:  20, color: "#F97316" },
    { id: "COA",   nombre: "COAHUILA",            angulo: 350, color: "#F59E0B" },
    { id: "CHP",   nombre: "CHIAPAS",             angulo: 140, color: "#34D399" },
    { id: "OAX",   nombre: "OAXACA",              angulo: 165, color: "#10B981" },
    { id: "TAB",   nombre: "TABASCO",             angulo: 110, color: "#60A5FA" },
    { id: "CAM",   nombre: "CAMPECHE",            angulo: 120, color: "#A78BFA" },
    { id: "QROO",  nombre: "QUINTANA ROO",        angulo:  90, color: "#F472B6" },
    { id: "GRO",   nombre: "GUERRERO",            angulo: 200, color: "#FB7185" },
    { id: "EDOMEX",nombre: "EDO. DE M√âXICO",      angulo: 230, color: "#EAB308" },
    { id: "HGO",   nombre: "HIDALGO",             angulo:  40, color: "#38BDF8" },
    // üî• agrega aqu√≠ las que quieras, siempre con angulo fijo
  ];

  // 2) Utilidades (m√≠nimas)
  function solLog(msg, obj){
    const box = document.getElementById("solLogs");
    const line = `[${new Date().toISOString()}] ${msg}`;
    if (box) box.textContent = (line + (obj? " :: "+JSON.stringify(obj):"") + "\n" + (box.textContent||"")).slice(0, 4000);
    if (window.logx) logx("‚òÄÔ∏è[SOL]", msg, obj);
  }

  function svgEl(name){
    return document.createElementNS("http://www.w3.org/2000/svg", name);
  }

  function polarToXY(cx, cy, r, deg){
    const rad = (deg - 90) * Math.PI / 180; // 0¬∞ arriba
    return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
  }

  function deg2rad(deg){ return (deg * Math.PI) / 180; }

  // arc flags for SVG
  function arcFlag(a0, a1){
    let d = ((a1 - a0) % 360 + 360) % 360;
    return d > 180 ? 1 : 0;
  }

  // Donut-wedge path. IMPORTANT: uses same angle convention as polarToXY (0¬∞ arriba).
  function wedgePathD(cx, cy, r0, r1, a0, a1){
    const A0 = a0 - 90;
    const A1 = a1 - 90;

    const p0o = { x: cx + r1 * Math.cos(deg2rad(A0)), y: cy + r1 * Math.sin(deg2rad(A0)) };
    const p1o = { x: cx + r1 * Math.cos(deg2rad(A1)), y: cy + r1 * Math.sin(deg2rad(A1)) };
    const p0i = { x: cx + r0 * Math.cos(deg2rad(A0)), y: cy + r0 * Math.sin(deg2rad(A0)) };
    const p1i = { x: cx + r0 * Math.cos(deg2rad(A1)), y: cy + r0 * Math.sin(deg2rad(A1)) };

    const laf = arcFlag(a0, a1);

    return [
      `M ${p0o.x.toFixed(2)} ${p0o.y.toFixed(2)}`,
      `A ${r1.toFixed(2)} ${r1.toFixed(2)} 0 ${laf} 1 ${p1o.x.toFixed(2)} ${p1o.y.toFixed(2)}`,
      `L ${p1i.x.toFixed(2)} ${p1i.y.toFixed(2)}`,
      `A ${r0.toFixed(2)} ${r0.toFixed(2)} 0 ${laf} 0 ${p0i.x.toFixed(2)} ${p0i.y.toFixed(2)}`,
      `Z`
    ].join(" ");
  }

  function computeMinAngleGap(data){
    const angs = (data||[]).map(d => Number(d.angulo)).filter(n => Number.isFinite(n));
    if(angs.length < 2) return 18;
    angs.sort((a,b)=>a-b);
    let min = 360;
    for(let i=0;i<angs.length;i++){
      const a = angs[i];
      const b = angs[(i+1)%angs.length] + (i===angs.length-1 ? 360 : 0);
      min = Math.min(min, b-a);
    }
    return min;
  }

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  // Escala bonita: sqrt (suave y legible)
  function scaleSqrt(v, vMax, Lmin=18, Lmax=240){
    if (!vMax || vMax <= 0) return Lmin;
    const t = clamp01(v / vMax);
    return Lmin + (Lmax - Lmin) * Math.sqrt(t);
  }

  // Formato de n√∫mero
  function fmtNum(n){ return Number(n||0).toLocaleString(); }
  function fmtMoney(n){ return "$" + Number(n||0).toLocaleString() + " MXN"; }

  // 3) Builder del SVG completo (grid + hub + barras)
  function buildSolSVG(svg, { title="ROMA ‚Ä¢ CDMX", subtitle="", onBarClick=null }){
    svg.innerHTML = "";

    // defs
    const defs = svgEl("defs");

    const filter = svgEl("filter");
    filter.setAttribute("id", "solGlow");
    filter.setAttribute("x", "-40%");
    filter.setAttribute("y", "-40%");
    filter.setAttribute("width", "180%");
    filter.setAttribute("height", "180%");
    const blur = svgEl("feGaussianBlur");
    blur.setAttribute("stdDeviation", "3");
    blur.setAttribute("result", "b");
    const merge = svgEl("feMerge");
    const mn1 = svgEl("feMergeNode"); mn1.setAttribute("in", "b");
    const mn2 = svgEl("feMergeNode"); mn2.setAttribute("in", "SourceGraphic");
    merge.appendChild(mn1); merge.appendChild(mn2);
    filter.appendChild(blur); filter.appendChild(merge);

    defs.appendChild(filter);
    svg.appendChild(defs);

    const cx=450, cy=450;

    // Grid
    const grid = svgEl("g");
    grid.setAttribute("opacity", "0.55");

    const rings = [140, 200, 260, 320, 380];
    rings.forEach((r,i)=>{
      const c = svgEl("circle");
      c.setAttribute("cx", cx);
      c.setAttribute("cy", cy);
      c.setAttribute("r", r);
      c.setAttribute("fill", "none");
      c.setAttribute("stroke", i===0||i===rings.length-1 ? "rgba(255,255,255,0.10)" : "rgba(255,255,255,0.07)");
      c.setAttribute("stroke-width", i===rings.length-1 ? "1.4" : "1.2");
      grid.appendChild(c);
    });

    const vline = svgEl("line");
    vline.setAttribute("x1", cx); vline.setAttribute("y1", 70);
    vline.setAttribute("x2", cx); vline.setAttribute("y2", 830);
    vline.setAttribute("stroke", "rgba(255,255,255,0.05)");
    vline.setAttribute("stroke-width", "1");
    grid.appendChild(vline);

    const hline = svgEl("line");
    hline.setAttribute("x1", 70); hline.setAttribute("y1", cy);
    hline.setAttribute("x2", 830); hline.setAttribute("y2", cy);
    hline.setAttribute("stroke", "rgba(255,255,255,0.05)");
    hline.setAttribute("stroke-width", "1");
    grid.appendChild(hline);

    svg.appendChild(grid);

    // Hub
    const hub = svgEl("g");
    hub.setAttribute("filter", "url(#solGlow)");

    const hubCircle = svgEl("circle");
    hubCircle.setAttribute("cx", cx);
    hubCircle.setAttribute("cy", cy);
    hubCircle.setAttribute("r", 62);
    hubCircle.setAttribute("fill", "rgba(23,162,166,0.18)");
    hubCircle.setAttribute("stroke", "rgba(23,162,166,0.35)");
    hubCircle.setAttribute("stroke-width", "1.5");
    hub.appendChild(hubCircle);

    const dot = svgEl("circle");
    dot.setAttribute("cx", cx); dot.setAttribute("cy", cy); dot.setAttribute("r", 6);
    dot.setAttribute("fill", "rgba(255,255,255,0.85)");
    hub.appendChild(dot);

    const txt = svgEl("text");
    txt.setAttribute("x", cx);
    txt.setAttribute("y", cy+2);
    txt.setAttribute("text-anchor", "middle");
    txt.setAttribute("fill", "rgba(255,255,255,0.82)");
    txt.setAttribute("font-size", "12");
    txt.setAttribute("font-weight", "700");
    txt.setAttribute("font-family", "system-ui");
    txt.textContent = title;
    hub.appendChild(txt);

    if (subtitle){
      const st = svgEl("text");
      st.setAttribute("x", cx);
      st.setAttribute("y", cy+18);
      st.setAttribute("text-anchor", "middle");
      st.setAttribute("fill", "rgba(255,255,255,0.55)");
      st.setAttribute("font-size", "11");
      st.setAttribute("font-family", "system-ui");
      st.textContent = subtitle;
      hub.appendChild(st);
    }

    svg.appendChild(hub);

    // Contenedor de barras
    const barras = svgEl("g");
    barras.setAttribute("id", "barras");
    svg.appendChild(barras);

    // Return API
    return {
      setBars: (bars, metricKey, opts={}) => renderBars(barras, bars, metricKey, onBarClick, opts)
    };
  }

  function renderBars(g, data, metricKey, onBarClick, opts={}){
    const cx=450, cy=450;
    const R0=140;
    const Lmax=240;

    g.innerHTML = "";

    const maxVal = Math.max(...data.map(d => Number(d[metricKey]||0)));

    data.forEach(d=>{
      const ang = Number(d.angulo||0);
      const v = Number(d[metricKey]||0);

      const L = scaleSqrt(v, maxVal, 18, Lmax);

      // --- WEDGES (cu√±as tipo dona) ---
      const minGap = computeMinAngleGap(data);
      const GAP_DEG = Math.max(1.2, Math.min(3, minGap * 0.12));
      const WEDGE_DEG = Math.max(3, Math.min(14, minGap - GAP_DEG));

      const a0 = ang - (WEDGE_DEG/2);
      const a1 = ang + (WEDGE_DEG/2);

      // Ghost wedge para ‚Äúllenar‚Äù el c√≠rculo (fondo)
      const ghost = svgEl("path");
      ghost.setAttribute("d", wedgePathD(cx, cy, R0, R0 + Lmax, a0, a1));
      ghost.setAttribute("fill", "rgba(255,255,255,0.04)");
      ghost.setAttribute("stroke", "rgba(255,255,255,0.03)");
      ghost.setAttribute("stroke-width", "1");
      ghost.setAttribute("pointer-events", "none");
      g.appendChild(ghost);

      // Wedge real
      const p = svgEl("path");
      p.setAttribute("d", wedgePathD(cx, cy, R0, R0 + L, a0, a1));
      p.setAttribute("fill", d.color || "rgba(23,162,166,0.9)");
      p.setAttribute("fill-opacity", "0.90");
      p.setAttribute("stroke", "rgba(255,255,255,0.09)");
      p.setAttribute("stroke-width", "1");

      // Tooltip nativo
      const title = svgEl("title");
      title.textContent =
        `${d.nombre}\n` +
        `Stock: ${fmtNum(d.stock)}\n` +
        `Valor: ${fmtMoney(d.valor)}\n` +
        `Cad <30d: ${Number(d.cad30||0)}%`;
      p.appendChild(title);

      // Hit area (m√°s f√°cil hover/click)
      const hit = svgEl("path");
      hit.setAttribute("d", wedgePathD(cx, cy, R0, R0 + L, a0, a1));
      hit.setAttribute("fill", "transparent");
      hit.setAttribute("stroke", "transparent");
      hit.setAttribute("stroke-width", "18");
      hit.style.cursor = (typeof onBarClick === "function") ? "pointer" : "default";

      if (typeof onBarClick === "function"){
        hit.addEventListener("click", ()=> onBarClick(d));
      }

      g.appendChild(p);
      g.appendChild(hit);
    });

    solLog("Render bars", { metricKey, count: data.length });
  }

  // =========================
  // Datos: fetch / mock (placeholder)
  // =========================

  // üî• Debe venir de Supabase: agregados por representaci√≥n
  // Forma esperada por cada representaci√≥n:
  // { id, nombre, angulo, color, stock, valor, cad30 }
  async function solFetchRepresentaciones(){
    // TODO: aqu√≠ conectamos a Supabase real.
    // Por ahora: demo usando tu arreglo + valores random
    return REPRESENTACIONES_RADIALES.map(r=>({
      ...r,
      stock: Math.floor(Math.random()*2400)+150,
      valor: Math.floor(Math.random()*12000000)+500000,
      cad30: Math.floor(Math.random()*22),
      strokeWidth: 10
    }));
  }

  // üî• Debe venir de Supabase: agregados por unidad m√©dica dentro de una representaci√≥n
  // Forma esperada:
  // { id, nombre, angulo, color, stock, valor, cad30 }
  async function solFetchUnidadesDeRepresentacion(repId){
    // TODO: Supabase real.
    // Demo: generamos 18 unidades con √°ngulos fijos alrededor del c√≠rculo (sin geo)
    const n = 18;
    const base = 360 / n;

    return Array.from({length:n}).map((_,i)=>({
      id: `${repId}_UM_${i+1}`,
      nombre: `Unidad ${i+1} (${repId})`,
      angulo: (i*base + 10) % 360,
      color: "rgba(255,255,255,0.78)",
      stock: Math.floor(Math.random()*700)+30,
      valor: Math.floor(Math.random()*3200000)+150000,
      cad30: Math.floor(Math.random()*18),
      strokeWidth: 8
    }));
  }

  // =========================
  // Controller: toggle + drilldown
  // =========================
  let solMetric = "stock"; // "stock" | "valor"
  let solAPI = null;
  let solDrillAPI = null;
  let solDataRep = [];
  let solDataUM = [];
  let solSelectedRep = null;

  async function solInit(){
    const svgN = document.getElementById("solNacional");
    const svgD = document.getElementById("solDrill");

    if(!svgN || !svgD){
      solLog("No SVG targets found");
      return;
    }

    // build SVGs
    solAPI = buildSolSVG(svgN, {
      title: "ROMA ‚Ä¢ CDMX",
      subtitle: "Representaciones",
      onBarClick: async (rep)=> {
        await solOpenDrill(rep);
      }
    });

    solDrillAPI = buildSolSVG(svgD, {
      title: "DRILLDOWN",
      subtitle: "Unidades m√©dicas",
      onBarClick: null // (opcional) segundo nivel
    });

    // hook toggle buttons
    const bS = document.getElementById("btnMetricStock");
    const bV = document.getElementById("btnMetricValor");
    if (bS && bV){
      bS.addEventListener("click", ()=> solSetMetric("stock"));
      bV.addEventListener("click", ()=> solSetMetric("valor"));
    }

    // close drill
    const btnClose = document.getElementById("btnCerrarDrill");
    btnClose?.addEventListener("click", ()=> solCloseDrill());

    // initial fetch + render
    solDataRep = await solFetchRepresentaciones();
    solRenderMain();

    solLog("Sol init OK", { metric: solMetric, reps: solDataRep.length });
  }

  function solSetMetric(m){
    solMetric = m;

    const bS = document.getElementById("btnMetricStock");
    const bV = document.getElementById("btnMetricValor");
    if(bS && bV){
      const stockOn = (m==="stock");
      bS.classList.toggle("opacity-60", !stockOn);
      bV.classList.toggle("opacity-60", stockOn);
    }

    // re-render main + drill if open
    solRenderMain();
    if (solSelectedRep) solRenderDrill();

    solLog("Metric changed", { solMetric });
  }

  function solRenderMain(){
    const sub = document.getElementById("solSubtitulo");
    if(sub) sub.textContent = `Vista por representaci√≥n ‚Ä¢ m√©trica: ${solMetric === "stock" ? "Stock" : "Valor"}`;

    solAPI?.setBars(solDataRep, solMetric);
  }

  async function solOpenDrill(rep){
    solSelectedRep = rep;

    const wrap = document.getElementById("solDrillWrap");
    const title = document.getElementById("solDrillTitle");
    if(wrap) wrap.classList.remove("hidden");
    if(title) title.textContent = `üè• ${rep.nombre} ‚Ä¢ Unidades m√©dicas (${solMetric === "stock" ? "Stock" : "Valor"})`;

    solDataUM = await solFetchUnidadesDeRepresentacion(rep.id);
    solRenderDrill();

    solLog("Open drill", { rep: rep.id, units: solDataUM.length });
  }

  function solRenderDrill(){
    const rep = solSelectedRep;
    if(!rep) return;

    const svgD = document.getElementById("solDrill");
    // Update hub text by rebuilding is overkill; simple: re-build once or just render bars.
    // Aqu√≠ solo renderizamos barras, y el t√≠tulo ya lo pusimos afuera.

    solDrillAPI?.setBars(solDataUM, solMetric);
  }

  function solCloseDrill(){
    solSelectedRep = null;
    solDataUM = [];
    const wrap = document.getElementById("solDrillWrap");
    wrap?.classList.add("hidden");
    solLog("Close drill");
  }

  // L√°nzalo cuando exista el DOM (si ya est√°s usando DOMContentLoaded, enc√°jalo ah√≠)
  window.addEventListener("DOMContentLoaded", ()=> {
    try { solInit(); } catch(e){ solLog("Init error", { e: String(e?.message||e) }); }
  });
  function qcEsc(v){
    return (typeof escapeHtml === "function") ? escapeHtml(v) : String(v ?? "");
  }

  function qcTodayISO(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return d.toISOString().slice(0,10);
  }

  function qcAddDaysISO(iso, days){
    const d = new Date(iso + "T00:00:00");
    d.setDate(d.getDate() + days);
    return d.toISOString().slice(0,10);
  }

  // Corte vigente para historicos: 10 o 25
  // regla:
  //  - d√≠a < 10  -> usa 25 del mes anterior
  //  - 10..24    -> usa 10 del mes actual
  //  - >= 25     -> usa 25 del mes actual
  function qcColumnaCorteVigente(){
    const now = new Date();
    const day = now.getDate();
    let month = now.getMonth() + 1;
    let year = now.getFullYear();
    let corte = 10;

    if(day < 10){
      corte = 25;
      month -= 1;
      if(month <= 0){ month = 12; year -= 1; }
    } else if(day >= 25){
      corte = 25;
    } else {
      corte = 10;
    }
    return `${corte}_${month}_${year}`;
  }

  async function qcEnsureChart(){
    const ok = await (typeof ensureChartJs === "function" ? ensureChartJs() : Promise.resolve(!!window.Chart));
    if(!ok) qclog("‚ùå Chart.js no disponible");
    return ok;
  }

  async function qcSbSelect(table, selectStr, opts={}){
    const sb = window.sb;
    if(!sb){
      qclog("‚ùå Supabase client no disponible (window.sb)");
      return [];
    }
    let q = sb.from(table).select(selectStr);
    if(opts.eq){ for(const [k,v] of Object.entries(opts.eq)) q = q.eq(k, v); }
    if(opts.in){ for(const [k,arr] of Object.entries(opts.in)) q = q.in(k, arr); }
    if(opts.gte){ for(const [k,v] of Object.entries(opts.gte)) q = q.gte(k, v); }
    if(opts.lte){ for(const [k,v] of Object.entries(opts.lte)) q = q.lte(k, v); }
    if(opts.order){ q = q.order(opts.order.col, { ascending: opts.order.asc !== false }); }
    if(opts.limit){ q = q.limit(opts.limit); }
    const { data, error } = await q;
    if(error){
      qclog(`‚ùå Supabase error en ${table}`, { error: String(error.message || error) });
      return [];
    }
    return Array.isArray(data) ? data : [];
  }

  function qcGetFilters(){
    const tipo = document.getElementById("qcTipo")?.value || "ALL";
    const almacen = document.getElementById("qcAlmacen")?.value || "ALL";
    const unidad = document.getElementById("qcUnidad")?.value || "ALL";
    const desde = document.getElementById("qcDesde")?.value || qcAddDaysISO(qcTodayISO(), -180);
    const hasta = document.getElementById("qcHasta")?.value || qcTodayISO();
    const soloCrit = !!document.getElementById("qcSoloCriticos")?.checked;
    const incluirCentral = !!document.getElementById("qcIncluirCentral")?.checked;
    return { tipo, almacen, unidad, desde, hasta, soloCrit, incluirCentral };
  }

  function qcSetDefaultDates(){
    const desdeEl = document.getElementById("qcDesde");
    const hastaEl = document.getElementById("qcHasta");
    if(desdeEl && !desdeEl.value) desdeEl.value = qcAddDaysISO(qcTodayISO(), -180);
    if(hastaEl && !hastaEl.value) hastaEl.value = qcTodayISO();
  }

  async function qcCargarUnidadesSelect(){
    try{
      const sel = document.getElementById("qcUnidad");
      if(!sel) return;
      // Si existe un selector global / caches de unidades, √∫salo. Si no, usa diccionario local.
      const entries = Object.entries(window.unidadesDestino || {}).filter(([k,_]) => String(k).trim());
      const opts = ["<option value=\"ALL\" selected>Todas</option>"];
      for(const [clave,nombre] of entries){
        // omitimos almacenes que son CUU/65/66 si quieres separarlos
        opts.push(`<option value=\"${qcEsc(clave)}\">${qcEsc(clave)} ¬∑ ${qcEsc(nombre)}</option>`);
      }
      sel.innerHTML = opts.join("\n");
    } catch(e){
      qclog("‚ùå Error cargando selector unidades", { err: String(e?.message || e) });
    }
  }

  // ---------- C√°lculos ----------
  function qcParseCaducidadToDate(fecha){
    if(!fecha || fecha === "S/C" || fecha === "0" || fecha === 0) return null;
    // Excel serial
    if(!isNaN(fecha)){
      const serial = parseInt(fecha, 10);
      if(serial > 1000) return new Date(1900, 0, serial - 2);
    }
    if(typeof fecha === "string"){
      if(/^\d{4}-\d{2}-\d{2}$/.test(fecha)){
        const [y,m,d] = fecha.split("-").map(Number);
        return new Date(y, m-1, d);
      }
      if(/^\d{2}\/\d{2}\/\d{4}$/.test(fecha)){
        const [d,m,y] = fecha.split("/").map(Number);
        return new Date(y, m-1, d);
      }
    }
    return null;
  }

  function qcDiasRestantes(fecha){
    const dt = qcParseCaducidadToDate(fecha);
    if(!dt || isNaN(dt.getTime())) return Infinity;
    const hoy = new Date(); hoy.setHours(0,0,0,0);
    dt.setHours(0,0,0,0);
    return Math.floor((dt - hoy) / (1000*60*60*24));
  }

  function qcFmt2(n){
    const x = Number(n);
    if(!Number.isFinite(x)) return "-";
    return x.toLocaleString("es-MX", { maximumFractionDigits: 2 });
  }

  function qcPillDias(dias){
    if(dias === Infinity) return `<span class=\"cadu-pill\">S/C</span>`;
    if(dias <= 7) return `<span class=\"cadu-pill cadu-pill--danger\">‚õî ${dias}d</span>`;
    if(dias <= 30) return `<span class=\"cadu-pill cadu-pill--warn\">‚ö†Ô∏è ${dias}d</span>`;
    return `<span class=\"cadu-pill cadu-pill--ok\">‚úÖ ${dias}d</span>`;
  }

  function qcCompute({ catalogo, productosQC, historicosQC, consumoQC, filtros, columnaCorte }){
    qclog("üß† Computando dashboard", { columnaCorte, filtros, nCat: catalogo.length, nProd: productosQC.length, nHist: historicosQC.length, nCon: consumoQC.length });

    // Normaliza cat√°logo
    const cat = (catalogo || []).map(x => ({
      referencia: String(x.referencia || "").trim(),
      tipo: String(x.tipo || "ALL").toUpperCase(),
      analito: x.analito ?? "",
      plataforma: x.plataforma_equipo ?? "",
      buffer_dias: Number(x.buffer_dias ?? 14),
    })).filter(x => x.referencia);

    // Index por referencia
    const catByRef = new Map();
    for(const it of cat) catByRef.set(it.referencia, it);

    // Filtra por tipo
    const allowedRefs = cat.filter(it => filtros.tipo === "ALL" || it.tipo === filtros.tipo).map(it => it.referencia);
    const allowedSet = new Set(allowedRefs);

    // Stock central: suma por ref (cantidad)
    const centralByRef = new Map();
    const lotesCentral = [];
    for(const p of (productosQC||[])){
      const ref = String(p.referencia || "").trim();
      if(!allowedSet.has(ref)) continue;
      const cant = Number(p.cantidad ?? 0);
      if(cant <= 0) continue;
      centralByRef.set(ref, (centralByRef.get(ref) || 0) + cant);
      lotesCentral.push({
        referencia: ref,
        nombre: p.nombre ?? "",
        fabricante: p.fabricante ?? "",
        lote: p.lote ?? "",
        caducidad: p.caducidad ?? "",
        cantidad: cant,
        origen: "CENTRAL",
      });
    }

    // Stock unidades: historicos col -> cantidad
    const unidadesByRef = new Map(); // ref -> total
    const unidadesDetalle = []; // rows
    for(const h of (historicosQC||[])){
      const ref = String(h.referencia || "").trim();
      if(!allowedSet.has(ref)) continue;
      const um = String(h.unidad_medica || h.unidad || "").trim();
      const val = Number(h[columnaCorte] ?? 0);
      if(!Number.isFinite(val) || val <= 0) continue;
      // filtro unidad
      if(filtros.unidad !== "ALL" && um !== filtros.unidad) continue;
      unidadesByRef.set(ref, (unidadesByRef.get(ref) || 0) + val);
      unidadesDetalle.push({ referencia: ref, unidad_medica: um, cantidad: val, origen: "UNIDAD" });
    }

    // Consumo: suma por ref y por mes
    const consumoByRef = new Map();
    const consumoMensual = new Map(); // yyyy-mm -> total
    const consumoMensualByTipo = new Map(); // yyyy-mm -> {IQC,EQC}
    for(const c of (consumoQC||[])){
      const ref = String(c.referencia || "").trim();
      if(!allowedSet.has(ref)) continue;
      if(filtros.unidad !== "ALL" && String(c.unidad_medica||"").trim() !== filtros.unidad) continue;
      const tipo = String(c.tipo || "ALL").toUpperCase();
      if(filtros.tipo !== "ALL" && tipo !== filtros.tipo) continue;
      const cantidad = Number(c.cantidad ?? 0);
      if(!Number.isFinite(cantidad) || cantidad <= 0) continue;
      consumoByRef.set(ref, (consumoByRef.get(ref) || 0) + cantidad);
      const f = String(c.fecha || "").slice(0,10);
      const ym = (f && f.length>=7) ? f.slice(0,7) : "S/F";
      consumoMensual.set(ym, (consumoMensual.get(ym) || 0) + cantidad);
      const bucket = consumoMensualByTipo.get(ym) || { IQC:0, EQC:0 };
      if(tipo === "EQC") bucket.EQC += cantidad; else bucket.IQC += cantidad;
      consumoMensualByTipo.set(ym, bucket);
    }

    // Rango d√≠as
    const daysRange = Math.max(1, Math.round((new Date(filtros.hasta+"T00:00:00") - new Date(filtros.desde+"T00:00:00")) / (1000*60*60*24)));
    const consumoTotal = Array.from(consumoByRef.values()).reduce((a,b)=>a+b,0);
    const consumoDiario = consumoTotal / daysRange;

    // Stock total por ref
    const stockTotalByRef = new Map();
    for(const ref of allowedRefs){
      const central = filtros.incluirCentral ? (centralByRef.get(ref) || 0) : 0;
      const unid = unidadesByRef.get(ref) || 0;
      stockTotalByRef.set(ref, central + unid);
    }

    // Coverage global (d√≠as)
    const stockTotal = Array.from(stockTotalByRef.values()).reduce((a,b)=>a+b,0);
    const coberturaGlobal = consumoDiario > 0 ? (stockTotal / consumoDiario) : Infinity;

    // Ventanas caducidad (por lote central)
    const bins = { "0-7":0, "8-15":0, "16-30":0, "31-90":0, ">90":0, "S/C":0 };
    const critCad = [];
    for(const r of lotesCentral){
      const d = qcDiasRestantes(r.caducidad);
      if(d === Infinity) { bins["S/C"] += 1; continue; }
      if(d <= 7) bins["0-7"] += 1;
      else if(d <= 15) bins["8-15"] += 1;
      else if(d <= 30) bins["16-30"] += 1;
      else if(d <= 90) bins["31-90"] += 1;
      else bins[">90"] += 1;
      if(d <= 30) critCad.push({ ...r, dias: d });
    }

    // Compra sugerida por ref
    const leadTimeDias = 14; // default (ajustable)
    const compra = [];
    const criticos = [];
    for(const ref of allowedRefs){
      const stock = stockTotalByRef.get(ref) || 0;
      const cons = consumoByRef.get(ref) || 0;
      const consDiarioRef = cons / daysRange;
      const it = catByRef.get(ref) || { buffer_dias: 14, tipo: "ALL" };
      const buffer = Number(it.buffer_dias ?? 14);
      const target = consDiarioRef > 0 ? Math.ceil(consDiarioRef * (leadTimeDias + buffer)) : 0;
      const sugerido = Math.max(0, target - stock);
      const cobertura = consDiarioRef > 0 ? (stock / consDiarioRef) : Infinity;
      compra.push({ referencia: ref, tipo: it.tipo || "", stock, consumo: cons, cobertura, sugerido, buffer_dias: buffer });
      const coberturaCrit = cobertura !== Infinity && cobertura <= 14;
      if(coberturaCrit || sugerido > 0){
        criticos.push({ referencia: ref, tipo: it.tipo || "", stock, consumo: cons, cobertura, sugerido, motivo: coberturaCrit ? "Cobertura baja" : "Reponer" });
      }
    }

    // Filtro s√≥lo cr√≠ticos
    const compraFiltrada = filtros.soloCrit ? compra.filter(x => x.sugerido > 0) : compra;
    const critFinal = filtros.soloCrit ? criticos : [...criticos];
    // A√±ade caducidades cr√≠ticas como √≠tems (por lote)
    for(const x of critCad){
      critFinal.push({ referencia: x.referencia, tipo: catByRef.get(x.referencia)?.tipo || "", stock: x.cantidad, consumo: 0, cobertura: Infinity, sugerido: 0, motivo: `Caduca en ${x.dias}d`, lote: x.lote, caducidad: x.caducidad, origen: x.origen });
    }

    // Cobertura por almac√©n (simple): usamos central CUU/65/66 como "almacenes" + unidades como "UNIDADES"
    // Nota: central por almac√©n real requiere una tabla que relacione productos->almac√©n; aqu√≠ asumimos CENTRAL agregado.
    const coberturaPorAlmacen = [
      { key: "CENTRAL", label: "Central", stock: filtros.incluirCentral ? Array.from(centralByRef.values()).reduce((a,b)=>a+b,0) : 0 },
      { key: "UNIDADES", label: "Unidades", stock: Array.from(unidadesByRef.values()).reduce((a,b)=>a+b,0) },
    ].map(x => ({ ...x, cobertura: consumoDiario>0 ? (x.stock/consumoDiario) : Infinity }));

    // Ordena
    compraFiltrada.sort((a,b)=> (b.sugerido - a.sugerido) || (a.referencia.localeCompare(b.referencia)));
    critFinal.sort((a,b)=>{
      const ac = a.cobertura ?? Infinity, bc = b.cobertura ?? Infinity;
      return (ac - bc) || (String(a.referencia).localeCompare(String(b.referencia)));
    });

    return {
      kpis: {
        stockTotal,
        consumoTotal,
        consumoDiario,
        coberturaGlobal,
        caducidadesCriticas: critCad.length,
        itemsReponer: compra.filter(x=>x.sugerido>0).length,
      },
      charts: {
        consumoMensualByTipo,
        coberturaPorAlmacen,
        cadBins: bins,
      },
      tablas: {
        criticos: critFinal,
        compra: compraFiltrada,
      },
      meta: { daysRange, columnaCorte }
    };
  }

  // ---------- Render ----------
  function qcRenderKPIs(kpis){
    const wrap = document.getElementById("qcKPIs");
    if(!wrap) return;
    const card = (title, value, sub="") => `
      <div class="space-card p-4">
        <div class="text-xs text-white/60">${qcEsc(title)}</div>
        <div class="text-2xl font-extrabold text-white/90 mt-1">${qcEsc(value)}</div>
        ${sub ? `<div class="text-xs text-white/55 mt-1">${qcEsc(sub)}</div>` : ""}
      </div>
    `;
    const cov = (kpis.coberturaGlobal === Infinity) ? "‚àû" : qcFmt2(kpis.coberturaGlobal);
    wrap.innerHTML = [
      card("Stock total QC", qcFmt2(kpis.stockTotal), "central + unidades"),
      card("Consumo (rango)", qcFmt2(kpis.consumoTotal), "unidades consumidas"),
      card("Consumo diario", qcFmt2(kpis.consumoDiario), "promedio"),
      card("Cobertura global (d√≠as)", cov, "stock / consumo"),
      card("Cr√≠ticos", qcFmt2(kpis.caducidadesCriticas + kpis.itemsReponer), "caducidad + reponer"),
    ].join("\n");
  }

  async function qcRenderCharts(ch){
    const ok = await qcEnsureChart();
    if(!ok) return;
    const Chart = window.Chart;

    // Consumo mensual
    const c1 = document.getElementById("qcChartConsumo");
    if(c1){
      const labels = Array.from(ch.consumoMensualByTipo.keys()).sort();
      const iqc = labels.map(k => ch.consumoMensualByTipo.get(k)?.IQC || 0);
      const eqc = labels.map(k => ch.consumoMensualByTipo.get(k)?.EQC || 0);
      const data = {
        labels,
        datasets: [
          { label: "IQC", data: iqc, tension: 0.25, order: 1 },
          { label: "EQC", data: eqc, tension: 0.25, order: 2 },
        ]
      };
      if(window.qcState.charts.consumo) window.qcState.charts.consumo.destroy();
      window.qcState.charts.consumo = new Chart(c1.getContext("2d"), {
        type: "line",
        data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: "rgba(255,255,255,.75)", sort: safeLegendSort } },
            tooltip: { enabled: true }
          },
          scales: {
            x: { ticks: { color: "rgba(255,255,255,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
            y: { ticks: { color: "rgba(255,255,255,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
          }
        }
      });
    }

    // Cobertura por almac√©n
    const c2 = document.getElementById("qcChartCobertura");
    if(c2){
      const labels = ch.coberturaPorAlmacen.map(x => x.label);
      const vals = ch.coberturaPorAlmacen.map(x => (x.cobertura===Infinity?0:x.cobertura));
      if(window.qcState.charts.cobertura) window.qcState.charts.cobertura.destroy();
      window.qcState.charts.cobertura = new Chart(c2.getContext("2d"), {
        type: "bar",
        data: { labels, datasets: [{ label: "D√≠as", data: vals, order: 1 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } },
          scales: {
            x: { ticks: { color: "rgba(255,255,255,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
            y: { ticks: { color: "rgba(255,255,255,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
          }
        }
      });
    }

    // Caducidades ventanas
    const c3 = document.getElementById("qcChartCaducidad");
    if(c3){
      const labels = Object.keys(ch.cadBins);
      const vals = labels.map(k => ch.cadBins[k] || 0);
      if(window.qcState.charts.caducidad) window.qcState.charts.caducidad.destroy();
      window.qcState.charts.caducidad = new Chart(c3.getContext("2d"), {
        type: "doughnut",
        data: { labels, datasets: [{ label: "Lotes", data: vals }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } }
        }
      });
    }
  }

  function qcRenderTablaCriticos(rows){
    const wrap = document.getElementById("qcTablaCriticos");
    if(!wrap) return;

    if(!rows?.length){
      wrap.innerHTML = `<div class="p-4 text-sm text-white/70">‚úÖ Sin cr√≠ticos con los filtros actuales.</div>`;
      return;
    }

    const head = `
      <table class="cadu-table">
        <thead>
          <tr>
            <th>Referencia</th>
            <th>Tipo</th>
            <th>Stock</th>
            <th>Cobertura</th>
            <th>Motivo</th>
          </tr>
        </thead>
        <tbody>
    `;

    const body = rows.slice(0, 120).map(r => {
      const cov = (r.cobertura === Infinity) ? "‚àû" : qcFmt2(r.cobertura);
      const motivo = r.motivo || "";
      return `
        <tr>
          <td class="whitespace-nowrap font-mono">${qcEsc(r.referencia)}</td>
          <td>${qcEsc(r.tipo || "")}</td>
          <td class="text-right">${qcFmt2(r.stock || 0)}</td>
          <td class="text-right">${qcEsc(cov)}</td>
          <td>${qcEsc(motivo)}${r.caducidad ? `<span class="cadu-sub">Lote ${qcEsc(r.lote||"")} ¬∑ ${qcEsc(r.caducidad)} ¬∑ ${qcPillDias(qcDiasRestantes(r.caducidad))}</span>` : ""}</td>
        </tr>
      `;
    }).join("\n");

    const foot = `</tbody></table>`;
    wrap.innerHTML = head + body + foot;
  }

  function qcRenderTablaCompra(rows){
    const wrap = document.getElementById("qcTablaCompra");
    if(!wrap) return;
    if(!rows?.length){
      wrap.innerHTML = `<div class="p-4 text-sm text-white/70">‚Äî Sin sugerencias de compra con los filtros actuales.</div>`;
      return;
    }
    const head = `
      <table class="cadu-table">
        <thead>
          <tr>
            <th>Referencia</th>
            <th>Tipo</th>
            <th>Stock</th>
            <th>Consumo</th>
            <th>Sugerido</th>
          </tr>
        </thead>
        <tbody>
    `;
    const body = rows.slice(0, 160).map(r => `
      <tr>
        <td class="whitespace-nowrap font-mono">${qcEsc(r.referencia)}</td>
        <td>${qcEsc(r.tipo || "")}</td>
        <td class="text-right">${qcFmt2(r.stock || 0)}</td>
        <td class="text-right">${qcFmt2(r.consumo || 0)}</td>
        <td class="text-right font-extrabold">${qcFmt2(r.sugerido || 0)}</td>
      </tr>
    `).join("\n");
    wrap.innerHTML = head + body + `</tbody></table>`;
  }

  // ---------- Orquestador ----------
  async function qc_refrescarDashboard(){
    const modal = document.getElementById("modalQC");
    if(modal && modal.classList.contains("hidden")) {
      // si est√° cerrado, no corremos por accidente
      qclog("‚è≠Ô∏è QC refresh ignorado (modal cerrado)");
      return;
    }

    loaderReset?.();
    mostrarLoader?.(true);
    try{
      qcSetDefaultDates();
      const filtros = qcGetFilters();
      const columnaCorte = qcColumnaCorteVigente();

      qclog("‚ñ∂ Iniciando QC refresh", { filtros, columnaCorte });
      loaderPush?.("QC: cargando cat√°logo (qc_items)");
      const catalogo = await qcSbSelect("qc_items", "referencia,tipo,analito,plataforma_equipo,buffer_dias");
      window.qcState.catalogo = catalogo;

      if(!catalogo.length){
        qclog("‚ö†Ô∏è qc_items vac√≠o. El dashboard mostrar√° datos incompletos.");
      }

      // refs a consultar
      const refs = catalogo.map(x => String(x.referencia||"").trim()).filter(Boolean);
      const uniqueRefs = Array.from(new Set(refs));

      loaderPush?.("QC: cargando productos (stock central)");
      const productosQC = uniqueRefs.length
        ? await qcSbSelect("productos", "referencia,nombre,fabricante,lote,caducidad,cantidad", { in: { referencia: uniqueRefs } })
        : [];
      window.qcState.productosQC = productosQC;

      loaderPush?.("QC: cargando historicos (stock unidades)");
      const histSelect = `unidad_medica,referencia,${columnaCorte}`;
      const historicosQC = uniqueRefs.length
        ? await qcSbSelect("historicos", histSelect, { in: { referencia: uniqueRefs } })
        : [];
      window.qcState.historicosQC = historicosQC;

      loaderPush?.("QC: cargando consumo (qc_consumo)");
      const consumoQC = await qcSbSelect("qc_consumo", "fecha,unidad_medica,referencia,tipo,cantidad", {
        gte: { fecha: filtros.desde },
        lte: { fecha: filtros.hasta },
      });
      window.qcState.consumoQC = consumoQC;

      const computed = qcCompute({ catalogo, productosQC, historicosQC, consumoQC, filtros, columnaCorte });
      window.qcState.computed = computed;
      window.qcState.lastRunAt = new Date().toISOString();

      // Render
      qcRenderKPIs(computed.kpis);
      await qcRenderCharts(computed.charts);
      qcRenderTablaCriticos(computed.tablas.criticos);
      qcRenderTablaCompra(computed.tablas.compra);

      qclog("‚úÖ QC dashboard listo", { kpis: computed.kpis, meta: computed.meta });
    } catch(e){
      qclog("‚ùå Error en QC refresh", { err: String(e?.message || e) });
      const t1 = document.getElementById("qcTablaCriticos");
      const t2 = document.getElementById("qcTablaCompra");
      if(t1) t1.innerHTML = `<div class="p-4 text-sm text-rose-200">‚ùå Error cargando QC: ${qcEsc(String(e?.message||e))}</div>`;
      if(t2) t2.innerHTML = `<div class="p-4 text-sm text-rose-200">‚ùå Error cargando QC: ${qcEsc(String(e?.message||e))}</div>`;
    } finally {
      ocultarLoader?.();
    }
  }

  function qc_exportarCSV(){
    try{
      const comp = window.qcState.computed;
      if(!comp){
        qclog("‚è≠Ô∏è No hay datos para exportar (corre Refrescar)");
        return;
      }
      const rows1 = comp.tablas.compra || [];
      const rows2 = comp.tablas.criticos || [];
      const esc = (v) => {
        const s = String(v ?? "").replaceAll('"','""');
        return `"${s}"`;
      };
      const head1 = ["referencia","tipo","stock","consumo","cobertura_dias","sugerido"].map(esc).join(",");
      const csv1 = rows1.map(r => [r.referencia,r.tipo,r.stock,r.consumo,r.cobertura,r.sugerido].map(esc).join(",")).join("\n");
      const head2 = ["referencia","tipo","stock","cobertura_dias","motivo","lote","caducidad"].map(esc).join(",");
      const csv2 = rows2.map(r => [r.referencia,r.tipo,r.stock,r.cobertura,r.motivo||"",r.lote||"",r.caducidad||""].map(esc).join(",")).join("\n");
      const out = [
        "# QC Command - Compra sugerida",
        head1,
        csv1,
        "",
        "# QC Command - Cr√≠ticos",
        head2,
        csv2,
        "",
        `# Meta: columnaCorte=${comp.meta?.columnaCorte || ""} daysRange=${comp.meta?.daysRange || ""}`,
      ].join("\n");

      const blob = new Blob([out], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `qc_command_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      qclog("‚¨áÔ∏è CSV exportado");
    } catch(e){
      qclog("‚ùå Error exportando CSV", { err: String(e?.message || e) });
    }
  }

  function abrirModalQC(){
    const modal = document.getElementById("modalQC");
    if(!modal) return;
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    qcSetDefaultDates();
    qcCargarUnidadesSelect();
    qclog("üõ∞Ô∏è QC modal abierto");
    // Auto-refresh al abrir (primera vez o siempre)
    qc_refrescarDashboard();
  }

  function cerrarModalQC(){
    const modal = document.getElementById("modalQC");
    if(!modal) return;
    modal.classList.add("hidden");
    modal.classList.remove("flex");
    qclog("üõ∞Ô∏è QC modal cerrado");
  }

  // Exponer APIs globales
  window.abrirModalQC = abrirModalQC;
  window.cerrarModalQC = cerrarModalQC;
  window.qc_refrescarDashboard = qc_refrescarDashboard;
  window.qc_exportarCSV = qc_exportarCSV;

  // Listeners
  document.addEventListener("DOMContentLoaded", () => {
    qcSetDefaultDates();
    qcCargarUnidadesSelect();
    const btn = document.getElementById("btnQC");
    if(btn) btn.addEventListener("click", () => abrirModalQC());
    ["qcTipo","qcAlmacen","qcUnidad","qcDesde","qcHasta","qcSoloCriticos","qcIncluirCentral"].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.addEventListener("change", () => qclog("üîÅ Filtro cambiado", { id, value: (el.type==="checkbox"?el.checked:el.value) }));
    });
  });

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      const modal = document.getElementById("modalQC");
      if(modal && !modal.classList.contains("hidden")) cerrarModalQC();
    }
  });

})();

// Abre el modal y prepara el selector:
window.abrirModalReporteMensual = function () {
  console.log("üü¢ abrirModalReporteMensual ejecutado");

  const modal = document.getElementById("modalReporteMensual");
  if (!modal) {
    console.error("‚ùå No se encontr√≥ el modalReporteMensual");
    return;
  }

  // ‚úÖ Fuerza centrado SIEMPRE (por si en el HTML falt√≥ flex)
  modal.classList.add("flex", "items-center", "justify-center");
  modal.classList.remove("hidden");

  // (Opcional pero recomendado) padding para m√≥viles
  modal.classList.add("p-4");

  inicializarSelectorMesAnio();

  console.log("‚úÖ Modal de reporte mensual abierto correctamente");
};

window.cerrarModalReporteMensual = function () {
  console.log("üîí Cerrando modal de reporte");
  const modal = document.getElementById("modalReporteMensual");
  if (!modal) return;

  modal.classList.add("hidden");
  // puedes dejar estas puestas siempre, pero si quieres limpiar:
  // modal.classList.remove("flex", "items-center", "justify-center");
};

window.generarReporteMensual = async function () {
  console.log("üöÄ Iniciando generaci√≥n de reporte");

  const mes = document.getElementById("inputMesMes")?.value;
  const anio = document.getElementById("inputMesAnio")?.value;

  if (!mes || !anio) {
    mostrarModal("‚ö†Ô∏è Selecciona mes y a√±o", "#f59e0b");
    return;
  }

  cerrarModalReporteMensual();
  mostrarModal("‚è≥ Generando reporte...", "#0ea5e9");

  const mesSeleccionado = `${anio}-${mes}`; // Formato "2024-08"
  const mesNum = parseInt(mes, 10);
  const anioNum = parseInt(anio, 10);
  const mesAnterior = mesNum === 1 ? 12 : mesNum - 1;
  const anioAnterior = mesNum === 1 ? anioNum - 1 : anioNum;

  const colInventarioInicial = `25_${mesAnterior}_${anioAnterior}`;
  const colInventarioCorte = `10_${mesNum}_${anioNum}`;
  const colInventarioFinal = `25_${mesNum}_${anioNum}`;
  const colPruebasFacturadas = `25_${mesNum}_${anioNum}`;

  const colConsumoInicial = `10_${mesNum}_${anioNum}`;
  const colConsumoCorte = `25_${mesNum}_${anioNum}`;

  const proyectos = {
    "CHIH IMSS B.S.": ["C03126","C03127","C03128","C03129","C03130","C03131","C03132","C03133","C03134","C03135"],
    "CHIH IMSS_BIENESTAR LAB.": ["C03122","C03123","C03124"],
    "CHIH SS LAB.": ["C03415","C03416","C03417","C03418","C03419","C03420","C03421","C03422","C03423","C03424",
    "C03425","C03426","C03427","C03428","C03429","C03430","C03431","C03432","C03433","C03434","C03435","C03436",
    "C03437","C03438","C03439","C03440","C03441","C03442","C03443","C03444","C03445","C03446","C03447","C03448",
    "C03449","C03450","C03451"]
  };

  try {
    const headers = { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` };

    // --- NUEVA llamada adicional para traer consumos_mensuales ---
    const [historicos, consumosMensuales, pruebasFacturadas] = await Promise.all([
      fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/historicos?select=*", { headers }).then(r => r.json()),
      fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/consumos_mensuales?select=*", { headers }).then(r => r.json()),
      fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/pruebas_facturadas?select=*", { headers }).then(r => r.json())
    ]);

    const filas = [];

    for (const h of historicos) {
      const proyecto = Object.entries(proyectos).find(([_, arr]) => arr.includes(h.unidad_medica))?.[0] || "";
      const cliente = h.unidad_medica;
      const lineadenegocio = proyecto === "CHIH IMSS B.S." ? "BANCO SANGRE" : "LABORATORIO";

      const inventarioInicial = parseFloat(h[colInventarioInicial] || 0);
      const inventarioCorte = parseFloat(h[colInventarioCorte] || 0);
      const inventarioFinal = parseFloat(h[colInventarioFinal] || 0);
      const io = parseFloat(h.inventario_objetivo || 0);
      const costoUnitario = parseFloat(h.costo || 0);
      const productoSurtirInicial = io - inventarioInicial;
      const productoSurtirCorte = io - inventarioCorte;

      // NUEVO c√°lculo de entregadoInicial y entregadoCorte desde consumos_mensuales:
      const consumoMatch = consumosMensuales.find(c => 
        c.referencia === h.referencia && c.unidad_medica === cliente
      );

      const entregadoInicial = consumoMatch ? parseFloat(consumoMatch[colConsumoInicial] || 0) : 0;
      const entregadoCorte = consumoMatch ? parseFloat(consumoMatch[colConsumoCorte] || 0) : 0;

      // Las remisiones las dejamos vac√≠as de momento
      const remisionInicial = "";
      const remisionCorte = "";

      const consumoInv10 = inventarioInicial + entregadoInicial - inventarioCorte;
      const productoConsumido = (inventarioInicial + entregadoInicial + entregadoCorte) - inventarioFinal;
      const costoConsumido = productoConsumido * costoUnitario;
      const pruebasConsumidas = productoConsumido * parseFloat(h.rendimiento || 0);
      const pruebasFact = pruebasFacturadas.find(p => p.unidad_medica === cliente && p.referencia === h.referencia)?.[colPruebasFacturadas] || 0;

      filas.push([
        proyecto, cliente, lineadenegocio, h.fabricante, h.unidad_nombre, h.referencia, h.nombre, h.presentacion, h.rendimiento,
        costoUnitario, io, io * costoUnitario, inventarioInicial, productoSurtirInicial, entregadoInicial, remisionInicial,
        inventarioCorte, consumoInv10, "", productoSurtirCorte, entregadoCorte, remisionCorte, inventarioFinal, productoConsumido,
        costoConsumido, pruebasConsumidas, pruebasFact
      ]);
    }

    // Generaci√≥n real del Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([
      ["Proyecto", "Cliente", "Lineadenegocio", "Proveedor", "Unidad Medica", "Clave de Producto", "Producto", "Unidad", 
      "Rendimiento", "Costo Unitario", "IO", "Costo IO", "Inventario Inicial", "Producto a surtir inicial", "Entregado inicial",
      "Remision inicial", "Inventario Corte", "Consumo INV 10", "Justificar si quieren que se pida", "Producto a surtir corte",
      "Entregado corte", "Remision corte", "Inventario Final", "Producto consumido", "Costo consumido", "Pruebas consumidas",
      "Pruebas facturadas"],
      ...filas
    ]);
    XLSX.utils.book_append_sheet(wb, ws, "Reporte");

    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: "application/octet-stream" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `Reporte_Mensual_${mesSeleccionado}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    mostrarModal("‚úÖ Reporte descargado", "#16a34a");
  }
  catch (err) {
    console.error("‚ùå Error durante generaci√≥n:", err);
    mostrarModal("‚ùå Error al generar el reporte", "#dc2626");
  }
};

document.getElementById("btnSubirRemision").addEventListener("click", async () => {
  const archivo = document.getElementById("inputArchivoRemision")?.files?.[0];
  const numeroRemision = document.getElementById("inputRemision")?.value.trim();
  const unidadDestino = document.getElementById("inputUnidad")?.value.trim();
  const nip = document.getElementById("inputNIP")?.value.trim();
  const resultado = document.getElementById("resultadoCargaArchivo");

  console.log("üì§ Cargar remisi√≥n SAP ‚Üí click");

  // Limpia estado anterior
  if (resultado) {
    resultado.textContent = "";
    resultado.classList.remove("text-green-600", "text-red-600");
  }

  // ‚úÖ Validaciones con modal (no alert)
  if (!archivo) {
    console.warn("‚ùå No se seleccion√≥ archivo");
    mostrarModal("‚ùå Selecciona un archivo .xlsx", "#7f1d1d");
    return;
  }

  if (!archivo.name.toLowerCase().endsWith(".xlsx")) {
    console.warn("‚ùå Archivo inv√°lido:", archivo.name);
    mostrarModal("‚ùå El archivo debe ser .xlsx", "#7f1d1d");
    return;
  }

  if (!numeroRemision) {
    console.warn("‚ùå Falta n√∫mero de remisi√≥n");
    mostrarModal("‚ùå Escribe el n√∫mero de remisi√≥n", "#7f1d1d");
    return;
  }

  if (!unidadDestino) {
    console.warn("‚ùå Falta unidad destino");
    mostrarModal("‚ùå Especifica la unidad destino", "#7f1d1d");
    return;
  }

  if (!nip) {
    console.warn("‚ùå Falta NIP");
    mostrarModal("‚ùå Ingresa tu NIP", "#7f1d1d");
    return;
  }

  const formData = new FormData();
  formData.append("file", archivo);
  formData.append("numero_remision", numeroRemision);
  formData.append("unidad_destino", unidadDestino);
  formData.append("usuario_carga", nip);

  console.log("üì¶ FormData listo:", {
    archivo: archivo.name,
    numeroRemision,
    unidadDestino,
    usuario: nip
  });

  try {
    const res = await fetch(
      "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/cargar_remision_sap",
      { method: "POST", body: formData }
    );

    const texto = await res.text();
    console.log("üì® Respuesta servidor:", res.status, texto);

    if (res.ok) {
      if (resultado) resultado.classList.add("text-green-600");
      if (resultado) resultado.textContent = `‚úÖ ${texto}`;

      mostrarModal("‚úÖ Remisi√≥n cargada correctamente", "#065f46");

      await cargarTablaRemisionSAP(numeroRemision); // sync tabla
    } else {
      if (resultado) resultado.classList.add("text-red-600");
      if (resultado) resultado.textContent = `‚ùå Error: ${texto}`;

      mostrarModal(`‚ùå Error al cargar remisi√≥n`, "#7f1d1d");
    }
  } catch (e) {
    console.error("‚ùå Error comunicaci√≥n SAP:", e);

    if (resultado) resultado.classList.add("text-red-600");
    if (resultado) resultado.textContent = "‚ùå Error en la comunicaci√≥n con el servidor.";

    mostrarModal("‚ùå Error de conexi√≥n con el servidor", "#7f1d1d");
  }
});





async function consultarEstadoBloqueo() {
  const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/usuarios?nombre=eq.CONTROL_GLOBAL", {
    headers: { "apikey": API_KEY }
  });

  const data = await res.json();

  if (data.length === 0) {
    console.warn("‚ö†Ô∏è No se encontr√≥ el usuario CONTROL_GLOBAL");
    return false;
  }

  const emailControl = data[0].email || "";
  const estado = emailControl.includes("bloqueo_remision:true");

  return estado;
}

async function cargarEstadoBloqueo() {
  const contenedor = document.getElementById("seccionBloqueoRemision");
  const btn = document.getElementById("btnBloqueoRemision");

  if (!contenedor || !btn) {
    console.warn("‚ö†Ô∏è Elementos de bloqueo no encontrados en el DOM");
    return;
  }

  if (!usuarioAdmin) {
    contenedor.classList.add("hidden");
    return;
  }

  contenedor.classList.remove("hidden");

  const estadoActual = await consultarEstadoBloqueo();

  btn.textContent = estadoActual 
    ? "üîí Bloqueo por remisi√≥n ACTIVADO" 
    : "üîì Bloqueo por remisi√≥n DESACTIVADO";

  btn.onclick = async () => {
    await cambiarEstadoBloqueo(!estadoActual);
    await cargarEstadoBloqueo(); // Refresca visual despu√©s de cambiar
  };
}


async function cambiarEstadoBloqueo(nuevoEstado) {
  await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/usuarios?nombre=eq.CONTROL_GLOBAL", {
    method: "PATCH",
    headers: {
      "apikey": API_KEY,
      "Authorization": `Bearer ${API_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      email: `bloqueo_remision:${nuevoEstado ? 'true' : 'false'}`
    })
  });
}

window.addEventListener("DOMContentLoaded", () => {
  const inputQR = document.getElementById("inputQR");

  if (inputQR) {
    inputQR.addEventListener("keyup", async function(event) {
      if (event.key === "Enter") {
        const contenido = event.target.value.trim();

        if (contenido) {
          // Divisi√≥n por coma o punto y coma (permite flexibilidad)
          const codigos = contenido.split(/[,;]+/);

          for (let codigo of codigos) {
            const limpio = codigo.trim();
            if (limpio) {
              try {
                await procesarQR(limpio);
              } catch (err) {
                console.error(`‚ùå Error al procesar QR m√∫ltiple: ${limpio}`, err);
              }
            }
          }

          inputQR.value = "";
          inputQR.focus();
        }
      }
    });
  }
});

async function mostrarPinDinamicoAdmin() {
  const pin = await generarPinDinamico();
  const el = document.getElementById("valorPinDinamicoSolo");
  if (el) el.textContent = pin;
}

function verMovimientos(referencia) {
  filtroReferenciaGlobal = referencia;

  const modal = document.getElementById("modalMovimientos");
  if (modal) modal.classList.remove("hidden");

  const cantidad = document.getElementById("cantidadMovimientos")?.value || "50";
  const fechaInicio = document.getElementById("fechaInicio")?.value;
  const fechaFin = document.getElementById("fechaFin")?.value;
  const loteSeleccionado = document.getElementById("selectLote")?.value;

  let url = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/TimeStamps?referencia=eq.${encodeURIComponent(referencia)}&select=usuario,movimiento,fecha_str,lote,remision,unidad_destino,fecha,pin_autorizado_por,timestamp,ts_eliminado`;

  const filtros = [];
  if (fechaInicio) filtros.push(`fecha=gte.${new Date(fechaInicio).getTime()}`);
  if (fechaFin) filtros.push(`fecha=lte.${new Date(fechaFin).getTime() + 86400000 - 1}`);
  if (loteSeleccionado) filtros.push(`lote=eq.${encodeURIComponent(loteSeleccionado)}`);
  if (filtros.length) url += `&${filtros.join("&")}`;
  url += `&order=fecha.desc`;

  fetch(url, {
    headers: { "apikey": API_KEY, "Authorization": `Bearer ${API_KEY}` }
  })
    .then(res => {
      if (!res.ok) throw new Error("No se pudo obtener movimientos");
      return res.json();
    })
    .then(data => {
      const contenedor = document.getElementById("movimientosContenido");
      const selectLote = document.getElementById("selectLote");

      if (selectLote && referencia !== selectLote.dataset.referencia) {
        const lotesUnicos = [...new Set(data.map(m => m.lote))].filter(Boolean);
        selectLote.innerHTML = `<option value="">Todos</option>` +
          lotesUnicos.map(l => `<option value="${l}">${l}</option>`).join("");
        selectLote.dataset.referencia = referencia;
      }

      if (!data.length) {
        contenedor.innerHTML = "<p class='text-sm text-center text-gray-600'>No hay movimientos registrados.</p>";
        return;
      }

      const grupos = {};
      for (const m of data) {
        const clave = `${m.remision || "-"}||${m.lote || "-"}||${m.unidad_destino || "-"}`;
        if (!grupos[clave]) grupos[clave] = [];
        grupos[clave].push(m);
      }

      let html = `<table class="w-full text-sm text-left border mt-2 rounded-xl overflow-hidden">
        <thead class="bg-teal-900 text-white text-center">
          <tr>
            <th class="p-2">üìÇ</th>
            <th class="p-2">Fecha</th>
            <th class="p-2">Usuario</th>
            <th class="p-2">Lote</th>
            <th class="p-2">Remisi√≥n</th>
            <th class="p-2">Unidad Destino</th>
            <th class="p-2">Cantidad</th>
            <th class="p-2 whitespace-normal w-32">Excedente<br>Autorizado por</th>
          </tr>
        </thead>
        <tbody class="text-black text-center">`;

      let i = 0;
      for (const [clave, movimientos] of Object.entries(grupos)) {
        const [remision, lote, unidad] = clave.split("||");
        const primero = movimientos[0];
        const unidadNombre = unidadesDestino[unidad] || unidad || "-";
        const autorizado = movimientos.find(m => m.pin_autorizado_por)?.pin_autorizado_por || " ";
        const id = i++;

        html += `<tr class="bg-gray-100">
          <td class="p-2">
            <button id="btnToggle-${id}" onclick="toggleSubtabla('${id}')" class="text-xs px-1.5 py-0.5 rounded-full border border-gray-400 hover:bg-gray-200">‚ñ∂</button>
          </td>
          <td class="p-2">${primero.fecha_str || "-"}</td>
          <td class="p-2">${primero.usuario || "-"}</td>
          <td class="p-2">${lote}</td>
          <td class="p-2">${remision}</td>
          <td class="p-2">${unidadNombre}</td>
          <td class="p-2">${movimientos.length}</td>
          <td class="p-2 text-red-800 font-bold">${autorizado}</td>
        </tr>`;

        html += `<tr id="subtabla-${id}" class="hidden bg-white"><td colspan="8" class="p-0">
          <table class="w-full text-xs text-center">
            <thead class="bg-gray-200 text-gray-700">
              <tr>
                <th class="p-1">Fecha</th>
                <th class="p-1">NS</th>
                <th class="p-1">Movimiento</th>
                <th class="p-1">¬øExcedente?</th>
              </tr>
            </thead>
            <tbody>`;
        for (const m of movimientos) {
          const nsBase = m.timestamp || m.ts_eliminado;
          const ns = nsBase ? String(nsBase).slice(-8) : "-";
          const excedente = m.pin_autorizado_por
            ? `<span class="text-red-800 font-bold">S√≠</span>`
            : `<span class="text-gray-400 font-bold">No</span>`;

          html += `<tr>
            <td class="p-1">${m.fecha_str || "-"}</td>
            <td class="p-1">${ns}</td>
            <td class="p-1">${m.movimiento || "-"}</td>
            <td class="p-1">${excedente}</td>
          </tr>`;
        }
        html += `</tbody></table></td></tr>`;
      }

      html += "</tbody></table>";
      contenedor.innerHTML = html;
    })
    .catch(err => {
      console.error("Error al cargar movimientos:", err);
      document.getElementById("movimientosContenido").innerHTML =
        "<p class='text-sm text-center text-red-600'>Error al obtener movimientos.</p>";
    });
}



function toggleSubtabla(id) {
  const sub = document.getElementById("subtabla-" + id);
  const btn = document.getElementById("btnToggle-" + id);

  if (!sub || !btn) {
    console.warn("üîç No se encontr√≥ subtabla o bot√≥n para:", id);
    return;
  }

  const visible = !sub.classList.contains("hidden");
  sub.classList.toggle("hidden");
  btn.textContent = visible ? "‚ñ∂" : "‚ñº";
}



  document.addEventListener("DOMContentLoaded", () => {
    const mesSelect = document.getElementById("mesCaptura");
    const anioSelect = document.getElementById("anioCaptura");

    const meses = [
      "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];

    // Generar meses
    meses.forEach((mes, i) => {
      const opt = document.createElement("option");
      opt.value = i + 1;
      opt.textContent = mes;
      mesSelect.appendChild(opt);
    });

    // Generar a√±os desde 2023 hasta 2028
    const a√±oActual = new Date().getFullYear();
    for (let a = a√±oActual - 1; a <= a√±oActual + 3; a++) {
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      anioSelect.appendChild(opt);
    }

    // Seleccionar el mes y a√±o actual por defecto
    mesSelect.value = new Date().getMonth() + 1;
    anioSelect.value = a√±oActual;
  });


  function actualizarTextoTipoCaptura() {
  const toggle = document.getElementById("toggleTipoCaptura");
  const texto = document.getElementById("textoTipoCaptura");
  const fondo = document.getElementById("fondoToggleTipo");
  const circulo = document.getElementById("circuloToggleTipo");
  const modo = document.getElementById("modoCaptura").value;

  texto.textContent = toggle.checked ? "Corte" : "Inicial";

  // Actualizar colores seg√∫n modo
  if (modo === "inventario") {
    fondo.className = "w-14 h-7 rounded-full transition-colors duration-300 " + (toggle.checked ? "bg-emerald-900" : "bg-gray-300");
  } else {
    fondo.className = "w-14 h-7 rounded-full transition-colors duration-300 " + (toggle.checked ? "bg-rose-900" : "bg-gray-300");
  }

  // Mover el c√≠rculo
  circulo.className = "absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-transform duration-300" + (toggle.checked ? " translate-x-7" : "");
}
async function verificarExistenciaYConfirmarEnvio() {
  const unidad = document.getElementById("unidadCaptura").value;
  const mes = document.getElementById("mesCaptura").value;
  const anio = document.getElementById("anioCaptura").value;
  const tipo = document.getElementById("modoCaptura").value;
  const tabla = tipo === "pruebas_facturadas" ? "pruebas_facturadas" : "historicos";
  const columna = calcularColumnaFecha(mes, anio);

  if (!unidad || !mes || !anio) return mostrarModal("‚ùå Faltan datos para verificar existencia", "red");

  try {
    const referencias = datosCaptura.map(d => `'${d.referencia}'`).join(",");
    const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/${tabla}?select=referencia,${columna}&unidad_medica=eq.${unidad}&referencia=in.(${referencias})`, {
      headers: {
        apikey: "API_KEY",
        Authorization: "Bearer API_KEY"
      }
    });
    const existentes = await res.json();

    const hayCoincidencias = existentes.some(e => e[columna] !== null && e[columna] !== undefined);
    if (hayCoincidencias) {
      mostrarModalConfirmacionSobrescribir(() => {
        enviarCapturaBase(); // Ejecuta si acepta sobrescribir
      });
    } else {
      enviarCapturaBase(); // Si no hay conflicto, env√≠a directamente
    }
  } catch (err) {
    console.error("‚ùå Error verificando existencia:", err);
    mostrarModal("‚ùå No se pudo verificar existencia", "red");
  }
}

function mostrarModalConfirmacionSobrescribir(callback) {
  callbackSobrescribir = callback;
  document.getElementById("modalSobrescribir").classList.remove("hidden");
}

function aceptarSobrescritura() {
  document.getElementById("modalSobrescribir").classList.add("hidden");
  if (callbackSobrescribir) callbackSobrescribir();
  callbackSobrescribir = null;
}

function cerrarModalSobrescribir() {
  document.getElementById("modalSobrescribir").classList.add("hidden");
  callbackSobrescribir = null;
}

async function cargarTablaRemisionSAP(numeroRemision) {
  const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?numero_remision=eq.${numeroRemision}`, {
    headers: {
      "apikey": API_KEY,
      "Authorization": `Bearer ${API_KEY}`
    }
  });

  const data = await res.json();
  const cuerpo = document.getElementById("bodyRemisionSAP");
  cuerpo.innerHTML = "";

  avanceRemision = {}; // üëà REINICIA AVANCE ACTUAL

  data.forEach(item => {
    const clave = `${item.referencia}||${item.lote}`;
    avanceRemision[clave] = {
      nombre: item.descripcion || '',
      escaneados: item.cantidad_escaneada
    };

    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td class="p-2">${item.referencia}</td>
      <td class="p-2">${item.descripcion || ''}</td>
      <td class="p-2">${item.lote || ''}</td>
      <td class="p-2 text-center">${item.cantidad_escaneada}</td>
    `;
    cuerpo.appendChild(fila);
});


  document.getElementById("tablaRemisionSAP").classList.remove("hidden");
}

function actualizarTablaRemisionSAP() {
  const tbody = document.getElementById("bodyRemisionSAP");
  tbody.innerHTML = "";

  Object.entries(avanceRemision).forEach(([clave, info]) => {
    const [referencia, lote] = clave.split("||");

    if (ocultarValidados && info.escaneados > 0) return;

    const fila = document.createElement("tr");
    fila.className = info.escaneados > 0 ? "bg-emerald-200 text-emerald-800" : "";

    fila.innerHTML = `
      <td class="p-2">${referencia}</td>
      <td class="p-2">${info.nombre || ""}</td>
      <td class="p-2">${lote}</td>
      <td class="p-2 text-center">${info.escaneados}</td>
    `;

    tbody.appendChild(fila);
  });

  document.getElementById("tablaRemisionSAP").classList.remove("hidden");
}

document.getElementById("btnToggleFilasValidadas").addEventListener("click", () => {
  ocultarValidados = !ocultarValidados;
  document.getElementById("btnToggleFilasValidadas").textContent = ocultarValidados
    ? "Mostrar validados"
    : "Ocultar validados";
  actualizarTablaRemisionSAP();
});
function confirmarModoInventario() {
  document.getElementById("modalInventario").classList.remove("hidden");
}



function iniciarActualizacionAutomaticaPIN() {
  if (intervaloPin) clearInterval(intervaloPin);

  // Ejecutar inmediatamente
  actualizarPinYContador();

  // Calcular cu√°nto falta para el siguiente m√∫ltiplo exacto del intervalo
  const ahora = new Date();
  const minutos = ahora.getUTCMinutes();
  const segundos = ahora.getUTCSeconds();

  const minutosHastaProximo = INTERVALO_MINUTOS - (minutos % INTERVALO_MINUTOS);
  const msHastaProximo = (minutosHastaProximo * 60 - segundos) * 1000;

  // ‚è≥ Primera actualizaci√≥n al siguiente punto exacto (ej. HH:10:00, HH:20:00...)
  setTimeout(() => {
    actualizarPinYContador();
    intervaloPin = setInterval(actualizarPinYContador, INTERVALO_MINUTOS * 60000);
  }, msHastaProximo);
}

async function detectarAdminDesdePIN(pinIngresado) {
  const ahora = new Date();
  const yyyy = ahora.getUTCFullYear();
  const mm = String(ahora.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(ahora.getUTCDate()).padStart(2, "0");
  const hh = String(ahora.getUTCHours()).padStart(2, "0");
  const bloque = Math.floor(ahora.getUTCMinutes() / 10);
  const clave = "medinova-secreto-2025";

  for (const admin of listaAdmins) {
    const base = `${admin.toLowerCase()}::${yyyy}-${mm}-${dd}-${hh}-${bloque}::${clave}`;
    const hash = await sha256(base);
    const pinGenerado = hash.substring(0, 6).toUpperCase();

    if (pinIngresado === pinGenerado) {
      return admin;
    }
  }

  return null;
}

//#region Basurero
async function procesarBasurero(datos) {
  if (!datos || !datos.referencia || !datos.lote || !datos.timestamp) {
    mostrarModal("‚ùå C√≥digo inv√°lido para eliminar", "#6b7280");
    return;
  }

  inputQR?.focus(); // üëà Asegura que vuelva a enfocar despu√©s de eliminar

  const payload = {
    referencia: datos.referencia,
    lote: datos.lote,
    timestamp: datos.timestamp,
    usuario: usuario || "Basurero"
  };

  try {
    const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/eliminar_etiqueta_basurero", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("üßæ Respuesta de eliminar_etiqueta_basurero:", data);

    if (data.status === "ok") {
      mostrarModal("‚ôªÔ∏è Etiqueta eliminada completamente", "#0f172a");

      try {
        await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/registro_errores", {
          method: "POST",
          headers: {
            "apikey": API_KEY,
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            usuario: usuario || "Basurero",
            referencia: datos.referencia,
            lote: datos.lote,
            fecha: new Date().toISOString(),
            motivo: "borrado etiqueta",
            modo: "borrar",
            pin_ingresado: usuario || "Basurero",
            valido: false,
            timestamp: datos.timestamp
          })
        });
        console.log("üì¶ Registro de eliminaci√≥n guardado en registro_errores.");
      } catch (err) {
        console.warn("‚ö†Ô∏è No se pudo guardar en registro_errores:", err);
      }

      // ‚úÖ Limpiar y reactivar input de escaneo
      if (inputQR) {
        inputQR.value = "";
        inputQR.classList.remove("hidden");
        inputQR.focus();
      }
    }

  } catch (err) {
    console.error("‚ùå Error al contactar Supabase:", err);
    mostrarModal("‚ùå Error de red", "#dc2626");
  }
}
//#endregion
//#region Cerrar Sesion
function cerrarSesion() {
  // üîÅ Limpiar estados
  usuario = null;
  nipAdmin = null;
  unidadSeleccionada = null;
  remisionActual = null;
  modo = "inactivo";
  modoSeleccionado = null;
  qrsPendientes = [];

  // ‚õîÔ∏è Ocultar bot√≥n cerrar sesi√≥n si existe
  const btnCerrar = document.getElementById("btnCerrarSesion");
  if (btnCerrar) btnCerrar.classList.add("hidden");

  // üßº Limpiar visual
  document.getElementById("usuarioActivo").textContent = "Selecciona un modo para iniciar";
  actualizarBotonModo("Inactivo", "bg-gray-500", "üîí");

  // üßΩ Limpiar campos
  document.getElementById("inputNIP").value = "";
  document.getElementById("inputUnidad").value = "";
  document.getElementById("inputRemision").value = "";

  // üß∫ Ocultar modales abiertos
  document.querySelectorAll(".fixed, .modal-modo, #modalPinUnidad").forEach(el => el.classList.add("hidden"));

  // üóëÔ∏è Vaciar tabla
  if (typeof actualizarTablaRegistros === "function") {
    actualizarTablaRegistros();
  }

  // ‚úÖ Mostrar confirmaci√≥n
  mostrarModal("üîí Sesi√≥n cerrada", "#6b7280");
}

// =========================
// ‚òÄÔ∏è‚òÄÔ∏è‚òÄÔ∏è Sol Nacional (SVG WEDGES)
// =========================
(function(){
  // --- Helpers ---
  function polarToXY(cx, cy, r, angleDeg){
    const a = (angleDeg * Math.PI) / 180;
    return {
      x: cx + r * Math.cos(a),
      y: cy + r * Math.sin(a)
    };
  }

  function deg2rad(deg){ return (deg * Math.PI) / 180; }

  // SVG arc flag helper
  function arcFlag(a0, a1){
    let d = ((a1 - a0) % 360 + 360) % 360;
    return d > 180 ? 1 : 0;
  }

  // Returns an SVG path "d" for a donut-wedge between radii r0..r1 and angles a0..a1 (degrees)
  function wedgePathD(cx, cy, r0, r1, a0, a1){
    // normalize
    const A0 = a0;
    const A1 = a1;

    const p0o = { x: cx + r1 * Math.cos(deg2rad(A0)), y: cy + r1 * Math.sin(deg2rad(A0)) };
    const p1o = { x: cx + r1 * Math.cos(deg2rad(A1)), y: cy + r1 * Math.sin(deg2rad(A1)) };
    const p0i = { x: cx + r0 * Math.cos(deg2rad(A0)), y: cy + r0 * Math.sin(deg2rad(A0)) };
    const p1i = { x: cx + r0 * Math.cos(deg2rad(A1)), y: cy + r0 * Math.sin(deg2rad(A1)) };

    const laf = arcFlag(A0, A1);

    // Sweep outer arc forward (1), inner arc backward (0)
    return [
      `M ${p0o.x.toFixed(2)} ${p0o.y.toFixed(2)}`,
      `A ${r1.toFixed(2)} ${r1.toFixed(2)} 0 ${laf} 1 ${p1o.x.toFixed(2)} ${p1o.y.toFixed(2)}`,
      `L ${p1i.x.toFixed(2)} ${p1i.y.toFixed(2)}`,
      `A ${r0.toFixed(2)} ${r0.toFixed(2)} 0 ${laf} 0 ${p0i.x.toFixed(2)} ${p0i.y.toFixed(2)}`,
      `Z`
    ].join(" ");
  }

  // Main render function for Sol Nacional (and drill/logs)
  function renderSolNacional(rows, metric, svg, barsGroup, logLines, L_MAX){
    // Configuraci√≥n
    const CX = 450, CY = 450, R0 = 170;
    const Lmax = L_MAX || 260;
    const N = Math.max(1, rows.length);
    const slotDeg = 360 / N;
    const GAP_DEG = 2;                 // separaci√≥n entre wedges
    const WEDGE_DEG = Math.max(2, Math.min(10, slotDeg - GAP_DEG)); // cu√±a visible

    logLines.push(`MODE: wedges | N=${N} | slot=${slotDeg.toFixed(2)}¬∞ | wedge=${WEDGE_DEG.toFixed(2)}¬∞ | gap=${GAP_DEG}¬∞`);

    // Limpiar grupo
    while (barsGroup.firstChild) barsGroup.removeChild(barsGroup.firstChild);

    // Calcular m√°ximo
    let Ls = [];
    for (const r of rows) {
      let L = Math.max(18, Math.min(Lmax, r.valor ?? 0));
      Ls.push(L);
    }
    // Render wedges
    for (let i = 0; i < rows.length; ++i) {
      const r = rows[i];
      const ang = (i * slotDeg) - 90; // -90 para empezar arriba
      const L = Ls[i];

      // --- WEDGE (donut slice) ---
      const a0 = ang - (WEDGE_DEG / 2);
      const a1 = ang + (WEDGE_DEG / 2);

      // Sombra/ghost (fondo) para ‚Äúllenar‚Äù el c√≠rculo sin afectar lectura
      const ghost = document.createElementNS("http://www.w3.org/2000/svg", "path");
      ghost.setAttribute("d", wedgePathD(CX, CY, R0, R0 + Lmax, a0, a1));
      ghost.setAttribute("fill", "rgba(255,255,255,0.04)");
      ghost.setAttribute("stroke", "rgba(255,255,255,0.03)");
      ghost.setAttribute("stroke-width", "1");
      ghost.setAttribute("pointer-events", "none");
      barsGroup.appendChild(ghost);

      // Wedge real
      const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
      p.setAttribute("d", wedgePathD(CX, CY, R0, R0 + L, a0, a1));
      p.setAttribute("fill", r.color || "#17A2A6");
      p.setAttribute("fill-opacity", "0.88");
      p.setAttribute("stroke", "rgba(255,255,255,0.08)");
      p.setAttribute("stroke-width", "1");

      // target invisible para hover/click (m√°s f√°cil de atinar)
      const hit = document.createElementNS("http://www.w3.org/2000/svg", "path");
      hit.setAttribute("d", wedgePathD(CX, CY, R0, R0 + L, a0, a1));
      hit.setAttribute("fill", "transparent");
      hit.setAttribute("stroke", "transparent");
      hit.setAttribute("stroke-width", "18");
      hit.style.cursor = "pointer";

      // tooltips / click: conserva exactamente la misma l√≥gica que ya ten√≠as para el line
      // Si tu c√≥digo actual hace line.addEventListener('mousemove', ...) y line.addEventListener('click', ...)
      // c√°mbialo para que se lo pongas a `hit` y al path `p`.
      // EJEMPLO (ajusta al handler real existente):
      // hit.addEventListener('mousemove', (ev)=> onHoverRep(ev, r, metric));
      // hit.addEventListener('mouseleave', hideTooltip);
      // hit.addEventListener('click', ()=> openDrill(r.id, r.nombre));

      barsGroup.appendChild(p);
      barsGroup.appendChild(hit);
    }
  }

  // Expose to global for integration
  window.renderSolNacional = renderSolNacional;
})();
//#endregion


  </script>
</body>
</html>

